{"version":3,"file":"app.bundle.js","sourceRoot":"","sources":["core/constants.js","core/build-info.js","core/settings.js","core/debug.js","core/updater.js","systems/update-manager.js","worldmap/WorldMapManager.js","worldmap/WorldMapView.js","worldmap/data/world-map-data.js","worldmap/progress/progress-manager.js","worldmap/nodes/level-node.js","worldmap/controller/player-map-controller.js","worldmap/ui/world-map-ui.js","worldmap/ui/shop-panel.js","systems/beeper.js","systems/jetpack.js","level/level-1.js","level/level-2.js","level/level-3.js","level/level-4.js","level/level-data.js","scenes/boot-scene.js","scenes/menu-scene.js","scenes/world-map-scene.js","scenes/extras-scene.js","scenes/intro-scene.js","scenes/options-scene.js","scenes/game-scene.js","scenes/ui-scene.js","main.js"],"sourcesContent":["\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.Config = {\n  GAME_WIDTH: 960,\n  GAME_HEIGHT: 540,\n  TILE: 8,\n  WIN_COIN_TARGET: 10,\n  PLAYER: {\n    maxSpeed: 164,\n    acceleration: 1080,\n    drag: 3200,\n    jumpVelocity: 420,\n    maxJumps: 1,\n    gravity: 1100,\n    coyoteTimeMs: 110,\n    jumpBufferMs: 130,\n    hurtInvulnMs: 900,\n    dashSpeed: 460,\n    dashDurationMs: 140,\n    dashCooldownMs: 900,\n    attackRange: 44,\n    attackCooldownMs: 320,\n    // Hard safety clamps for vertical velocity to avoid physics spikes.\n    maxRiseSpeed: 520,\n    maxFallSpeed: 760,\n  },\n  JETPACK: {\n    // Fuel pool in seconds of continuous use.\n    fuelCapacity: 1.25,\n    // Fuel seconds consumed per second while thrusting.\n    drainRate: 1.0,\n    // Fuel seconds regenerated per second while grounded.\n    regenRate: 0.72,\n    // Gravity-like control knobs.\n    hoverAccelFactor: 0.95,\n    liftAccelFactor: 1.34,\n    // Extra upward thrust acceleration (in addition to anti-gravity).\n    thrustAccelFactor: 0.52,\n    // Small extra assist while still moving upward after jump.\n    jumpAssistAccelFactor: 0.34,\n    rampUpTime: 0.16,\n    rampDownTime: 0.22,\n    minHoldToLift: 0.2,\n    liftThresholdSpeed: 56,\n    // Keep ascent intentionally slow vs jump.\n    maxUpSpeed: 220,\n    // Preserve/extend existing upward momentum when jetpack is activated mid-air.\n    momentumBoostSpeed: 72,\n    activationKickSpeed: 34,\n    // Safety caps.\n    maxAccel: 1320,\n    maxThrustAccel: 1300,\n    brakeDecelMax: 760,\n  },\n};\n\n/*\nHow to tune gravity-like jetpack:\n- hoverAccelFactor: 0.90-1.05. Near 1.0 feels like hover / soft fall braking.\n- liftAccelFactor: 1.05-1.25. Slightly above 1 for gentle upward climb.\n- thrustAccelFactor: 0.12-0.35 for extra upward push while held.\n- jumpAssistAccelFactor: 0.08-0.22 to slightly extend jump when thrust starts mid-air.\n- rampUpTime: 0.25-0.60 for smoother spool-up.\n- rampDownTime: 0.15-0.40 for natural release dropoff.\n- minHoldToLift: 0.15-0.30 to require commitment before ascent.\n- liftThresholdSpeed: 30-80 so lift can start once fall is mostly canceled.\n- maxUpSpeed: keep low (about 20-40% of jump velocity).\n- momentumBoostSpeed / activationKickSpeed: increase for stronger mid-air activation momentum.\n- maxAccel / maxThrustAccel / brakeDecelMax: lower values feel heavier and less snappy.\n*/\n\n// Keeps legacy world map available for fallback/debug.\nPlatformer.DEBUG_WORLD_MAP = false;\nPlatformer.DEBUG_JETPACK = false;\n","window.Platformer = window.Platformer || {};\n\n// Auto-generated by scripts/write_build_info.py during packaging.\nPlatformer.BUILD_VERSION = \"2026.02.16.1338\";\nPlatformer.BUILD_TIME_UTC = \"2026-02-16T13:38:30.453739Z\";\nPlatformer.BUILD_UPDATE_REPO = \"zyynx-hub/Platformer\";\nPlatformer.BUILD_UPDATE_CHANNEL = \"stable\";\nPlatformer.BUILD_UPDATE_ENABLED = true;\nPlatformer.BUILD_DEBUG = false;\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.DEFAULT_SETTINGS = {\n  settingsVersion: 6,\n  gameplay: {\n    difficulty: \"normal\",\n  },\n  controls: {\n    left: \"A\",\n    right: \"D\",\n    jump: \"W\",\n    dash: \"SHIFT\",\n    attack: \"J\",\n    interact: \"E\",\n    pause: \"ESC\",\n  },\n  accessibility: {\n    textSize: \"medium\",\n    colorblindMode: \"off\",\n    reduceScreenShake: 50,\n    reducedMotion: false,\n    flashReduction: false,\n    subtitles: true,\n    audioCues: true,\n  },\n  video: {\n    fullscreen: false,\n    displayMode: \"windowed\",\n    resolutionPreset: \"1920x1080\",\n    resolutionScale: 100,\n    pixelPerfect: true,\n    vsync: true,\n    fpsCap: \"60\",\n    cameraSmoothing: 35,\n    brightness: 1.0,\n  },\n  audio: {\n    master: 80,\n    music: 60,\n    sfx: 85,\n    ui: 70,\n    dynamicRange: \"normal\",\n    muteWhenUnfocused: false,\n  },\n  convenience: {\n    autoSave: true,\n    checkpointFrequency: \"standard\",\n    speedrunMode: false,\n    introSeen: false,\n  },\n  updates: {\n    enabled: true,\n    autoUpdate: true,\n    currentVersion: \"1.0.0\",\n    source: \"GitHub Releases\",\n    manifestUrl: \"\",\n    downloadUrl: \"\",\n  },\n  debug: {\n    hitboxesEnabled: false,\n    playerHitbox: { w: 9, h: 24, ox: 0, oy: -3 },\n  },\n};\n\nPlatformer.deepClone = function deepClone(obj) {\n  return JSON.parse(JSON.stringify(obj));\n};\n\nPlatformer.deepMerge = function deepMerge(base, incoming) {\n  const out = Platformer.deepClone(base);\n  const mergeInto = (target, source) => {\n    if (!source || typeof source !== \"object\") return;\n    Object.keys(source).forEach((key) => {\n      const src = source[key];\n      if (src && typeof src === \"object\" && !Array.isArray(src)) {\n        if (!target[key] || typeof target[key] !== \"object\") {\n          target[key] = {};\n        }\n        mergeInto(target[key], src);\n      } else {\n        target[key] = src;\n      }\n    });\n  };\n  mergeInto(out, incoming);\n  return out;\n};\n\nPlatformer.Settings = {\n  key: \"anime_platformer_settings_v2\",\n  legacyKeys: [\"anime_platformer_settings_v1\"],\n  prefix: \"anime_platformer_settings_\",\n  current: Platformer.deepClone(Platformer.DEFAULT_SETTINGS),\n  _bootstrapped: false,\n\n  waitForBridgeReady(timeoutMs = 2500) {\n    return new Promise((resolve) => {\n      const isReady = () => !!(window.pywebview && window.pywebview.api);\n      if (isReady()) {\n        resolve(true);\n        return;\n      }\n      let done = false;\n      const finish = (ok) => {\n        if (done) return;\n        done = true;\n        try { window.removeEventListener(\"pywebviewready\", onReady); } catch (_e) {}\n        clearInterval(timer);\n        clearTimeout(expire);\n        resolve(ok);\n      };\n      const onReady = () => finish(true);\n      try { window.addEventListener(\"pywebviewready\", onReady, { once: true }); } catch (_e) {}\n      const timer = setInterval(() => {\n        if (isReady()) finish(true);\n      }, 100);\n      const expire = setTimeout(() => finish(isReady()), Math.max(200, Number(timeoutMs) || 2500));\n    });\n  },\n\n  migrate(parsed) {\n    const input = parsed && typeof parsed === \"object\" ? Platformer.deepClone(parsed) : {};\n    const ver = Number(input.settingsVersion || 1);\n    const out = input;\n\n    if (ver < 2) {\n      // v2: deprecate player-editable update URLs and lock source label.\n      if (!out.updates || typeof out.updates !== \"object\") out.updates = {};\n      out.updates.source = \"GitHub Releases\";\n      out.updates.manifestUrl = \"\";\n      out.updates.downloadUrl = \"\";\n      out.settingsVersion = 2;\n    }\n    if (ver < 3) {\n      if (!out.video || typeof out.video !== \"object\") out.video = {};\n      if (!out.video.displayMode) {\n        out.video.displayMode = out.video.fullscreen ? \"fullscreen\" : \"windowed\";\n      }\n      out.settingsVersion = 3;\n    }\n    if (ver < 4) {\n      if (!out.video || typeof out.video !== \"object\") out.video = {};\n      if (!out.video.resolutionPreset) out.video.resolutionPreset = \"1920x1080\";\n      out.settingsVersion = 4;\n    }\n    if (ver < 5) {\n      if (!out.debug || typeof out.debug !== \"object\") out.debug = {};\n      if (!out.debug.playerHitbox || typeof out.debug.playerHitbox !== \"object\") {\n        out.debug.playerHitbox = { w: 9, h: 24, ox: 0, oy: -3 };\n      }\n      if (typeof out.debug.hitboxesEnabled !== \"boolean\") out.debug.hitboxesEnabled = false;\n      out.settingsVersion = 5;\n    }\n    if (ver < 6) {\n      if (!out.debug || typeof out.debug !== \"object\") out.debug = {};\n      // New global standard hitbox for all installs.\n      out.debug.playerHitbox = { w: 9, h: 24, ox: 0, oy: -3 };\n      if (typeof out.debug.hitboxesEnabled !== \"boolean\") out.debug.hitboxesEnabled = false;\n      out.settingsVersion = 6;\n    }\n    out.settingsVersion = 6;\n    return out;\n  },\n\n  archiveLegacySnapshot(raw) {\n    if (!raw || !window.indexedDB) return;\n    try {\n      const req = window.indexedDB.open(\"anime_platformer_archive\", 1);\n      req.onupgradeneeded = (e) => {\n        const db = e.target.result;\n        if (!db.objectStoreNames.contains(\"settings\")) {\n          db.createObjectStore(\"settings\", { keyPath: \"id\", autoIncrement: true });\n        }\n      };\n      req.onsuccess = () => {\n        try {\n          const db = req.result;\n          const tx = db.transaction(\"settings\", \"readwrite\");\n          tx.objectStore(\"settings\").add({ at: Date.now(), payload: String(raw).slice(0, 2048) });\n          tx.oncomplete = () => db.close();\n          tx.onerror = () => db.close();\n        } catch (_e) {\n          // best effort\n        }\n      };\n    } catch (_e) {\n      // best effort\n    }\n  },\n\n  cleanupObsoleteStorage() {\n    try {\n      const keep = new Set([this.key, ...this.legacyKeys]);\n      Object.keys(localStorage).forEach((k) => {\n        if (k && k.startsWith(this.prefix) && !keep.has(k)) {\n          localStorage.removeItem(k);\n        }\n      });\n    } catch (_e) {\n      // ignore\n    }\n  },\n\n  load() {\n    try {\n      const buildVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      const buildUpdateEnabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n      let raw = localStorage.getItem(this.key);\n      if (!raw) {\n        for (const legacy of this.legacyKeys) {\n          raw = localStorage.getItem(legacy);\n          if (raw) break;\n        }\n      }\n      if (!raw) {\n        this.current = Platformer.deepClone(Platformer.DEFAULT_SETTINGS);\n        this.current.updates.currentVersion = buildVersion;\n        this.current.updates.enabled = buildUpdateEnabled;\n        this.current.updates.source = \"GitHub Releases\";\n        return this.current;\n      }\n      this.archiveLegacySnapshot(raw);\n      const parsed = this.migrate(JSON.parse(raw));\n      this.current = Platformer.deepMerge(Platformer.DEFAULT_SETTINGS, parsed);\n      // Session-only flag: always reset on full page refresh.\n      this.current.convenience.introSeen = false;\n      // Always bind current version to packaged build, not stale localStorage.\n      this.current.updates.currentVersion = buildVersion;\n      // Build config is authoritative for whether updates are enabled.\n      this.current.updates.enabled = buildUpdateEnabled;\n      this.current.updates.source = \"GitHub Releases\";\n      this.cleanupObsoleteStorage();\n      this.persistLocal();\n      return this.current;\n    } catch (_e) {\n      const buildVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      const buildUpdateEnabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n      this.current = Platformer.deepClone(Platformer.DEFAULT_SETTINGS);\n      this.current.convenience.introSeen = false;\n      this.current.updates.currentVersion = buildVersion;\n      this.current.updates.enabled = buildUpdateEnabled;\n      this.current.updates.source = \"GitHub Releases\";\n      return this.current;\n    }\n  },\n\n  persistLocal() {\n    // Do not persist introSeen; keep it session-only.\n    const toSave = Platformer.deepClone(this.current);\n    toSave.convenience.introSeen = false;\n    toSave.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n    toSave.updates.source = \"GitHub Releases\";\n    // Legacy player-editable URLs are intentionally not persisted anymore.\n    toSave.updates.manifestUrl = \"\";\n    toSave.updates.downloadUrl = \"\";\n    this.current.updates.currentVersion = toSave.updates.currentVersion;\n    this.current.updates.source = toSave.updates.source;\n    this.current.updates.manifestUrl = \"\";\n    this.current.updates.downloadUrl = \"\";\n    const compact = JSON.stringify(toSave);\n    localStorage.setItem(this.key, compact);\n    this.legacyKeys.forEach((k) => localStorage.removeItem(k));\n    this.cleanupObsoleteStorage();\n  },\n\n  async save() {\n    this.persistLocal();\n    await this.persistHost();\n  },\n\n  async persistHost() {\n    try {\n      await this.waitForBridgeReady(2000);\n      if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.write_settings_blob === \"function\")) {\n        return;\n      }\n      const payload = JSON.stringify(this.current);\n      const res = await window.pywebview.api.write_settings_blob(payload);\n      if (Platformer.Debug && (!res || !res.ok)) {\n        Platformer.Debug.warn(\"Settings.host\", (res && res.message) || \"Failed writing host settings.\");\n      }\n    } catch (e) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"Settings.host\", `write failed: ${e && e.message ? e.message : e}`);\n    }\n  },\n\n  async bootstrap() {\n    this.load();\n    if (this._bootstrapped) return this.current;\n    this._bootstrapped = true;\n    try {\n      await this.waitForBridgeReady(3000);\n      if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.read_settings_blob === \"function\")) {\n        return this.current;\n      }\n      const res = await window.pywebview.api.read_settings_blob();\n      if (!res || !res.ok || !res.data) return this.current;\n      const parsed = this.migrate(JSON.parse(String(res.data)));\n      this.current = Platformer.deepMerge(Platformer.DEFAULT_SETTINGS, parsed);\n      this.current.convenience.introSeen = false;\n      this.current.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      this.current.updates.enabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n      this.current.updates.source = \"GitHub Releases\";\n      this.persistLocal();\n      if (Platformer.Debug) Platformer.Debug.log(\"Settings.host\", \"Loaded persisted settings from desktop host.\");\n    } catch (e) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"Settings.host\", `bootstrap failed: ${e && e.message ? e.message : e}`);\n    }\n    return this.current;\n  },\n\n  reset() {\n    this.current = Platformer.deepClone(Platformer.DEFAULT_SETTINGS);\n    this.current.convenience.introSeen = false;\n    this.current.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n    this.current.updates.enabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n    this.current.updates.source = \"GitHub Releases\";\n    this.current.updates.manifestUrl = \"\";\n    this.current.updates.downloadUrl = \"\";\n    this.save();\n    return this.current;\n  },\n\n  textScale() {\n    const size = this.current.accessibility.textSize;\n    if (size === \"small\") return 0.9;\n    if (size === \"large\") return 1.2;\n    return 1;\n  },\n};\n\nPlatformer.Settings.load();\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.Debug = {\n  initialized: false,\n  enabled: false,\n  lines: [],\n  maxLines: 300,\n  panel: null,\n  logEl: null,\n  statusEl: null,\n  copyBtn: null,\n  latestErrorBlock: \"\",\n  _monitorsAttached: false,\n  _nativeLogInFlight: 0,\n  _nativeLogDropped: 0,\n  _lastMismatchKey: \"\",\n  _lastMismatchAt: 0,\n  hitboxesEnabled: false,\n  playerHitboxProfile: { w: 9, h: 24, ox: 0, oy: -3 },\n\n  init() {\n    if (this.initialized) return;\n    this.initialized = true;\n    this.enabled = true;\n    const settingsDebug = (Platformer.Settings && Platformer.Settings.current && Platformer.Settings.current.debug) || null;\n    if (settingsDebug) {\n      this.hitboxesEnabled = !!settingsDebug.hitboxesEnabled;\n      this.playerHitboxProfile = {\n        w: this.clampNum(settingsDebug.playerHitbox && settingsDebug.playerHitbox.w, 4, 64, 9),\n        h: this.clampNum(settingsDebug.playerHitbox && settingsDebug.playerHitbox.h, 4, 64, 24),\n        ox: this.clampNum(settingsDebug.playerHitbox && settingsDebug.playerHitbox.ox, -24, 24, 0),\n        oy: this.clampNum(settingsDebug.playerHitbox && settingsDebug.playerHitbox.oy, -24, 24, -3),\n      };\n    } else {\n      try {\n        this.hitboxesEnabled = localStorage.getItem(\"platformer_hitboxes_enabled\") === \"1\";\n      } catch (_e) {\n        this.hitboxesEnabled = false;\n      }\n      this.loadPlayerHitboxProfile();\n    }\n\n    const root = document.createElement(\"div\");\n    root.style.position = \"fixed\";\n    root.style.right = \"12px\";\n    root.style.bottom = \"12px\";\n    root.style.zIndex = \"999999\";\n    root.style.fontFamily = \"Consolas, monospace\";\n\n    const toggle = document.createElement(\"button\");\n    toggle.textContent = \"DEBUG\";\n    toggle.style.padding = \"8px 10px\";\n    toggle.style.background = \"#111827\";\n    toggle.style.color = \"#e5e7eb\";\n    toggle.style.border = \"1px solid #374151\";\n    toggle.style.cursor = \"pointer\";\n    toggle.style.borderRadius = \"6px\";\n\n    const panel = document.createElement(\"div\");\n    panel.style.display = \"none\";\n    panel.style.marginTop = \"8px\";\n    panel.style.width = \"min(920px, 92vw)\";\n    panel.style.height = \"min(46vh, 420px)\";\n    panel.style.background = \"rgba(0,0,0,0.92)\";\n    panel.style.color = \"#86efac\";\n    panel.style.border = \"1px solid #374151\";\n    panel.style.borderRadius = \"8px\";\n    panel.style.padding = \"10px\";\n    panel.style.boxSizing = \"border-box\";\n    panel.style.display = \"none\";\n\n    const topBar = document.createElement(\"div\");\n    topBar.style.display = \"flex\";\n    topBar.style.justifyContent = \"space-between\";\n    topBar.style.alignItems = \"center\";\n    topBar.style.marginBottom = \"8px\";\n\n    const title = document.createElement(\"div\");\n    title.textContent = \"Runtime Debug Console\";\n    title.style.color = \"#f9fafb\";\n\n    const right = document.createElement(\"div\");\n    right.style.display = \"flex\";\n    right.style.gap = \"8px\";\n\n    const copyBtn = document.createElement(\"button\");\n    copyBtn.textContent = \"Copy latest error\";\n    copyBtn.style.padding = \"6px 8px\";\n    copyBtn.style.background = \"#1f2937\";\n    copyBtn.style.color = \"#f9fafb\";\n    copyBtn.style.border = \"1px solid #4b5563\";\n    copyBtn.style.cursor = \"pointer\";\n\n    const clearBtn = document.createElement(\"button\");\n    clearBtn.textContent = \"Clear\";\n    clearBtn.style.padding = \"6px 8px\";\n    clearBtn.style.background = \"#1f2937\";\n    clearBtn.style.color = \"#f9fafb\";\n    clearBtn.style.border = \"1px solid #4b5563\";\n    clearBtn.style.cursor = \"pointer\";\n\n    const hitboxBtn = document.createElement(\"button\");\n    hitboxBtn.style.padding = \"6px 8px\";\n    hitboxBtn.style.background = \"#1f2937\";\n    hitboxBtn.style.color = \"#f9fafb\";\n    hitboxBtn.style.border = \"1px solid #4b5563\";\n    hitboxBtn.style.cursor = \"pointer\";\n    const refreshHitboxBtn = () => {\n      hitboxBtn.textContent = this.hitboxesEnabled ? \"Hitboxes: On\" : \"Hitboxes: Off\";\n    };\n    refreshHitboxBtn();\n    const makeMini = (label) => {\n      const b = document.createElement(\"button\");\n      b.textContent = label;\n      b.style.padding = \"4px 6px\";\n      b.style.background = \"#111827\";\n      b.style.color = \"#cbd5e1\";\n      b.style.border = \"1px solid #334155\";\n      b.style.cursor = \"pointer\";\n      b.style.fontSize = \"11px\";\n      return b;\n    };\n    const hbInfo = document.createElement(\"div\");\n    hbInfo.style.color = \"#93c5fd\";\n    hbInfo.style.fontSize = \"11px\";\n    hbInfo.style.marginBottom = \"6px\";\n    const hbRow = document.createElement(\"div\");\n    hbRow.style.display = \"flex\";\n    hbRow.style.flexWrap = \"wrap\";\n    hbRow.style.gap = \"4px\";\n    hbRow.style.marginBottom = \"8px\";\n    const hbWm = makeMini(\"W-\");\n    const hbWp = makeMini(\"W+\");\n    const hbHm = makeMini(\"H-\");\n    const hbHp = makeMini(\"H+\");\n    const hbXm = makeMini(\"X-\");\n    const hbXp = makeMini(\"X+\");\n    const hbYm = makeMini(\"Y-\");\n    const hbYp = makeMini(\"Y+\");\n    const hbReset = makeMini(\"HB Reset\");\n    const refreshHbInfo = () => {\n      const p = this.playerHitboxProfile;\n      hbInfo.textContent = `Player HB w=${p.w} h=${p.h} ox=${p.ox} oy=${p.oy}`;\n    };\n    refreshHbInfo();\n\n    right.appendChild(hitboxBtn);\n    right.appendChild(copyBtn);\n    right.appendChild(clearBtn);\n\n    topBar.appendChild(title);\n    topBar.appendChild(right);\n\n    const status = document.createElement(\"div\");\n    status.style.marginBottom = \"6px\";\n    status.style.color = \"#93c5fd\";\n    status.textContent = \"No errors yet.\";\n\n    const log = document.createElement(\"pre\");\n    log.style.margin = \"0\";\n    log.style.height = \"calc(100% - 58px)\";\n    log.style.overflow = \"auto\";\n    log.style.whiteSpace = \"pre-wrap\";\n    log.style.fontSize = \"12px\";\n    log.style.lineHeight = \"1.32\";\n    log.textContent = \"Debug console ready.\\n\";\n\n    panel.appendChild(topBar);\n    panel.appendChild(status);\n    panel.appendChild(hbInfo);\n    panel.appendChild(hbRow);\n    panel.appendChild(log);\n    root.appendChild(toggle);\n    root.appendChild(panel);\n    document.body.appendChild(root);\n\n    toggle.addEventListener(\"click\", () => {\n      panel.style.display = panel.style.display === \"none\" ? \"block\" : \"none\";\n    });\n    window.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"F1\") {\n        e.preventDefault();\n        panel.style.display = panel.style.display === \"none\" ? \"block\" : \"none\";\n      }\n    });\n\n    clearBtn.addEventListener(\"click\", () => {\n      this.lines = [];\n      log.textContent = \"\";\n      status.textContent = \"Cleared.\";\n    });\n\n    hitboxBtn.addEventListener(\"click\", () => {\n      this.setHitboxesEnabled(!this.hitboxesEnabled);\n      refreshHitboxBtn();\n      status.textContent = `Hitbox overlay ${this.hitboxesEnabled ? \"enabled\" : \"disabled\"}.`;\n      status.style.color = \"#93c5fd\";\n    });\n    const bumpHb = (key, delta, min, max) => {\n      const p = { ...this.playerHitboxProfile };\n      p[key] = Math.max(min, Math.min(max, p[key] + delta));\n      this.setPlayerHitboxProfile(p);\n      refreshHbInfo();\n      status.textContent = \"Player hitbox updated.\";\n      status.style.color = \"#93c5fd\";\n    };\n    hbWm.addEventListener(\"click\", () => bumpHb(\"w\", -1, 4, 64));\n    hbWp.addEventListener(\"click\", () => bumpHb(\"w\", 1, 4, 64));\n    hbHm.addEventListener(\"click\", () => bumpHb(\"h\", -1, 4, 64));\n    hbHp.addEventListener(\"click\", () => bumpHb(\"h\", 1, 4, 64));\n    hbXm.addEventListener(\"click\", () => bumpHb(\"ox\", -1, -24, 24));\n    hbXp.addEventListener(\"click\", () => bumpHb(\"ox\", 1, -24, 24));\n    hbYm.addEventListener(\"click\", () => bumpHb(\"oy\", -1, -24, 24));\n    hbYp.addEventListener(\"click\", () => bumpHb(\"oy\", 1, -24, 24));\n    hbReset.addEventListener(\"click\", () => {\n      this.setPlayerHitboxProfile({ w: 9, h: 24, ox: 0, oy: -3 });\n      refreshHbInfo();\n      status.textContent = \"Player hitbox reset.\";\n      status.style.color = \"#93c5fd\";\n    });\n    [hbWm, hbWp, hbHm, hbHp, hbXm, hbXp, hbYm, hbYp, hbReset].forEach((b) => hbRow.appendChild(b));\n\n    copyBtn.addEventListener(\"click\", async () => {\n      const text = this.latestErrorBlock || \"No captured error block yet.\";\n      try {\n        await navigator.clipboard.writeText(text);\n        status.textContent = \"Latest error copied to clipboard.\";\n      } catch (_e) {\n        status.textContent = \"Copy failed. Select text manually from logs.\";\n      }\n    });\n\n    this.panel = panel;\n    this.logEl = log;\n    this.statusEl = status;\n    this.copyBtn = copyBtn;\n\n    window.addEventListener(\"error\", (event) => {\n      // Resource load failures (scripts, audio, images) come through error events too.\n      if (event && event.target && event.target !== window) {\n        const t = event.target;\n        const tag = t.tagName || \"UNKNOWN\";\n        const src = t.src || t.href || \"(no src/href)\";\n        this.error(\"resource.error\", `TAG: ${tag}\\nSOURCE: ${src}`);\n        return;\n      }\n\n      const msg = event.message || \"Unknown window error\";\n      const file = event.filename || \"(no filename)\";\n      const line = event.lineno || 0;\n      const col = event.colno || 0;\n      const stack = event.error && event.error.stack ? event.error.stack : \"(no stack)\";\n      this.error(\"window.onerror\", `MESSAGE: ${msg}\\nFILE: ${file}:${line}:${col}\\n${stack}`);\n    }, true);\n\n    window.addEventListener(\"unhandledrejection\", (event) => {\n      const reason = event.reason;\n      const msg = reason && reason.message ? reason.message : String(reason);\n      const stack = reason && reason.stack ? reason.stack : \"(no stack)\";\n      this.error(\"unhandledrejection\", `${msg}\\n${stack}`);\n    });\n\n    this.patchConsole();\n  },\n\n  patchConsole() {\n    if (console.__platformerDebugPatched) return;\n    console.__platformerDebugPatched = true;\n\n    const origLog = console.log.bind(console);\n    const origWarn = console.warn.bind(console);\n    const origErr = console.error.bind(console);\n\n    console.log = (...args) => {\n      this.log(\"console.log\", this.stringifyArgs(args));\n      origLog(...args);\n    };\n    console.warn = (...args) => {\n      this.warn(\"console.warn\", this.stringifyArgs(args));\n      origWarn(...args);\n    };\n    console.error = (...args) => {\n      this.error(\"console.error\", this.stringifyArgs(args));\n      origErr(...args);\n    };\n  },\n\n  stringifyArgs(args) {\n    return args.map((a) => {\n      if (typeof a === \"string\") return a;\n      try {\n        return JSON.stringify(a);\n      } catch (_e) {\n        return String(a);\n      }\n    }).join(\" \");\n  },\n\n  timestamp() {\n    return new Date().toISOString().slice(11, 19);\n  },\n\n  append(type, label, message) {\n    if (!this.enabled) return;\n    const line = `[${this.timestamp()}] [${type}] ${label}: ${message}`;\n    this.lines.push(line);\n    if (this.lines.length > this.maxLines) {\n      this.lines.shift();\n    }\n    if (this.logEl) {\n      this.logEl.textContent = this.lines.join(\"\\n\");\n      this.logEl.scrollTop = this.logEl.scrollHeight;\n    }\n    this.forwardToNativeConsole(type, label, message);\n  },\n\n  forwardToNativeConsole(type, label, message) {\n    try {\n      if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.log_event === \"function\")) {\n        return;\n      }\n      // Avoid flooding host bridge on high-frequency logs.\n      if (this._nativeLogInFlight > 10) {\n        this._nativeLogDropped += 1;\n        if (this._nativeLogDropped % 25 === 0) {\n          window.pywebview.api.log_event(\"WARN\", \"DebugBridge\", `Dropped ${this._nativeLogDropped} log lines (bridge saturated)`).catch(() => {});\n        }\n        return;\n      }\n      this._nativeLogInFlight += 1;\n      window.pywebview.api.log_event(type, label, String(message)).catch(() => {})\n        .finally(() => {\n          this._nativeLogInFlight = Math.max(0, this._nativeLogInFlight - 1);\n        });\n    } catch (_e) {\n      // best effort\n    }\n  },\n\n  log(label, message) {\n    this.append(\"INFO\", label, message);\n  },\n\n  warn(label, message) {\n    this.append(\"WARN\", label, message);\n  },\n\n  error(label, message) {\n    this.append(\"ERROR\", label, message);\n    this.latestErrorBlock = [\n      \"=== COPY_THIS_TO_ASSISTANT ===\",\n      `TIME: ${new Date().toISOString()}`,\n      `SOURCE: ${label}`,\n      \"DETAILS:\",\n      message,\n      \"=== END_COPY ===\",\n    ].join(\"\\n\");\n    if (this.statusEl) {\n      this.statusEl.textContent = \"Error captured. Click 'Copy latest error'.\";\n      this.statusEl.style.color = \"#fca5a5\";\n    }\n  },\n\n  attachGameMonitors(game) {\n    if (!this.enabled) return;\n    if (this._monitorsAttached || !game) return;\n    this._monitorsAttached = true;\n\n    try {\n      const sm = game.scene && game.scene.events ? game.scene.events : null;\n      if (sm) {\n        const sceneEvent = (name) => (scene) => {\n          const key = scene && scene.scene && scene.scene.key ? scene.scene.key : \"unknown\";\n          this.log(\"Scene\", `${name}: ${key}`);\n        };\n        sm.on(\"start\", sceneEvent(\"start\"));\n        sm.on(\"ready\", sceneEvent(\"ready\"));\n        sm.on(\"pause\", sceneEvent(\"pause\"));\n        sm.on(\"resume\", sceneEvent(\"resume\"));\n        sm.on(\"sleep\", sceneEvent(\"sleep\"));\n        sm.on(\"wake\", sceneEvent(\"wake\"));\n        sm.on(\"shutdown\", sceneEvent(\"shutdown\"));\n        sm.on(\"destroy\", sceneEvent(\"destroy\"));\n      }\n    } catch (e) {\n      this.warn(\"Debug.attachGameMonitors\", `Scene monitor attach failed: ${e && e.message ? e.message : e}`);\n    }\n\n    try {\n      if (game.scale && game.scale.on) {\n        game.scale.on(\"resize\", (sz) => {\n          this.log(\"Scale.resize\", `${Math.round(sz.width)}x${Math.round(sz.height)}`);\n        });\n      }\n    } catch (e) {\n      this.warn(\"Debug.attachGameMonitors\", `Scale monitor attach failed: ${e && e.message ? e.message : e}`);\n    }\n\n    try {\n      document.addEventListener(\"visibilitychange\", () => {\n        this.log(\"Visibility\", document.hidden ? \"hidden\" : \"visible\");\n      });\n    } catch (_e) {\n      // best effort\n    }\n\n    // Detect black bars / stale canvas sizing (common in desktop wrappers).\n    setInterval(() => {\n      try {\n        if (!game.canvas) return;\n        const root = document.getElementById(\"game-root\");\n        const vw = (root && root.clientWidth) || (document.documentElement && document.documentElement.clientWidth) || window.innerWidth || 0;\n        const vh = (root && root.clientHeight) || (document.documentElement && document.documentElement.clientHeight) || window.innerHeight || 0;\n        const cw = game.canvas.clientWidth || game.canvas.width || 0;\n        const ch = game.canvas.clientHeight || game.canvas.height || 0;\n        const dx = Math.abs(cw - vw);\n        const dy = Math.abs(ch - vh);\n        if (dx > 8 || dy > 8) {\n          const now = Date.now();\n          const key = `${vw}x${vh}|${cw}x${ch}`;\n          if (key !== this._lastMismatchKey || now - this._lastMismatchAt > 5000) {\n            this._lastMismatchKey = key;\n            this._lastMismatchAt = now;\n            this.warn(\"ViewportMismatch\", `viewport=${vw}x${vh} canvas=${cw}x${ch} (dx=${dx},dy=${dy})`);\n          }\n        }\n      } catch (_e) {\n        // best effort\n      }\n    }, 1200);\n  },\n\n  safe(label, fn, ctx, args) {\n    if (!this.enabled) {\n      return fn.apply(ctx, args || []);\n    }\n    try {\n      return fn.apply(ctx, args || []);\n    } catch (err) {\n      const stack = err && err.stack ? err.stack : String(err);\n      this.error(label, stack);\n      return undefined;\n    }\n  },\n\n  setHitboxesEnabled(enabled) {\n    this.hitboxesEnabled = !!enabled;\n    if (Platformer.Settings && Platformer.Settings.current) {\n      Platformer.Settings.current.debug = Platformer.Settings.current.debug || {};\n      Platformer.Settings.current.debug.hitboxesEnabled = this.hitboxesEnabled;\n      Platformer.Settings.save();\n    } else {\n      try {\n        localStorage.setItem(\"platformer_hitboxes_enabled\", this.hitboxesEnabled ? \"1\" : \"0\");\n      } catch (_e) {\n        // best effort\n      }\n    }\n    try {\n      window.dispatchEvent(new CustomEvent(\"platformer:hitboxes-toggle\", { detail: { enabled: this.hitboxesEnabled } }));\n    } catch (_e) {\n      // best effort\n    }\n    this.log(\"Debug.hitboxes\", `Hitboxes ${this.hitboxesEnabled ? \"ON\" : \"OFF\"}`);\n  },\n\n  loadPlayerHitboxProfile() {\n    try {\n      const raw = localStorage.getItem(\"platformer_player_hitbox\");\n      if (!raw) return;\n      const p = JSON.parse(raw);\n      this.playerHitboxProfile = {\n        w: this.clampNum(p.w, 4, 64, 9),\n        h: this.clampNum(p.h, 4, 64, 24),\n        ox: this.clampNum(p.ox, -24, 24, 0),\n        oy: this.clampNum(p.oy, -24, 24, -3),\n      };\n    } catch (_e) {\n      // best effort\n    }\n  },\n\n  setPlayerHitboxProfile(profile) {\n    this.playerHitboxProfile = {\n      w: this.clampNum(profile.w, 4, 64, 9),\n      h: this.clampNum(profile.h, 4, 64, 24),\n      ox: this.clampNum(profile.ox, -24, 24, 0),\n      oy: this.clampNum(profile.oy, -24, 24, -3),\n    };\n    if (Platformer.Settings && Platformer.Settings.current) {\n      Platformer.Settings.current.debug = Platformer.Settings.current.debug || {};\n      Platformer.Settings.current.debug.playerHitbox = { ...this.playerHitboxProfile };\n      Platformer.Settings.save();\n    } else {\n      try {\n        localStorage.setItem(\"platformer_player_hitbox\", JSON.stringify(this.playerHitboxProfile));\n      } catch (_e) {\n        // best effort\n      }\n    }\n    try {\n      window.dispatchEvent(new CustomEvent(\"platformer:player-hitbox-changed\", { detail: { ...this.playerHitboxProfile } }));\n    } catch (_e) {\n      // best effort\n    }\n    this.log(\"Debug.hitboxProfile\", `w=${this.playerHitboxProfile.w} h=${this.playerHitboxProfile.h} ox=${this.playerHitboxProfile.ox} oy=${this.playerHitboxProfile.oy}`);\n  },\n\n  getPlayerHitboxProfile() {\n    return { ...this.playerHitboxProfile };\n  },\n\n  clampNum(v, min, max, fallback) {\n    const n = Number(v);\n    if (!Number.isFinite(n)) return fallback;\n    return Math.max(min, Math.min(max, n));\n  },\n};\n\nPlatformer.wrapSceneSafety = function wrapSceneSafety(SceneClass, sceneName) {\n  if (!SceneClass || SceneClass.__safeWrapped) return SceneClass;\n\n  class SafeScene extends SceneClass {\n    preload(...args) {\n      const fn = SceneClass.prototype.preload;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.preload`, fn, this, args);\n    }\n\n    init(...args) {\n      const fn = SceneClass.prototype.init;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.init`, fn, this, args);\n    }\n\n    create(...args) {\n      const fn = SceneClass.prototype.create;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.create`, fn, this, args);\n    }\n\n    update(...args) {\n      const fn = SceneClass.prototype.update;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.update`, fn, this, args);\n    }\n\n    shutdown(...args) {\n      const fn = SceneClass.prototype.shutdown;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.shutdown`, fn, this, args);\n    }\n  }\n\n  SafeScene.__safeWrapped = true;\n  return SafeScene;\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.Updater = {\n  resolveSource() {\n    const cfg = Platformer.Settings.current.updates || {};\n    const defaultRepo = \"zyynx-hub/Platformer\";\n    const buildRepo = String(Platformer.BUILD_UPDATE_REPO || \"\").trim().replace(/^\\/+|\\/+$/g, \"\");\n    const buildChannel = String(Platformer.BUILD_UPDATE_CHANNEL || \"stable\").trim() || \"stable\";\n    const buildEnabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n    const repo = buildRepo || defaultRepo;\n    return {\n      enabled: buildEnabled && cfg.enabled !== false,\n      kind: \"github\",\n      repo,\n      channel: buildChannel,\n      currentVersion: cfg.currentVersion || \"0.0.0\",\n      fallbackDownloadUrl: cfg.downloadUrl || \"\",\n    };\n  },\n\n  friendlyError(message) {\n    const raw = String(message || \"\").toLowerCase();\n    if (!raw) return \"Update check failed.\";\n    if (raw.includes(\"no public release\")) {\n      return \"No public release found yet.\";\n    }\n    if (raw.includes(\"winerror 87\") || raw.includes(\"parameter is incorrect\")) {\n      return \"Network/proxy config issue. Retry or disable proxy/VPN.\";\n    }\n    if (raw.includes(\"timed out\") || raw.includes(\"network\") || raw.includes(\"offline\") || raw.includes(\"failed to fetch\")) {\n      return \"Offline, retrying later.\";\n    }\n    if (raw.includes(\"rate limit\") || raw.includes(\"403\")) {\n      return \"Update server busy, try later.\";\n    }\n    if (raw.includes(\"404\")) {\n      return \"No public release found yet.\";\n    }\n    return \"Can't reach update server.\";\n  },\n\n  wait(ms) {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  },\n\n  compareVersions(a, b) {\n    const norm = (v) => String(v || \"0\")\n      .split(\".\")\n      .map((p) => parseInt(p, 10))\n      .map((n) => (Number.isFinite(n) ? n : 0));\n\n    const aa = norm(a);\n    const bb = norm(b);\n    const len = Math.max(aa.length, bb.length);\n    for (let i = 0; i < len; i += 1) {\n      const av = aa[i] || 0;\n      const bv = bb[i] || 0;\n      if (av > bv) return 1;\n      if (av < bv) return -1;\n    }\n    return 0;\n  },\n\n  async check() {\n    const source = this.resolveSource();\n    if (!source.enabled) {\n      return { ok: true, enabled: false, message: \"Auto updates are off.\" };\n    }\n\n    if (source.kind === \"github\" && window.pywebview && window.pywebview.api) {\n      if (typeof window.pywebview.api.check_update_github !== \"function\") {\n        return { ok: false, enabled: true, transient: true, message: \"Update bridge not ready yet.\" };\n      }\n      try {\n        const res = await window.pywebview.api.check_update_github(\n          source.repo,\n          source.currentVersion,\n          source.channel,\n        );\n        if (res && res.ok) {\n          const hasUpdate = !!res.hasUpdate;\n          const downloadUrl = res.downloadUrl || source.fallbackDownloadUrl || \"\";\n          if (hasUpdate && !downloadUrl) {\n            return {\n              ok: false,\n              enabled: true,\n              transient: true,\n              latestVersion: res.latestVersion || source.currentVersion,\n              releaseNotes: res.releaseNotes || \"\",\n              releasePublishedAt: res.releasePublishedAt || \"\",\n              message: \"Update found, but package is not published yet. Retry in a moment.\",\n            };\n          }\n          return {\n            ok: true,\n            enabled: true,\n            hasUpdate,\n            latestVersion: res.latestVersion || source.currentVersion,\n            downloadUrl,\n            checksumSha256: res.checksumSha256 || \"\",\n            releaseNotes: res.releaseNotes || \"\",\n            releasePublishedAt: res.releasePublishedAt || \"\",\n            message: res.message || (hasUpdate ? \"Update found.\" : \"You're up to date.\"),\n          };\n        }\n        return {\n          ok: false,\n          enabled: true,\n          message: this.friendlyError((res && res.message) || \"Can't reach update server.\"),\n        };\n      } catch (e) {\n        return { ok: false, enabled: true, message: this.friendlyError(e && e.message ? e.message : e) };\n      }\n    }\n\n    return { ok: false, enabled: true, message: \"Update service not ready in this runtime.\" };\n  },\n\n  openDownload(url) {\n    if (!url) return false;\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.open_url === \"function\") {\n      window.pywebview.api.open_url(url);\n      return true;\n    }\n    try {\n      window.open(url, \"_blank\", \"noopener,noreferrer\");\n      return true;\n    } catch (_e) {\n      return false;\n    }\n  },\n\n  canInAppApply() {\n    return !!(\n      window.pywebview\n      && window.pywebview.api\n      && typeof window.pywebview.api.start_update_download === \"function\"\n      && typeof window.pywebview.api.get_update_progress === \"function\"\n      && typeof window.pywebview.api.apply_downloaded_update === \"function\"\n    );\n  },\n\n  async updateAndRestart(downloadUrl, onProgress) {\n    if (!this.canInAppApply()) {\n      return { ok: false, message: \"In-app updater API unavailable.\" };\n    }\n    if (!downloadUrl) {\n      return { ok: false, message: \"Update package URL missing.\" };\n    }\n\n    const sendProgress = (payload) => {\n      if (typeof onProgress === \"function\") onProgress(payload);\n    };\n\n    try {\n      if (Platformer.Debug) Platformer.Debug.log(\"Updater\", `Starting in-app update: ${downloadUrl}`);\n      const start = await window.pywebview.api.start_update_download(\n        downloadUrl,\n        Platformer.Updater.latestChecksumSha256 || \"\",\n      );\n      if (!start || !start.ok) {\n        const msg = (start && start.message) || \"Failed to start update download.\";\n        if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n        return { ok: false, message: msg };\n      }\n\n      sendProgress({ stage: \"downloading\", progress: 0, message: \"Downloading update...\" });\n\n      for (let i = 0; i < 1200; i += 1) {\n        const status = await window.pywebview.api.get_update_progress();\n        if (!status || !status.ok) {\n          const msg = (status && status.message) || \"Failed to read update progress.\";\n          if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n          return { ok: false, message: msg };\n        }\n\n        sendProgress(status);\n\n        if (status.stage === \"error\") {\n          const msg = status.message || \"Update download failed.\";\n          if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n          return { ok: false, message: msg };\n        }\n        if (status.stage === \"downloaded\") {\n          break;\n        }\n        await this.wait(250);\n      }\n\n      sendProgress({ stage: \"applying\", progress: 100, message: \"Restarting to finish update...\" });\n      if (Platformer.Debug) Platformer.Debug.log(\"Updater\", \"Download complete. Applying update.\");\n      const applied = await window.pywebview.api.apply_downloaded_update();\n      if (!applied || !applied.ok) {\n        const msg = (applied && applied.message) || \"Failed to apply update.\";\n        if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n        return { ok: false, message: msg };\n      }\n\n      if (Platformer.Debug) Platformer.Debug.log(\"Updater\", \"Updater helper launched; app is restarting.\");\n      return { ok: true, message: applied.message || \"Restarting to finish update...\" };\n    } catch (e) {\n      const msg = `Update flow failed: ${e && e.message ? e.message : e}`;\n      if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n      return { ok: false, message: msg };\n    }\n  },\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.UpdateManager = class {\n  constructor(scene) {\n    this.scene = scene;\n    this.pendingUpdateUrl = \"\";\n    this.updateInProgress = false;\n    this.statusLockUntil = 0;\n    this.lastManualUpdateAt = 0;\n    this.latestChecksumSha256 = \"\";\n  }\n\n  log(level, msg) {\n    if (!Platformer.Debug) return;\n    if (level === \"error\") Platformer.Debug.error(\"UpdateManager\", msg);\n    else if (level === \"warn\") Platformer.Debug.warn(\"UpdateManager\", msg);\n    else Platformer.Debug.log(\"UpdateManager\", msg);\n  }\n\n  now() {\n    return this.scene && this.scene.time ? this.scene.time.now : Date.now();\n  }\n\n  syncSceneState() {\n    this.scene.pendingUpdateUrl = this.pendingUpdateUrl;\n    this.scene.updateInProgress = this.updateInProgress;\n    this.scene.updateStatusLockUntil = this.statusLockUntil;\n    this.scene.lastManualUpdateAt = this.lastManualUpdateAt;\n  }\n\n  setStatus(text, sticky = false, ms = 8000) {\n    const scene = this.scene;\n    if (!scene || !scene.sys || !scene.sys.settings || !scene.sys.settings.active) return;\n    const now = this.now();\n    if (!sticky && now < this.statusLockUntil) return;\n    if (sticky) this.statusLockUntil = now + Math.max(500, ms);\n    scene.setBottomLeftUpdateStatus(text, true);\n    this.syncSceneState();\n  }\n\n  setButtonText(text) {\n    const scene = this.scene;\n    if (!scene || !scene.updateButtonText) return;\n    scene.safeSetText(scene.updateButtonText, text, \"updateButtonText\");\n  }\n\n  async startInAppUpdate(downloadUrl, startMessage = \"Preparing update...\") {\n    const scene = this.scene;\n    this.updateInProgress = true;\n    this.statusLockUntil = this.now() + 30000;\n    this.syncSceneState();\n\n    if (scene.updateButton) scene.updateButton.disableInteractive();\n    this.setButtonText(\"Updating...\");\n    this.setStatus(startMessage, true, 30000);\n    this.log(\"info\", `startInAppUpdate: ${startMessage}`);\n\n    const result = await Platformer.Updater.updateAndRestart(downloadUrl, (status) => {\n      const pct = Number(status.progress || 0);\n      const msg = status.message || status.stage || \"Updating...\";\n      const compact = status.stage === \"downloading\" && Number.isFinite(pct)\n        ? `${msg} (${pct.toFixed(1)}%)`\n        : msg;\n      this.setStatus(compact, true, 15000);\n    });\n\n    if (!result.ok) {\n      this.updateInProgress = false;\n      this.statusLockUntil = this.now() + 15000;\n      this.syncSceneState();\n      if (scene.updateButton) scene.updateButton.setInteractive({ useHandCursor: true });\n      this.setButtonText(\"Update + Restart\");\n      this.setStatus(result.message || \"Update failed.\", true, 15000);\n      this.log(\"error\", `startInAppUpdate failed: ${result.message || \"unknown\"}`);\n      return { ok: false, message: result.message || \"Update failed.\" };\n    }\n\n    this.setStatus(result.message || \"Restarting to finish update...\", true, 30000);\n    this.log(\"info\", \"startInAppUpdate succeeded; helper should relaunch app.\");\n    return { ok: true, message: result.message || \"Restarting to finish update...\" };\n  }\n\n  async handleUpdateClick() {\n    const scene = this.scene;\n    this.lastManualUpdateAt = this.now();\n    this.statusLockUntil = this.now() + 12000;\n    this.syncSceneState();\n\n    this.log(\"info\", \"Update button clicked.\");\n    if (this.updateInProgress) {\n      this.log(\"warn\", \"Ignored click: update already in progress.\");\n      this.setStatus(\"Update already in progress...\", true, 10000);\n      return;\n    }\n\n    if (this.pendingUpdateUrl) {\n      if (Platformer.Updater.canInAppApply()) {\n        const result = await this.startInAppUpdate(this.pendingUpdateUrl, \"Updating game...\");\n        if (!result.ok) this.log(\"error\", result.message || \"Update failed.\");\n        return;\n      }\n      this.log(\"info\", `In-app updater unavailable; opening URL: ${this.pendingUpdateUrl}`);\n      const opened = Platformer.Updater.openDownload(this.pendingUpdateUrl);\n      this.setStatus(opened ? \"Downloading update...\" : \"Update download failed\", true, 12000);\n      return;\n    }\n\n    this.setStatus(\"Checking for updates...\", true, 12000);\n    this.log(\"info\", \"Manual update check requested.\");\n    const result = await Platformer.Updater.check();\n    if (!result.ok) {\n      this.log(\"warn\", `Check failed: ${result.message || \"unknown\"}`);\n      this.setStatus(result.message || \"Can't reach update server.\", true, 12000);\n      return;\n    }\n\n    if (scene.setLatestChangesFromResult) scene.setLatestChangesFromResult(result);\n    if (!result.enabled) {\n      this.setStatus(\"Auto updates are off.\", true, 12000);\n      return;\n    }\n\n    if (result.hasUpdate) {\n      this.pendingUpdateUrl = result.downloadUrl || \"\";\n      this.latestChecksumSha256 = result.checksumSha256 || \"\";\n      Platformer.Updater.latestChecksumSha256 = this.latestChecksumSha256;\n      this.syncSceneState();\n\n      if (!this.pendingUpdateUrl) {\n        this.setButtonText(\"Update\");\n        this.setStatus(\"Update found, package not ready yet. Retry soon.\", true, 12000);\n        this.log(\"warn\", `Update ${result.latestVersion || \"(unknown)\"} available without download URL.`);\n        return;\n      }\n\n      const v = result.latestVersion ? `v${result.latestVersion}` : \"new\";\n      this.setButtonText(\"Update + Restart\");\n      this.setStatus(`Update found (${v}). Starting now...`, true, 12000);\n      this.log(\"warn\", `Update available: ${v}`);\n\n      if (Platformer.Updater.canInAppApply()) {\n        const autoStart = await this.startInAppUpdate(this.pendingUpdateUrl, \"Updating game...\");\n        if (!autoStart.ok) this.log(\"error\", autoStart.message || \"Update failed.\");\n      }\n      return;\n    }\n\n    this.pendingUpdateUrl = \"\";\n    this.latestChecksumSha256 = \"\";\n    Platformer.Updater.latestChecksumSha256 = \"\";\n    this.syncSceneState();\n    this.setButtonText(\"Update\");\n    this.setStatus(\"You're up to date.\", true, 8000);\n    this.log(\"info\", \"No update available.\");\n  }\n\n  async autoCheck() {\n    const scene = this.scene;\n    if (!scene || !scene.sys || !scene.sys.settings || !scene.sys.settings.active) return;\n    if (this.updateInProgress) return;\n    if (this.now() - this.lastManualUpdateAt < 10000) {\n      this.log(\"info\", \"Auto-check skipped: recent manual update action.\");\n      return;\n    }\n\n    const cfg = Platformer.Settings.current.updates || {};\n    if (!cfg.enabled) {\n      this.setStatus(\"Auto updates are off.\");\n      return;\n    }\n\n    this.setStatus(\"Checking for updates...\");\n    const result = await Platformer.Updater.check();\n    if (!scene.sys || !scene.sys.settings || !scene.sys.settings.active) return;\n    if (!scene.scene || !scene.scene.isActive || !scene.scene.isActive(\"MenuScene\")) return;\n\n    if (!result.ok) {\n      if (result.transient) {\n        this.log(\"warn\", `Transient check state: ${result.message || \"pending\"}`);\n        this.setStatus(\"Checking for updates...\");\n        if (scene.time && scene.sys && scene.sys.settings && scene.sys.settings.active) {\n          scene.time.delayedCall(1200, () => this.autoCheck());\n        }\n        return;\n      }\n      this.setStatus(result.message || \"Can't reach update server.\");\n      return;\n    }\n    if (!result.enabled) {\n      this.setStatus(\"Auto updates are off.\");\n      return;\n    }\n\n    if (scene.setLatestChangesFromResult) scene.setLatestChangesFromResult(result);\n    if (result.hasUpdate) {\n      const v = result.latestVersion ? `v${result.latestVersion}` : \"new version\";\n      this.pendingUpdateUrl = result.downloadUrl || \"\";\n      this.latestChecksumSha256 = result.checksumSha256 || \"\";\n      Platformer.Updater.latestChecksumSha256 = this.latestChecksumSha256;\n      this.syncSceneState();\n      if (!this.pendingUpdateUrl) {\n        this.setButtonText(\"Update\");\n        this.setStatus(\"Update found, package not ready yet. Retry soon.\");\n        this.log(\"warn\", `Auto-check found update ${result.latestVersion || \"(unknown)\"} without download URL.`);\n        return;\n      }\n      this.setButtonText(\"Update + Restart\");\n      this.setStatus(`Update found (${v}). Press Update.`);\n    } else {\n      this.pendingUpdateUrl = \"\";\n      this.latestChecksumSha256 = \"\";\n      Platformer.Updater.latestChecksumSha256 = \"\";\n      this.syncSceneState();\n      this.setButtonText(\"Update\");\n      this.setStatus(\"You're up to date.\");\n    }\n  }\n};\n\n","window.Platformer = window.Platformer || {};\n\nPlatformer.WorldMapManager = {\n  registry: {},\n  cache: {},\n  shopCache: {},\n  activeWorldId: null,\n  defaultWorldId: \"world_tutorial\",\n  embeddedDefaults: {\n    world_tutorial: {\n      id: \"world_tutorial\",\n      name: \"Tutorial World\",\n      orderIndex: 0,\n      theme: {},\n      backgroundLayers: [],\n      lineStyle: {},\n      defaultNodeStyle: {},\n      startNodeId: \"start\",\n      nodes: [\n        { id: \"start\", type: \"start\", pos: { x: 180, y: 640 }, gameLevel: 5, ui: { title: \"Rooftop Start\", hint: \"WASD / Arrow keys to move\" } },\n        { id: \"teach_move\", type: \"tutorial\", pos: { x: 430, y: 560 }, gameLevel: 5, ui: { title: \"Movement Basics\", hint: \"Press Enter/E to confirm\" } },\n        { id: \"junction_1\", type: \"junction\", pos: { x: 700, y: 640 }, ui: { title: \"Route Split\", hint: \"Left = Shop, Up = Continue\" } },\n        { id: \"shop_01\", type: \"shop\", pos: { x: 930, y: 640 }, ui: { title: \"Supply Kiosk\", hint: \"Press Enter/E to confirm\" } },\n        { id: \"teach_jump\", type: \"tutorial\", pos: { x: 700, y: 430 }, ui: { title: \"Jump Timing\", hint: \"WASD / Arrow keys to move\" } },\n        { id: \"teach_hazards\", type: \"level\", pos: { x: 980, y: 360 }, ui: { title: \"Hazard Control\", hint: \"Press Enter/E to confirm\" } },\n        { id: \"boss_approach\", type: \"level\", pos: { x: 1260, y: 360 }, ui: { title: \"Boss Approach\", hint: \"Press Enter/E to confirm\" } },\n        { id: \"boss_tutorial\", type: \"boss\", pos: { x: 1460, y: 280 }, ui: { title: \"Boss Tutorial\", hint: \"Press Enter/E to confirm\" } },\n      ],\n      edges: [\n        { from: \"start\", to: \"teach_move\", kind: \"straight\" },\n        { from: \"teach_move\", to: \"junction_1\", kind: \"straight\" },\n        { from: \"junction_1\", to: \"shop_01\", kind: \"straight\" },\n        { from: \"junction_1\", to: \"teach_jump\", kind: \"straight\" },\n        { from: \"teach_jump\", to: \"teach_hazards\", kind: \"straight\" },\n        { from: \"teach_hazards\", to: \"boss_approach\", kind: \"straight\" },\n        { from: \"boss_approach\", to: \"boss_tutorial\", kind: \"straight\" },\n      ],\n      raw: { config: {}, nodes: {} },\n    },\n  },\n  embeddedShops: {\n    world_tutorial: {\n      shop_01: {\n        id: \"shop_01\",\n        name: \"Supply Kiosk\",\n        items: [\n          { id: \"hp_up_1\", label: \"Health Up\", cost: 10, stat: \"health\", delta: 1 },\n          { id: \"speed_up_1\", label: \"Speed Up\", cost: 8, stat: \"speed\", delta: 0.1 },\n          { id: \"dash_cd_1\", label: \"Dash Cooldown\", cost: 12, stat: \"dashCooldown\", delta: -0.08 },\n        ],\n      },\n    },\n  },\n\n  registerWorld(def) {\n    if (!def || !def.id) return;\n    const id = String(def.id);\n    this.registry[id] = {\n      id,\n      basePath: String(def.basePath || \"\").replace(/\\\\/g, \"/\").replace(/\\/$/, \"\"),\n    };\n  },\n\n  registerDefaults() {\n    if (!this.registry.world_tutorial) {\n      this.registerWorld({\n        id: \"world_tutorial\",\n        basePath: \"js/level/world_tutorial\",\n      });\n    }\n  },\n\n  getWorldDef(worldId) {\n    this.registerDefaults();\n    return this.registry[String(worldId || this.defaultWorldId)] || null;\n  },\n\n  getCached(worldId) {\n    return this.cache[String(worldId || this.defaultWorldId)] || null;\n  },\n\n  getActiveWorld() {\n    return this.getCached(this.activeWorldId || this.defaultWorldId);\n  },\n\n  getNodeById(world, nodeId) {\n    if (!world || !Array.isArray(world.nodes)) return null;\n    const id = String(nodeId || \"\");\n    return world.nodes.find((n) => n && String(n.id) === id) || null;\n  },\n\n  resolveGameLevelRef(levelRef) {\n    if (typeof levelRef === \"number\" && Number.isFinite(levelRef)) return Number(levelRef);\n    const ref = String(levelRef || \"\");\n    const m = ref.match(/(\\d+)/);\n    if (m) return Number(m[1]);\n    return 1;\n  },\n\n  async fetchJson(path) {\n    const normalized = String(path || \"\").replace(/\\\\/g, \"/\");\n    const response = await fetch(normalized, { cache: \"no-store\" });\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status} while loading ${normalized}`);\n    }\n    return response.json();\n  },\n\n  normalize(worldId, config, nodes) {\n    const cfg = config && typeof config === \"object\" ? config : {};\n    const nd = nodes && typeof nodes === \"object\" ? nodes : {};\n\n    return {\n      id: String(cfg.id || worldId),\n      name: String(cfg.name || worldId),\n      orderIndex: Number(cfg.orderIndex || 0),\n      theme: cfg.theme || {},\n      backgroundLayers: Array.isArray(cfg.backgroundLayers) ? cfg.backgroundLayers : [],\n      lineStyle: cfg.lineStyle || {},\n      defaultNodeStyle: cfg.defaultNodeStyle || {},\n      startNodeId: nd.startNodeId || null,\n      nodes: Array.isArray(nd.nodes) ? nd.nodes : [],\n      edges: Array.isArray(nd.edges) ? nd.edges : [],\n      raw: {\n        config: cfg,\n        nodes: nd,\n      },\n    };\n  },\n\n  async loadWorld(worldId, opts = {}) {\n    const id = String(worldId || this.defaultWorldId);\n    if (!opts.force && this.cache[id]) {\n      return this.cache[id];\n    }\n\n    const def = this.getWorldDef(id);\n    if (!def) {\n      throw new Error(`World not registered: ${id}`);\n    }\n\n    const configPath = `${def.basePath}/world.config.json`;\n    const nodesPath = `${def.basePath}/nodes.json`;\n\n    let world = null;\n    try {\n      const [config, nodes] = await Promise.all([\n        this.fetchJson(configPath),\n        this.fetchJson(nodesPath),\n      ]);\n      world = this.normalize(id, config, nodes);\n    } catch (err) {\n      const embedded = this.embeddedDefaults[id] || null;\n      if (!embedded) throw err;\n      world = this.normalize(id, embedded, embedded);\n      if (Platformer.Debug) {\n        Platformer.Debug.warn(\"WorldMapManager\", `Using embedded fallback for ${id}: ${err && err.message ? err.message : err}`);\n      }\n    }\n    this.cache[id] = world;\n    this.activeWorldId = id;\n\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\"WorldMapManager\", `Loaded world=${id} nodes=${world.nodes.length} edges=${world.edges.length}`);\n    }\n\n    return world;\n  },\n\n  async warmupDefault() {\n    try {\n      return await this.loadWorld(this.defaultWorldId);\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.warn(\"WorldMapManager\", `Warmup failed: ${err && err.message ? err.message : err}`);\n      }\n      return null;\n    }\n  },\n\n  async loadShop(worldId, shopRef, opts = {}) {\n    const wid = String(worldId || this.defaultWorldId);\n    const sid = String(shopRef || \"\");\n    if (!sid) throw new Error(\"Missing shopRef\");\n    const cacheKey = `${wid}:${sid}`;\n    if (!opts.force && this.shopCache[cacheKey]) return this.shopCache[cacheKey];\n\n    const def = this.getWorldDef(wid);\n    if (!def) throw new Error(`World not registered: ${wid}`);\n    const shopPath = `${def.basePath}/shop/${sid}.json`;\n    let shop = null;\n    try {\n      shop = await this.fetchJson(shopPath);\n    } catch (err) {\n      const fallback = this.embeddedShops[wid] && this.embeddedShops[wid][sid] ? this.embeddedShops[wid][sid] : null;\n      if (!fallback) throw err;\n      shop = fallback;\n      if (Platformer.Debug) {\n        Platformer.Debug.warn(\"WorldMapManager.shop\", `Using embedded fallback for ${cacheKey}: ${err && err.message ? err.message : err}`);\n      }\n    }\n\n    const normalized = {\n      id: String(shop.id || sid),\n      name: String(shop.name || sid),\n      items: Array.isArray(shop.items) ? shop.items.map((it) => ({\n        id: String(it.id || \"\"),\n        label: String(it.label || it.id || \"Upgrade\"),\n        cost: Math.max(0, Number(it.cost || 0)),\n        stat: String(it.stat || \"\"),\n        delta: Number(it.delta || 0),\n        max: Math.max(1, Number(it.max || 1)),\n      })).filter((it) => !!it.id) : [],\n    };\n    this.shopCache[cacheKey] = normalized;\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\"WorldMapManager.shop\", `Loaded shop=${cacheKey} items=${normalized.items.length}`);\n    }\n    return normalized;\n  },\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.WorldMapView = class WorldMapView {\n  constructor(scene, worldData) {\n    this.scene = scene;\n    this.world = worldData || null;\n    this.root = scene.add.container(0, 0).setDepth(10);\n    this.nodeById = {};\n    this.nodeViews = {};\n    this.selectedNodeId = null;\n    this.availableNodeIds = [];\n    this.pendingNodeId = null;\n    this.avatar = null;\n\n    this.bgSky = null;\n    this.bgBandA = null;\n    this.bgBandB = null;\n    this.scanlines = null;\n    this.bgLayers = [];\n    this.bgOrbs = [];\n    this.layerKeys = [];\n    this.pathGraphics = null;\n    this.pathLines = [];\n    this.particles = null;\n\n    this.infoPanel = null;\n    this.infoTitle = null;\n    this.infoBody = null;\n    this.infoHint = null;\n    this.debugText = null;\n  }\n\n  render() {\n    this.ensureNodeIndex();\n    this.safeRun(\"drawBackground\", () => this.drawBackground());\n    this.safeRun(\"drawPaths\", () => this.drawPaths());\n    this.safeRun(\"drawNodes\", () => this.drawNodes());\n    this.safeRun(\"createInfoPanel\", () => this.createInfoPanel());\n    this.safeRun(\"resize\", () => this.resize());\n\n    const startId = this.world && this.world.startNodeId ? this.world.startNodeId : null;\n    if (startId && this.nodeById[startId]) {\n      this.selectNode(startId);\n    }\n  }\n\n  drawBackground() {\n    const vp = this.getViewport();\n    const colors = (this.world && this.world.theme && this.world.theme.colors) ? this.world.theme.colors : {};\n    const cTop = this.parseColor(colors.bgTop, 0x050b1f);\n    const cBottom = this.parseColor(colors.bgBottom, 0x0a183c);\n    const cMidA = this.parseColor(colors.bgBandA, 0x11285b);\n    const cMidB = this.parseColor(colors.bgBandB, 0x0f2a5e);\n    this.bgSky = this.scene.add.rectangle(0, 0, vp.w, vp.h, cTop, 1).setOrigin(0, 0).setDepth(0).setScrollFactor(0);\n    this.bgBandA = this.scene.add.rectangle(0, vp.h * 0.14, vp.w, vp.h * 0.26, cMidA, 0.22).setOrigin(0, 0).setDepth(1).setScrollFactor(0);\n    this.bgBandB = this.scene.add.rectangle(0, vp.h * 0.58, vp.w, vp.h * 0.22, cMidB, 0.18).setOrigin(0, 0).setDepth(1).setScrollFactor(0);\n    this.bgOrbs = [\n      this.scene.add.circle(vp.w * 0.18, vp.h * 0.23, Math.max(90, Math.round(vp.h * 0.11)), 0x7c3aed, 0.1).setDepth(1.3).setScrollFactor(0),\n      this.scene.add.circle(vp.w * 0.8, vp.h * 0.18, Math.max(110, Math.round(vp.h * 0.14)), 0x22d3ee, 0.08).setDepth(1.35).setScrollFactor(0),\n    ];\n\n    this.scanlines = this.scene.add.graphics().setDepth(2).setScrollFactor(0);\n    this.redrawScanlines(vp.w, vp.h, cBottom, colors);\n    this.createParallaxLayers(vp.w, vp.h);\n\n    this.particles = this.scene.add.particles(0, 0, this.textureOr(\"coin\", \"__WHITE\"), {\n      x: { min: 0, max: vp.w },\n      y: { min: 0, max: vp.h },\n      lifespan: { min: 3000, max: 5200 },\n      speedY: { min: -20, max: -7 },\n      speedX: { min: -7, max: 7 },\n      scale: { start: 0.06, end: 0 },\n      alpha: { start: 0.24, end: 0 },\n      quantity: 1,\n      frequency: 160,\n    }).setDepth(3).setScrollFactor(0);\n  }\n\n  createParallaxLayers(w, h) {\n    this.bgLayers = [];\n    const layers = Array.isArray(this.world && this.world.backgroundLayers) ? this.world.backgroundLayers : [];\n    layers.forEach((layer, idx) => {\n      const key = `wm-bg-${String(this.world && this.world.id ? this.world.id : \"world\")}-${idx}`;\n      const alpha = Phaser.Math.Clamp(Number(layer && layer.alpha != null ? layer.alpha : 0.8), 0, 1);\n      const parallax = Number(layer && layer.parallax != null ? layer.parallax : 0.2);\n      const depth = 1.2 + idx * 0.35;\n      const fallbackTint = [0x1e3a8a, 0x1d4ed8, 0x0ea5e9][idx % 3];\n      const ts = this.scene.add.tileSprite(0, 0, w, h, \"__WHITE\")\n        .setOrigin(0, 0)\n        .setDepth(depth)\n        .setScrollFactor(0)\n        .setAlpha(alpha)\n        .setTint(fallbackTint);\n      this.bgLayers.push({ sprite: ts, parallax, key, src: layer && layer.src ? String(layer.src) : \"\" });\n\n      const src = layer && layer.src ? String(layer.src) : \"\";\n      if (!src) return;\n      if (this.scene.textures.exists(key)) {\n        ts.setTexture(key).clearTint();\n        return;\n      }\n      this.safeRun(\"bgLayer.load\", () => {\n        this.scene.load.image(key, src);\n        this.scene.load.once(`filecomplete-image-${key}`, () => {\n          if (!this.scene || !this.scene.sys || !this.scene.sys.settings || !this.scene.sys.settings.active) return;\n          if (!ts || !ts.active) return;\n          ts.setTexture(key).clearTint();\n          if (Platformer.Debug) Platformer.Debug.log(\"WorldMapView.theme\", `Loaded background layer ${idx + 1}: ${src}`);\n        });\n        this.scene.load.once(\"loaderror\", (fileObj) => {\n          if (!fileObj || String(fileObj.key) !== key) return;\n          if (Platformer.Debug) Platformer.Debug.warn(\"WorldMapView.theme\", `Background layer missing: ${src} (fallback tint used)`);\n        });\n        this.scene.load.start();\n      });\n    });\n  }\n\n  redrawScanlines(w, h, bottomColor, colors) {\n    if (!this.scanlines) return;\n    this.scanlines.clear();\n    const lineColor = this.parseColor(colors && colors.gridLine, 0x67e8f9);\n    const orbA = this.parseColor(colors && colors.orbA, 0x7c3aed);\n    const orbB = this.parseColor(colors && colors.orbB, 0x38bdf8);\n\n    this.scanlines.fillStyle(bottomColor, 0.16);\n    this.scanlines.fillCircle(w * 0.18, h * 0.26, Math.max(120, Math.round(h * 0.16)));\n    this.scanlines.fillStyle(bottomColor, 0.12);\n    this.scanlines.fillCircle(w * 0.82, h * 0.18, Math.max(140, Math.round(h * 0.2)));\n\n    this.scanlines.fillStyle(orbA, 0.09);\n    this.scanlines.fillCircle(w * 0.24, h * 0.24, Math.max(90, Math.round(h * 0.12)));\n    this.scanlines.fillStyle(orbB, 0.08);\n    this.scanlines.fillCircle(w * 0.78, h * 0.2, Math.max(110, Math.round(h * 0.14)));\n\n    this.scanlines.lineStyle(1, lineColor, 0.08);\n    for (let y = 0; y <= h; y += 84) {\n      this.scanlines.beginPath();\n      this.scanlines.moveTo(0, y);\n      this.scanlines.lineTo(w, y);\n      this.scanlines.strokePath();\n    }\n\n    this.scanlines.lineStyle(2, lineColor, 0.14);\n    for (let i = 0; i < 10; i += 1) {\n      const x = (i * 137) % (w + 200) - 80;\n      const y = 40 + ((i * 97) % (h - 80));\n      this.scanlines.beginPath();\n      this.scanlines.moveTo(x, y);\n      this.scanlines.lineTo(x + 170, y - 44);\n      this.scanlines.strokePath();\n    }\n  }\n\n  drawPaths() {\n    this.ensureNodeIndex();\n    this.clearPathLines();\n    const edges = Array.isArray(this.world && this.world.edges) ? this.world.edges : [];\n    if (!edges.length && Platformer.Debug) {\n      Platformer.Debug.warn(\"WorldMapView\", \"No edges found to draw.\");\n    }\n    let drawn = 0;\n    edges.forEach((edge) => {\n      const from = this.getNode(edge.from);\n      const to = this.getNode(edge.to);\n      if (!from || !to) return;\n      try {\n        const lineCfg = this.world && this.world.lineStyle ? this.world.lineStyle : {};\n        const glowColor = this.parseColor(lineCfg.glowColor, 0x1e3a8a);\n        const coreColor = this.parseColor(lineCfg.color, 0x67e8f9);\n        const glowWidth = Math.max(1, Number(lineCfg.glowWidth || 10));\n        const coreWidth = Math.max(1, Number(lineCfg.width || 4));\n        const glow = this.scene.add.line(\n          0, 0,\n          from.pos.x, from.pos.y,\n          to.pos.x, to.pos.y,\n          glowColor,\n          0.95\n        ).setOrigin(0, 0).setLineWidth(glowWidth, glowWidth).setDepth(11);\n        const core = this.scene.add.line(\n          0, 0,\n          from.pos.x, from.pos.y,\n          to.pos.x, to.pos.y,\n          coreColor,\n          1\n        ).setOrigin(0, 0).setLineWidth(coreWidth, coreWidth).setDepth(12);\n        const dot = this.scene.add.circle(\n          (from.pos.x + to.pos.x) * 0.5,\n          (from.pos.y + to.pos.y) * 0.5,\n          3.5,\n          0x93c5fd,\n          0.95\n        ).setDepth(13);\n        this.pathLines.push(glow, core, dot);\n        this.root.add([glow, core, dot]);\n        drawn += 1;\n      } catch (err) {\n        if (Platformer.Debug) {\n          Platformer.Debug.error(\"WorldMapView.drawPaths\", `edge ${edge.from}->${edge.to} failed: ${err && err.stack ? err.stack : err}`);\n        }\n      }\n    });\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\"WorldMapView.drawPaths\", `edges total=${edges.length} drawn=${drawn}`);\n      if (drawn === 0 && edges.length > 0) {\n        Platformer.Debug.warn(\"WorldMapView.drawPaths\", \"Edges exist but none were drawn.\");\n      }\n    }\n  }\n\n  drawNodes() {\n    this.ensureNodeIndex();\n    const nodes = Array.isArray(this.world && this.world.nodes) ? this.world.nodes : [];\n    nodes.forEach((node) => {\n      const style = this.resolveNodeStyle(node);\n      const outer = this.scene.add.circle(node.pos.x, node.pos.y, 18, style.fill, 0.95)\n        .setStrokeStyle(3, style.stroke, 0.92)\n        .setDepth(20);\n      const inner = this.scene.add.circle(node.pos.x, node.pos.y, 9, style.inner, 1)\n        .setDepth(21);\n      const label = this.scene.add.text(node.pos.x, node.pos.y - 30, this.nodeTitle(node), {\n        fontFamily: \"Consolas\",\n        fontSize: \"16px\",\n        color: style.label,\n        stroke: \"#0f172a\",\n        strokeThickness: 4,\n      }).setOrigin(0.5).setDepth(22);\n      const badge = this.scene.add.text(node.pos.x, node.pos.y, this.nodeBadge(node), {\n        fontFamily: \"Consolas\",\n        fontSize: \"15px\",\n        color: \"#f8fafc\",\n        stroke: \"#0f172a\",\n        strokeThickness: 3,\n      }).setOrigin(0.5).setDepth(23);\n\n      this.nodeViews[node.id] = { outer, inner, label, badge, style };\n      this.root.add([outer, inner, label, badge]);\n    });\n  }\n\n  resolveNodeStyle(node) {\n    const type = String(node.type || \"level\");\n    const state = String(node.state || \"\").toLowerCase();\n    const isLocked = state === \"locked\";\n    const isCompleted = state === \"completed\";\n    if (isLocked) {\n      return { fill: 0x475569, stroke: 0x64748b, inner: 0x334155, label: \"#94a3b8\" };\n    }\n    if (isCompleted) {\n      return { fill: 0x16a34a, stroke: 0xbbf7d0, inner: 0xfef08a, label: \"#dcfce7\" };\n    }\n    if (type === \"shop\") return { fill: 0x22c55e, stroke: 0xbbf7d0, inner: 0xfef08a, label: \"#dcfce7\" };\n    if (type === \"boss\") return { fill: 0xef4444, stroke: 0xfecaca, inner: 0xf97316, label: \"#fee2e2\" };\n    if (type === \"junction\") return { fill: 0xa855f7, stroke: 0xe9d5ff, inner: 0xc4b5fd, label: \"#f3e8ff\" };\n    if (type === \"tutorial\") return { fill: 0x38bdf8, stroke: 0xe0f2fe, inner: 0xfacc15, label: \"#e2e8f0\" };\n    if (type === \"start\") return { fill: 0x0ea5e9, stroke: 0xbae6fd, inner: 0xfacc15, label: \"#f8fafc\" };\n    return { fill: 0x38bdf8, stroke: 0xe0f2fe, inner: 0xfacc15, label: \"#e2e8f0\" };\n  }\n\n  createInfoPanel() {\n    this.infoPanel = this.scene.add.rectangle(20, 20, 360, 220, 0x0f172a, 0.84)\n      .setOrigin(0, 0)\n      .setStrokeStyle(2, 0x7dd3fc, 0.78)\n      .setDepth(70)\n      .setScrollFactor(0);\n    this.infoTitle = this.scene.add.text(34, 34, \"Tutorial World\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"26px\",\n      color: \"#f8fafc\",\n      stroke: \"#020617\",\n      strokeThickness: 4,\n    }).setDepth(71).setScrollFactor(0);\n    this.infoBody = this.scene.add.text(34, 74, \"Walk to a node to inspect.\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#cbd5e1\",\n      lineSpacing: 4,\n      wordWrap: { width: 330 },\n    }).setDepth(71).setScrollFactor(0);\n    this.infoHint = this.scene.add.text(30, 252, \"Press E / ENTER to play this level\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"22px\",\n      color: \"#fef3c7\",\n      stroke: \"#0f172a\",\n      strokeThickness: 5,\n    }).setDepth(72).setScrollFactor(0);\n    this.infoHint.setText(\"Use WASD / Arrow keys to move on the map\");\n\n    this.debugText = this.scene.add.text(this.getViewport().w - 20, this.getViewport().h - 18, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"16px\",\n      color: \"#93c5fd\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n      align: \"right\",\n    }).setOrigin(1, 1).setDepth(72).setScrollFactor(0);\n  }\n\n  selectNode(nodeId) {\n    const node = this.getNode(nodeId);\n    if (!node) return;\n    this.selectedNodeId = nodeId;\n\n    Object.keys(this.nodeViews).forEach((id) => {\n      const view = this.nodeViews[id];\n      if (!view) return;\n      if (id === nodeId) {\n        view.outer.setScale(1.15).setFillStyle(0x22d3ee, 1);\n        view.inner.setScale(1.2);\n        if (view.badge) view.badge.setScale(1.1);\n      } else {\n        view.outer.setScale(1).setFillStyle(view.style.fill, 0.95);\n        view.inner.setScale(1);\n        if (view.badge) view.badge.setScale(1);\n      }\n    });\n\n    this.infoTitle.setText(`${this.nodeTitle(node)} (${node.id})`);\n    const type = String(node.type || \"level\");\n    const state = String(node.state || \"unlocked\");\n    const hint = (node.ui && node.ui.hint) ? node.ui.hint : \"Press Enter/E to confirm\";\n    this.infoBody.setText([\n      `Type: ${type}`,\n      `State: ${state}`,\n      \"\",\n      hint,\n    ].join(\"\\n\"));\n\n    this.reflowInfoPanel();\n  }\n\n  setDebug(text) {\n    if (!this.debugText) return;\n    this.debugText.setText(String(text || \"\"));\n  }\n\n  setPrompt(text) {\n    if (!this.infoHint) return;\n    this.infoHint.setText(String(text || \"\"));\n  }\n\n  setAvailableNodes(nodeIds, pendingNodeId) {\n    this.availableNodeIds = Array.isArray(nodeIds) ? nodeIds.slice() : [];\n    this.pendingNodeId = pendingNodeId || null;\n    const available = new Set(this.availableNodeIds);\n    Object.keys(this.nodeViews).forEach((id) => {\n      const view = this.nodeViews[id];\n      if (!view) return;\n      const isSelected = id === this.selectedNodeId;\n      const isAvailable = available.has(id);\n      const isPending = id === this.pendingNodeId;\n      if (isPending) {\n        view.outer.setStrokeStyle(4, 0xfef08a, 1);\n      } else if (isAvailable) {\n        view.outer.setStrokeStyle(3, 0x67e8f9, 1);\n      } else {\n        view.outer.setStrokeStyle(3, view.style.stroke, 0.92);\n      }\n      if (!isSelected) {\n        view.outer.setFillStyle(view.style.fill, 0.95);\n      }\n    });\n  }\n\n  setNodeState(nodeId, state) {\n    const node = this.getNode(nodeId);\n    const view = this.nodeViews[String(nodeId)];\n    if (!node || !view) return;\n    node.state = String(state || \"locked\");\n    const style = this.resolveNodeStyle(node);\n    view.style = style;\n    view.outer.setFillStyle(style.fill, 0.95).setStrokeStyle(3, style.stroke, 0.92);\n    view.inner.setFillStyle(style.inner, 1);\n    view.label.setColor(style.label);\n    if (view.badge) view.badge.setColor(\"#f8fafc\");\n  }\n\n  createAvatar() {\n    if (this.avatar && this.avatar.active) return this.avatar;\n    this.avatar = this.scene.add.sprite(0, 0, this.textureOr(\"player-run-1\", \"player-idle-1\")).setDepth(30);\n    this.avatar.setDisplaySize(42, 56);\n    this.root.add(this.avatar);\n    return this.avatar;\n  }\n\n  setAvatarPosition(x, y) {\n    if (!this.avatar) this.createAvatar();\n    if (!this.avatar) return;\n    this.avatar.setPosition(Number(x) || 0, Number(y) || 0);\n  }\n\n  setAvatarFacing(dirX) {\n    if (!this.avatar) return;\n    if (Math.abs(dirX) < 0.01) return;\n    this.avatar.setFlipX(dirX < 0);\n  }\n\n  setAvatarMoving(isMoving, tickNow) {\n    if (!this.avatar) return;\n    const t = Number(tickNow || 0);\n    if (isMoving) {\n      const frame = Math.floor(t / 120) % 2 === 0 ? \"player-run-1\" : \"player-run-2\";\n      this.avatar.setTexture(this.textureOr(frame, \"player-idle-1\"));\n    } else {\n      this.avatar.setTexture(this.textureOr(\"player-idle-1\", \"player-run-1\"));\n    }\n  }\n\n  reflowInfoPanel() {\n    if (!this.infoPanel || !this.infoBody || !this.infoHint) return;\n    const panelHeight = Math.max(220, Math.ceil(84 + this.infoBody.height + 20));\n    this.infoPanel.setSize(360, panelHeight);\n    this.infoHint.setPosition(this.infoPanel.x + 8, this.infoPanel.y + panelHeight + 10);\n  }\n\n  resize() {\n    this.safeRun(\"resize.exec\", () => {\n      const vp = this.getViewport();\n      this.safeRect(this.bgSky, vp.w, vp.h, 0, 0);\n      this.safeRect(this.bgBandA, vp.w, vp.h * 0.22, 0, vp.h * 0.2);\n      this.safeRect(this.bgBandB, vp.w, vp.h * 0.24, 0, vp.h * 0.62);\n      if (this.bgOrbs[0]) this.bgOrbs[0].setPosition(vp.w * 0.18, vp.h * 0.23);\n      if (this.bgOrbs[1]) this.bgOrbs[1].setPosition(vp.w * 0.8, vp.h * 0.18);\n      const colors = (this.world && this.world.theme && this.world.theme.colors) ? this.world.theme.colors : {};\n      this.redrawScanlines(vp.w, vp.h, this.parseColor(colors.bgBottom, 0x0a183c), colors);\n      this.bgLayers.forEach((entry) => {\n        if (!entry || !entry.sprite || !entry.sprite.active || typeof entry.sprite.setSize !== \"function\") return;\n        entry.sprite.setSize(vp.w, vp.h).setPosition(0, 0);\n      });\n\n      if (this.particles) {\n        this.particles.setConfig({\n          x: { min: 0, max: vp.w },\n          y: { min: 0, max: vp.h },\n        });\n      }\n\n      this.layoutMapRootToViewport();\n\n      if (this.debugText) {\n        this.debugText.setPosition(vp.w - 20, vp.h - 18);\n      }\n    });\n  }\n\n  updateAmbient(timeMs) {\n    const t = Number(timeMs || 0) * 0.001;\n    this.bgLayers.forEach((entry, idx) => {\n      if (!entry || !entry.sprite || !entry.sprite.active) return;\n      if (typeof entry.sprite.tilePositionX !== \"number\") return;\n      const p = Number(entry.parallax || 0.2);\n      entry.sprite.tilePositionX = (t * 40 * p) + idx * 7;\n      entry.sprite.tilePositionY = Math.sin(t * (0.2 + p * 0.3)) * (2 + idx);\n    });\n    if (this.bgOrbs[0]) this.bgOrbs[0].x += Math.cos(t * 0.8) * 0.22;\n    if (this.bgOrbs[1]) this.bgOrbs[1].x += Math.sin(t * 0.7) * 0.25;\n  }\n\n  layoutMapRootToViewport() {\n    if (!this.root || !this.world) return;\n    const vp = this.getViewport();\n    const b = this.deriveBounds();\n    const margin = Math.max(24, Math.round(Math.min(vp.w, vp.h) * 0.04));\n    const sx = (vp.w - margin * 2) / Math.max(1, b.width);\n    const sy = (vp.h - margin * 2) / Math.max(1, b.height);\n    const scale = Phaser.Math.Clamp(Math.min(sx, sy), 0.35, 2.2);\n    const fittedW = b.width * scale;\n    const fittedH = b.height * scale;\n    const offsetX = (vp.w - fittedW) * 0.5 - b.x * scale;\n    const offsetY = (vp.h - fittedH) * 0.5 - b.y * scale;\n\n    this.root.setScale(scale);\n    this.root.setPosition(offsetX, offsetY);\n\n    const cam = this.scene.cameras && this.scene.cameras.main;\n    if (cam) {\n      cam.setViewport(0, 0, vp.w, vp.h);\n      cam.setZoom(1);\n      cam.scrollX = 0;\n      cam.scrollY = 0;\n      cam.roundPixels = true;\n    }\n  }\n\n  deriveBounds() {\n    const nodes = Array.isArray(this.world && this.world.nodes) ? this.world.nodes : [];\n    if (!nodes.length) return { x: 0, y: 0, width: 1000, height: 700 };\n    let minX = Number.POSITIVE_INFINITY;\n    let minY = Number.POSITIVE_INFINITY;\n    let maxX = Number.NEGATIVE_INFINITY;\n    let maxY = Number.NEGATIVE_INFINITY;\n    nodes.forEach((n) => {\n      const x = Number(n.pos && n.pos.x);\n      const y = Number(n.pos && n.pos.y);\n      if (!Number.isFinite(x) || !Number.isFinite(y)) return;\n      minX = Math.min(minX, x);\n      minY = Math.min(minY, y);\n      maxX = Math.max(maxX, x);\n      maxY = Math.max(maxY, y);\n    });\n    if (!Number.isFinite(minX) || !Number.isFinite(minY)) return { x: 0, y: 0, width: 1000, height: 700 };\n    return {\n      x: minX - 120,\n      y: minY - 120,\n      width: (maxX - minX) + 240,\n      height: (maxY - minY) + 240,\n    };\n  }\n\n  nodeTitle(node) {\n    if (!node) return \"Node\";\n    if (node.ui && node.ui.title) return String(node.ui.title);\n    return String(node.id || \"Node\");\n  }\n\n  nodeBadge(node) {\n    const t = String((node && node.type) || \"level\");\n    if (t === \"start\") return \"S\";\n    if (t === \"shop\") return \"$\";\n    if (t === \"boss\") return \"B\";\n    if (t === \"junction\") return \"+\";\n    if (t === \"tutorial\") return \"T\";\n    return \"L\";\n  }\n\n  getNode(id) {\n    return this.nodeById[String(id)] || null;\n  }\n\n  ensureNodeIndex() {\n    this.nodeById = {};\n    const nodes = Array.isArray(this.world && this.world.nodes) ? this.world.nodes : [];\n    nodes.forEach((n) => {\n      if (!n || !n.id || !n.pos) return;\n      this.nodeById[n.id] = n;\n    });\n  }\n\n  getViewport() {\n    const gs = this.scene.scale && this.scene.scale.gameSize ? this.scene.scale.gameSize : null;\n    const bs = this.scene.scale && this.scene.scale.baseSize ? this.scene.scale.baseSize : null;\n    const w = (gs && gs.width) || (bs && bs.width) || this.scene.scale.width || 960;\n    const h = (gs && gs.height) || (bs && bs.height) || this.scene.scale.height || 540;\n    return { w: Math.max(640, Math.round(w)), h: Math.max(360, Math.round(h)) };\n  }\n\n  safeRect(obj, width, height, x, y) {\n    if (!obj || !obj.active || !obj.scene) return;\n    obj.setSize(width, height).setPosition(x, y);\n  }\n\n  textureOr(key, fallback) {\n    if (key && this.scene.textures.exists(key)) return key;\n    if (fallback && this.scene.textures.exists(fallback)) return fallback;\n    return \"__WHITE\";\n  }\n\n  parseColor(value, fallback) {\n    if (typeof value === \"number\" && Number.isFinite(value)) return value;\n    if (typeof value === \"string\") {\n      const s = value.trim();\n      if (/^#?[0-9a-fA-F]{6}$/.test(s)) {\n        return Number.parseInt(s.replace(\"#\", \"\"), 16);\n      }\n    }\n    return fallback;\n  }\n\n  destroy() {\n    this.clearPathLines();\n    [\n      this.bgSky,\n      this.bgBandA,\n      this.bgBandB,\n      this.scanlines,\n      this.particles,\n      this.infoPanel,\n      this.infoTitle,\n      this.infoBody,\n      this.infoHint,\n      this.debugText,\n      this.avatar,\n      this.root,\n    ].forEach((obj) => {\n      if (obj && obj.destroy) obj.destroy();\n    });\n    this.bgOrbs.forEach((o) => {\n      if (o && o.destroy) o.destroy();\n    });\n    this.bgOrbs = [];\n    this.bgLayers = [];\n  }\n\n  clearPathLines() {\n    if (!Array.isArray(this.pathLines)) this.pathLines = [];\n    this.pathLines.forEach((obj) => {\n      if (obj && obj.destroy) obj.destroy();\n    });\n    this.pathLines = [];\n  }\n\n  safeRun(label, fn) {\n    try {\n      return fn();\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"WorldMapView\", `${label} failed: ${err && err.stack ? err.stack : err}`);\n      }\n      return null;\n    }\n  }\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.WorldMapData = {\n  id: \"NeoTokyoRoute\",\n  bounds: { x: 40, y: 80, width: 1520, height: 760 },\n  spawn: { x: 150, y: 700 },\n  blockedRegions: [\n    { x: 430, y: 270, width: 170, height: 95, label: \"water\" },\n    { x: 860, y: 470, width: 200, height: 95, label: \"water\" },\n    { x: 1200, y: 260, width: 150, height: 120, label: \"cliff\" },\n  ],\n  nodes: [\n    {\n      id: \"Level_01\",\n      levelId: \"Level_01\",\n      gameLevel: 1,\n      displayName: \"Rooftop Start\",\n      difficulty: \"Easy\",\n      x: 180,\n      y: 680,\n      requires: [],\n      next: [\"Level_02\"],\n      tutorial: \"Collect 10 coins to clear. Use checkpoints and watch turret shots.\",\n    },\n    {\n      id: \"Level_02\",\n      levelId: \"Level_02\",\n      gameLevel: 2,\n      displayName: \"Metro Drift\",\n      difficulty: \"Normal\",\n      x: 460,\n      y: 540,\n      requires: [\"Level_01\"],\n      next: [\"Level_03\"],\n      tutorial: \"Enemy pressure increases when close. Use dash to break contact.\",\n    },\n    {\n      id: \"Level_03\",\n      levelId: \"Level_03\",\n      gameLevel: 3,\n      displayName: \"Neon Ward\",\n      difficulty: \"Normal\",\n      x: 780,\n      y: 640,\n      requires: [\"Level_02\"],\n      next: [\"Level_04\"],\n      tutorial: \"Projectiles are the main threat. Keep moving and route for coins.\",\n    },\n    {\n      id: \"Level_04\",\n      levelId: \"Level_04\",\n      gameLevel: 4,\n      displayName: \"Skyline Core\",\n      difficulty: \"Hard\",\n      x: 1100,\n      y: 500,\n      requires: [\"Level_03\"],\n      next: [\"Boss_01\"],\n      tutorial: \"Hard mode spacing: fewer safe zones and faster enemy reactions.\",\n    },\n    {\n      id: \"Boss_01\",\n      levelId: \"Boss_01\",\n      gameLevel: 4,\n      displayName: \"Boss Approach\",\n      difficulty: \"Very Hard\",\n      x: 1390,\n      y: 360,\n      requires: [\"Level_04\"],\n      next: [],\n      tutorial: \"Boss node currently uses level 4 ruleset as a challenge endpoint.\",\n    },\n  ],\n};\n\nPlatformer.WorldMapData.getNodeById = function getNodeById(id) {\n  return this.nodes.find((n) => n.id === id) || null;\n};\n\nPlatformer.WorldMapData.getNodeForGameLevel = function getNodeForGameLevel(level) {\n  return this.nodes.find((n) => Number(n.gameLevel) === Number(level)) || null;\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.Progress = {\n  key: \"anime_platformer_progress_v1\",\n  data: null,\n\n  defaultData() {\n    return {\n      unlockedNodes: { Level_01: true },\n      completedNodes: {},\n      bestByNode: {},\n      tutorialSeenByNode: {},\n      lastSelectedNodeId: \"Level_01\",\n      lastMapPosition: null,\n      lastCompletedNodeId: null,\n      worlds: {},\n      walletCoins: 0,\n      upgradesOwned: {},\n      playerStats: { health: 0, speed: 1, dashCooldown: 1 },\n      version: 2,\n    };\n  },\n\n  ensureLoaded() {\n    if (!this.data) this.load();\n    return this.data;\n  },\n\n  load() {\n    try {\n      const raw = localStorage.getItem(this.key);\n      if (!raw) {\n        this.data = this.defaultData();\n        return this.data;\n      }\n      const parsed = JSON.parse(raw);\n      this.data = Object.assign(this.defaultData(), parsed || {});\n      this.data.unlockedNodes = Object.assign({ Level_01: true }, this.data.unlockedNodes || {});\n      this.data.completedNodes = Object.assign({}, this.data.completedNodes || {});\n      this.data.bestByNode = Object.assign({}, this.data.bestByNode || {});\n      this.data.tutorialSeenByNode = Object.assign({}, this.data.tutorialSeenByNode || {});\n      this.data.worlds = Object.assign({}, this.data.worlds || {});\n      this.data.walletCoins = Math.max(0, Number(this.data.walletCoins || 0));\n      this.data.upgradesOwned = Object.assign({}, this.data.upgradesOwned || {});\n      const ps = this.data.playerStats && typeof this.data.playerStats === \"object\" ? this.data.playerStats : {};\n      this.data.playerStats = {\n        health: Number(ps.health || 0),\n        speed: Number(ps.speed || 1),\n        dashCooldown: Number(ps.dashCooldown || 1),\n      };\n      return this.data;\n    } catch (_e) {\n      this.data = this.defaultData();\n      return this.data;\n    }\n  },\n\n  save() {\n    try {\n      this.ensureLoaded();\n      localStorage.setItem(this.key, JSON.stringify(this.data));\n    } catch (_e) {\n      // best effort local persistence\n    }\n  },\n\n  isUnlocked(nodeId) {\n    const d = this.ensureLoaded();\n    return !!d.unlockedNodes[nodeId];\n  },\n\n  setUnlocked(nodeId, unlocked = true) {\n    const d = this.ensureLoaded();\n    d.unlockedNodes[nodeId] = !!unlocked;\n    this.save();\n  },\n\n  markTutorialSeen(nodeId) {\n    const d = this.ensureLoaded();\n    d.tutorialSeenByNode[nodeId] = true;\n    this.save();\n  },\n\n  hasSeenTutorial(nodeId) {\n    const d = this.ensureLoaded();\n    return !!d.tutorialSeenByNode[nodeId];\n  },\n\n  updateMapPosition(pos) {\n    const d = this.ensureLoaded();\n    d.lastMapPosition = pos ? { x: Number(pos.x) || 0, y: Number(pos.y) || 0 } : null;\n    this.save();\n  },\n\n  ensureWorldState(world) {\n    const d = this.ensureLoaded();\n    const worldId = world && world.id ? String(world.id) : \"world_tutorial\";\n    if (!d.worlds[worldId]) {\n      d.worlds[worldId] = {\n        unlockedNodes: {},\n        completedNodes: {},\n        bestByNode: {},\n        tutorialSeenByNode: {},\n        lastSelectedNodeId: null,\n        lastCompletedNodeId: null,\n      };\n    }\n    const ws = d.worlds[worldId];\n    ws.unlockedNodes = Object.assign({}, ws.unlockedNodes || {});\n    ws.completedNodes = Object.assign({}, ws.completedNodes || {});\n    ws.bestByNode = Object.assign({}, ws.bestByNode || {});\n    ws.tutorialSeenByNode = Object.assign({}, ws.tutorialSeenByNode || {});\n\n    const startNodeId = world && world.startNodeId ? String(world.startNodeId) : null;\n    if (startNodeId && !ws.unlockedNodes[startNodeId]) ws.unlockedNodes[startNodeId] = true;\n    const edges = Array.isArray(world && world.edges) ? world.edges : [];\n    edges.forEach((edge) => {\n      if (!edge || String(edge.from) !== String(startNodeId)) return;\n      if (!edge.unlockRule && edge.to) ws.unlockedNodes[String(edge.to)] = true;\n    });\n    this.propagateWorldUnlocks(world, ws);\n    if (!ws.lastSelectedNodeId) ws.lastSelectedNodeId = startNodeId;\n    return ws;\n  },\n\n  isWorldNodeUnlocked(world, nodeId) {\n    const ws = this.ensureWorldState(world);\n    return !!ws.unlockedNodes[String(nodeId)];\n  },\n\n  isWorldNodeCompleted(world, nodeId) {\n    const ws = this.ensureWorldState(world);\n    return !!ws.completedNodes[String(nodeId)];\n  },\n\n  getWorldNodeBest(world, nodeId) {\n    const ws = this.ensureWorldState(world);\n    return ws.bestByNode[String(nodeId)] || null;\n  },\n\n  setWorldSelectedNode(world, nodeId) {\n    const ws = this.ensureWorldState(world);\n    ws.lastSelectedNodeId = String(nodeId || \"\");\n    this.save();\n  },\n\n  hasSeenWorldTutorial(world, nodeId) {\n    const ws = this.ensureWorldState(world);\n    return !!ws.tutorialSeenByNode[String(nodeId)];\n  },\n\n  markWorldTutorialSeen(world, nodeId) {\n    const ws = this.ensureWorldState(world);\n    ws.tutorialSeenByNode[String(nodeId)] = true;\n    this.save();\n  },\n\n  evaluateUnlockRule(rule, completedMap) {\n    if (!rule) return true;\n    const s = String(rule);\n    if (s.startsWith(\"complete:\")) {\n      const id = s.slice(\"complete:\".length);\n      return !!completedMap[id];\n    }\n    return true;\n  },\n\n  propagateWorldUnlocks(world, ws) {\n    const startNodeId = world && world.startNodeId ? String(world.startNodeId) : null;\n    const edges = Array.isArray(world && world.edges) ? world.edges : [];\n    const prevUnlocked = Object.assign({}, ws.unlockedNodes || {});\n    const rebuiltUnlocked = {};\n    if (startNodeId) rebuiltUnlocked[startNodeId] = true;\n    Object.keys(ws.completedNodes || {}).forEach((id) => {\n      if (ws.completedNodes[id]) rebuiltUnlocked[String(id)] = true;\n    });\n\n    let changed = true;\n    let guard = 0;\n    while (changed && guard < 64) {\n      guard += 1;\n      changed = false;\n      edges.forEach((edge) => {\n        if (!edge || !edge.from || !edge.to) return;\n        const fromId = String(edge.from);\n        const toId = String(edge.to);\n        if (!rebuiltUnlocked[fromId]) return;\n        const canUnlock = this.evaluateUnlockRule(edge.unlockRule, ws.completedNodes);\n        if (!canUnlock) return;\n        if (!rebuiltUnlocked[toId]) {\n          rebuiltUnlocked[toId] = true;\n          changed = true;\n        }\n      });\n    }\n\n    ws.unlockedNodes = rebuiltUnlocked;\n    const prevKeys = Object.keys(prevUnlocked).filter((k) => prevUnlocked[k]);\n    const nextKeys = Object.keys(rebuiltUnlocked).filter((k) => rebuiltUnlocked[k]);\n    const pruned = prevKeys.filter((k) => !rebuiltUnlocked[k]).length;\n    const added = nextKeys.filter((k) => !prevUnlocked[k]).length;\n    if ((added > 0 || pruned > 0) && Platformer.Debug) {\n      Platformer.Debug.log(\n        \"Progress.world\",\n        `Reconciled unlocks in ${world && world.id ? world.id : \"world\"}: +${added}, -${pruned}, total=${nextKeys.length}.`\n      );\n    }\n  },\n\n  applyWorldUnlockGraph(world, completedNodeId) {\n    const ws = this.ensureWorldState(world);\n    const completed = ws.completedNodes;\n    const unlocked = ws.unlockedNodes;\n    const edges = Array.isArray(world && world.edges) ? world.edges : [];\n    edges.forEach((edge) => {\n      if (!edge || String(edge.from) !== String(completedNodeId)) return;\n      const canUnlock = this.evaluateUnlockRule(edge.unlockRule, completed);\n      if (canUnlock && edge.to) unlocked[String(edge.to)] = true;\n    });\n    this.propagateWorldUnlocks(world, ws);\n  },\n\n  markWorldLevelCompleted(world, payload) {\n    const ws = this.ensureWorldState(world);\n    const nodeId = payload && payload.nodeId ? String(payload.nodeId) : null;\n    if (!nodeId) return null;\n    const firstClear = !ws.completedNodes[nodeId];\n\n    ws.completedNodes[nodeId] = true;\n    ws.unlockedNodes[nodeId] = true;\n    ws.lastCompletedNodeId = nodeId;\n    ws.lastSelectedNodeId = nodeId;\n\n    const coins = Number(payload && payload.coins ? payload.coins : 0);\n    const timeLeft = Number(payload && payload.timeLeft ? payload.timeLeft : 0);\n    const prev = ws.bestByNode[nodeId] || { bestCoins: 0, bestTimeLeft: 0 };\n    ws.bestByNode[nodeId] = {\n      bestCoins: Math.max(prev.bestCoins || 0, coins),\n      bestTimeLeft: Math.max(prev.bestTimeLeft || 0, timeLeft),\n    };\n\n    if (firstClear && coins > 0) {\n      const d = this.ensureLoaded();\n      d.walletCoins = Math.max(0, Number(d.walletCoins || 0) + coins);\n      if (Platformer.Debug) Platformer.Debug.log(\"Progress.shop\", `Awarded ${coins} coins for first clear of ${nodeId}. Wallet=${d.walletCoins}`);\n    }\n\n    this.applyWorldUnlockGraph(world, nodeId);\n    this.save();\n    return nodeId;\n  },\n\n  getWalletCoins() {\n    const d = this.ensureLoaded();\n    return Math.max(0, Number(d.walletCoins || 0));\n  },\n\n  getOwnedUpgradeCount(upgradeId) {\n    const d = this.ensureLoaded();\n    return Math.max(0, Number((d.upgradesOwned || {})[String(upgradeId || \"\")] || 0));\n  },\n\n  getPlayerStats() {\n    const d = this.ensureLoaded();\n    const ps = d.playerStats || {};\n    return {\n      health: Number(ps.health || 0),\n      speed: Number(ps.speed || 1),\n      dashCooldown: Number(ps.dashCooldown || 1),\n    };\n  },\n\n  purchaseUpgrade(item) {\n    const d = this.ensureLoaded();\n    if (!item || !item.id) return { ok: false, message: \"Invalid item.\" };\n    const itemId = String(item.id);\n    const cost = Math.max(0, Number(item.cost || 0));\n    const max = Math.max(1, Number(item.max || 1));\n    const owned = this.getOwnedUpgradeCount(itemId);\n    if (owned >= max) return { ok: false, message: \"Already maxed.\" };\n    const coins = this.getWalletCoins();\n    if (coins < cost) return { ok: false, message: \"Not enough coins.\" };\n\n    d.walletCoins = coins - cost;\n    d.upgradesOwned[itemId] = owned + 1;\n    d.playerStats = d.playerStats || { health: 0, speed: 1, dashCooldown: 1 };\n    const stat = String(item.stat || \"\");\n    const delta = Number(item.delta || 0);\n    if (stat === \"health\") {\n      d.playerStats.health = Number(d.playerStats.health || 0) + delta;\n    } else if (stat === \"speed\") {\n      d.playerStats.speed = Number(d.playerStats.speed || 1) + delta;\n    } else if (stat === \"dashCooldown\") {\n      d.playerStats.dashCooldown = Number(d.playerStats.dashCooldown || 1) + delta;\n    }\n    this.save();\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\"Progress.shop\", `Purchased ${itemId} cost=${cost} owned=${d.upgradesOwned[itemId]} wallet=${d.walletCoins}`);\n    }\n    return { ok: true, walletCoins: d.walletCoins, owned: d.upgradesOwned[itemId], stats: this.getPlayerStats() };\n  },\n\n  markLevelCompleted(payload) {\n    const manager = Platformer.WorldMapManager || null;\n    const targetWorldId = payload && payload.worldId ? String(payload.worldId) : null;\n    const activeWorld = manager && typeof manager.getCached === \"function\" && targetWorldId\n      ? manager.getCached(targetWorldId)\n      : (manager && typeof manager.getActiveWorld === \"function\" ? manager.getActiveWorld() : null);\n    const incomingNodeId = payload && payload.nodeId ? String(payload.nodeId) : null;\n    if (activeWorld && incomingNodeId && manager && typeof manager.getNodeById === \"function\" && manager.getNodeById(activeWorld, incomingNodeId)) {\n      return this.markWorldLevelCompleted(activeWorld, payload);\n    }\n\n    const fallbackActiveWorld = manager && typeof manager.getActiveWorld === \"function\"\n      ? manager.getActiveWorld()\n      : null;\n    if (fallbackActiveWorld && incomingNodeId && manager && typeof manager.getNodeById === \"function\" && manager.getNodeById(fallbackActiveWorld, incomingNodeId)) {\n      return this.markWorldLevelCompleted(fallbackActiveWorld, payload);\n    }\n\n    const d = this.ensureLoaded();\n    const nodeId = payload && payload.nodeId ? payload.nodeId : null;\n    const levelNum = payload && payload.level ? Number(payload.level) : 1;\n    const mapNode = nodeId ? Platformer.WorldMapData.getNodeById(nodeId) : Platformer.WorldMapData.getNodeForGameLevel(levelNum);\n    const resolvedNodeId = mapNode ? mapNode.id : `Level_${String(levelNum).padStart(2, \"0\")}`;\n\n    d.completedNodes[resolvedNodeId] = true;\n    d.lastCompletedNodeId = resolvedNodeId;\n\n    const coins = Number(payload && payload.coins ? payload.coins : 0);\n    const timeLeft = Number(payload && payload.timeLeft ? payload.timeLeft : 0);\n    const prev = d.bestByNode[resolvedNodeId] || { bestCoins: 0, bestTimeLeft: 0 };\n    d.bestByNode[resolvedNodeId] = {\n      bestCoins: Math.max(prev.bestCoins || 0, coins),\n      bestTimeLeft: Math.max(prev.bestTimeLeft || 0, timeLeft),\n    };\n\n    this.setUnlocked(resolvedNodeId, true);\n    this.applyUnlockGraph(resolvedNodeId);\n    this.save();\n    return resolvedNodeId;\n  },\n\n  applyUnlockGraph(completedNodeId) {\n    const d = this.ensureLoaded();\n    const completed = d.completedNodes;\n    const unlocked = d.unlockedNodes;\n\n    const node = Platformer.WorldMapData.getNodeById(completedNodeId);\n    if (!node || !Array.isArray(node.next)) return;\n\n    node.next.forEach((nextId) => {\n      const nextNode = Platformer.WorldMapData.getNodeById(nextId);\n      if (!nextNode) return;\n      const req = Array.isArray(nextNode.requires) ? nextNode.requires : [];\n      const ok = req.every((id) => !!completed[id]);\n      if (ok) unlocked[nextId] = true;\n    });\n  },\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.LevelNode = class LevelNode {\n  constructor(scene, data, progress, rootContainer) {\n    this.scene = scene;\n    this.data = data;\n    this.progress = progress;\n    this.id = data.id;\n    this.unlocked = !!progress.isUnlocked(this.id);\n    this.selected = false;\n    this.radius = data.triggerRadius || 40;\n\n    this.pathGlow = null;\n    this.node = scene.add.circle(data.x, data.y, 18, this.unlocked ? 0x38bdf8 : 0x475569, 0.92)\n      .setStrokeStyle(3, this.unlocked ? 0xe0f2fe : 0x64748b, 0.9)\n      .setDepth(20);\n    this.inner = scene.add.circle(data.x, data.y, 9, this.unlocked ? 0xfacc15 : 0x334155, this.unlocked ? 1 : 0.85)\n      .setDepth(21);\n    this.label = scene.add.text(data.x, data.y - 30, data.displayName || data.id, {\n      fontFamily: \"Consolas\",\n      fontSize: \"16px\",\n      color: this.unlocked ? \"#e2e8f0\" : \"#94a3b8\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n      align: \"center\",\n    }).setOrigin(0.5).setDepth(22);\n\n    if (rootContainer && rootContainer.add) {\n      rootContainer.add([this.node, this.inner, this.label]);\n    }\n  }\n\n  refreshUnlock() {\n    this.unlocked = !!this.progress.isUnlocked(this.id);\n    this.node.setFillStyle(this.unlocked ? 0x38bdf8 : 0x475569, 0.92);\n    this.node.setStrokeStyle(3, this.unlocked ? 0xe0f2fe : 0x64748b, 0.9);\n    this.inner.setFillStyle(this.unlocked ? 0xfacc15 : 0x334155, this.unlocked ? 1 : 0.85);\n    this.label.setColor(this.unlocked ? \"#e2e8f0\" : \"#94a3b8\");\n  }\n\n  setSelected(active) {\n    if (this.selected === active) return;\n    this.selected = active;\n    if (active) {\n      this.node.setScale(1.15);\n      this.inner.setScale(1.2);\n      this.node.setFillStyle(this.unlocked ? 0x22d3ee : 0x64748b, 1);\n    } else {\n      this.node.setScale(1);\n      this.inner.setScale(1);\n      this.refreshUnlock();\n    }\n  }\n\n  inRange(x, y) {\n    const dx = x - this.data.x;\n    const dy = y - this.data.y;\n    return Math.sqrt(dx * dx + dy * dy) <= this.radius;\n  }\n\n  destroy() {\n    if (this.node) this.node.destroy();\n    if (this.inner) this.inner.destroy();\n    if (this.label) this.label.destroy();\n    if (this.pathGlow) this.pathGlow.destroy();\n  }\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.PlayerMapController = class PlayerMapController {\n  constructor(scene, sprite, bounds, blockedRegions) {\n    this.scene = scene;\n    this.sprite = sprite;\n    this.bounds = bounds;\n    this.blockedRegions = blockedRegions || [];\n    this.velocity = new Phaser.Math.Vector2(0, 0);\n    this.maxSpeed = 220;\n    this.accel = 980;\n    this.drag = 1100;\n  }\n\n  isBlocked(nextX, nextY) {\n    return this.blockedRegions.some((r) => {\n      return nextX >= r.x && nextX <= (r.x + r.width) && nextY >= r.y && nextY <= (r.y + r.height);\n    });\n  }\n\n  update(input, deltaMs) {\n    const dt = Math.max(0.001, deltaMs / 1000);\n    const dir = new Phaser.Math.Vector2(\n      (input.left ? -1 : 0) + (input.right ? 1 : 0),\n      (input.up ? -1 : 0) + (input.down ? 1 : 0)\n    );\n    if (dir.lengthSq() > 0) dir.normalize();\n\n    const targetVX = dir.x * this.maxSpeed;\n    const targetVY = dir.y * this.maxSpeed;\n\n    this.velocity.x = Phaser.Math.Linear(this.velocity.x, targetVX, Phaser.Math.Clamp(this.accel * dt / this.maxSpeed, 0, 1));\n    this.velocity.y = Phaser.Math.Linear(this.velocity.y, targetVY, Phaser.Math.Clamp(this.accel * dt / this.maxSpeed, 0, 1));\n\n    if (dir.lengthSq() === 0) {\n      const dragStep = this.drag * dt;\n      this.velocity.x = Math.abs(this.velocity.x) <= dragStep ? 0 : this.velocity.x - Math.sign(this.velocity.x) * dragStep;\n      this.velocity.y = Math.abs(this.velocity.y) <= dragStep ? 0 : this.velocity.y - Math.sign(this.velocity.y) * dragStep;\n    }\n\n    let nx = this.sprite.x + this.velocity.x * dt;\n    let ny = this.sprite.y + this.velocity.y * dt;\n\n    nx = Phaser.Math.Clamp(nx, this.bounds.x + 14, this.bounds.x + this.bounds.width - 14);\n    ny = Phaser.Math.Clamp(ny, this.bounds.y + 14, this.bounds.y + this.bounds.height - 14);\n\n    if (!this.isBlocked(nx, this.sprite.y)) {\n      this.sprite.x = nx;\n    } else {\n      this.velocity.x = 0;\n    }\n    if (!this.isBlocked(this.sprite.x, ny)) {\n      this.sprite.y = ny;\n    } else {\n      this.velocity.y = 0;\n    }\n\n    if (Math.abs(this.velocity.x) > 8) {\n      this.sprite.setFlipX(this.velocity.x < 0);\n    }\n\n    return {\n      speed: this.velocity.length(),\n      moving: Math.abs(this.velocity.x) > 8 || Math.abs(this.velocity.y) > 8,\n    };\n  }\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.WorldMapUI = class WorldMapUI {\n  constructor(scene) {\n    this.scene = scene;\n    this.infoPanel = null;\n    this.infoTitle = null;\n    this.infoBody = null;\n    this.hintText = null;\n    this.backText = null;\n    this.helpButton = null;\n    this.helpButtonText = null;\n    this.helpPanel = null;\n    this.helpPanelText = null;\n    this.helpOpen = false;\n    this.debugText = null;\n    this.resize();\n  }\n\n  buildIfMissing() {\n    if (this.infoPanel) return;\n    this.infoPanel = this.scene.add.rectangle(18, 18, 340, 220, 0x0f172a, 0.82)\n      .setOrigin(0, 0)\n      .setStrokeStyle(2, 0x7dd3fc, 0.75)\n      .setScrollFactor(0)\n      .setDepth(70);\n    this.infoTitle = this.scene.add.text(30, 30, \"Map Node\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"22px\",\n      color: \"#f8fafc\",\n      stroke: \"#020617\",\n      strokeThickness: 4,\n    }).setDepth(71);\n    this.infoTitle.setScrollFactor(0);\n    this.infoBody = this.scene.add.text(30, 62, \"Walk onto a node.\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"16px\",\n      color: \"#cbd5e1\",\n      lineSpacing: 4,\n      wordWrap: { width: 315 },\n    }).setDepth(71);\n    this.infoBody.setScrollFactor(0);\n\n    this.hintText = this.scene.add.text(24, 252, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#fef3c7\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n    }).setDepth(71);\n    this.hintText.setScrollFactor(0);\n\n    this.backText = this.scene.add.text(24, this.scene.scale.height - 34, \"ESC: Back to Menu\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#e2e8f0\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n    }).setDepth(71);\n    this.backText.setScrollFactor(0);\n\n    this.helpButton = this.scene.add.rectangle(this.scene.scale.width - 85, 34, 132, 34, 0x1d4ed8, 0.96)\n      .setStrokeStyle(2, 0x93c5fd, 0.85)\n      .setScrollFactor(0)\n      .setDepth(72)\n      .setInteractive({ useHandCursor: true });\n    this.helpButtonText = this.scene.add.text(this.scene.scale.width - 85, 34, \"Info (H)\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#f8fafc\",\n    }).setOrigin(0.5).setDepth(73);\n    this.helpButtonText.setScrollFactor(0);\n    this.helpButton.on(\"pointerdown\", () => this.toggleHelp());\n\n    this.helpPanel = this.scene.add.rectangle(this.scene.scale.width / 2, this.scene.scale.height / 2, 620, 300, 0x020617, 0.9)\n      .setStrokeStyle(2, 0x67e8f9, 0.9)\n      .setScrollFactor(0)\n      .setDepth(90)\n      .setVisible(false)\n      .setInteractive();\n    this.helpPanelText = this.scene.add.text(this.scene.scale.width / 2 - 290, this.scene.scale.height / 2 - 130,\n      \"World Map Help\\n\\n- Move: WASD / Arrow Keys\\n- Select node by walking onto it\\n- Enter level: E or Enter\\n- Back to menu: ESC\\n\\nNode tips appear per-level when first selected.\\nThis panel is optional and never blocks map movement.\", {\n        fontFamily: \"Consolas\",\n        fontSize: \"20px\",\n        color: \"#e2e8f0\",\n        lineSpacing: 6,\n        wordWrap: { width: 570 },\n      }).setDepth(91).setVisible(false);\n    this.helpPanelText.setScrollFactor(0);\n    this.helpPanel.on(\"pointerdown\", () => this.toggleHelp(false));\n\n    this.debugText = this.scene.add.text(this.scene.scale.width - 14, this.scene.scale.height - 14, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"14px\",\n      color: \"#93c5fd\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n      align: \"right\",\n    }).setOrigin(1, 1).setDepth(71);\n    this.debugText.setScrollFactor(0);\n  }\n\n  updateNodeInfo(node, best, unlocked, showInteractHint, tutorialHint) {\n    this.buildIfMissing();\n    if (!node) {\n      this.infoTitle.setText(\"Map Node\");\n      this.infoBody.setText(\"Walk onto a node.\");\n      this.hintText.setText(\"\");\n      return;\n    }\n\n    const bestCoins = best && Number.isFinite(best.bestCoins) ? best.bestCoins : 0;\n    const bestTime = best && Number.isFinite(best.bestTimeLeft) ? best.bestTimeLeft : 0;\n    this.infoTitle.setText(`${node.displayName} (${node.levelId})`);\n    this.infoBody.setText([\n      `Difficulty: ${node.difficulty || \"Unknown\"}`,\n      `State: ${unlocked ? \"Unlocked\" : \"Locked\"}`,\n      `Best Coins: ${bestCoins}`,\n      `Best Time Left: ${bestTime}s`,\n      \"\",\n      tutorialHint || \"\",\n    ].join(\"\\n\").trim());\n    this.reflowInfoPanel();\n\n    if (showInteractHint && unlocked) {\n      this.hintText.setText(\"Press E / ENTER to play this level\");\n    } else if (!unlocked) {\n      this.hintText.setText(\"Locked: clear required previous node(s)\");\n    } else {\n      this.hintText.setText(\"\");\n    }\n  }\n\n  setDebug(text) {\n    this.buildIfMissing();\n    this.debugText.setText(String(text || \"\"));\n  }\n\n  toggleHelp(force) {\n    this.buildIfMissing();\n    if (typeof force === \"boolean\") this.helpOpen = force;\n    else this.helpOpen = !this.helpOpen;\n    this.helpPanel.setVisible(this.helpOpen);\n    this.helpPanelText.setVisible(this.helpOpen);\n  }\n\n  resize() {\n    this.buildIfMissing();\n    const w = this.scene.scale.width;\n    const h = this.scene.scale.height;\n    this.backText.setPosition(24, h - 34);\n    this.helpButton.setPosition(w - 85, 34);\n    this.helpButtonText.setPosition(w - 85, 34);\n    this.helpPanel.setPosition(w / 2, h / 2);\n    this.helpPanelText.setPosition(w / 2 - 290, h / 2 - 130);\n    this.debugText.setPosition(w - 14, h - 14);\n    this.reflowInfoPanel();\n  }\n\n  reflowInfoPanel() {\n    if (!this.infoPanel || !this.infoBody || !this.infoTitle || !this.hintText) return;\n    const minHeight = 220;\n    const padTop = 12;\n    const bodyTop = 62;\n    const bottomPad = 16;\n    const contentBottom = bodyTop + this.infoBody.height + bottomPad;\n    const panelHeight = Math.max(minHeight, Math.ceil(contentBottom + padTop));\n    this.infoPanel.setSize(this.infoPanel.width, panelHeight);\n    this.hintText.setPosition(this.infoPanel.x + 6, this.infoPanel.y + panelHeight + 10);\n  }\n\n  destroy() {\n    [\n      this.infoPanel,\n      this.infoTitle,\n      this.infoBody,\n      this.hintText,\n      this.backText,\n      this.helpButton,\n      this.helpButtonText,\n      this.helpPanel,\n      this.helpPanelText,\n      this.debugText,\n    ].forEach((el) => {\n      if (el && el.destroy) el.destroy();\n    });\n  }\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.WorldMapShopPanel = class WorldMapShopPanel {\n  constructor(scene) {\n    this.scene = scene;\n    this.root = null;\n    this.title = null;\n    this.wallet = null;\n    this.body = null;\n    this.footer = null;\n    this.visible = false;\n    this.shop = null;\n    this.selected = 0;\n    this.onClose = null;\n  }\n\n  build() {\n    if (this.root) return;\n    const w = this.scene.scale.width;\n    const h = this.scene.scale.height;\n    this.root = this.scene.add.container(w / 2, h / 2).setDepth(120).setVisible(false);\n\n    const bg = this.scene.add.rectangle(0, 0, 620, 360, 0x020617, 0.92)\n      .setStrokeStyle(2, 0x7dd3fc, 0.9);\n    this.title = this.scene.add.text(-292, -160, \"SHOP\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"30px\",\n      color: \"#f8fafc\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n    });\n    this.wallet = this.scene.add.text(292, -160, \"Coins: 0\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"20px\",\n      color: \"#fcd34d\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n      align: \"right\",\n    }).setOrigin(1, 0);\n    this.body = this.scene.add.text(-292, -112, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"22px\",\n      color: \"#e2e8f0\",\n      lineSpacing: 8,\n      wordWrap: { width: 584 },\n    });\n    this.footer = this.scene.add.text(-292, 136, \"UP/DOWN choose  ENTER buy  ESC close\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#93c5fd\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n    });\n\n    this.root.add([bg, this.title, this.wallet, this.body, this.footer]);\n  }\n\n  open(shop, onClose) {\n    this.build();\n    this.shop = shop || { id: \"shop\", name: \"Shop\", items: [] };\n    this.selected = 0;\n    this.onClose = typeof onClose === \"function\" ? onClose : null;\n    this.visible = true;\n    this.root.setVisible(true);\n    this.resize();\n    this.refresh();\n    if (Platformer.Debug) Platformer.Debug.log(\"WorldMap.shop\", `Opened shop=${this.shop.id} items=${(this.shop.items || []).length}`);\n  }\n\n  close() {\n    if (!this.visible) return;\n    this.visible = false;\n    if (this.root) this.root.setVisible(false);\n    const cb = this.onClose;\n    this.onClose = null;\n    this.shop = null;\n    if (cb) cb();\n    if (Platformer.Debug) Platformer.Debug.log(\"WorldMap.shop\", \"Closed shop panel.\");\n  }\n\n  moveSelection(dir) {\n    if (!this.visible || !this.shop || !Array.isArray(this.shop.items) || this.shop.items.length === 0) return;\n    const n = this.shop.items.length;\n    this.selected = (this.selected + dir + n) % n;\n    this.refresh();\n  }\n\n  tryBuySelected() {\n    if (!this.visible || !this.shop || !Array.isArray(this.shop.items) || this.shop.items.length === 0) return;\n    const item = this.shop.items[this.selected];\n    const res = Platformer.Progress.purchaseUpgrade(item);\n    if (!res || !res.ok) {\n      Platformer.beeper.damage();\n      if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.shop\", `Purchase denied: ${res && res.message ? res.message : \"unknown\"}`);\n    } else {\n      Platformer.beeper.coin();\n    }\n    this.refresh();\n  }\n\n  refresh() {\n    if (!this.visible || !this.shop) return;\n    const coins = Platformer.Progress.getWalletCoins();\n    this.title.setText(this.shop.name || \"Shop\");\n    this.wallet.setText(`Coins: ${coins}`);\n    const items = Array.isArray(this.shop.items) ? this.shop.items : [];\n    if (!items.length) {\n      this.body.setText(\"No items available.\");\n      return;\n    }\n    const lines = [];\n    items.forEach((it, idx) => {\n      const owned = Platformer.Progress.getOwnedUpgradeCount(it.id);\n      const max = Math.max(1, Number(it.max || 1));\n      const soldOut = owned >= max;\n      const afford = coins >= Number(it.cost || 0);\n      const marker = idx === this.selected ? \"> \" : \"  \";\n      const state = soldOut ? \"MAX\" : (afford ? \"BUY\" : \"LOCK\");\n      lines.push(`${marker}${it.label}  [${it.cost}]  (${owned}/${max})  ${state}`);\n      if (idx === this.selected) {\n        lines.push(`   ${it.stat} ${Number(it.delta) >= 0 ? \"+\" : \"\"}${it.delta}`);\n      }\n    });\n    this.body.setText(lines.join(\"\\n\"));\n  }\n\n  handleInput(justInput) {\n    if (!this.visible) return false;\n    if (justInput.up) {\n      this.moveSelection(-1);\n      return true;\n    }\n    if (justInput.down) {\n      this.moveSelection(1);\n      return true;\n    }\n    if (justInput.interact) {\n      this.tryBuySelected();\n      return true;\n    }\n    return true;\n  }\n\n  resize() {\n    if (!this.root) return;\n    this.root.setPosition(this.scene.scale.width / 2, this.scene.scale.height / 2);\n  }\n\n  destroy() {\n    if (this.root) this.root.destroy(true);\n    this.root = null;\n  }\n};\n\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.Beeper = class {\n  constructor() {\n    this.ctx = null;\n    this.enabled = true;\n  }\n\n  unlock() {\n    if (!this.enabled) return;\n    if (!this.ctx) {\n      const AudioCtx = window.AudioContext || window.webkitAudioContext;\n      if (!AudioCtx) {\n        this.enabled = false;\n        return;\n      }\n      this.ctx = new AudioCtx();\n    }\n    if (this.ctx.state === \"suspended\") {\n      this.ctx.resume();\n    }\n  }\n\n  tone(freq, duration, type = \"square\", gainValue = 0.05) {\n    if (!this.ctx || !this.enabled) return;\n    const settings = Platformer.Settings ? Platformer.Settings.current : null;\n    if (settings && !settings.accessibility.audioCues) return;\n\n    let mix = 1;\n    if (settings) {\n      mix = (settings.audio.master / 100) * (settings.audio.sfx / 100);\n      if (settings.audio.muteWhenUnfocused && document.hidden) {\n        mix = 0;\n      }\n    }\n    if (mix <= 0) return;\n\n    const now = this.ctx.currentTime;\n    const osc = this.ctx.createOscillator();\n    const gain = this.ctx.createGain();\n    osc.type = type;\n    osc.frequency.setValueAtTime(freq, now);\n    gain.gain.setValueAtTime(gainValue * mix, now);\n    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);\n    osc.connect(gain);\n    gain.connect(this.ctx.destination);\n    osc.start(now);\n    osc.stop(now + duration);\n  }\n\n  jump() {\n    this.tone(420, 0.08, \"square\", 0.05);\n  }\n\n  coin() {\n    this.tone(880, 0.06, \"triangle\", 0.06);\n    this.tone(1320, 0.08, \"triangle\", 0.045);\n  }\n\n  damage() {\n    this.tone(180, 0.14, \"sawtooth\", 0.06);\n  }\n\n  stomp() {\n    this.tone(240, 0.09, \"square\", 0.055);\n  }\n\n  dash() {\n    this.tone(520, 0.05, \"triangle\", 0.05);\n    this.tone(340, 0.06, \"square\", 0.035);\n  }\n\n  attack() {\n    this.tone(300, 0.04, \"sawtooth\", 0.045);\n    this.tone(220, 0.05, \"square\", 0.03);\n  }\n\n  land() {\n    this.tone(140, 0.05, \"square\", 0.03);\n  }\n};\n\nPlatformer.beeper = new Platformer.Beeper();\n","window.Platformer = window.Platformer || {};\n\nPlatformer.JetpackController = class {\n  constructor(config, hooks) {\n    const defaults = Platformer.Config.JETPACK || {};\n    this.cfg = Object.assign({}, defaults, config || {});\n    this.hooks = Object.assign({\n      onJetpackStart: null,\n      onJetpackStop: null,\n    }, hooks || {});\n\n    this.fuel = this.cfg.fuelCapacity;\n    this.isThrusting = false;\n    this.airborne = false;\n    this.armedAfterTakeoff = false;\n    this.holdTime = 0;\n    this.currentAccel = 0;\n    this.currentThrustAccel = 0;\n    this.rampAlpha = 0;\n    this.phase = \"OFF\";\n    this.currentMaxUpSpeed = -Math.abs(this.cfg.maxUpSpeed || 150);\n    this.lastDebugAt = -9999;\n  }\n\n  reset(fullFuel = true) {\n    this.isThrusting = false;\n    this.airborne = false;\n    this.armedAfterTakeoff = false;\n    this.holdTime = 0;\n    this.currentAccel = 0;\n    this.currentThrustAccel = 0;\n    this.rampAlpha = 0;\n    this.phase = \"OFF\";\n    this.currentMaxUpSpeed = -Math.abs(this.cfg.maxUpSpeed || 150);\n    if (fullFuel) this.fuel = this.cfg.fuelCapacity;\n  }\n\n  get fuelPercent() {\n    if (!this.cfg.fuelCapacity) return 0;\n    return Phaser.Math.Clamp((this.fuel / this.cfg.fuelCapacity) * 100, 0, 100);\n  }\n\n  canUseInState(scene) {\n    if (!scene) return false;\n    if (scene.isDead || scene.levelComplete || scene.isDashing) return false;\n    // Guard rails for future state machines.\n    if (scene.isOnLadder || scene.isClimbing) return false;\n    if (scene.isInWater || scene.isSwimming) return false;\n    if (scene.isWallSliding || scene.isWallClinging) return false;\n    return true;\n  }\n\n  emitStart(scene) {\n    if (this.hooks.onJetpackStart) this.hooks.onJetpackStart(scene, this);\n    if (scene && scene.events && scene.events.emit) scene.events.emit(\"jetpack-start\", { fuelPercent: this.fuelPercent });\n  }\n\n  emitStop(scene, reason) {\n    if (this.hooks.onJetpackStop) this.hooks.onJetpackStop(scene, this, reason);\n    if (scene && scene.events && scene.events.emit) scene.events.emit(\"jetpack-stop\", { fuelPercent: this.fuelPercent, reason });\n  }\n\n  update(ctx) {\n    const {\n      scene,\n      player,\n      now,\n      dt,\n      grounded,\n      jumpHeld,\n      thrustHeld,\n      worldGravity,\n      jumpVelocity,\n    } = ctx;\n\n    if (!player || !player.body) {\n      return { isThrusting: false, fuelPercent: this.fuelPercent, accelApplied: 0, rampAlpha: 0, phase: \"OFF\" };\n    }\n\n    const body = player.body;\n    const prevThrust = this.isThrusting;\n    const maxAccel = Math.max(0, Number(this.cfg.maxAccel || worldGravity));\n    const rampUp = Math.max(0.001, Number(this.cfg.rampUpTime || 0.3));\n    const rampUpRate = maxAccel / rampUp;\n\n    if (grounded) {\n      this.airborne = false;\n      this.armedAfterTakeoff = false;\n      this.isThrusting = false;\n      this.holdTime = 0;\n      this.currentAccel = 0;\n      this.currentThrustAccel = 0;\n      this.rampAlpha = 0;\n      this.phase = \"OFF\";\n      this.fuel = Math.min(this.cfg.fuelCapacity, this.fuel + this.cfg.regenRate * dt);\n      player.setAccelerationY(0);\n      body.setGravityY(0);\n      if (prevThrust) this.emitStop(scene, \"landed\");\n      return { isThrusting: false, fuelPercent: this.fuelPercent, accelApplied: 0, rampAlpha: 0, phase: this.phase };\n    }\n\n    if (!this.airborne) {\n      this.airborne = true;\n      // Prevent accidental thrust from same press as takeoff jump.\n      this.armedAfterTakeoff = !jumpHeld;\n    } else if (!this.armedAfterTakeoff && !jumpHeld) {\n      this.armedAfterTakeoff = true;\n    }\n\n    const canUse = this.canUseInState(scene);\n    const wantsThrust = canUse && this.armedAfterTakeoff && thrustHeld && this.fuel > 0;\n\n    if (wantsThrust) {\n      this.holdTime += dt;\n      const vy = Number(body.velocity.y || 0);\n      const enteringThrust = !prevThrust;\n      const liftThreshold = Math.abs(Number(this.cfg.liftThresholdSpeed || 56));\n      const minHoldToLift = Math.max(0, Number(this.cfg.minHoldToLift || 0.2));\n      const isNearHover = vy <= liftThreshold;\n      const canLift = isNearHover || this.holdTime >= minHoldToLift;\n      this.phase = canLift ? \"LIFT\" : \"BRAKE\";\n\n      const hoverAccel = worldGravity * Number(this.cfg.hoverAccelFactor || 0.95);\n      const liftAccel = worldGravity * Number(this.cfg.liftAccelFactor || 1.1);\n      let targetAccel = canLift ? liftAccel : hoverAccel;\n      const maxThrustAccel = Math.max(0, Number(this.cfg.maxThrustAccel || maxAccel * 0.35));\n      const thrustFactor = Math.max(0, Number(this.cfg.thrustAccelFactor || 0.22));\n      const jumpAssistFactor = Math.max(0, Number(this.cfg.jumpAssistAccelFactor || 0.14));\n\n      // While braking a fast fall, cap upward anti-gravity so cancellation feels weighty.\n      if (!canLift && vy > 0) {\n        const brakeCap = Math.max(0, Number(this.cfg.brakeDecelMax || maxAccel));\n        targetAccel = Math.min(targetAccel, brakeCap);\n      }\n\n      targetAccel = Phaser.Math.Clamp(targetAccel, 0, maxAccel);\n      this.currentAccel = Phaser.Math.Clamp(\n        this.currentAccel + rampUpRate * dt,\n        0,\n        targetAccel\n      );\n      // Keep a dedicated thrust channel so gravity + thrust work together.\n      const phaseMult = canLift ? 1.0 : 0.35;\n      let targetThrustAccel = worldGravity * thrustFactor * phaseMult;\n      if (vy < 0) {\n        // Slight jump extension when thrusting while still rising.\n        targetThrustAccel += worldGravity * jumpAssistFactor;\n      }\n      targetThrustAccel = Phaser.Math.Clamp(targetThrustAccel, 0, maxThrustAccel);\n      this.currentThrustAccel = Phaser.Math.Clamp(\n        this.currentThrustAccel + (maxThrustAccel / rampUp) * dt,\n        0,\n        targetThrustAccel\n      );\n      this.rampAlpha = maxAccel > 0 ? Phaser.Math.Clamp(this.currentAccel / maxAccel, 0, 1) : 0;\n      this.isThrusting = this.currentAccel > 1;\n\n      this.fuel = Math.max(0, this.fuel - this.cfg.drainRate * dt);\n      if (enteringThrust) {\n        const baseMaxUp = -Math.abs(Number(this.cfg.maxUpSpeed || 150));\n        const momentumBoost = Math.max(0, Number(this.cfg.momentumBoostSpeed || 72));\n        const activationKick = Math.max(0, Number(this.cfg.activationKickSpeed || 34));\n        if (vy < 0) {\n          // Preserve upward momentum and allow a little extra lift.\n          this.currentMaxUpSpeed = Math.min(baseMaxUp, vy - momentumBoost);\n          player.setVelocityY(vy - activationKick);\n        } else {\n          this.currentMaxUpSpeed = baseMaxUp;\n        }\n      }\n      if (!prevThrust && this.isThrusting) this.emitStart(scene);\n\n      player.setAccelerationY(-this.currentThrustAccel);\n      // Anti-gravity offset: engine gravity (down) + this offset (up).\n      body.setGravityY(-this.currentAccel);\n\n      // Keep upward lift intentionally slow.\n      const maxUp = this.currentMaxUpSpeed;\n      if (body.velocity.y < maxUp) player.setVelocityY(maxUp);\n\n      if (this.fuel <= 0) {\n        this.holdTime = 0;\n        this.isThrusting = false;\n        this.phase = \"OFF\";\n        this.currentAccel = 0;\n        this.currentThrustAccel = 0;\n        this.currentMaxUpSpeed = -Math.abs(Number(this.cfg.maxUpSpeed || 150));\n        this.rampAlpha = 0;\n        player.setAccelerationY(0);\n        body.setGravityY(0);\n        this.emitStop(scene, \"fuel_empty\");\n      }\n    } else {\n      this.holdTime = 0;\n      this.phase = \"OFF\";\n      this.isThrusting = false;\n      this.currentMaxUpSpeed = -Math.abs(Number(this.cfg.maxUpSpeed || 150));\n      this.currentAccel = 0;\n      this.currentThrustAccel = 0;\n      this.rampAlpha = 0;\n      player.setAccelerationY(0);\n      body.setGravityY(0);\n      if (prevThrust) this.emitStop(scene, canUse ? \"released\" : \"state_blocked\");\n    }\n\n    if (Platformer.DEBUG_JETPACK && Platformer.Debug && now - this.lastDebugAt > 220) {\n      this.lastDebugAt = now;\n      Platformer.Debug.log(\n        \"Jetpack.debug\",\n        `grounded=${grounded} fuel=${this.fuelPercent.toFixed(0)} thrust=${this.isThrusting} vy=${Math.round(body.velocity.y)} accel=${Math.round(this.currentAccel + this.currentThrustAccel)} ramp=${this.rampAlpha.toFixed(2)} phase=${this.phase} maxUp=${Math.round(this.currentMaxUpSpeed)}`\n      );\n    }\n\n    return {\n      isThrusting: this.isThrusting,\n      fuelPercent: this.fuelPercent,\n      accelApplied: this.currentAccel + this.currentThrustAccel,\n      rampAlpha: this.rampAlpha,\n      phase: this.phase,\n    };\n  }\n};\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[1] = function buildLevel1(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Ground with wide, readable gaps.\n  line(12, 15, 17, \".\");\n  line(34, 37, 17, \".\");\n  line(58, 61, 17, \".\");\n  line(78, 81, 17, \".\");\n\n  // Broad patrol islands.\n  rect(0, 16, 7, 16, \"#\");\n  rect(18, 16, 25, 16, \"#\");\n  rect(40, 16, 47, 16, \"#\");\n  rect(64, 16, 71, 16, \"#\");\n  rect(84, 16, 89, 16, \"#\");\n\n  // Platforms.\n  line(8, 13, 12, \"=\");\n  line(23, 29, 11, \"=\");\n  line(44, 50, 10, \"=\");\n  line(66, 73, 9, \"=\");\n\n  many([[3, 16]], \"S\");\n  many([[27, 10], [69, 8]], \"K\");\n  many([[10, 11], [24, 10], [28, 10], [45, 9], [49, 9], [67, 8], [72, 8], [86, 15], [88, 15], [20, 15]], \"C\");\n  many([[25, 10], [46, 9], [68, 8], [86, 15]], \"^\");\n  manyEnemies([[20, 16, \"E\"], [43, 16, \"E\"], [66, 16, \"E\"], [86, 16, \"E\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[2] = function buildLevel2(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Vertical rooftop style with wide landing zones.\n  line(14, 18, 17, \".\");\n  line(38, 42, 17, \".\");\n  line(62, 66, 17, \".\");\n\n  rect(0, 16, 10, 16, \"#\");\n  rect(22, 16, 30, 16, \"#\");\n  rect(46, 16, 54, 16, \"#\");\n  rect(70, 16, 89, 16, \"#\");\n\n  rect(14, 14, 18, 14, \"#\");\n  rect(38, 13, 42, 13, \"#\");\n  rect(62, 12, 66, 12, \"#\");\n\n  line(9, 15, 12, \"=\");\n  line(27, 34, 10, \"=\");\n  line(49, 56, 8, \"=\");\n  line(71, 79, 7, \"=\");\n\n  many([[4, 16]], \"S\");\n  many([[33, 9], [74, 6]], \"K\");\n  many([[12, 11], [29, 9], [33, 9], [50, 7], [55, 7], [72, 6], [78, 6], [86, 15], [25, 15], [47, 15]], \"C\");\n  many([[31, 9], [53, 7], [75, 6], [85, 15]], \"^\");\n  manyEnemies([[24, 16, \"F\"], [48, 16, \"F\"], [72, 16, \"F\"], [84, 16, \"F\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[3] = function buildLevel3(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Dash-pressure lanes, but no trap cracks for enemies.\n  line(10, 13, 17, \".\");\n  line(28, 31, 17, \".\");\n  line(46, 49, 17, \".\");\n  line(64, 67, 17, \".\");\n  line(80, 83, 17, \".\");\n\n  rect(0, 16, 6, 16, \"#\");\n  rect(16, 16, 23, 16, \"#\");\n  rect(34, 16, 41, 16, \"#\");\n  rect(52, 16, 59, 16, \"#\");\n  rect(70, 16, 77, 16, \"#\");\n  rect(86, 16, 89, 16, \"#\");\n\n  line(7, 12, 13, \"=\");\n  line(21, 27, 12, \"=\");\n  line(39, 45, 11, \"=\");\n  line(57, 63, 10, \"=\");\n  line(75, 82, 9, \"=\");\n\n  many([[2, 16]], \"S\");\n  many([[27, 11], [77, 8]], \"K\");\n  many([[9, 12], [23, 11], [26, 11], [40, 10], [44, 10], [58, 9], [62, 9], [76, 8], [81, 8], [88, 15]], \"C\");\n  many([[24, 11], [42, 10], [60, 9], [78, 8]], \"^\");\n  manyEnemies([[18, 16, \"G\"], [36, 16, \"G\"], [54, 16, \"G\"], [72, 16, \"G\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[4] = function buildLevel4(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Fortress layout: layered routes, tank enemies, clean patrol lanes.\n  line(12, 16, 17, \".\");\n  line(36, 40, 17, \".\");\n  line(60, 64, 17, \".\");\n\n  rect(0, 16, 8, 16, \"#\");\n  rect(20, 16, 28, 16, \"#\");\n  rect(44, 16, 52, 16, \"#\");\n  rect(68, 16, 76, 16, \"#\");\n  rect(84, 16, 89, 16, \"#\");\n\n  rect(30, 14, 34, 14, \"#\");\n  rect(54, 13, 58, 13, \"#\");\n  rect(78, 12, 82, 12, \"#\");\n\n  line(9, 16, 12, \"=\");\n  line(26, 34, 10, \"=\");\n  line(48, 57, 8, \"=\");\n  line(70, 80, 7, \"=\");\n\n  many([[3, 16]], \"S\");\n  many([[32, 9], [74, 6]], \"K\");\n  many([[11, 11], [28, 9], [33, 9], [49, 7], [56, 7], [71, 6], [79, 6], [86, 15], [22, 15], [45, 15]], \"C\");\n  many([[30, 9], [52, 7], [75, 6], [86, 15]], \"^\");\n  manyEnemies([[22, 16, \"H\"], [46, 16, \"H\"], [70, 16, \"H\"], [85, 16, \"H\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\nPlatformer.LevelJsonCache = Platformer.LevelJsonCache || {};\n\nPlatformer.createLevelData = function createLevelData(level = 1) {\n  const jsonLevel = Platformer.LevelJsonCache[level] || null;\n  const width = Number((jsonLevel && jsonLevel.width) || 90);\n  const height = Number((jsonLevel && jsonLevel.height) || 18);\n  const rows = Array.from({ length: height }, () => Array.from({ length: width }, () => \".\"));\n\n  const inBounds = (x, y) => x >= 0 && x < width && y >= 0 && y < height;\n  const put = (x, y, ch) => {\n    if (inBounds(x, y)) rows[y][x] = ch;\n  };\n  const line = (x1, x2, y, ch) => {\n    for (let x = x1; x <= x2; x += 1) put(x, y, ch);\n  };\n  const rect = (x1, y1, x2, y2, ch) => {\n    for (let y = y1; y <= y2; y += 1) {\n      for (let x = x1; x <= x2; x += 1) put(x, y, ch);\n    }\n  };\n  const many = (items, ch) => items.forEach(([x, y]) => put(x, y, ch));\n  const manyEnemies = (items) => items.forEach(([x, y, ch]) => put(x, y, ch));\n\n  // Base floor.\n  line(0, width - 1, height - 1, \"#\");\n\n  if (jsonLevel && Array.isArray(jsonLevel.commands)) {\n    jsonLevel.commands.forEach((cmd) => {\n      const op = String((cmd && cmd.op) || \"\");\n      if (op === \"line\") line(Number(cmd.x1), Number(cmd.x2), Number(cmd.y), String(cmd.ch || \".\"));\n      if (op === \"rect\") rect(Number(cmd.x1), Number(cmd.y1), Number(cmd.x2), Number(cmd.y2), String(cmd.ch || \".\"));\n      if (op === \"many\") many(Array.isArray(cmd.items) ? cmd.items : [], String(cmd.ch || \".\"));\n      if (op === \"manyEnemies\") manyEnemies(Array.isArray(cmd.items) ? cmd.items : []);\n    });\n  } else {\n    const builder = Platformer.LevelBuilders[level] || Platformer.LevelBuilders[1];\n    if (builder) {\n      builder({\n        width,\n        height,\n        put,\n        line,\n        rect,\n        many,\n        manyEnemies,\n      });\n    }\n  }\n\n  return rows.map((r) => r.join(\"\"));\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.BootScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"BootScene\");\n    this.playerIdleLoadFailed = false;\n    this.playerIdleWarned = false;\n  }\n\n  preload() {\n    this.load.audio(\"game-bgm\", \"assets/Slaughter to Prevail - K (mp3cut.net).mp3\");\n    this.load.audio(\"pause-bgm\", \"assets/Elevator Music - So Chill (mp3cut.net).mp3\");\n    this.load.image(\"player-idle-raw\", \"assets/IFFY_IDLE.png\");\n    this.load.json(\"ldtk-test\", \"assets/test.ldtk\");\n    this.load.spritesheet(\"ldtk-cavernas\", \"assets/Cavernas_by_Adam_Saltsman.png\", {\n      frameWidth: 8,\n      frameHeight: 8,\n    });\n    this.load.json(\"level-1\", \"assets/levels/level-1.json\");\n    this.load.json(\"level-2\", \"assets/levels/level-2.json\");\n    this.load.json(\"level-3\", \"assets/levels/level-3.json\");\n    this.load.json(\"level-4\", \"assets/levels/level-4.json\");\n    this.load.json(\"level-5\", \"assets/levels/level-ldtk-test.json\");\n    this.load.on(\"loaderror\", (fileObj) => {\n      if (fileObj && fileObj.key === \"player-idle-raw\") {\n        this.playerIdleLoadFailed = true;\n        if (Platformer.Debug && !this.playerIdleWarned) {\n          this.playerIdleWarned = true;\n          Platformer.Debug.warn(\"BootScene.playerIdle\", \"Optional asset missing: assets/IFFY_IDLE.png. Using built-in fallback character.\");\n        }\n      }\n      if (fileObj && /^level-\\d+$/.test(fileObj.key || \"\")) {\n        Platformer.Debug.warn(\"BootScene.levels\", `Level JSON missing for ${fileObj.key}; using built-in fallback.`);\n      }\n    });\n  }\n\n  createRectTexture(key, width, height, fillColor, borderColor = null) {\n    const g = this.add.graphics();\n    g.fillStyle(fillColor, 1);\n    g.fillRect(0, 0, width, height);\n    if (borderColor !== null) {\n      g.lineStyle(2, borderColor, 1);\n      g.strokeRect(1, 1, width - 2, height - 2);\n    }\n    g.generateTexture(key, width, height);\n    g.destroy();\n  }\n\n  createCircleTexture(key, diameter, fillColor, borderColor = null) {\n    const g = this.add.graphics();\n    g.fillStyle(fillColor, 1);\n    g.fillCircle(diameter / 2, diameter / 2, diameter / 2);\n    if (borderColor !== null) {\n      g.lineStyle(2, borderColor, 1);\n      g.strokeCircle(diameter / 2, diameter / 2, diameter / 2 - 1);\n    }\n    g.generateTexture(key, diameter, diameter);\n    g.destroy();\n  }\n\n  createHazardTexture(key, size, baseColor, accentColor) {\n    const g = this.add.graphics();\n    const s = Math.max(12, size);\n    const pad = Math.max(1, Math.round(s * 0.12));\n    const bodyTop = Math.max(1, Math.round(s * 0.25));\n    const bodyH = Math.max(4, s - bodyTop - pad);\n    const bodyW = Math.max(4, s - pad * 2);\n    const mountH = Math.max(2, Math.round(s * 0.25));\n    const mountY = s - mountH - 1;\n    const centerX = s / 2;\n    const muzzleY = Math.max(2, Math.round(s * 0.2));\n    const corner = Math.max(1, Math.round(s * 0.12));\n\n    // Base mount\n    g.fillStyle(0x111827, 1);\n    g.fillRoundedRect(pad, mountY, s - pad * 2, mountH, corner);\n\n    // Turret body\n    g.fillStyle(baseColor, 1);\n    g.fillRoundedRect(pad + 1, bodyTop, bodyW - 2, bodyH, corner);\n\n    // Barrel and muzzle glow\n    g.fillStyle(0x1f2937, 1);\n    g.fillRect(centerX - Math.max(1, s * 0.08), 1, Math.max(2, s * 0.16), Math.max(2, s * 0.24));\n    g.fillStyle(accentColor, 1);\n    g.fillCircle(centerX, muzzleY, Math.max(1, s * 0.12));\n    g.fillStyle(0xfef08a, 0.85);\n    g.fillCircle(centerX, muzzleY, Math.max(1, s * 0.06));\n\n    // Warning chevrons\n    g.fillStyle(0x450a0a, 1);\n    const triY = s - Math.max(2, s * 0.12);\n    const triH = Math.max(2, s * 0.15);\n    g.fillTriangle(pad + 1, triY, pad + 1 + s * 0.12, triY - triH, pad + 1 + s * 0.24, triY);\n    g.fillTriangle(s - pad - 1 - s * 0.24, triY, s - pad - 1 - s * 0.12, triY - triH, s - pad - 1, triY);\n\n    g.lineStyle(Math.max(1, Math.round(s * 0.08)), 0x0b1220, 1);\n    g.strokeRoundedRect(pad + 1, bodyTop, bodyW - 2, bodyH, corner);\n    g.lineStyle(1, 0xe2e8f0, 0.6);\n    g.strokeCircle(centerX, muzzleY, Math.max(1, s * 0.12));\n    g.generateTexture(key, s, s);\n    g.destroy();\n  }\n\n  drawCreatureEnemy(g, size, palette) {\n    const outline = palette.outline || 0x0f172a;\n    const hood = palette.body || 0x6477ff;\n    const hoodDark = palette.inner || 0x4652d9;\n    const face = palette.face || 0xf8fafc;\n    const skin = palette.skin || 0xf4cda6;\n    const eye = palette.eye || 0x020617;\n\n    // Hood/body.\n    g.fillStyle(hood, 1);\n    g.fillRoundedRect(3, 7, size - 6, size - 9, 8);\n    g.fillEllipse(size * 0.50, size * 0.46, size * 0.86, size * 0.82);\n    g.fillTriangle(size * 0.50, 1, size * 0.36, 9, size * 0.62, 9);\n\n    // Face area.\n    g.fillStyle(face, 1);\n    g.fillEllipse(size * 0.50, size * 0.52, size * 0.54, size * 0.56);\n\n    // Eyes.\n    g.fillStyle(eye, 1);\n    g.fillEllipse(size * 0.37, size * 0.51, size * 0.16, size * 0.24);\n    g.fillEllipse(size * 0.63, size * 0.51, size * 0.16, size * 0.24);\n    g.fillStyle(0xffffff, 0.95);\n    g.fillCircle(size * 0.35, size * 0.45, 1.2);\n    g.fillCircle(size * 0.61, size * 0.45, 1.2);\n\n    // Mouth/muzzle area.\n    g.fillStyle(skin, 1);\n    g.fillRoundedRect(size * 0.41, size * 0.60, size * 0.18, size * 0.10, 2);\n\n    // Legs.\n    g.fillStyle(hoodDark, 1);\n    g.fillRoundedRect(size * 0.30, size - 8, size * 0.14, 7, 2);\n    g.fillRoundedRect(size * 0.56, size - 8, size * 0.14, 7, 2);\n\n    // Outline.\n    g.lineStyle(2, outline, 1);\n    g.strokeRoundedRect(3, 7, size - 6, size - 9, 8);\n    g.lineStyle(2, outline, 0.95);\n    g.strokeEllipse(size * 0.50, size * 0.46, size * 0.86, size * 0.82);\n    g.lineStyle(1.5, outline, 0.95);\n    g.strokeEllipse(size * 0.50, size * 0.52, size * 0.54, size * 0.56);\n  }\n\n  createEnemyTexture(key, size, bodyColor, accentColor) {\n    const g = this.add.graphics();\n    this.drawCreatureEnemy(g, size, {\n      body: bodyColor,\n      inner: Phaser.Display.Color.IntegerToColor(bodyColor).darken(25).color,\n      face: 0xf8fafc,\n      skin: 0xf4cda6,\n      eye: 0x020617,\n      outline: accentColor || 0x0f172a,\n    });\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  createEnemyTextureVariant(key, size, palette) {\n    const g = this.add.graphics();\n    this.drawCreatureEnemy(g, size, {\n      body: palette.body,\n      inner: palette.inner,\n      face: 0xf8fafc,\n      skin: 0xf4cda6,\n      eye: 0x020617,\n      outline: palette.horns || 0x0f172a,\n    });\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  createProjectileTexture(key, size) {\n    const g = this.add.graphics();\n    g.fillStyle(0x7f1d1d, 1);\n    g.fillCircle(size / 2, size / 2, size / 2);\n    g.fillStyle(0xf97316, 1);\n    g.fillCircle(size / 2, size / 2, size / 2 - 2);\n    g.fillStyle(0xfef08a, 1);\n    g.fillCircle(size / 2 + 1, size / 2 - 1, size / 2 - 5);\n    g.lineStyle(1, 0x111827, 0.8);\n    g.strokeCircle(size / 2, size / 2, size / 2 - 1);\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  createJetpackFlameTexture(key, width, height, coreColor, glowColor) {\n    const g = this.add.graphics();\n    g.fillStyle(glowColor, 0.5);\n    g.fillEllipse(width / 2, height * 0.46, width * 0.92, height * 0.9);\n    g.fillStyle(coreColor, 0.95);\n    g.fillTriangle(width * 0.5, height, width * 0.2, height * 0.36, width * 0.8, height * 0.36);\n    g.fillStyle(0xfef08a, 0.9);\n    g.fillTriangle(width * 0.5, height * 0.8, width * 0.36, height * 0.4, width * 0.64, height * 0.4);\n    g.generateTexture(key, width, height);\n    g.destroy();\n  }\n\n  createAnimeGirlTexture(key, pose) {\n    const g = this.add.graphics();\n    const hairColor = pose.jump ? 0xf59e0b : 0xfbbf24;\n    const dressColor = pose.jump ? 0x1d4ed8 : 0x2563eb;\n    const skin = 0xffddc7;\n\n    g.fillStyle(hairColor, 1);\n    g.fillEllipse(14, 10, 20, 16);\n    g.fillEllipse(8, 11, 8, 8);\n    g.fillEllipse(20, 11, 8, 8);\n\n    g.fillStyle(skin, 1);\n    g.fillEllipse(14, 11, 13, 12);\n\n    g.fillStyle(0x111827, 1);\n    g.fillCircle(11, pose.blink ? 11 : 10, pose.blink ? 1 : 1.6);\n    g.fillCircle(17, pose.blink ? 11 : 10, pose.blink ? 1 : 1.6);\n\n    g.lineStyle(1.5, 0xe11d48, 1);\n    g.beginPath();\n    g.moveTo(12, 14);\n    g.lineTo(16, 14);\n    g.strokePath();\n\n    g.fillStyle(dressColor, 1);\n    g.fillRoundedRect(9, 17, 10, 10, 2);\n\n    g.fillStyle(0xffffff, 1);\n    g.fillRect(11, 19, 6, 3);\n\n    const armLeftY = pose.armLeftY ?? 21;\n    const armRightY = pose.armRightY ?? 21;\n    g.fillStyle(skin, 1);\n    g.fillRect(6, armLeftY, 3, 8);\n    g.fillRect(19, armRightY, 3, 8);\n\n    g.fillStyle(0x0f172a, 1);\n    g.fillRect(8, 27, 12, 5);\n\n    const legLeftY = pose.legLeftY ?? 32;\n    const legRightY = pose.legRightY ?? 32;\n    g.fillStyle(0x111827, 1);\n    g.fillRect(10, legLeftY, 3, 6);\n    g.fillRect(15, legRightY, 3, 6);\n\n    g.fillStyle(0xec4899, 1);\n    g.fillRect(6, 4, 4, 2);\n    g.fillRect(18, 4, 4, 2);\n\n    g.generateTexture(key, 28, 38);\n    g.destroy();\n  }\n\n  createPlayerTextures() {\n    this.createAnimeGirlTexture(\"player-idle-1\", {\n      armLeftY: 21, armRightY: 21, legLeftY: 32, legRightY: 32, blink: false, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-idle-2\", {\n      armLeftY: 22, armRightY: 22, legLeftY: 32, legRightY: 32, blink: true, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-run-1\", {\n      armLeftY: 19, armRightY: 23, legLeftY: 31, legRightY: 33, blink: false, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-run-2\", {\n      armLeftY: 23, armRightY: 19, legLeftY: 33, legRightY: 31, blink: false, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-jump\", {\n      armLeftY: 17, armRightY: 17, legLeftY: 30, legRightY: 30, blink: false, jump: true,\n    });\n  }\n\n  create() {\n    const { TILE } = Platformer.Config;\n    const cbMode = Platformer.Settings.current.accessibility.colorblindMode;\n    const hazardColor = cbMode === \"off\" ? 0xdc2626 : (cbMode === \"tritanopia\" ? 0xf59e0b : 0x2563eb);\n    const laserAccent = cbMode === \"off\" ? 0xfca5a5 : 0xfef08a;\n    const coinColor = cbMode === \"deuteranopia\" ? 0xf9a8d4 : 0xfacc15;\n    const enemyColor = cbMode === \"protanopia\" ? 0x22d3ee : 0xfb923c;\n    const enemyFangColor = cbMode === \"protanopia\" ? 0xfef08a : 0xffffff;\n\n    this.createPlayerTextures();\n    this.createRectTexture(\"ground\", TILE, TILE, 0x8b5a2b, 0x5a3a1d);\n    this.createRectTexture(\"platform\", TILE, TILE, 0x6b7280, 0x374151);\n    this.createRectTexture(\"oneway\", TILE, Math.max(3, Math.round(TILE * 0.38)), 0x38bdf8, 0x0369a1);\n    this.createHazardTexture(\"hazard\", TILE, hazardColor, laserAccent);\n    this.setupPlayerIdleAnimation();\n    this.createCircleTexture(\"coin\", 16, coinColor, 0xa16207);\n    this.createEnemyTexture(\"enemy\", 24, enemyColor, enemyFangColor);\n    this.createEnemyTextureVariant(\"enemy-e\", 24, { body: 0xfb923c, inner: 0x7f1d1d, accent: 0xffffff, horns: 0xfef08a });\n    this.createEnemyTextureVariant(\"enemy-f\", 24, { body: 0x22d3ee, inner: 0x164e63, accent: 0xfef08a, horns: 0xe2e8f0 });\n    this.createEnemyTextureVariant(\"enemy-g\", 24, { body: 0xf43f5e, inner: 0x4c0519, accent: 0xfef2f2, horns: 0xfda4af });\n    this.createEnemyTextureVariant(\"enemy-h\", 24, { body: 0xa855f7, inner: 0x3b0764, accent: 0xfef08a, horns: 0xd8b4fe });\n    this.createProjectileTexture(\"hazard-projectile\", 14);\n    this.createJetpackFlameTexture(\"jetpack-flame-1\", 18, 26, 0xf97316, 0xfb7185);\n    this.createJetpackFlameTexture(\"jetpack-flame-2\", 18, 24, 0xf59e0b, 0xfacc15);\n    this.createRectTexture(\"checkpoint\", 16, 40, 0xa855f7, 0x581c87);\n\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"health\", 3);\n    this.registry.set(\"lives\", 2);\n    this.registry.set(\"level\", 1);\n    Platformer.LevelJsonCache = {};\n    [1, 2, 3, 4, 5].forEach((n) => {\n      const key = `level-${n}`;\n      const json = this.cache.json.get(key);\n      if (json && typeof json === \"object\") {\n        Platformer.LevelJsonCache[n] = json;\n      }\n    });\n    if (Platformer.WorldMapManager && typeof Platformer.WorldMapManager.warmupDefault === \"function\") {\n      Platformer.WorldMapManager.warmupDefault();\n    }\n\n    this.scene.start(\"MenuScene\");\n  }\n\n  setupPlayerIdleAnimation() {\n    if (!this.textures.exists(\"player-idle-raw\")) {\n      if (Platformer.Debug && !this.playerIdleWarned) {\n        this.playerIdleWarned = true;\n        const msg = this.playerIdleLoadFailed\n          ? \"Player idle spritesheet failed to preload. Using built-in fallback character.\"\n          : \"Player idle spritesheet not found. Using built-in fallback character.\";\n        Platformer.Debug.warn(\"BootScene.playerIdle\", msg);\n      }\n      return;\n    }\n\n    const source = this.textures.get(\"player-idle-raw\").getSourceImage();\n    if (!source || !source.width || !source.height) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"BootScene.playerIdle\", \"player-idle-raw source has invalid dimensions.\");\n      return;\n    }\n\n    const frames = 4;\n    const frameWidth = Math.floor(source.width / frames);\n    const frameHeight = source.height;\n    if (frameWidth < 1 || frameHeight < 1) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"BootScene.playerIdle\", `Invalid frame size: ${frameWidth}x${frameHeight}`);\n      return;\n    }\n\n    if (this.textures.exists(\"player-idle-sheet\")) {\n      this.textures.remove(\"player-idle-sheet\");\n    }\n    this.textures.addSpriteSheet(\"player-idle-sheet\", source, {\n      frameWidth,\n      frameHeight,\n      endFrame: frames - 1,\n    });\n\n    if (this.anims.exists(\"playerIdleAnim\")) {\n      this.anims.remove(\"playerIdleAnim\");\n    }\n    this.anims.create({\n      key: \"playerIdleAnim\",\n      frames: this.anims.generateFrameNumbers(\"player-idle-sheet\", { start: 0, end: frames - 1 }),\n      frameRate: 6,\n      repeat: -1,\n    });\n    if (Platformer.Debug) Platformer.Debug.log(\"BootScene.playerIdle\", `Loaded IFFY idle sheet ${source.width}x${source.height}, frames=${frames}`);\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.MenuScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"MenuScene\");\n    this.menuMusic = null;\n    this.menuMusicHtml = null;\n    this.updateButton = null;\n    this.updateButtonText = null;\n    this.versionInfoText = null;\n    this.changeButton = null;\n    this.changeButtonText = null;\n    this.changePanel = null;\n    this.changePanelTitle = null;\n    this.changePanelBody = null;\n    this.changePanelOpen = false;\n    this.localBuildNotes = [\n      \"No update details yet.\",\n      \"\",\n      \"Recent changes:\",\n      \"- Live animated menu lane (runner + enemy stomps)\",\n      \"- Menu hit feedback (red blink + knockback, non-lethal)\",\n      \"- Menu ambient state persists after Options return\",\n      \"- Options opens as live overlay over animated menu\",\n      \"- Reworked Options into standalone category cards\",\n      \"- Resize-safe Options layout and anchored back button\",\n      \"- Stable Options scrolling with fixed action footer\",\n      \"- Save + Back / Reset defaults always visible\",\n      \"\",\n      \"If online notes are available, this panel auto-refreshes from GitHub Releases.\",\n    ].join(\"\\n\");\n    this.latestReleaseNotes = this.localBuildNotes;\n    this.latestReleaseTag = \"\";\n    this.pendingUpdateUrl = \"\";\n    this.updateInProgress = false;\n    this.bgSky = null;\n    this.bgMid = null;\n    this.bgGround = null;\n    this.bgAccentTop = null;\n    this.bgAccentBottom = null;\n    this.bgOrbs = [];\n    this.menuCard = null;\n    this.titleText = null;\n    this.titleShadow = null;\n    this.comingSoonText = null;\n    this.menuButtons = {};\n    this.onResize = null;\n    this.menuUiElements = [];\n    this.menuInteractive = false;\n    this.introFx = null;\n    this.introParticles = null;\n    this.introLines = [];\n    this.introGlow = null;\n    this.menuIntroInProgress = false;\n    this.menuIntroUiFadeCall = null;\n    this.menuIntroDoneCall = null;\n    this.menuStage = null;\n    this.menuRunner = null;\n    this.menuRunnerFace = 1;\n    this.menuRunnerGroundY = 0;\n    this.menuRunnerSpeed = 82;\n    this.menuRunnerJumpVy = -270;\n    this.menuRunnerVy = 0;\n    this.menuRunnerGravity = 700;\n    this.menuRunnerJumpCooldown = 0;\n    this.menuRunnerActionTimer = 0;\n    this.menuRunnerDamageCooldown = 0;\n    this.menuRunnerDamageFlashUntil = 0;\n    this.menuEnemies = [];\n    this.onSettingsChanged = null;\n    this.updateStatusLockUntil = 0;\n    this.lastManualUpdateAt = 0;\n    this.updateManager = null;\n    this.introConfig = {\n      totalMs: 1800,\n      uiFadeMs: 260,\n      titleRevealDelayMs: 80,\n      titleRevealMs: 420,\n      buttonStaggerMs: 90,\n      buttonMovePx: 18,\n      skyColor: 0x081336,\n      midColor: 0x132a56,\n      groundColor: 0x0b6f49,\n      glowCyan: 0x53e0ff,\n      glowPink: 0xff71c7,\n    };\n  }\n\n  create() {\n    const textScale = Platformer.Settings.textScale();\n\n    this.bgSky = this.add.rectangle(0, 0, 10, 10, this.introConfig.skyColor, 1).setOrigin(0, 0);\n    this.bgMid = this.add.rectangle(0, 0, 10, 10, this.introConfig.midColor, 1).setOrigin(0, 0);\n    this.bgGround = this.add.rectangle(0, 0, 10, 10, this.introConfig.groundColor, 1).setOrigin(0, 0);\n    this.bgAccentTop = this.add.rectangle(0, 0, 10, 10, 0x1e3a8a, 0.24).setOrigin(0, 0);\n    this.bgAccentBottom = this.add.rectangle(0, 0, 10, 10, 0x34d399, 0.22).setOrigin(0, 0);\n    this.createPrettyBackdrop();\n\n    this.titleShadow = this.add.text(0, 74, \"ANIME PLATFORMER\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(46 * textScale)}px`,\n      color: \"#67e8f9\",\n      stroke: \"#020617\",\n      strokeThickness: 12,\n    }).setOrigin(0.5).setDepth(13).setAlpha(0.26);\n\n    this.titleText = this.add.text(0, 72, \"ANIME PLATFORMER\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(46 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#1e293b\",\n      strokeThickness: 7,\n    }).setOrigin(0.5).setDepth(14);\n    this.onSettingsChanged = (nextSettings) => this.applyRuntimeSettings(nextSettings);\n    this.game.events.on(\"settings-changed\", this.onSettingsChanged);\n    this.updateManager = new Platformer.UpdateManager(this);\n    this.setupMenuMusic();\n\n    const makeButton = (id, y, label, onClick, opts = {}) => {\n      const disabled = !!opts.disabled;\n      const glow = this.add.rectangle(0, y, 286, 56, 0x22d3ee, disabled ? 0.08 : 0.14)\n        .setDepth(9)\n        .setBlendMode(Phaser.BlendModes.ADD);\n      const box = this.add.rectangle(0, y, 280, 50, disabled ? 0x475569 : 0x243b67, 0.96)\n        .setStrokeStyle(3, disabled ? 0x64748b : 0x7dd3fc, 0.95)\n        .setDepth(10);\n      const txt = this.add.text(0, y, label, {\n        fontFamily: \"Consolas\",\n        fontSize: `${Math.round(30 * textScale)}px`,\n        color: disabled ? \"#cbd5e1\" : \"#f8fafc\",\n        stroke: disabled ? \"#334155\" : \"#0f172a\",\n        strokeThickness: 2,\n      }).setOrigin(0.5).setDepth(11);\n\n      if (!disabled) {\n        box.setInteractive({ useHandCursor: true });\n        box.on(\"pointerover\", () => {\n          box.setFillStyle(0x2f4f86, 1);\n          glow.setAlpha(0.26);\n          this.tweens.add({ targets: [box, txt, glow], scaleX: 1.03, scaleY: 1.03, duration: 120, ease: \"Sine.Out\" });\n        });\n        box.on(\"pointerout\", () => {\n          box.setFillStyle(0x243b67, 0.96);\n          glow.setAlpha(0.14);\n          this.tweens.add({ targets: [box, txt, glow], scaleX: 1, scaleY: 1, duration: 120, ease: \"Sine.Out\" });\n        });\n        box.on(\"pointerdown\", onClick);\n      }\n\n      this.menuButtons[id] = { box, txt, glow };\n      return this.menuButtons[id];\n    };\n\n    const launchWorldMap = () => {\n      // Keep menu BGM flowing into world map; gameplay scene will take over music.\n      if (this.scene.isActive(\"UIScene\") || this.scene.isPaused(\"UIScene\")) this.scene.stop(\"UIScene\");\n      if (this.scene.isActive(\"GameScene\") || this.scene.isPaused(\"GameScene\")) this.scene.stop(\"GameScene\");\n      if (Platformer.Progress && typeof Platformer.Progress.ensureLoaded === \"function\") {\n        Platformer.Progress.ensureLoaded();\n      }\n      this.scene.start(\"WorldMapScene\");\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Play -> WorldMapScene launched.\");\n    };\n\n    const startGame = () => {\n      if (!this.menuInteractive) return;\n      Platformer.beeper.unlock();\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Play clicked.\");\n      if (this.sound && this.sound.context && this.sound.context.state === \"suspended\") {\n        this.sound.context.resume().catch(() => {});\n      }\n      launchWorldMap();\n    };\n\n    makeButton(\"play\", 0, \"PLAY\", startGame);\n    makeButton(\"continue\", 0, \"CONTINUE\", null, { disabled: true });\n    this.comingSoonText = this.add.text(0, 0, \"Coming soon ^^\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(17 * textScale)}px`,\n      color: \"#fef3c7\",\n      stroke: \"#78350f\",\n      strokeThickness: 3,\n    }).setOrigin(0.5).setDepth(12);\n\n    makeButton(\"options\", 0, \"OPTIONS\", () => {\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Opening OptionsScene from menu.\");\n      try {\n        this.scene.start(\"OptionsScene\", { returnTo: \"menu\" });\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.options\", \"OptionsScene started in dedicated mode.\");\n      } catch (err) {\n        if (Platformer.Debug) {\n          Platformer.Debug.error(\"MenuScene.options\", err && err.stack ? err.stack : String(err));\n        }\n      }\n    });\n    makeButton(\"extras\", 0, \"EXTRA'S\", () => this.showExtras());\n    makeButton(\"exit\", 0, \"EXIT\", () => this.handleExit());\n    this.createBottomLeftVersionInfo();\n    this.createMenuUpdateWidget();\n    this.createWhatsChangedWidget();\n    this.createMenuMiniStage();\n    this.menuCard = this.add.rectangle(0, 0, 360, 390, 0x0b1731, 0.46)\n      .setStrokeStyle(2, 0x7dd3fc, 0.38)\n      .setDepth(8.5);\n    this.collectMenuUiElements();\n    const shouldPlayMenuIntro = !Platformer._menuBootIntroPlayed;\n    if (shouldPlayMenuIntro) {\n      Platformer._menuBootIntroPlayed = true;\n      this.setMenuUiVisible(false);\n      this.setMenuInteractive(false);\n    } else {\n      this.setMenuUiVisible(true);\n      this.setMenuInteractive(true);\n    }\n    this.createMenuIntroFx();\n    this.layoutMenu();\n    this.onResize = () => {\n      if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n      this.handleResize();\n    };\n    this.scale.on(\"resize\", this.onResize);\n    if (shouldPlayMenuIntro) this.playMenuIntro();\n\n    this.input.keyboard.on(\"keydown-ENTER\", startGame);\n  }\n\n  layoutMenu() {\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n    if (!this.bgSky || !this.bgMid || !this.bgGround) return;\n    if (!this.titleText || !this.titleShadow) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const cx = w / 2;\n    const cy = h / 2;\n\n    const safeRectSizePos = (obj, width, height, x, y) => {\n      if (!obj || !obj.active || !obj.scene) return;\n      obj.setSize(width, height).setPosition(x, y);\n    };\n    const safePos = (obj, x, y) => {\n      if (!obj || !obj.active || !obj.scene) return;\n      obj.setPosition(x, y);\n    };\n\n    try {\n      safeRectSizePos(this.bgSky, w, h, 0, 0);\n      safeRectSizePos(this.bgMid, w, 220, 0, cy + 160);\n      safeRectSizePos(this.bgGround, w, 120, 0, cy + 220);\n      safeRectSizePos(this.bgAccentTop, w, Math.round(h * 0.42), 0, 0);\n      safeRectSizePos(this.bgAccentBottom, w, Math.round(h * 0.2), 0, h - Math.round(h * 0.24));\n      safePos(this.titleShadow, cx, 74);\n      safePos(this.titleText, cx, 72);\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.warn(\"MenuScene.layout\", `Skipping stale resize pass: ${err && err.message ? err.message : err}`);\n      }\n      return;\n    }\n\n    const y0 = cy - 40;\n    const spacing = 60;\n    const p = this.menuButtons.play;\n    const c = this.menuButtons.continue;\n    const o = this.menuButtons.options;\n    const cr = this.menuButtons.extras;\n    const e = this.menuButtons.exit;\n    const place = (item, y) => {\n      if (!item) return;\n      if (item.glow) item.glow.setPosition(cx, y);\n      item.box.setPosition(cx, y);\n      item.txt.setPosition(cx, y);\n    };\n    place(p, y0);\n    place(c, y0 + spacing);\n    place(o, y0 + spacing * 2);\n    place(cr, y0 + spacing * 3);\n    place(e, y0 + spacing * 4);\n    if (this.menuCard) this.menuCard.setPosition(cx, y0 + spacing * 2).setSize(360, 356);\n    if (this.comingSoonText) this.comingSoonText.setPosition(cx + 210, y0 + spacing);\n\n    if (this.updateButton && this.updateButtonText) {\n      const ux = w - 96;\n      const uy = 38;\n      this.updateButton.setPosition(ux, uy);\n      this.updateButtonText.setPosition(ux, uy);\n    }\n    if (this.changeButton && this.changeButtonText) {\n      const cxRight = w - 96;\n      const cyTop = 84;\n      this.changeButton.setPosition(cxRight, cyTop);\n      this.changeButtonText.setPosition(cxRight, cyTop);\n    }\n    if (this.changePanel && this.changePanelTitle && this.changePanelBody) {\n      const panelW = Math.min(560, Math.max(380, Math.round(w * 0.34)));\n      const panelH = Math.min(430, Math.max(240, Math.round(h * 0.5)));\n      const px = w - panelW / 2 - 20;\n      const py = Math.min(116 + panelH / 2, h - panelH / 2 - 20);\n      this.changePanel.setSize(panelW, panelH).setPosition(px, py);\n      this.changePanelTitle.setPosition(px - panelW / 2 + 16, py - panelH / 2 + 12);\n      this.changePanelBody\n        .setPosition(px - panelW / 2 + 16, py - panelH / 2 + 44)\n        .setWordWrapWidth(panelW - 32);\n    }\n    if (this.versionInfoText && this.versionInfoText.active && this.versionInfoText.scene) this.versionInfoText.setPosition(14, h - 12);\n    this.layoutMenuMiniStage();\n    this.layoutMenuIntroFx();\n  }\n\n  createMenuMiniStage() {\n    this.menuStage = this.add.container(0, 0).setDepth(7.8);\n\n    // Invisible logical lane: runner/enemies stay inside the existing green menu band.\n    const lane = this.add.rectangle(0, 0, 10, 10, 0x12815f, 0).setOrigin(0, 0.5);\n    const topStrip = this.add.rectangle(0, 0, 10, 8, 0x4ade80, 0).setOrigin(0, 1);\n    const laneShade = this.add.rectangle(0, 0, 10, 10, 0x0c5e45, 0).setOrigin(0, 0.5);\n    this.menuStage.add([lane, topStrip]);\n    this.menuStage.lane = lane;\n    this.menuStage.topStrip = topStrip;\n    this.menuStage.laneShade = laneShade;\n    this.menuStage.add(laneShade);\n\n    this.menuRunner = this.add.sprite(0, 0, this.textureOr(\"player-run-1\", \"player\")).setDepth(8.2);\n    this.menuRunner.setDisplaySize(48, 64);\n    this.menuStage.add(this.menuRunner);\n\n    this.menuEnemies = [];\n    for (let i = 0; i < 4; i += 1) {\n      const enemy = this.add.sprite(0, 0, this.textureOr(\"enemy-e\", \"enemy\")).setDepth(8.15);\n      enemy.setDisplaySize(34, 34);\n      enemy.menuX = 0;\n      enemy.menuDir = i % 2 === 0 ? 1 : -1;\n      enemy.menuSpeed = 30 + (i * 8);\n      enemy.alive = true;\n      enemy.respawnAt = 0;\n      this.menuEnemies.push(enemy);\n      this.menuStage.add(enemy);\n    }\n    this.restoreMenuMiniStageState();\n  }\n\n  layoutMenuMiniStage() {\n    if (!this.menuStage || !this.menuStage.lane || !this.menuStage.topStrip) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const baseGroundTop = this.bgGround ? this.bgGround.y : (h - 160);\n    const baseGroundH = this.bgGround ? this.bgGround.height : 120;\n    const laneY = baseGroundTop + Math.round(baseGroundH * 0.44);\n    const laneH = Math.max(30, Math.round(baseGroundH * 0.34));\n    const margin = 26;\n    const laneX = margin;\n    const laneW = Math.max(280, w - margin * 2);\n    this.menuRunnerGroundY = laneY - 6;\n\n    this.menuStage.lane.setPosition(laneX, laneY).setSize(laneW, laneH);\n    this.menuStage.topStrip.setPosition(laneX, laneY).setSize(laneW, 8);\n    this.menuStage.laneShade.setPosition(laneX, laneY + 12).setSize(laneW, laneH - 12);\n\n    if (this.menuRunner) {\n      if (!Number.isFinite(this.menuRunner.menuX)) {\n        this.menuRunner.menuX = laneX + 60;\n      }\n      this.menuRunner.y = this.menuRunnerGroundY;\n    }\n\n    const slot = laneW / (this.menuEnemies.length + 1);\n    this.menuEnemies.forEach((enemy, idx) => {\n      if (!enemy) return;\n      if (!enemy.alive && this.time.now < enemy.respawnAt) return;\n      enemy.alive = true;\n      enemy.menuX = laneX + slot * (idx + 1) + Phaser.Math.Between(-26, 26);\n      enemy.y = this.menuRunnerGroundY + 2;\n      enemy.setVisible(true);\n      enemy.setAlpha(1);\n    });\n  }\n\n  restoreMenuMiniStageState() {\n    const s = Platformer._menuAmbientState;\n    if (!s) return;\n    if (this.menuRunner && Number.isFinite(s.runnerX)) {\n      this.menuRunner.menuX = s.runnerX;\n      this.menuRunner.y = Number.isFinite(s.runnerY) ? s.runnerY : this.menuRunnerGroundY;\n      this.menuRunnerFace = s.runnerFace === -1 ? -1 : 1;\n      this.menuRunnerVy = Number.isFinite(s.runnerVy) ? s.runnerVy : 0;\n      this.menuRunnerJumpCooldown = Number.isFinite(s.runnerJumpCooldown) ? s.runnerJumpCooldown : 0;\n      this.menuRunnerDamageCooldown = Number.isFinite(s.runnerDamageCooldown) ? s.runnerDamageCooldown : 0;\n      this.menuRunnerActionTimer = Number.isFinite(s.runnerActionTimer) ? s.runnerActionTimer : 0;\n    }\n    if (Array.isArray(s.enemies) && this.menuEnemies && this.menuEnemies.length) {\n      this.menuEnemies.forEach((enemy, idx) => {\n        const se = s.enemies[idx];\n        if (!enemy || !se) return;\n        enemy.menuX = Number.isFinite(se.x) ? se.x : enemy.menuX;\n        enemy.menuDir = se.dir === -1 ? -1 : 1;\n        enemy.alive = se.alive !== false;\n        enemy.respawnAt = Number.isFinite(se.respawnAt) ? se.respawnAt : 0;\n        enemy.setVisible(enemy.alive);\n        if (enemy.alive) {\n          enemy.setAlpha(1);\n          enemy.setScale(1, 1);\n        }\n      });\n    }\n  }\n\n  saveMenuMiniStageState() {\n    Platformer._menuAmbientState = {\n      runnerX: this.menuRunner && Number.isFinite(this.menuRunner.menuX) ? this.menuRunner.menuX : null,\n      runnerY: this.menuRunner ? this.menuRunner.y : null,\n      runnerFace: this.menuRunnerFace,\n      runnerVy: this.menuRunnerVy,\n      runnerJumpCooldown: this.menuRunnerJumpCooldown,\n      runnerDamageCooldown: this.menuRunnerDamageCooldown,\n      runnerActionTimer: this.menuRunnerActionTimer,\n      enemies: (this.menuEnemies || []).map((enemy) => ({\n        x: enemy && Number.isFinite(enemy.menuX) ? enemy.menuX : null,\n        dir: enemy && enemy.menuDir === -1 ? -1 : 1,\n        alive: !!(enemy && enemy.alive),\n        respawnAt: enemy && Number.isFinite(enemy.respawnAt) ? enemy.respawnAt : 0,\n      })),\n    };\n  }\n\n  handleResize() {\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n    this.layoutMenu();\n    if (this.menuIntroInProgress) {\n      this.forceCompleteMenuIntro();\n    }\n  }\n\n  createMenuUpdateWidget() {\n    const x = this.scale.width - 96;\n    const y = 38;\n    this.updateButton = this.add.rectangle(x, y, 160, 38, 0x334155, 0.95)\n      .setStrokeStyle(2, 0x67e8f9, 0.95)\n      .setDepth(20)\n      .setInteractive({ useHandCursor: true });\n    this.updateButtonText = this.add.text(x, y, \"Update\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"22px\",\n      color: \"#f8fafc\",\n    }).setOrigin(0.5).setDepth(21);\n    this.updateButton.on(\"pointerover\", () => this.updateButton.setFillStyle(0x3b4f73, 0.98));\n    this.updateButton.on(\"pointerout\", () => this.updateButton.setFillStyle(0x334155, 0.95));\n    this.updateButton.on(\"pointerdown\", async () => {\n      if (!this.updateManager) {\n        if (Platformer.Debug) Platformer.Debug.error(\"MenuScene.update\", \"UpdateManager missing.\");\n        this.setBottomLeftUpdateStatus(\"Update system unavailable.\", true);\n        return;\n      }\n      await this.updateManager.handleUpdateClick();\n    });\n\n    this.time.delayedCall(100, () => this.autoCheckUpdatesForBottomLeft());\n  }\n\n  async startInAppUpdate(downloadUrl, startMessage = \"Preparing update...\") {\n    if (!this.updateManager) {\n      return { ok: false, message: \"Update manager unavailable.\" };\n    }\n    return this.updateManager.startInAppUpdate(downloadUrl, startMessage);\n  }\n\n  createBottomLeftVersionInfo() {\n    const currentVersion = ((Platformer.Settings.current.updates || {}).currentVersion || \"1.0.0\").trim();\n    this.versionInfoStyle = {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#e2e8f0\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n      align: \"left\",\n    };\n    this.ensureVersionInfoText();\n\n    this.setBottomLeftUpdateStatus(\"Checking for updates...\");\n    this.safeSetText(this.versionInfoText, `Version: ${currentVersion}\\nUpdate: Checking for updates...`, \"versionInfoText\");\n  }\n\n  ensureVersionInfoText() {\n    if (this.versionInfoText && this.versionInfoText.active && this.versionInfoText.scene === this) {\n      this.versionInfoText.setPosition(14, this.scale.height - 12);\n      return this.versionInfoText;\n    }\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return null;\n    try {\n      this.versionInfoText = this.add.text(14, this.scale.height - 12, \"\", this.versionInfoStyle || {\n        fontFamily: \"Consolas\",\n        fontSize: \"18px\",\n        color: \"#e2e8f0\",\n        stroke: \"#0f172a\",\n        strokeThickness: 4,\n        align: \"left\",\n      }).setOrigin(0, 1).setDepth(25);\n      return this.versionInfoText;\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.warn(\"MenuScene.text\", `ensureVersionInfoText failed: ${err && err.message ? err.message : err}`);\n      }\n      return null;\n    }\n  }\n\n  safeSetText(target, text, label = \"text\") {\n    if (!target || !target.active || !target.scene) return false;\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return false;\n    try {\n      target.setText(String(text));\n      return true;\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.warn(\"MenuScene.text\", `setText failed (${label}): ${err && err.message ? err.message : err}`);\n      }\n      if (target === this.versionInfoText) {\n        const rebuilt = this.ensureVersionInfoText();\n        if (rebuilt && rebuilt !== target) {\n          try {\n            rebuilt.setText(String(text));\n            return true;\n          } catch (err2) {\n            if (Platformer.Debug) {\n              Platformer.Debug.warn(\"MenuScene.text\", `setText retry failed (${label}): ${err2 && err2.message ? err2.message : err2}`);\n            }\n          }\n        }\n      }\n      return false;\n    }\n  }\n\n  setBottomLeftUpdateStatus(statusText, sticky = false) {\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n    if (!sticky && this.time && this.time.now < this.updateStatusLockUntil) return;\n    if (sticky && this.time) this.updateStatusLockUntil = this.time.now + 8000;\n    if (!this.ensureVersionInfoText()) return;\n    const currentVersion = ((Platformer.Settings.current.updates || {}).currentVersion || \"1.0.0\").trim();\n    const safeStatus = statusText || \"Unknown\";\n    this.safeSetText(this.versionInfoText, `Version: ${currentVersion}\\nUpdate: ${safeStatus}`, \"bottomLeftStatus\");\n  }\n\n  async autoCheckUpdatesForBottomLeft() {\n    if (!this.updateManager) return;\n    await this.updateManager.autoCheck();\n  }\n\n  createWhatsChangedWidget() {\n    const x = this.scale.width - 96;\n    const y = 84;\n    this.changeButton = this.add.rectangle(x, y, 160, 34, 0x1e293b, 0.95)\n      .setStrokeStyle(2, 0x67e8f9, 0.95)\n      .setDepth(20)\n      .setInteractive({ useHandCursor: true });\n    this.changeButtonText = this.add.text(x, y, \"What's Changed\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#e2e8f0\",\n    }).setOrigin(0.5).setDepth(21);\n\n    this.changePanel = this.add.rectangle(0, 0, 480, 290, 0x0f172a, 0.92)\n      .setStrokeStyle(2, 0x67e8f9)\n      .setDepth(22)\n      .setVisible(false);\n    this.changePanelTitle = this.add.text(0, 0, \"What's Changed\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"20px\",\n      color: \"#f8fafc\",\n    }).setOrigin(0, 0).setDepth(23).setVisible(false);\n    this.changePanelBody = this.add.text(0, 0, this.latestReleaseNotes, {\n      fontFamily: \"Consolas\",\n      fontSize: \"15px\",\n      color: \"#cbd5e1\",\n      align: \"left\",\n      wordWrap: { width: 440, useAdvancedWrap: true },\n    }).setOrigin(0, 0).setDepth(23).setVisible(false);\n\n    this.changeButton.on(\"pointerover\", () => this.changeButton.setFillStyle(0x334155, 0.98));\n    this.changeButton.on(\"pointerout\", () => this.changeButton.setFillStyle(0x1e293b, 0.95));\n    this.changeButton.on(\"pointerdown\", () => {\n      this.changePanelOpen = !this.changePanelOpen;\n      const on = this.changePanelOpen;\n      this.changePanel.setVisible(on);\n      this.changePanelTitle.setVisible(on);\n      this.changePanelBody.setVisible(on);\n      if (on) {\n        this.changeButtonText.setText(\"Hide Changes\");\n      } else {\n        this.changeButtonText.setText(\"What's Changed\");\n      }\n    });\n  }\n\n  collectMenuUiElements() {\n    this.menuUiElements = [];\n    if (this.titleText) this.menuUiElements.push(this.titleText);\n    if (this.titleShadow) this.menuUiElements.push(this.titleShadow);\n    if (this.menuCard) this.menuUiElements.push(this.menuCard);\n    Object.values(this.menuButtons).forEach((b) => {\n      if (b && b.glow) this.menuUiElements.push(b.glow);\n      if (b && b.box) this.menuUiElements.push(b.box);\n      if (b && b.txt) this.menuUiElements.push(b.txt);\n    });\n    if (this.comingSoonText) this.menuUiElements.push(this.comingSoonText);\n    if (this.updateButton) this.menuUiElements.push(this.updateButton);\n    if (this.updateButtonText) this.menuUiElements.push(this.updateButtonText);\n    if (this.changeButton) this.menuUiElements.push(this.changeButton);\n    if (this.changeButtonText) this.menuUiElements.push(this.changeButtonText);\n    if (this.changePanel) this.menuUiElements.push(this.changePanel);\n    if (this.changePanelTitle) this.menuUiElements.push(this.changePanelTitle);\n    if (this.changePanelBody) this.menuUiElements.push(this.changePanelBody);\n    if (this.versionInfoText) this.menuUiElements.push(this.versionInfoText);\n  }\n\n  setMenuUiVisible(visible) {\n    const a = visible ? 1 : 0;\n    this.menuUiElements.forEach((el) => {\n      if (!el || !el.active) return;\n      el.setAlpha(a);\n      if (this.changePanelOpen && (el === this.changePanel || el === this.changePanelTitle || el === this.changePanelBody)) {\n        el.setVisible(visible);\n      }\n    });\n  }\n\n  setMenuInteractive(enabled) {\n    this.menuInteractive = !!enabled;\n    const interactiveIds = [\"play\", \"options\", \"extras\", \"exit\"];\n    interactiveIds.forEach((id) => {\n      const b = this.menuButtons[id];\n      if (!b || !b.box) return;\n      if (enabled) b.box.setInteractive({ useHandCursor: true });\n      else b.box.disableInteractive();\n    });\n    if (this.updateButton) {\n      if (enabled) this.updateButton.setInteractive({ useHandCursor: true });\n      else this.updateButton.disableInteractive();\n    }\n    if (this.changeButton) {\n      if (enabled) this.changeButton.setInteractive({ useHandCursor: true });\n      else this.changeButton.disableInteractive();\n    }\n  }\n\n  ensureMenuIntroTextures() {\n    if (!this.textures.exists(\"menu-intro-dot\")) {\n      const g = this.make.graphics({ x: 0, y: 0, add: false });\n      g.fillStyle(0xffffff, 1);\n      g.fillCircle(4, 4, 4);\n      g.generateTexture(\"menu-intro-dot\", 8, 8);\n      g.destroy();\n    }\n    if (!this.textures.exists(\"menu-intro-line\")) {\n      const g = this.make.graphics({ x: 0, y: 0, add: false });\n      g.fillStyle(0xffffff, 1);\n      g.fillRect(0, 0, 140, 2);\n      g.generateTexture(\"menu-intro-line\", 140, 2);\n      g.destroy();\n    }\n  }\n\n  createMenuIntroFx() {\n    this.ensureMenuIntroTextures();\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.introFx = this.add.container(0, 0).setDepth(9);\n    this.introLines = [];\n\n    for (let i = 0; i < 12; i += 1) {\n      const isPink = i % 3 === 0;\n      const line = this.add.image(\n        Phaser.Math.Between(0, w),\n        Phaser.Math.Between(40, h - 80),\n        \"menu-intro-line\"\n      )\n        .setOrigin(0, 0.5)\n        .setTint(isPink ? this.introConfig.glowPink : this.introConfig.glowCyan)\n        .setAlpha(isPink ? 0.18 : 0.24)\n        .setBlendMode(Phaser.BlendModes.SCREEN);\n      line.introSpeed = Phaser.Math.FloatBetween(38, 90);\n      line.introParallax = Phaser.Math.FloatBetween(0.3, 1);\n      this.introLines.push(line);\n      this.introFx.add(line);\n    }\n\n    this.introParticles = this.add.particles(0, 0, \"menu-intro-dot\", {\n      x: { min: 0, max: w },\n      y: { min: 0, max: h * 0.72 },\n      lifespan: { min: 1500, max: 3600 },\n      speedX: { min: -8, max: 8 },\n      speedY: { min: -36, max: -10 },\n      scale: { start: 0.55, end: 0 },\n      alpha: { start: 0.36, end: 0 },\n      tint: [this.introConfig.glowCyan, this.introConfig.glowPink, 0xffffff],\n      blendMode: \"ADD\",\n      frequency: 90,\n      quantity: 1,\n    }).setDepth(10);\n  }\n\n  layoutMenuIntroFx() {\n    if (!this.introParticles) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.introParticles.setConfig({\n      x: { min: 0, max: w },\n      y: { min: 0, max: h * 0.72 },\n    });\n  }\n\n  playMenuIntro() {\n    if (!this.titleText) return;\n    this.menuIntroInProgress = true;\n\n    this.titleText.setAlpha(0).setScale(0.94).setY(42);\n    this.cameras.main.fadeIn(520, 0, 0, 0);\n\n    this.tweens.add({\n      targets: this.titleText,\n      delay: this.introConfig.titleRevealDelayMs,\n      y: 72,\n      alpha: 1,\n      scaleX: 1,\n      scaleY: 1,\n      ease: \"Cubic.Out\",\n      duration: this.introConfig.titleRevealMs,\n    });\n\n    this.introGlow = this.add.circle(this.scale.width / 2, 86, 220, this.introConfig.glowCyan, 0.08)\n      .setBlendMode(Phaser.BlendModes.ADD)\n      .setDepth(13);\n    this.tweens.add({\n      targets: this.introGlow,\n      alpha: { from: 0.15, to: 0.03 },\n      scale: { from: 0.8, to: 1.14 },\n      ease: \"Sine.InOut\",\n      yoyo: true,\n      repeat: -1,\n      duration: 2200,\n    });\n\n    const orderedButtons = [\"play\", \"continue\", \"options\", \"extras\", \"exit\"]\n      .map((id) => this.menuButtons[id])\n      .filter((b) => !!b);\n    const buttonTargets = [];\n    orderedButtons.forEach((b) => {\n      if (b.glow) buttonTargets.push(b.glow);\n      if (b.box) buttonTargets.push(b.box);\n      if (b.txt) buttonTargets.push(b.txt);\n    });\n\n    buttonTargets.forEach((obj) => {\n      obj.y += this.introConfig.buttonMovePx;\n      obj.setAlpha(0);\n    });\n\n    const titleEndAt = this.introConfig.titleRevealDelayMs + this.introConfig.titleRevealMs;\n    orderedButtons.forEach((b, idx) => {\n      const delay = titleEndAt + idx * this.introConfig.buttonStaggerMs;\n      this.tweens.add({\n        targets: [b.box, b.txt].filter(Boolean),\n        y: `-=${this.introConfig.buttonMovePx}`,\n        alpha: 1,\n        duration: this.introConfig.uiFadeMs,\n        ease: \"Cubic.Out\",\n        delay,\n      });\n    });\n\n    const remainingUi = this.menuUiElements.filter((el) => {\n      if (el === this.titleText) return false;\n      if (buttonTargets.includes(el)) return false;\n      return true;\n    });\n    this.menuIntroUiFadeCall = this.time.delayedCall(titleEndAt + orderedButtons.length * this.introConfig.buttonStaggerMs - 40, () => {\n      this.tweens.add({\n        targets: remainingUi,\n        alpha: 1,\n        duration: this.introConfig.uiFadeMs,\n        ease: \"Sine.Out\",\n      });\n    });\n\n    this.menuIntroDoneCall = this.time.delayedCall(this.introConfig.totalMs, () => {\n      this.menuIntroInProgress = false;\n      this.setMenuInteractive(true);\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Menu intro complete. UI interactive.\");\n    });\n  }\n\n  forceCompleteMenuIntro() {\n    if (!this.menuIntroInProgress) return;\n    this.menuIntroInProgress = false;\n\n    if (this.menuIntroUiFadeCall) this.menuIntroUiFadeCall.remove(false);\n    if (this.menuIntroDoneCall) this.menuIntroDoneCall.remove(false);\n    this.menuIntroUiFadeCall = null;\n    this.menuIntroDoneCall = null;\n\n    const targets = [\n      this.titleText,\n      this.titleShadow,\n      this.menuCard,\n      this.comingSoonText,\n      this.updateButton,\n      this.updateButtonText,\n      this.changeButton,\n      this.changeButtonText,\n      this.changePanel,\n      this.changePanelTitle,\n      this.changePanelBody,\n      this.versionInfoText,\n    ];\n    Object.values(this.menuButtons).forEach((b) => {\n      if (!b) return;\n      targets.push(b.glow, b.box, b.txt);\n    });\n    this.tweens.killTweensOf(targets.filter(Boolean));\n    if (this.introGlow) this.tweens.killTweensOf(this.introGlow);\n\n    this.layoutMenu();\n    this.setMenuUiVisible(true);\n    this.setMenuInteractive(true);\n    if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene\", \"Intro auto-completed due to resize.\");\n  }\n\n  createPrettyBackdrop() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const orbA = this.add.circle(w * 0.78, h * 0.22, 150, this.introConfig.glowCyan, 0.11)\n      .setBlendMode(Phaser.BlendModes.ADD)\n      .setDepth(2);\n    const orbB = this.add.circle(w * 0.2, h * 0.3, 110, this.introConfig.glowPink, 0.1)\n      .setBlendMode(Phaser.BlendModes.ADD)\n      .setDepth(2);\n    this.bgOrbs = [orbA, orbB];\n    this.bgOrbs.forEach((orb, idx) => {\n      this.tweens.add({\n        targets: orb,\n        alpha: { from: orb.alpha * 0.8, to: orb.alpha * 1.35 },\n        scale: { from: 0.88 + idx * 0.08, to: 1.12 + idx * 0.12 },\n        duration: 2800 + idx * 800,\n        yoyo: true,\n        repeat: -1,\n        ease: \"Sine.InOut\",\n      });\n    });\n  }\n\n  normalizeReleaseNotes(rawText) {\n    const text = String(rawText || \"\").replace(/\\r/g, \"\").trim();\n    const isPlaceholder = text.toLowerCase() === \"none\" || text.toLowerCase() === \"null\" || text === \"-\";\n    if (!text || isPlaceholder) {\n      return \"Changelog unavailable for this check.\\n\\nOpen GitHub Releases for full patch notes.\";\n    }\n\n    const withoutTail = text\n      .replace(/\\*\\*?\\s*full\\s*changelog\\s*\\*?\\s*:?\\s*[\\s\\S]*$/i, \"\")\n      .replace(/full\\s*changelog\\s*:?\\s*[\\s\\S]*$/i, \"\")\n      .trim();\n\n    const lines = withoutTail\n      .split(\"\\n\")\n      .filter((line) => !/full\\s*changelog/i.test(line))\n      .filter((line) => !/github\\.com\\/.+\\/compare\\//i.test(line))\n      .filter((line) => !/github\\.com\\/.+\\/releases\\/download\\//i.test(line))\n      .filter((line) => !/^\\s*https?:\\/\\/\\S+\\s*$/i.test(line))\n      .map((line) => line.replace(/https?:\\/\\/\\S+/g, \"\"))\n      .map((line) => line.length > 68 ? `${line.slice(0, 68)}...` : line)\n      .filter((line) => line.trim().length > 0);\n\n    const compact = lines.join(\"\\n\").trim();\n    const capped = compact.length > 460 ? `${compact.slice(0, 460)}\\n...` : compact;\n    return capped || \"Changelog unavailable for this check.\\n\\nOpen GitHub Releases for full patch notes.\";\n  }\n\n  parseVersionParts(versionText) {\n    return String(versionText || \"\")\n      .split(\".\")\n      .map((p) => Number(p))\n      .filter((n) => Number.isFinite(n));\n  }\n\n  compareVersions(aText, bText) {\n    const a = this.parseVersionParts(aText);\n    const b = this.parseVersionParts(bText);\n    const len = Math.max(a.length, b.length);\n    for (let i = 0; i < len; i += 1) {\n      const av = Number.isFinite(a[i]) ? a[i] : 0;\n      const bv = Number.isFinite(b[i]) ? b[i] : 0;\n      if (av > bv) return 1;\n      if (av < bv) return -1;\n    }\n    return 0;\n  }\n\n  setLatestChangesFromResult(result) {\n    if (!result) return;\n    const currentBuild = ((Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\");\n    const v = result.latestVersion ? String(result.latestVersion) : \"\";\n    const staleRemote = !v || this.compareVersions(v, currentBuild) < 0;\n    if (staleRemote) {\n      this.latestReleaseTag = currentBuild;\n      this.latestReleaseNotes = `Release ${currentBuild}\\n\\n${this.localBuildNotes}`;\n      if (this.changePanelBody) this.changePanelBody.setText(this.latestReleaseNotes);\n      return;\n    }\n    const notes = this.normalizeReleaseNotes(result.releaseNotes || \"\");\n    this.latestReleaseTag = v;\n    this.latestReleaseNotes = v ? `Release ${v}\\n\\n${notes}` : notes;\n    if (this.changePanelBody) this.changePanelBody.setText(this.latestReleaseNotes);\n  }\n\n  showExtras() {\n    if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Extras opened.\");\n    try {\n      this.scene.start(\"ExtrasScene\");\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"MenuScene.extras\", err && err.stack ? err.stack : String(err));\n      }\n    }\n  }\n\n  handleExit() {\n    if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Exit requested.\");\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.exit_app === \"function\") {\n      window.pywebview.api.exit_app();\n      return;\n    }\n\n    const hint = this.add.text(this.scale.width / 2, this.scale.height - 36,\n      \"Exit is disabled in browser. Close tab/window.\", {\n        fontFamily: \"Consolas\",\n        fontSize: \"20px\",\n        color: \"#0f172a\",\n        stroke: \"#f8fafc\",\n        strokeThickness: 4,\n      }\n    ).setOrigin(0.5);\n\n    this.time.delayedCall(2200, () => hint.destroy());\n  }\n\n  setupMenuMusic() {\n    const settings = Platformer.Settings.current.audio;\n    const volume = (settings.master / 100) * (settings.music / 100);\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\n        \"MenuScene.audio\",\n        `setupMenuMusic master=${settings.master} music=${settings.music} volume=${volume.toFixed(2)} muted=${this.sound && this.sound.mute ? \"yes\" : \"no\"} hidden=${document.hidden ? \"yes\" : \"no\"}`\n      );\n      if (volume <= 0.001) {\n        Platformer.Debug.warn(\"MenuScene.audio\", \"Effective music volume is 0. Increase Master/Music volume in Options.\");\n      }\n    }\n\n    this.sound.stopByKey(\"pause-bgm\");\n    if (Platformer.pauseMusicHtml) {\n      Platformer.pauseMusicHtml.pause();\n      Platformer.pauseMusicHtml.currentTime = 0;\n      Platformer.pauseMusicHtml = null;\n    }\n\n    if (Platformer.gameMusic) {\n      Platformer.gameMusic.stop();\n      Platformer.gameMusic = null;\n    }\n    if (Platformer.gameMusicHtml) {\n      Platformer.gameMusicHtml.pause();\n      Platformer.gameMusicHtml.currentTime = 0;\n      Platformer.gameMusicHtml = null;\n    }\n\n    const wirePlayback = () => {\n      this.menuMusic = this.sound.get(\"menu-bgm\");\n      if (!this.menuMusic) {\n        try {\n          this.menuMusic = this.sound.add(\"menu-bgm\", { loop: true, volume });\n          if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Created menu-bgm sound instance.\");\n        } catch (_e) {\n          if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene.audio\", \"Failed to create menu-bgm sound instance.\");\n          return;\n        }\n      } else {\n        this.menuMusic.setVolume(volume);\n        this.menuMusic.setLoop(true);\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Reusing existing menu-bgm instance.\");\n      }\n\n      const tryPlay = () => {\n        if (!this.menuMusic) return;\n        if (settings.muteWhenUnfocused && document.hidden) return;\n        if (this.menuMusic.isPlaying) return;\n        try {\n          if (this.sound && this.sound.context && this.sound.context.state === \"suspended\") {\n            this.sound.context.resume().catch(() => {});\n            if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene.audio\", \"WebAudio context suspended; resume requested.\");\n          }\n          this.menuMusic.play();\n          if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Playing menu-bgm (Phaser).\");\n        } catch (_e) {\n          // Autoplay restrictions are expected; user input handler below retries.\n          if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene.audio\", \"menu-bgm play blocked; waiting for next input.\");\n        }\n      };\n\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    };\n\n    // If HTML fallback is already active, just update its volume and keep playing.\n    if (Platformer.menuMusicHtml) {\n      this.menuMusicHtml = Platformer.menuMusicHtml;\n      this.menuMusicHtml.volume = Phaser.Math.Clamp(volume, 0, 1);\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Using existing HTML menu music instance.\");\n      return;\n    }\n\n    if (this.cache.audio.exists(\"menu-bgm\")) {\n      wirePlayback();\n      return;\n    }\n\n    this.load.audio(\"menu-bgm\", \"assets/nickpanek-energetic-chiptune-video-game-music-platformer-8-bit-318348.mp3\");\n    this.load.once(\"complete\", wirePlayback);\n    this.load.once(\"loaderror\", () => {\n      if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene.audio\", \"menu-bgm loaderror; switching to HTML fallback.\");\n      this.setupHtmlAudioFallback(volume, settings);\n    });\n    this.load.start();\n    this.time.delayedCall(1300, () => {\n      if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n      const phaserPlaying = !!(this.menuMusic && this.menuMusic.isPlaying);\n      const htmlPlaying = !!(Platformer.menuMusicHtml && !Platformer.menuMusicHtml.paused);\n      if (!phaserPlaying && !htmlPlaying && Platformer.Debug) {\n        Platformer.Debug.warn(\"MenuScene.audio\", \"No menu music is currently playing after startup.\");\n      }\n    });\n  }\n\n  applyRuntimeSettings(nextSettings) {\n    try {\n      const settings = nextSettings || Platformer.Settings.current || {};\n      const audio = settings.audio || { master: 80, music: 60, muteWhenUnfocused: false };\n      const volume = Phaser.Math.Clamp((Number(audio.master) / 100) * (Number(audio.music) / 100), 0, 1);\n      if (this.menuMusic) {\n        this.menuMusic.setVolume(volume);\n      }\n      if (this.menuMusicHtml) {\n        this.menuMusicHtml.volume = volume;\n      }\n      if (Platformer.menuMusicHtml) {\n        Platformer.menuMusicHtml.volume = volume;\n      }\n      if (audio.muteWhenUnfocused && document.hidden) {\n        if (Platformer.menuMusicHtml && !Platformer.menuMusicHtml.paused) {\n          Platformer.menuMusicHtml.pause();\n        }\n      }\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\"MenuScene.settings\", `Applied runtime settings: menuVolume=${volume.toFixed(2)}`);\n      }\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"MenuScene.settings\", err && err.stack ? err.stack : String(err));\n      }\n    }\n  }\n\n  setupHtmlAudioFallback(volume, settings) {\n    try {\n      if (Platformer.menuMusicHtml) {\n        this.menuMusicHtml = Platformer.menuMusicHtml;\n        this.menuMusicHtml.volume = Phaser.Math.Clamp(volume, 0, 1);\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Reusing HTML fallback music instance.\");\n        return;\n      }\n\n      this.menuMusicHtml = new Audio(\"assets/nickpanek-energetic-chiptune-video-game-music-platformer-8-bit-318348.mp3\");\n      Platformer.menuMusicHtml = this.menuMusicHtml;\n      this.menuMusicHtml.loop = true;\n      this.menuMusicHtml.volume = Phaser.Math.Clamp(volume, 0, 1);\n\n      const tryPlay = () => {\n        if (!this.menuMusicHtml) return;\n        if (settings.muteWhenUnfocused && document.hidden) return;\n        this.menuMusicHtml.play()\n          .then(() => {\n            if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Playing menu-bgm (HTML fallback).\");\n          })\n          .catch((err) => {\n            if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene.audio\", `HTML fallback play blocked: ${err && err.message ? err.message : err}`);\n          });\n      };\n\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    } catch (_e) {\n      // Keep menu functional with no music.\n      if (Platformer.Debug) Platformer.Debug.error(\"MenuScene.audio\", \"HTML fallback setup failed.\");\n    }\n  }\n\n  stopMenuMusic() {\n    if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.audio\", \"Stopping menu music.\");\n    if (this.menuMusic && this.menuMusic.isPlaying) {\n      this.menuMusic.stop();\n    }\n    if (this.menuMusicHtml) {\n      this.menuMusicHtml.pause();\n      this.menuMusicHtml.currentTime = 0;\n      this.menuMusicHtml = null;\n    }\n    if (Platformer.menuMusicHtml) {\n      Platformer.menuMusicHtml.pause();\n      Platformer.menuMusicHtml.currentTime = 0;\n      Platformer.menuMusicHtml = null;\n    }\n  }\n\n  update(_time, delta) {\n    if (!this.introLines || this.introLines.length === 0) return;\n    const w = this.scale.width;\n    const dt = Math.max(0.001, delta / 1000);\n    this.introLines.forEach((line) => {\n      if (!line || !line.active) return;\n      line.x -= line.introSpeed * line.introParallax * dt;\n      if (line.x < -line.width - 10) {\n        line.x = w + Phaser.Math.Between(10, 80);\n      }\n    });\n    const t = _time * 0.001;\n    if (this.bgOrbs && this.bgOrbs.length === 2) {\n      this.bgOrbs[0].x = this.scale.width * 0.78 + Math.cos(t * 0.6) * 16;\n      this.bgOrbs[1].x = this.scale.width * 0.2 + Math.sin(t * 0.75) * 18;\n    }\n    this.updateMenuMiniStage(delta);\n  }\n\n  updateMenuMiniStage(delta) {\n    if (!this.menuRunner || !this.menuStage || !this.menuStage.lane) return;\n    const dt = Math.max(0.001, delta / 1000);\n    const lane = this.menuStage.lane;\n    const minX = lane.x + 26;\n    const maxX = lane.x + lane.width - 26;\n\n    if (!Number.isFinite(this.menuRunner.menuX)) this.menuRunner.menuX = minX + 40;\n    this.menuRunner.menuX += this.menuRunnerFace * this.menuRunnerSpeed * dt;\n    if (this.menuRunner.menuX <= minX) {\n      this.menuRunner.menuX = minX;\n      this.menuRunnerFace = 1;\n    } else if (this.menuRunner.menuX >= maxX) {\n      this.menuRunner.menuX = maxX;\n      this.menuRunnerFace = -1;\n    }\n\n    this.menuRunnerJumpCooldown -= delta;\n    this.menuRunnerDamageCooldown -= delta;\n    this.menuRunnerActionTimer -= delta;\n    const target = this.menuEnemies.find((e) => {\n      if (!e || !e.alive) return false;\n      const dx = e.menuX - this.menuRunner.menuX;\n      if (Math.abs(dx) > 120) return false;\n      return dx * this.menuRunnerFace > 0;\n    });\n    const grounded = this.menuRunner.y >= this.menuRunnerGroundY - 0.5;\n    const freestyleJump = grounded && this.menuRunnerActionTimer <= 0 && this.menuRunnerJumpCooldown <= 0 && Phaser.Math.Between(0, 100) < 12;\n    if ((target || freestyleJump) && grounded && this.menuRunnerJumpCooldown <= 0) {\n      this.menuRunnerVy = this.menuRunnerJumpVy;\n      this.menuRunnerJumpCooldown = target ? 520 : 900;\n      this.menuRunnerActionTimer = Phaser.Math.Between(650, 1300);\n    }\n\n    this.menuRunnerVy += this.menuRunnerGravity * dt;\n    this.menuRunner.y += this.menuRunnerVy * dt;\n    if (this.menuRunner.y > this.menuRunnerGroundY) {\n      this.menuRunner.y = this.menuRunnerGroundY;\n      this.menuRunnerVy = 0;\n    }\n\n    this.menuRunner.setFlipX(this.menuRunnerFace < 0);\n    if (this.menuRunnerVy < -30) this.menuRunner.setTexture(this.textureOr(\"player-jump\", \"player\"));\n    else if (this.menuRunnerVy > 70 && this.menuRunner.y < this.menuRunnerGroundY) this.menuRunner.setTexture(this.textureOr(\"player-jump\", \"player\"));\n    else this.menuRunner.setTexture(this.textureOr(Math.floor(this.time.now / 130) % 2 === 0 ? \"player-run-1\" : \"player-run-2\", \"player\"));\n    this.menuRunner.x = this.menuRunner.menuX;\n    if (this.time.now < this.menuRunnerDamageFlashUntil) {\n      const blinkOn = Math.floor(this.time.now / 70) % 2 === 0;\n      if (blinkOn) this.menuRunner.setTint(0xff4d4d);\n      else this.menuRunner.clearTint();\n    } else {\n      this.menuRunner.clearTint();\n    }\n\n    this.menuEnemies.forEach((enemy) => {\n      if (!enemy) return;\n      if (!enemy.alive) {\n        if (this.time.now >= enemy.respawnAt) {\n          enemy.alive = true;\n          enemy.setVisible(true);\n          enemy.setAlpha(1);\n          enemy.setScale(1, 1);\n          enemy.y = this.menuRunnerGroundY + 2;\n          enemy.menuX = Phaser.Math.Between(minX + 40, maxX - 40);\n          enemy.menuDir = Phaser.Math.Between(0, 1) ? 1 : -1;\n        }\n        return;\n      }\n\n      enemy.menuX += enemy.menuDir * enemy.menuSpeed * dt;\n      if (enemy.menuX <= minX + 18) {\n        enemy.menuX = minX + 18;\n        enemy.menuDir = 1;\n      } else if (enemy.menuX >= maxX - 18) {\n        enemy.menuX = maxX - 18;\n        enemy.menuDir = -1;\n      }\n      enemy.x = enemy.menuX;\n      enemy.setFlipX(enemy.menuDir < 0);\n      const stomp = Math.abs(this.menuRunner.x - enemy.x) < 18\n        && this.menuRunner.y < enemy.y - 10\n        && this.menuRunnerVy > 60;\n      if (stomp) {\n        enemy.alive = false;\n        enemy.respawnAt = this.time.now + Phaser.Math.Between(1300, 2200);\n        this.tweens.add({\n          targets: enemy,\n          scaleX: 1.35,\n          scaleY: 0.45,\n          alpha: 0.25,\n          duration: 120,\n          onComplete: () => {\n            if (enemy && enemy.active) enemy.setVisible(false);\n          },\n        });\n        const puff = this.add.circle(enemy.x, enemy.y - 6, 6, 0xffffff, 0.95).setDepth(8.25).setBlendMode(Phaser.BlendModes.ADD);\n        this.menuStage.add(puff);\n        this.tweens.add({\n          targets: puff,\n          scale: 3.1,\n          alpha: 0,\n          duration: 260,\n          ease: \"Cubic.Out\",\n          onComplete: () => puff.destroy(),\n        });\n        this.menuRunnerVy = -190;\n        return;\n      }\n\n      const sideHit = Math.abs(this.menuRunner.x - enemy.x) < 22\n        && Math.abs(this.menuRunner.y - enemy.y) < 24\n        && this.menuRunnerDamageCooldown <= 0;\n      if (sideHit) {\n        this.menuRunnerDamageCooldown = 700;\n        this.menuRunnerDamageFlashUntil = this.time.now + 420;\n        this.menuRunnerVy = -120;\n        this.menuRunnerFace = this.menuRunner.x < enemy.x ? -1 : 1;\n        this.menuRunner.menuX += this.menuRunnerFace * 20;\n        this.menuRunner.menuX = Phaser.Math.Clamp(this.menuRunner.menuX, minX, maxX);\n      }\n    });\n    this.saveMenuMiniStageState();\n  }\n\n  textureOr(textureKey, fallbackKey) {\n    if (textureKey && this.textures.exists(textureKey)) return textureKey;\n    if (fallbackKey && this.textures.exists(fallbackKey)) return fallbackKey;\n    return \"__WHITE\";\n  }\n\n  shutdown() {\n    if (this.onSettingsChanged) {\n      this.game.events.off(\"settings-changed\", this.onSettingsChanged);\n      this.onSettingsChanged = null;\n    }\n    // Keep menu music alive across Menu <-> Options transitions.\n    this.saveMenuMiniStageState();\n    if (this.onResize) {\n      this.scale.off(\"resize\", this.onResize);\n      this.onResize = null;\n    }\n    if (this.introParticles) {\n      this.introParticles.destroy();\n      this.introParticles = null;\n    }\n    if (this.introFx) {\n      this.introFx.destroy(true);\n      this.introFx = null;\n    }\n    if (this.introGlow) {\n      this.introGlow.destroy();\n      this.introGlow = null;\n    }\n    if (this.menuStage) {\n      this.menuStage.destroy(true);\n      this.menuStage = null;\n    }\n    this.menuRunner = null;\n    this.menuEnemies = [];\n    this.bgOrbs = [];\n    this.introLines = [];\n  }\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.WorldMapScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"WorldMapScene\");\n    this.mapData = null;\n    this.progress = null;\n    this.mapRoot = null;\n    this.avatar = null;\n    this.controller = null;\n    this.nodes = [];\n    this.selectedNode = null;\n    this.ui = null;\n    this.keys = null;\n    this.onResize = null;\n    this.lastSaveAt = 0;\n    this.lastInteractDown = false;\n    this.lastHelpDown = false;\n    this.focusNodeId = null;\n    this.lastViewportW = 0;\n    this.lastViewportH = 0;\n    this.pendingRelayoutCall = null;\n    this.useDataDrivenWorld = false;\n    this.worldView = null;\n    this.activeWorld = null;\n    this.pendingWorldLoad = null;\n    this.worldNodeById = {};\n    this.worldGraph = {};\n    this.currentNodeId = null;\n    this.pendingTargetNodeId = null;\n    this.travelState = null;\n    this.prevInput = { left: false, right: false, up: false, down: false, interact: false };\n    this.autoWalkConsumed = {};\n    this.worldState = null;\n    this.shopPanel = null;\n    this.onSettingsChanged = null;\n  }\n\n  init(data) {\n    this.focusNodeId = data && data.focusNodeId ? String(data.focusNodeId) : null;\n  }\n\n  create() {\n    this.onSettingsChanged = (nextSettings) => this.applyRuntimeSettings(nextSettings);\n    this.game.events.on(\"settings-changed\", this.onSettingsChanged);\n    if (!Platformer.DEBUG_WORLD_MAP) {\n      this.useDataDrivenWorld = true;\n      this.createDataDrivenWorldStatic();\n      return;\n    }\n\n    this.mapData = Platformer.WorldMapData;\n    this.progress = Platformer.Progress;\n    this.progress.ensureLoaded();\n\n    this.mapRoot = this.add.container(0, 0).setDepth(10);\n    this.drawBackground();\n    this.drawPathsAndBlockedRegions();\n    this.createNodes();\n    this.createAvatar();\n    this.ui = new Platformer.WorldMapUI(this);\n\n    this.keys = this.buildInputMap();\n    this.input.keyboard.on(\"keydown-ESC\", () => this.scene.start(\"MenuScene\"));\n    this.input.keyboard.on(\"keydown-H\", () => this.ui.toggleHelp());\n\n    this.onResize = () => this.handleResize();\n    this.scale.on(\"resize\", this.onResize);\n    this.handleResize();\n\n    if (Platformer.Debug) {\n      const unlocked = Object.keys(this.progress.ensureLoaded().unlockedNodes || {}).length;\n      Platformer.Debug.log(\"WorldMap\", `Loaded map=${this.mapData.id} nodes=${this.nodes.length} unlocked=${unlocked}`);\n    }\n  }\n\n  createDataDrivenWorldStatic() {\n    this.progress = Platformer.Progress;\n    this.progress.ensureLoaded();\n    this.keys = this.buildInputMap();\n    this.shopPanel = new Platformer.WorldMapShopPanel(this);\n    this.ensureWorldMapMusic();\n    this.time.delayedCall(1300, () => {\n      if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n      const phaserPlaying = !!(this.sound && this.sound.get(\"menu-bgm\") && this.sound.get(\"menu-bgm\").isPlaying);\n      const htmlPlaying = !!(Platformer.menuMusicHtml && !Platformer.menuMusicHtml.paused);\n      if (!phaserPlaying && !htmlPlaying && Platformer.Debug) {\n        Platformer.Debug.warn(\"WorldMap.audio\", \"No world-map music is currently playing after startup.\");\n      }\n    });\n\n    this.input.keyboard.on(\"keydown-ESC\", () => {\n      if (this.shopPanel && this.shopPanel.visible) {\n        this.shopPanel.close();\n        this.refreshTraversalUi();\n        return;\n      }\n      this.scene.start(\"MenuScene\");\n    });\n    this.onResize = () => this.handleResize();\n    this.scale.on(\"resize\", this.onResize);\n\n    this.pendingWorldLoad = Platformer.WorldMapManager.loadWorld(\"world_tutorial\")\n      .then((world) => {\n        if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n        this.activeWorld = world;\n        this.worldState = this.progress.ensureWorldState(world);\n        this.applyWorldProgressToNodes();\n        this.worldView = new Platformer.WorldMapView(this, world);\n        this.worldView.render();\n        this.buildWorldGraph();\n        this.initWorldTraversalState();\n        this.handleResize();\n      })\n      .catch((err) => {\n        if (Platformer.Debug) {\n          Platformer.Debug.error(\"WorldMapScene.createDataDrivenWorldStatic\", err && err.stack ? err.stack : String(err));\n        }\n      })\n      .finally(() => {\n        this.pendingWorldLoad = null;\n      });\n  }\n\n  applyWorldProgressToNodes() {\n    if (!this.activeWorld || !Array.isArray(this.activeWorld.nodes) || !this.progress) return;\n    const ws = this.progress.ensureWorldState(this.activeWorld);\n    this.worldState = ws;\n    this.activeWorld.nodes.forEach((node) => {\n      if (!node || !node.id) return;\n      const id = String(node.id);\n      const unlocked = !!ws.unlockedNodes[id];\n      const completed = !!ws.completedNodes[id];\n      node.state = completed ? \"completed\" : (unlocked ? \"unlocked\" : \"locked\");\n    });\n  }\n\n  buildWorldGraph() {\n    this.worldNodeById = {};\n    this.worldGraph = {};\n    const nodes = Array.isArray(this.activeWorld && this.activeWorld.nodes) ? this.activeWorld.nodes : [];\n    const edges = Array.isArray(this.activeWorld && this.activeWorld.edges) ? this.activeWorld.edges : [];\n    nodes.forEach((n) => {\n      if (!n || !n.id || !n.pos) return;\n      this.worldNodeById[n.id] = n;\n      this.worldGraph[n.id] = this.worldGraph[n.id] || [];\n    });\n    edges.forEach((e) => {\n      if (!e || !e.from || !e.to) return;\n      if (!this.worldNodeById[e.from] || !this.worldNodeById[e.to]) return;\n      this.worldGraph[e.from] = this.worldGraph[e.from] || [];\n      this.worldGraph[e.to] = this.worldGraph[e.to] || [];\n      if (!this.worldGraph[e.from].includes(e.to)) this.worldGraph[e.from].push(e.to);\n      if (!this.worldGraph[e.to].includes(e.from)) this.worldGraph[e.to].push(e.from);\n    });\n  }\n\n  initWorldTraversalState() {\n    const startId = (this.activeWorld && this.activeWorld.startNodeId) || null;\n    this.currentNodeId = this.resolveInitialNodeId(startId);\n    this.pendingTargetNodeId = null;\n    this.travelState = null;\n    this.autoWalkConsumed = {};\n\n    const node = this.worldNodeById[this.currentNodeId];\n    if (node && this.worldView) {\n      this.worldView.createAvatar();\n      this.worldView.setAvatarPosition(node.pos.x - 26, node.pos.y);\n      this.worldView.selectNode(node.id);\n      this.refreshTraversalUi();\n    }\n  }\n\n  resolveInitialNodeId(defaultId) {\n    if (this.focusNodeId && this.worldNodeById[this.focusNodeId]) return this.focusNodeId;\n    const ws = this.progress.ensureWorldState(this.activeWorld);\n    if (ws && ws.lastSelectedNodeId && this.worldNodeById[ws.lastSelectedNodeId]) return ws.lastSelectedNodeId;\n    if (defaultId && this.worldNodeById[defaultId]) return defaultId;\n    const keys = Object.keys(this.worldNodeById);\n    return keys.length ? keys[0] : null;\n  }\n\n  getConnectedNodeIds(nodeId) {\n    return (this.worldGraph[nodeId] || []).filter((id) => !!this.worldNodeById[id]);\n  }\n\n  isCurrentWorldNodeUnlocked(nodeId) {\n    if (!this.activeWorld || !this.progress) return false;\n    return this.progress.isWorldNodeUnlocked(this.activeWorld, nodeId);\n  }\n\n  chooseDirectionalNeighbor(fromId, dirX, dirY) {\n    const from = this.worldNodeById[fromId];\n    if (!from) return null;\n    const candidates = this.getConnectedNodeIds(fromId).filter((id) => this.isCurrentWorldNodeUnlocked(id));\n    if (!candidates.length) return null;\n\n    let bestId = null;\n    let bestScore = -Infinity;\n    candidates.forEach((id) => {\n      const to = this.worldNodeById[id];\n      if (!to) return;\n      const vx = to.pos.x - from.pos.x;\n      const vy = to.pos.y - from.pos.y;\n      const mag = Math.sqrt(vx * vx + vy * vy);\n      if (mag < 0.001) return;\n      const nx = vx / mag;\n      const ny = vy / mag;\n      const dot = nx * dirX + ny * dirY;\n      if (dot <= 0.15) return;\n      const score = dot * 1000 - mag;\n      if (score > bestScore) {\n        bestScore = score;\n        bestId = id;\n      }\n    });\n    return bestId;\n  }\n\n  startTravelTo(targetNodeId, autoWalk = false) {\n    if (!this.currentNodeId || !targetNodeId || this.currentNodeId === targetNodeId) return false;\n    if (!this.isCurrentWorldNodeUnlocked(targetNodeId)) return false;\n    const from = this.worldNodeById[this.currentNodeId];\n    const to = this.worldNodeById[targetNodeId];\n    if (!from || !to) return false;\n    const dx = to.pos.x - from.pos.x;\n    const dy = to.pos.y - from.pos.y;\n    const dist = Math.sqrt(dx * dx + dy * dy);\n    if (dist < 1) return false;\n\n    this.travelState = {\n      fromId: this.currentNodeId,\n      toId: targetNodeId,\n      x: from.pos.x - 26,\n      y: from.pos.y,\n      startX: from.pos.x - 26,\n      startY: from.pos.y,\n      endX: to.pos.x - 26,\n      endY: to.pos.y,\n      dist,\n      traveled: 0,\n      speed: autoWalk ? 92 : 170,\n      autoWalk: !!autoWalk,\n    };\n    this.pendingTargetNodeId = targetNodeId;\n    return true;\n  }\n\n  updateTravel(deltaMs) {\n    if (!this.travelState || !this.worldView) return;\n    const dt = Math.max(0.001, Number(deltaMs || 16) / 1000);\n    const t = this.travelState;\n    const step = Math.min(t.dist - t.traveled, t.speed * dt);\n    t.traveled += step;\n    const p = Phaser.Math.Clamp(t.traveled / Math.max(1, t.dist), 0, 1);\n    const x = Phaser.Math.Linear(t.startX, t.endX, p);\n    const y = Phaser.Math.Linear(t.startY, t.endY, p);\n    this.worldView.setAvatarPosition(x, y);\n    this.worldView.setAvatarFacing(t.endX - t.startX);\n    this.worldView.setAvatarMoving(true, this.time.now);\n\n    if (p >= 1) {\n      this.currentNodeId = t.toId;\n      this.travelState = null;\n      this.pendingTargetNodeId = null;\n      this.onArriveNode(this.currentNodeId);\n    }\n  }\n\n  onArriveNode(nodeId) {\n    const node = this.worldNodeById[nodeId];\n    if (!node || !this.worldView) return;\n    this.worldView.setAvatarMoving(false, this.time.now);\n    this.worldView.selectNode(nodeId);\n    this.progress.setWorldSelectedNode(this.activeWorld, nodeId);\n    this.refreshTraversalUi();\n  }\n\n  refreshTraversalUi() {\n    if (!this.worldView || !this.currentNodeId) return;\n    const node = this.worldNodeById[this.currentNodeId];\n    if (!node) return;\n    this.applyWorldProgressToNodes();\n    if (this.worldView) {\n      this.activeWorld.nodes.forEach((n) => {\n        this.worldView.setNodeState(n.id, n.state);\n      });\n    }\n    this.worldView.selectNode(node.id);\n    const options = this.getConnectedNodeIds(node.id).filter((id) => this.isCurrentWorldNodeUnlocked(id));\n    this.worldView.setAvailableNodes(options, this.pendingTargetNodeId);\n\n    const title = node.ui && node.ui.title ? node.ui.title : node.id;\n    const hint = node.ui && node.ui.hint ? node.ui.hint : \"Press Enter/E to confirm\";\n    const nodeUnlocked = this.isCurrentWorldNodeUnlocked(node.id);\n    const prompt = this.pendingTargetNodeId\n      ? `Traveling to ${this.pendingTargetNodeId}...`\n      : (nodeUnlocked\n        ? (String(node.type || \"\") === \"shop\" ? \"Move: WASD/Arrows  Confirm: E/Enter (Shop)\" : \"Move: WASD/Arrows  Confirm: E/Enter\")\n        : \"Locked node.\");\n    const best = this.progress.getWorldNodeBest(this.activeWorld, node.id);\n    this.worldView.infoTitle.setText(`${title} (${node.id})`);\n    this.worldView.infoBody.setText([\n      `Type: ${String(node.type || \"level\")}`,\n      `State: ${String(node.state || \"locked\")}`,\n      `Best Coins: ${best ? Number(best.bestCoins || 0) : 0}`,\n      `Best Time Left: ${best ? Number(best.bestTimeLeft || 0) : 0}s`,\n      \"\",\n      hint,\n    ].join(\"\\n\"));\n    this.worldView.reflowInfoPanel();\n    this.worldView.setPrompt(prompt);\n\n    const edgeCount = Array.isArray(this.activeWorld && this.activeWorld.edges) ? this.activeWorld.edges.length : 0;\n    const unlockedCount = this.activeWorld.nodes.filter((n) => this.isCurrentWorldNodeUnlocked(n.id)).length;\n    this.worldView.setDebug(`World: ${this.activeWorld.id} | Node: ${node.id} | Next: ${options.length} | Unlocked: ${unlockedCount}/${this.activeWorld.nodes.length} | Edges: ${edgeCount}`);\n  }\n\n  tryStartAutoWalk() {\n    if (!this.currentNodeId || this.travelState) return;\n    const node = this.worldNodeById[this.currentNodeId];\n    if (!node || !node.autoWalkTo) return;\n    if (this.autoWalkConsumed[node.id]) return;\n    if (!this.worldNodeById[node.autoWalkTo]) return;\n    if (!this.isCurrentWorldNodeUnlocked(node.autoWalkTo)) return;\n    this.autoWalkConsumed[node.id] = true;\n    this.startTravelTo(node.autoWalkTo, true);\n    this.refreshTraversalUi();\n  }\n\n  drawBackground() {\n    const { w, h } = this.getViewportSize();\n    this.bgSky = this.add.rectangle(0, 0, w, h, 0x071638, 1).setOrigin(0, 0).setDepth(0).setScrollFactor(0);\n    this.bgStrip1 = this.add.rectangle(0, h * 0.15, w, h * 0.18, 0x122b63, 0.5).setOrigin(0, 0).setDepth(1).setScrollFactor(0);\n    this.bgStrip2 = this.add.rectangle(0, h * 0.62, w, h * 0.22, 0x173c84, 0.48).setOrigin(0, 0).setDepth(1).setScrollFactor(0);\n    this.grid = this.add.graphics().setDepth(2).setScrollFactor(0);\n    this.redrawGrid();\n\n    this.particles = this.add.particles(0, 0, this.textureOr(\"coin\", \"__WHITE\"), {\n      x: { min: 0, max: w },\n      y: { min: 0, max: h },\n      lifespan: { min: 2500, max: 5000 },\n      speedY: { min: -18, max: -5 },\n      speedX: { min: -8, max: 8 },\n      scale: { start: 0.08, end: 0 },\n      alpha: { start: 0.3, end: 0 },\n      frequency: 130,\n      quantity: 1,\n    }).setDepth(3).setScrollFactor(0);\n  }\n\n  redrawGrid() {\n    if (!this.grid) return;\n    const { w, h } = this.getViewportSize();\n    this.grid.clear();\n    this.grid.lineStyle(1, 0x38bdf8, 0.08);\n    for (let x = 0; x < w; x += 64) {\n      this.grid.beginPath();\n      this.grid.moveTo(x, 0);\n      this.grid.lineTo(x, h);\n      this.grid.strokePath();\n    }\n    for (let y = 0; y < h; y += 64) {\n      this.grid.beginPath();\n      this.grid.moveTo(0, y);\n      this.grid.lineTo(w, y);\n      this.grid.strokePath();\n    }\n  }\n\n  drawPathsAndBlockedRegions() {\n    const g = this.add.graphics().setDepth(10);\n    g.lineStyle(8, 0x0f2f63, 0.95);\n    this.mapData.nodes.forEach((node) => {\n      (node.next || []).forEach((nextId) => {\n        const next = this.mapData.getNodeById(nextId);\n        if (!next) return;\n        g.beginPath();\n        g.moveTo(node.x, node.y);\n        g.lineTo(next.x, next.y);\n        g.strokePath();\n      });\n    });\n    g.lineStyle(3, 0x67e8f9, 0.88);\n    this.mapData.nodes.forEach((node) => {\n      (node.next || []).forEach((nextId) => {\n        const next = this.mapData.getNodeById(nextId);\n        if (!next) return;\n        g.beginPath();\n        g.moveTo(node.x, node.y);\n        g.lineTo(next.x, next.y);\n        g.strokePath();\n      });\n    });\n\n    this.mapRoot.add(g);\n    this.blockedVisuals = this.mapData.blockedRegions.map((r) => {\n      const rect = this.add.rectangle(r.x + r.width / 2, r.y + r.height / 2, r.width, r.height, 0x0f172a, 0.62)\n        .setStrokeStyle(2, 0x334155, 0.9)\n        .setDepth(11);\n      const label = this.add.text(rect.x, rect.y, r.label || \"blocked\", {\n        fontFamily: \"Consolas\",\n        fontSize: \"14px\",\n        color: \"#94a3b8\",\n      }).setOrigin(0.5).setDepth(12);\n      this.mapRoot.add([rect, label]);\n      return { rect, label };\n    });\n  }\n\n  createNodes() {\n    this.nodes = this.mapData.nodes.map((n) => new Platformer.LevelNode(this, n, this.progress, this.mapRoot));\n    this.refreshNodeUnlocks();\n  }\n\n  createAvatar() {\n    const spawn = this.computeSpawnPoint();\n    this.avatar = this.add.sprite(spawn.x, spawn.y, this.textureOr(\"player-run-1\", \"player-idle-1\")).setDepth(30);\n    this.avatar.setDisplaySize(42, 56);\n    this.mapRoot.add(this.avatar);\n    this.controller = new Platformer.PlayerMapController(\n      this,\n      this.avatar,\n      this.mapData.bounds,\n      this.mapData.blockedRegions\n    );\n  }\n\n  computeSpawnPoint() {\n    const d = this.progress.ensureLoaded();\n    if (this.focusNodeId) {\n      const node = this.mapData.getNodeById(this.focusNodeId);\n      if (node) return { x: node.x - 26, y: node.y };\n    }\n    if (d.lastMapPosition) {\n      return {\n        x: Phaser.Math.Clamp(d.lastMapPosition.x, this.mapData.bounds.x + 18, this.mapData.bounds.x + this.mapData.bounds.width - 18),\n        y: Phaser.Math.Clamp(d.lastMapPosition.y, this.mapData.bounds.y + 18, this.mapData.bounds.y + this.mapData.bounds.height - 18),\n      };\n    }\n    if (d.lastSelectedNodeId) {\n      const node = this.mapData.getNodeById(d.lastSelectedNodeId);\n      if (node) return { x: node.x - 26, y: node.y };\n    }\n    return { x: this.mapData.spawn.x, y: this.mapData.spawn.y };\n  }\n\n  buildInputMap() {\n    const controls = Platformer.Settings.current.controls || {};\n    const key = (name, fallback) => {\n      const code = String(controls[name] || fallback || \"\").toUpperCase();\n      return this.input.keyboard.addKey(code);\n    };\n    return {\n      left: key(\"left\", \"A\"),\n      right: key(\"right\", \"D\"),\n      up: key(\"jump\", \"W\"),\n      down: this.input.keyboard.addKey(\"S\"),\n      interact: key(\"interact\", \"E\"),\n      enter: this.input.keyboard.addKey(\"ENTER\"),\n      arrows: this.input.keyboard.createCursorKeys(),\n    };\n  }\n\n  getInputState() {\n    const k = this.keys;\n    return {\n      left: (k.left && k.left.isDown) || (k.arrows && k.arrows.left.isDown),\n      right: (k.right && k.right.isDown) || (k.arrows && k.arrows.right.isDown),\n      up: (k.up && k.up.isDown) || (k.arrows && k.arrows.up.isDown),\n      down: (k.down && k.down.isDown) || (k.arrows && k.arrows.down.isDown),\n      interact: (k.interact && k.interact.isDown) || (k.enter && k.enter.isDown),\n    };\n  }\n\n  refreshNodeUnlocks() {\n    this.nodes.forEach((n) => n.refreshUnlock());\n  }\n\n  update(_time, delta) {\n    if (this.useDataDrivenWorld) {\n      if (this.worldView && typeof this.worldView.updateAmbient === \"function\") {\n        this.worldView.updateAmbient(_time, delta);\n      }\n      const vp = this.getViewportSize();\n      if (vp.w !== this.lastViewportW || vp.h !== this.lastViewportH) {\n        this.handleResize(vp.w, vp.h);\n      }\n      if (this.travelState) {\n        this.updateTravel(delta);\n        return;\n      }\n      this.handleDataDrivenInput();\n      return;\n    }\n    if (!this.controller || !this.avatar) return;\n    const vp = this.getViewportSize();\n    if (vp.w !== this.lastViewportW || vp.h !== this.lastViewportH) {\n      this.handleResize(vp.w, vp.h);\n    }\n    const input = this.getInputState();\n    const motion = this.controller.update(input, delta);\n\n    if (motion.moving) {\n      const frame = Math.floor(this.time.now / 120) % 2 === 0 ? \"player-run-1\" : \"player-run-2\";\n      this.avatar.setTexture(this.textureOr(frame, \"player-idle-1\"));\n    } else {\n      this.avatar.setTexture(this.textureOr(\"player-idle-1\", \"player-run-1\"));\n    }\n\n    this.updateSelectedNode();\n    this.updateInteraction(input.interact);\n    this.updateSaveTick();\n  }\n\n  updateSelectedNode() {\n    let nearest = null;\n    let nearestDist = Infinity;\n    this.nodes.forEach((node) => {\n      const dx = this.avatar.x - node.data.x;\n      const dy = this.avatar.y - node.data.y;\n      const dist = Math.sqrt(dx * dx + dy * dy);\n      const inRange = dist <= node.radius;\n      node.setSelected(inRange);\n      if (inRange && dist < nearestDist) {\n        nearest = node;\n        nearestDist = dist;\n      }\n    });\n\n    this.selectedNode = nearest;\n    const d = this.progress.ensureLoaded();\n    const best = nearest ? d.bestByNode[nearest.id] : null;\n    const tutorialHint = nearest && !this.progress.hasSeenTutorial(nearest.id)\n      ? `Tip: ${nearest.data.tutorial || \"No tutorial text.\"}`\n      : \"\";\n    this.ui.updateNodeInfo(\n      nearest ? nearest.data : null,\n      best,\n      nearest ? nearest.unlocked : false,\n      !!nearest,\n      tutorialHint\n    );\n\n    const unlockedCount = Object.keys(d.unlockedNodes || {}).filter((k) => d.unlockedNodes[k]).length;\n    this.ui.setDebug(`Selected: ${nearest ? nearest.id : \"none\"} | Unlocked: ${unlockedCount}/${this.nodes.length}`);\n  }\n\n  updateInteraction(interactDown) {\n    const pressed = interactDown && !this.lastInteractDown;\n    this.lastInteractDown = interactDown;\n    if (!pressed || !this.selectedNode) return;\n\n    const node = this.selectedNode;\n    if (!node.unlocked) {\n      Platformer.beeper.damage();\n      return;\n    }\n\n    this.progress.data.lastSelectedNodeId = node.id;\n    this.progress.save();\n    if (!this.progress.hasSeenTutorial(node.id)) {\n      this.progress.markTutorialSeen(node.id);\n      if (Platformer.Debug) Platformer.Debug.log(\"WorldMap\", `First-time hint consumed for ${node.id}`);\n    }\n    this.progress.updateMapPosition({ x: this.avatar.x, y: this.avatar.y });\n\n    this.launchLevel(node.data);\n  }\n\n  launchLevel(nodeData) {\n    if (!nodeData) return;\n    const levelNum = this.resolveNodeGameLevel(nodeData);\n    if (Platformer.Debug) Platformer.Debug.log(\"WorldMap\", `Entering ${nodeData.id} -> level=${levelNum}`);\n    this.stopWorldMapMusic();\n\n    const difficulty = Platformer.Settings.current.gameplay.difficulty;\n    const baseLives = difficulty === \"easy\" ? 3 : (difficulty === \"hard\" ? 1 : 2);\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"health\", 3);\n    this.registry.set(\"lives\", baseLives);\n    this.registry.set(\"level\", levelNum);\n\n    if (this.scene.isActive(\"UIScene\") || this.scene.isPaused(\"UIScene\")) {\n      this.scene.stop(\"UIScene\");\n    }\n\n    this.scene.start(\"GameScene\", {\n      level: levelNum,\n      nodeId: nodeData.id,\n      worldId: this.activeWorld && this.activeWorld.id ? this.activeWorld.id : null,\n      fromWorldMap: true,\n    });\n    this.scene.launch(\"UIScene\");\n  }\n\n  resolveNodeGameLevel(nodeData) {\n    if (!nodeData) return 1;\n    if (Number.isFinite(Number(nodeData.gameLevel))) return Number(nodeData.gameLevel);\n    if (nodeData.levelRef && Platformer.WorldMapManager && typeof Platformer.WorldMapManager.resolveGameLevelRef === \"function\") {\n      return Platformer.WorldMapManager.resolveGameLevelRef(nodeData.levelRef);\n    }\n    return 1;\n  }\n\n  ensureWorldMapMusic() {\n    try {\n      const audioSettings = Platformer.Settings.current.audio;\n      const volume = Phaser.Math.Clamp((audioSettings.master / 100) * (audioSettings.music / 100), 0, 1);\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\n          \"WorldMap.audio\",\n          `Ensuring map BGM master=${audioSettings.master} music=${audioSettings.music} volume=${volume.toFixed(2)} muted=${this.sound && this.sound.mute ? \"yes\" : \"no\"} hidden=${document.hidden ? \"yes\" : \"no\"}`\n        );\n        if (volume <= 0.001) {\n          Platformer.Debug.warn(\"WorldMap.audio\", \"Effective music volume is 0. Increase Master/Music volume in Options.\");\n        }\n      }\n\n      if (Platformer.gameMusic) {\n        try {\n          if (Platformer.gameMusic.isPlaying) Platformer.gameMusic.stop();\n        } catch (_e) {}\n        Platformer.gameMusic = null;\n      }\n      if (Platformer.gameMusicHtml) {\n        try {\n          Platformer.gameMusicHtml.pause();\n          Platformer.gameMusicHtml.currentTime = 0;\n        } catch (_e) {}\n        Platformer.gameMusicHtml = null;\n      }\n\n      const tryPlayMenuBgm = () => {\n        let music = this.sound.get(\"menu-bgm\");\n        if (!music) {\n          try {\n            music = this.sound.add(\"menu-bgm\", { loop: true, volume });\n            if (Platformer.Debug) Platformer.Debug.log(\"WorldMap.audio\", \"Created menu-bgm sound instance.\");\n          } catch (err) {\n            if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.audio\", `menu-bgm add failed: ${err && err.message ? err.message : err}`);\n            return false;\n          }\n        }\n        Platformer.menuMusic = music;\n        music.setLoop(true);\n        music.setVolume(volume);\n        if (!music.isPlaying) {\n          try {\n            if (this.sound && this.sound.context && this.sound.context.state === \"suspended\") {\n              this.sound.context.resume().catch(() => {});\n              if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.audio\", \"WebAudio context suspended; resume requested.\");\n            }\n            music.play();\n            if (Platformer.Debug) Platformer.Debug.log(\"WorldMap.audio\", \"Playing menu-bgm (Phaser).\");\n          } catch (err) {\n            if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.audio\", `menu-bgm play blocked: ${err && err.message ? err.message : err}`);\n            return false;\n          }\n        } else if (Platformer.Debug) {\n          Platformer.Debug.log(\"WorldMap.audio\", \"menu-bgm already playing.\");\n        }\n        return true;\n      };\n\n      if (this.cache.audio.exists(\"menu-bgm\")) {\n        if (tryPlayMenuBgm()) return;\n      } else {\n        this.load.audio(\"menu-bgm\", \"assets/nickpanek-energetic-chiptune-video-game-music-platformer-8-bit-318348.mp3\");\n        this.load.once(\"complete\", () => {\n          if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n          if (!tryPlayMenuBgm()) {\n            this.playWorldMapHtmlMusic(volume, audioSettings);\n          }\n        });\n        this.load.once(\"loaderror\", () => {\n          if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.audio\", \"menu-bgm loaderror; using HTML fallback.\");\n          this.playWorldMapHtmlMusic(volume, audioSettings);\n        });\n        this.load.start();\n        return;\n      }\n      this.playWorldMapHtmlMusic(volume, audioSettings);\n    } catch (err) {\n      if (Platformer.Debug) Platformer.Debug.error(\"WorldMap.audio\", err && err.stack ? err.stack : String(err));\n    }\n  }\n\n  applyRuntimeSettings(nextSettings) {\n    try {\n      const settings = nextSettings || Platformer.Settings.current || {};\n      const audio = settings.audio || { master: 80, music: 60, muteWhenUnfocused: false };\n      const volume = Phaser.Math.Clamp((Number(audio.master) / 100) * (Number(audio.music) / 100), 0, 1);\n\n      if (Platformer.menuMusic && typeof Platformer.menuMusic.setVolume === \"function\") {\n        Platformer.menuMusic.setVolume(volume);\n      }\n      if (Platformer.menuMusicHtml) {\n        Platformer.menuMusicHtml.volume = volume;\n      }\n      if (audio.muteWhenUnfocused && document.hidden) {\n        if (Platformer.menuMusicHtml && !Platformer.menuMusicHtml.paused) {\n          Platformer.menuMusicHtml.pause();\n        }\n      }\n      this.keys = this.buildInputMap();\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\"WorldMap.settings\", `Applied runtime settings: mapVolume=${volume.toFixed(2)}`);\n      }\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"WorldMap.settings\", err && err.stack ? err.stack : String(err));\n      }\n    }\n  }\n\n  playWorldMapHtmlMusic(volume, audioSettings) {\n    try {\n      if (!Platformer.menuMusicHtml) {\n        Platformer.menuMusicHtml = new Audio(\"assets/nickpanek-energetic-chiptune-video-game-music-platformer-8-bit-318348.mp3\");\n      }\n      const music = Platformer.menuMusicHtml;\n      music.loop = true;\n      music.volume = Phaser.Math.Clamp(volume, 0, 1);\n      music.onerror = (e) => {\n        if (Platformer.Debug) Platformer.Debug.error(\"WorldMap.audio\", `HTML audio error: ${e && e.message ? e.message : \"unknown error\"}`);\n      };\n      const tryPlay = () => {\n        if (audioSettings && audioSettings.muteWhenUnfocused && document.hidden) return;\n        music.play().then(() => {\n          if (Platformer.Debug) Platformer.Debug.log(\"WorldMap.audio\", \"Playing menu-bgm (HTML fallback).\");\n        }).catch((e) => {\n          if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.audio\", `HTML play blocked: ${e && e.message ? e.message : e}`);\n        });\n      };\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    } catch (err) {\n      if (Platformer.Debug) Platformer.Debug.error(\"WorldMap.audio\", `HTML fallback failed: ${err && err.message ? err.message : err}`);\n    }\n  }\n\n  stopWorldMapMusic() {\n    try {\n      this.sound.stopByKey(\"menu-bgm\");\n      if (Platformer.menuMusic) {\n        try {\n          if (Platformer.menuMusic.isPlaying) Platformer.menuMusic.stop();\n        } catch (_e) {}\n        Platformer.menuMusic = null;\n      }\n      if (Platformer.menuMusicHtml) {\n        Platformer.menuMusicHtml.pause();\n        Platformer.menuMusicHtml.currentTime = 0;\n        Platformer.menuMusicHtml = null;\n      }\n      if (Platformer.Debug) Platformer.Debug.log(\"WorldMap.audio\", \"Stopped world-map/menu music.\");\n    } catch (err) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.audio\", `Stop failed: ${err && err.message ? err.message : err}`);\n    }\n  }\n\n  updateSaveTick() {\n    if (!this.progress || !this.avatar) return;\n    if (this.time.now - this.lastSaveAt < 900) return;\n    this.lastSaveAt = this.time.now;\n    this.progress.updateMapPosition({ x: this.avatar.x, y: this.avatar.y });\n  }\n\n  handleDataDrivenInput() {\n    if (!this.keys || !this.currentNodeId || !this.worldView) return;\n    const input = this.getInputState();\n    const just = {\n      left: input.left && !this.prevInput.left,\n      right: input.right && !this.prevInput.right,\n      up: input.up && !this.prevInput.up,\n      down: input.down && !this.prevInput.down,\n      interact: input.interact && !this.prevInput.interact,\n    };\n    this.prevInput = input;\n\n    if (this.shopPanel && this.shopPanel.visible) {\n      this.shopPanel.handleInput(just);\n      return;\n    }\n\n    let direction = null;\n    if (just.left) direction = { x: -1, y: 0 };\n    else if (just.right) direction = { x: 1, y: 0 };\n    else if (just.up) direction = { x: 0, y: -1 };\n    else if (just.down) direction = { x: 0, y: 1 };\n\n    if (direction) {\n      const candidate = this.chooseDirectionalNeighbor(this.currentNodeId, direction.x, direction.y);\n      if (candidate) {\n        this.pendingTargetNodeId = candidate;\n        this.startTravelTo(candidate, false);\n      } else if (Platformer.Debug) {\n        Platformer.Debug.log(\"WorldMap.unlock\", `Blocked move from ${this.currentNodeId}: no unlocked neighbor in direction (${direction.x},${direction.y}).`);\n      }\n      this.refreshTraversalUi();\n      return;\n    }\n\n    if (just.interact) {\n      const node = this.worldNodeById[this.currentNodeId];\n      if (!node) return;\n      if (!this.isCurrentWorldNodeUnlocked(node.id)) {\n        Platformer.beeper.damage();\n        return;\n      }\n      if (!this.progress.hasSeenWorldTutorial(this.activeWorld, node.id)) {\n        this.progress.markWorldTutorialSeen(this.activeWorld, node.id);\n      }\n      if (String(node.type || \"\") === \"shop\" || !!node.shopRef) {\n        this.openShopForNode(node);\n        return;\n      }\n      if (node.levelRef || Number.isFinite(Number(node.gameLevel))) {\n        this.launchLevel(node);\n        return;\n      }\n      Platformer.beeper.coin();\n    }\n  }\n\n  handleResize(inW, inH) {\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n    const vp = this.getViewportSize();\n    const w = Number(inW) || vp.w;\n    const h = Number(inH) || vp.h;\n    this.lastViewportW = w;\n    this.lastViewportH = h;\n    if (this.useDataDrivenWorld) {\n      if (this.worldView) this.worldView.resize();\n      if (this.shopPanel) this.shopPanel.resize();\n      return;\n    }\n    const safeRectSizePos = (obj, width, height, x, y) => {\n      if (!obj || !obj.active || !obj.scene) return;\n      obj.setSize(width, height).setPosition(x, y);\n    };\n    safeRectSizePos(this.bgSky, w, h, 0, 0);\n    safeRectSizePos(this.bgStrip1, w, h * 0.18, 0, h * 0.15);\n    safeRectSizePos(this.bgStrip2, w, h * 0.22, 0, h * 0.62);\n    this.redrawGrid();\n    if (this.particles) {\n      this.particles.setConfig({\n        x: { min: 0, max: w },\n        y: { min: 0, max: h },\n      });\n    }\n    if (this.ui) this.ui.resize();\n    this.layoutMapRootToViewport();\n    if (this.pendingRelayoutCall) {\n      this.pendingRelayoutCall.remove(false);\n      this.pendingRelayoutCall = null;\n    }\n    if (this.time && this.sys && this.sys.settings && this.sys.settings.active) {\n      this.pendingRelayoutCall = this.time.delayedCall(40, () => {\n        this.pendingRelayoutCall = null;\n        if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n        this.layoutMapRootToViewport();\n      });\n    }\n  }\n\n  layoutMapRootToViewport() {\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n    if (!this.mapRoot || !this.mapRoot.active || !this.mapData || !this.mapData.bounds) return;\n    const { w, h } = this.getViewportSize();\n    const b = this.mapData.bounds;\n    const margin = Math.max(24, Math.round(Math.min(w, h) * 0.04));\n    const sx = (w - margin * 2) / Math.max(1, b.width);\n    const sy = (h - margin * 2) / Math.max(1, b.height);\n    const scale = Phaser.Math.Clamp(Math.min(sx, sy), 0.35, 2.2);\n    const fittedW = b.width * scale;\n    const fittedH = b.height * scale;\n    const offsetX = (w - fittedW) * 0.5 - b.x * scale;\n    const offsetY = (h - fittedH) * 0.5 - b.y * scale;\n\n    this.mapRoot.setScale(scale);\n    this.mapRoot.setPosition(offsetX, offsetY);\n\n    const cam = this.cameras && this.cameras.main;\n    if (cam) {\n      cam.setViewport(0, 0, w, h);\n      cam.setZoom(1);\n      cam.scrollX = 0;\n      cam.scrollY = 0;\n      cam.roundPixels = true;\n    }\n  }\n\n  getViewportSize() {\n    const gs = this.scale && this.scale.gameSize ? this.scale.gameSize : null;\n    const bs = this.scale && this.scale.baseSize ? this.scale.baseSize : null;\n    const w = (gs && gs.width) || (bs && bs.width) || this.scale.width || 960;\n    const h = (gs && gs.height) || (bs && bs.height) || this.scale.height || 540;\n    return { w: Math.max(640, Math.round(w)), h: Math.max(360, Math.round(h)) };\n  }\n\n  openShopForNode(node) {\n    const worldId = this.activeWorld && this.activeWorld.id ? this.activeWorld.id : \"world_tutorial\";\n    const shopRef = node && node.shopRef ? String(node.shopRef) : null;\n    if (!shopRef) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"WorldMap.shop\", `Node ${node && node.id ? node.id : \"unknown\"} has no shopRef.`);\n      Platformer.beeper.damage();\n      return;\n    }\n    Platformer.WorldMapManager.loadShop(worldId, shopRef)\n      .then((shop) => {\n        if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n        if (!this.shopPanel) return;\n        this.shopPanel.open(shop, () => {\n          this.refreshTraversalUi();\n        });\n      })\n      .catch((err) => {\n        if (Platformer.Debug) Platformer.Debug.error(\"WorldMap.shop\", err && err.stack ? err.stack : String(err));\n        Platformer.beeper.damage();\n      });\n  }\n\n  textureOr(key, fallback) {\n    if (key && this.textures.exists(key)) return key;\n    if (fallback && this.textures.exists(fallback)) return fallback;\n    return \"__WHITE\";\n  }\n\n  shutdown() {\n    if (this.onSettingsChanged) {\n      this.game.events.off(\"settings-changed\", this.onSettingsChanged);\n      this.onSettingsChanged = null;\n    }\n    if (!this.scene.isActive(\"GameScene\")) {\n      this.stopWorldMapMusic();\n    }\n    if (this.pendingWorldLoad && typeof this.pendingWorldLoad.cancel === \"function\") {\n      this.pendingWorldLoad.cancel();\n    }\n    this.pendingWorldLoad = null;\n    if (this.pendingRelayoutCall) {\n      this.pendingRelayoutCall.remove(false);\n      this.pendingRelayoutCall = null;\n    }\n    if (this.onResize) {\n      this.scale.off(\"resize\", this.onResize);\n      this.onResize = null;\n    }\n    if (this.ui) {\n      this.ui.destroy();\n      this.ui = null;\n    }\n    if (this.worldView) {\n      this.worldView.destroy();\n      this.worldView = null;\n    }\n    if (this.shopPanel) {\n      this.shopPanel.destroy();\n      this.shopPanel = null;\n    }\n    this.worldNodeById = {};\n    this.worldGraph = {};\n    this.currentNodeId = null;\n    this.pendingTargetNodeId = null;\n    this.travelState = null;\n    this.nodes.forEach((n) => n.destroy());\n    this.nodes = [];\n    if (this.particles) {\n      this.particles.destroy();\n      this.particles = null;\n    }\n    if (this.mapRoot) {\n      this.mapRoot.destroy(true);\n      this.mapRoot = null;\n    }\n  }\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.ExtrasScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"ExtrasScene\");\n    this.onResize = null;\n    this.categoryButtons = {};\n    this.cards = [];\n    this.selectedCategory = \"conceptArt\";\n    this.preview = null;\n    this.previewText = null;\n    this.infoText = null;\n    this.progressSnapshot = null;\n  }\n\n  create() {\n    this.bgSky = this.add.rectangle(0, 0, 10, 10, 0x081336, 0.98).setOrigin(0, 0);\n    this.bgMid = this.add.rectangle(0, 0, 10, 10, 0x132a56, 0.94).setOrigin(0, 0);\n    this.bgGround = this.add.rectangle(0, 0, 10, 10, 0x0b6f49, 0.34).setOrigin(0, 0);\n    this.bgOverlay = this.add.rectangle(0, 0, 10, 10, 0x020617, 0.38).setOrigin(0, 0);\n\n    this.title = this.add.text(0, 34, \"EXTRA'S\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"54px\",\n      color: \"#f8fafc\",\n      stroke: \"#0f172a\",\n      strokeThickness: 6,\n    }).setOrigin(0.5, 0).setDepth(10);\n\n    this.subtitle = this.add.text(0, 98, \"Unlock concept art, achievements and skins by playing levels.\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"20px\",\n      color: \"#cbd5e1\",\n      stroke: \"#0f172a\",\n      strokeThickness: 3,\n    }).setOrigin(0.5, 0).setDepth(10);\n\n    this.backBtn = this.add.rectangle(98, 42, 164, 48, 0x1e293b, 0.96)\n      .setStrokeStyle(2, 0x67e8f9, 1)\n      .setInteractive({ useHandCursor: true })\n      .setDepth(12);\n    this.backLabel = this.add.text(98, 42, \"< BACK\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"28px\",\n      color: \"#f8fafc\",\n    }).setOrigin(0.5).setDepth(13);\n    this.backBtn.on(\"pointerdown\", () => {\n      if (Platformer.Debug) Platformer.Debug.log(\"ExtrasScene\", \"Back to menu.\");\n      this.scene.start(\"MenuScene\");\n    });\n\n    this.categoryBar = this.add.container(0, 0).setDepth(11);\n    this.cardsContainer = this.add.container(0, 0).setDepth(11);\n\n    this.preview = this.add.rectangle(0, 0, 10, 10, 0x0f172a, 0.9)\n      .setStrokeStyle(2, 0x67e8f9, 0.9)\n      .setDepth(12)\n      .setVisible(false);\n    this.previewText = this.add.text(0, 0, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"20px\",\n      color: \"#e2e8f0\",\n      align: \"left\",\n      wordWrap: { width: 520 },\n    }).setDepth(13).setVisible(false);\n\n    this.infoText = this.add.text(0, 0, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#93c5fd\",\n      stroke: \"#0f172a\",\n      strokeThickness: 3,\n    }).setOrigin(0, 1).setDepth(12);\n\n    this.input.keyboard.on(\"keydown-ESC\", () => {\n      if (this.preview && this.preview.visible) {\n        this.preview.setVisible(false);\n        this.previewText.setVisible(false);\n        return;\n      }\n      this.scene.start(\"MenuScene\");\n    });\n    this.input.on(\"pointerdown\", (pointer) => {\n      if (!this.preview || !this.preview.visible) return;\n      const b = this.preview.getBounds();\n      if (!Phaser.Geom.Rectangle.Contains(b, pointer.x, pointer.y)) {\n        this.preview.setVisible(false);\n        this.previewText.setVisible(false);\n      }\n    });\n\n    this.refreshProgressSnapshot();\n    this.createCategoryButtons();\n    this.renderCards();\n    this.layout();\n\n    this.onResize = () => {\n      if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n      this.layout();\n    };\n    this.scale.on(\"resize\", this.onResize);\n  }\n\n  refreshProgressSnapshot() {\n    try {\n      this.progressSnapshot = Platformer.Progress ? Platformer.Progress.ensureLoaded() : {};\n    } catch (err) {\n      this.progressSnapshot = {};\n      if (Platformer.Debug) Platformer.Debug.error(\"ExtrasScene.progress\", err && err.stack ? err.stack : String(err));\n    }\n  }\n\n  getCompletedCount() {\n    const progress = this.progressSnapshot || {};\n    const worlds = progress.worlds || {};\n    const worldCompleted = Object.values(worlds)\n      .map((w) => (w && w.completedNodes) ? Object.keys(w.completedNodes).filter((k) => w.completedNodes[k]).length : 0)\n      .reduce((sum, n) => sum + n, 0);\n    const legacyCompleted = progress.completedNodes\n      ? Object.keys(progress.completedNodes).filter((k) => progress.completedNodes[k]).length\n      : 0;\n    return Math.max(worldCompleted, legacyCompleted);\n  }\n\n  getTotalCoins() {\n    const progress = this.progressSnapshot || {};\n    return Math.max(0, Number(progress.walletCoins || 0));\n  }\n\n  buildExtrasData() {\n    const completed = this.getCompletedCount();\n    const coins = this.getTotalCoins();\n    const owned = (this.progressSnapshot && this.progressSnapshot.upgradesOwned) || {};\n\n    const unlockedBy = (type, value) => {\n      if (type === \"levels\") return completed >= value;\n      if (type === \"coins\") return coins >= value;\n      if (type === \"upgrade\") return Number(owned[value] || 0) > 0;\n      return false;\n    };\n\n    const mk = (item) => ({\n      id: item.id,\n      name: item.name,\n      subcategory: item.subcategory,\n      description: item.description,\n      unlockType: item.unlockType,\n      unlockValue: item.unlockValue,\n      unlocked: unlockedBy(item.unlockType, item.unlockValue),\n    });\n\n    return {\n      conceptArt: [\n        mk({ id: \"concept_rooftop\", name: \"Rooftop Sketch\", subcategory: \"Environment\", description: \"Early rooftop layout and jump flow.\", unlockType: \"levels\", unlockValue: 1 }),\n        mk({ id: \"concept_enemy\", name: \"Blue Creature Draft\", subcategory: \"Enemies\", description: \"Concept pass for creature face + silhouette.\", unlockType: \"levels\", unlockValue: 2 }),\n        mk({ id: \"concept_boss\", name: \"Boss Moodboard\", subcategory: \"Boss\", description: \"Color and posture exploration for boss route.\", unlockType: \"levels\", unlockValue: 4 }),\n      ],\n      achievements: [\n        mk({ id: \"ach_first_clear\", name: \"First Clear\", subcategory: \"Milestone\", description: \"Complete any level.\", unlockType: \"levels\", unlockValue: 1 }),\n        mk({ id: \"ach_collector\", name: \"Coin Collector\", subcategory: \"Economy\", description: \"Hold at least 25 wallet coins.\", unlockType: \"coins\", unlockValue: 25 }),\n        mk({ id: \"ach_hunter\", name: \"Path Hunter\", subcategory: \"Progress\", description: \"Complete 4 levels.\", unlockType: \"levels\", unlockValue: 4 }),\n      ],\n      skins: [\n        mk({ id: \"skin_classic\", name: \"Classic Runner\", subcategory: \"Player\", description: \"Base skin available from start.\", unlockType: \"levels\", unlockValue: 0 }),\n        mk({ id: \"skin_dash\", name: \"Turbo Accent\", subcategory: \"Player\", description: \"Unlock by buying a speed upgrade.\", unlockType: \"upgrade\", unlockValue: \"speed_boost_1\" }),\n        mk({ id: \"skin_guardian\", name: \"Guardian Palette\", subcategory: \"Player\", description: \"Unlock by buying a health upgrade.\", unlockType: \"upgrade\", unlockValue: \"hp_up_1\" }),\n      ],\n    };\n  }\n\n  createCategoryButtons() {\n    const entries = [\n      { id: \"conceptArt\", label: \"Concept Art\" },\n      { id: \"achievements\", label: \"Achievements\" },\n      { id: \"skins\", label: \"Skins\" },\n    ];\n    entries.forEach((entry) => {\n      const box = this.add.rectangle(0, 0, 220, 44, 0x1e293b, 0.94)\n        .setStrokeStyle(2, 0x67e8f9, 0.75)\n        .setInteractive({ useHandCursor: true });\n      const txt = this.add.text(0, 0, entry.label, {\n        fontFamily: \"Consolas\",\n        fontSize: \"24px\",\n        color: \"#e2e8f0\",\n      }).setOrigin(0.5);\n      box.on(\"pointerdown\", () => {\n        this.selectedCategory = entry.id;\n        this.renderCards();\n      });\n      this.categoryBar.add([box, txt]);\n      this.categoryButtons[entry.id] = { box, txt };\n    });\n  }\n\n  clearCards() {\n    this.cards.forEach((card) => {\n      if (!card) return;\n      [card.box, card.label, card.sub, card.desc, card.status].forEach((o) => {\n        if (o && o.destroy) o.destroy();\n      });\n    });\n    this.cards = [];\n    this.cardsContainer.removeAll(true);\n  }\n\n  renderCards() {\n    this.refreshProgressSnapshot();\n    const all = this.buildExtrasData();\n    const selected = all[this.selectedCategory] || [];\n    this.clearCards();\n\n    selected.forEach((item) => {\n      const box = this.add.rectangle(0, 0, 320, 160, item.unlocked ? 0x102748 : 0x0f172a, 0.95)\n        .setStrokeStyle(2, item.unlocked ? 0x38bdf8 : 0x475569, 0.95)\n        .setInteractive({ useHandCursor: true });\n      const label = this.add.text(0, 0, item.name, {\n        fontFamily: \"Consolas\",\n        fontSize: \"26px\",\n        color: item.unlocked ? \"#f8fafc\" : \"#94a3b8\",\n      }).setOrigin(0, 0);\n      const sub = this.add.text(0, 0, `Category: ${item.subcategory}`, {\n        fontFamily: \"Consolas\",\n        fontSize: \"18px\",\n        color: \"#93c5fd\",\n      }).setOrigin(0, 0);\n      const desc = this.add.text(0, 0, item.description, {\n        fontFamily: \"Consolas\",\n        fontSize: \"17px\",\n        color: \"#cbd5e1\",\n        wordWrap: { width: 280 },\n      }).setOrigin(0, 0);\n      const requirement = item.unlockType === \"levels\"\n        ? `Complete ${item.unlockValue} level(s)`\n        : item.unlockType === \"coins\"\n          ? `Collect ${item.unlockValue} wallet coins`\n          : `Buy upgrade: ${item.unlockValue}`;\n      const status = this.add.text(0, 0, item.unlocked ? \"UNLOCKED - Click to view\" : `LOCKED - ${requirement}`, {\n        fontFamily: \"Consolas\",\n        fontSize: \"16px\",\n        color: item.unlocked ? \"#4ade80\" : \"#fca5a5\",\n      }).setOrigin(0, 0);\n\n      box.on(\"pointerdown\", () => this.showPreview(item, requirement));\n\n      this.cardsContainer.add([box, label, sub, desc, status]);\n      this.cards.push({ item, box, label, sub, desc, status });\n    });\n    this.layout();\n  }\n\n  showPreview(item, requirementText) {\n    const lines = [\n      `${item.name}`,\n      `Type: ${item.subcategory}`,\n      \"\",\n      item.description,\n      \"\",\n      item.unlocked ? \"Unlocked content preview ready.\" : `Locked: ${requirementText}`,\n      \"\",\n      \"Press ESC or click outside to close.\",\n    ];\n    this.previewText.setText(lines.join(\"\\n\"));\n    this.preview.setVisible(true);\n    this.previewText.setVisible(true);\n    this.layout();\n  }\n\n  layout() {\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.bgSky.setSize(w, h).setPosition(0, 0);\n    this.bgMid.setSize(w, Math.round(h * 0.45)).setPosition(0, Math.round(h * 0.28));\n    this.bgGround.setSize(w, Math.round(h * 0.22)).setPosition(0, Math.round(h * 0.72));\n    this.bgOverlay.setSize(w, h).setPosition(0, 0);\n\n    this.title.setPosition(w * 0.5, 22);\n    this.subtitle.setPosition(w * 0.5, 88);\n\n    const catY = 140;\n    const catStartX = Math.round(w * 0.5 - 240);\n    const catGap = 250;\n    [\"conceptArt\", \"achievements\", \"skins\"].forEach((id, idx) => {\n      const btn = this.categoryButtons[id];\n      if (!btn) return;\n      const x = catStartX + idx * catGap;\n      btn.box.setPosition(x, catY);\n      btn.txt.setPosition(x, catY);\n      const active = this.selectedCategory === id;\n      btn.box.setFillStyle(active ? 0x1d4ed8 : 0x1e293b, active ? 0.98 : 0.94);\n      btn.box.setStrokeStyle(2, active ? 0x93c5fd : 0x67e8f9, active ? 1 : 0.75);\n    });\n\n    const gridTop = 186;\n    const cols = 3;\n    const cardW = Math.min(360, Math.floor((w - 80) / cols) - 18);\n    const cardH = 176;\n    const gapX = 16;\n    const gapY = 16;\n    this.cards.forEach((card, idx) => {\n      const col = idx % cols;\n      const row = Math.floor(idx / cols);\n      const x = 30 + col * (cardW + gapX);\n      const y = gridTop + row * (cardH + gapY);\n      card.box.setPosition(x + cardW / 2, y + cardH / 2).setSize(cardW, cardH);\n      card.label.setPosition(x + 14, y + 10);\n      card.sub.setPosition(x + 14, y + 50);\n      card.desc.setPosition(x + 14, y + 78).setWordWrapWidth(cardW - 28);\n      card.status.setPosition(x + 14, y + cardH - 24);\n    });\n\n    const progress = this.progressSnapshot || {};\n    const completed = this.getCompletedCount();\n    const coins = this.getTotalCoins();\n    this.infoText.setText(`Completed Levels: ${completed}   |   Wallet Coins: ${coins}   |   ESC: Back to menu`)\n      .setPosition(18, h - 10);\n\n    if (this.preview.visible && this.previewText.visible) {\n      const pw = Math.min(620, w - 80);\n      const ph = Math.min(300, h - 220);\n      const px = w * 0.5;\n      const py = h * 0.5 + 30;\n      this.preview.setSize(pw, ph).setPosition(px, py);\n      this.previewText.setPosition(px - pw / 2 + 18, py - ph / 2 + 16).setWordWrapWidth(pw - 36);\n    }\n\n    if (progress && Platformer.Debug) {\n      Platformer.Debug.log(\"ExtrasScene.layout\", `${w}x${h} category=${this.selectedCategory} cards=${this.cards.length}`);\n    }\n  }\n\n  shutdown() {\n    if (this.onResize) {\n      this.scale.off(\"resize\", this.onResize);\n      this.onResize = null;\n    }\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.IntroScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"IntroScene\");\n    this.slideIndex = 0;\n    this.slides = [];\n  }\n\n  create() {\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n    const textScale = Platformer.Settings.textScale();\n\n    this.slides = [\n      {\n        title: \"Mission Briefing\",\n        body: \"Complete 4 levels by collecting 10 coins each.\\nBeat the timer and use checkpoints to survive.\",\n      },\n      {\n        title: \"Hazards + Enemies\",\n        body: \"Laser turrets launch fireballs.\\nEnemy types per level: Walker, Hopper, Dasher, Tank.\\nStomp enemies from above to defeat.\",\n      },\n      {\n        title: \"Controls\",\n        body: \"Move: Left/Right\\nJump: Jump key (rebindable)\\nDash: Dash key (burst + enemy break)\\nAttack: Attack key (close-range hit)\\nPause: Pause key\\nTip: F2 = demo instant win\",\n      },\n      {\n        title: \"Coin Rewards\",\n        body: \"3 Coins: +1 Health\\n6 Coins: +12s Time\\n9 Coins: +1 Shield block\\n10 Coins: Level clear\",\n      },\n    ];\n\n    this.add.rectangle(cx, cy, this.scale.width, this.scale.height, 0x020617, 0.55);\n\n    this.add.text(cx, 70, \"LEVEL PREVIEW\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(42 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#0f172a\",\n      strokeThickness: 6,\n    }).setOrigin(0.5);\n\n    this.panel = this.add.rectangle(cx, cy + 10, 760, 320, 0x0f172a, 0.58)\n      .setStrokeStyle(2, 0x94a3b8, 0.9);\n\n    this.titleText = this.add.text(cx, cy - 86, \"\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(34 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#111827\",\n      strokeThickness: 4,\n    }).setOrigin(0.5);\n\n    this.bodyText = this.add.text(cx, cy - 4, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(24 * textScale)}px`,\n      color: \"#e2e8f0\",\n      align: \"center\",\n      lineSpacing: 10,\n    }).setOrigin(0.5);\n\n    this.pageText = this.add.text(cx - 340, cy + 136, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(18 * textScale)}px`,\n      color: \"#cbd5e1\",\n    }).setOrigin(0, 0.5);\n\n    this.nextBtn = this.add.rectangle(cx + 280, cy + 136, 170, 44, 0x1d4ed8, 0.98)\n      .setStrokeStyle(2, 0x93c5fd)\n      .setInteractive({ useHandCursor: true });\n    this.nextBtnText = this.add.text(cx + 280, cy + 136, \"Next >\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(25 * textScale)}px`,\n      color: \"#f8fafc\",\n    }).setOrigin(0.5);\n\n    this.skipBtn = this.add.rectangle(cx + 90, cy + 136, 140, 44, 0x475569, 0.96)\n      .setStrokeStyle(2, 0x94a3b8)\n      .setInteractive({ useHandCursor: true });\n    this.skipText = this.add.text(cx + 90, cy + 136, \"Skip\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(24 * textScale)}px`,\n      color: \"#f8fafc\",\n    }).setOrigin(0.5);\n\n    this.nextBtn.on(\"pointerdown\", () => this.next());\n    this.skipBtn.on(\"pointerdown\", () => this.startGame());\n\n    this.input.keyboard.on(\"keydown-ENTER\", () => this.next());\n    this.input.keyboard.on(\"keydown-SPACE\", () => this.next());\n    this.input.keyboard.on(\"keydown-ESC\", () => this.scene.start(\"MenuScene\"));\n\n    this.renderSlide();\n  }\n\n  renderSlide() {\n    const s = this.slides[this.slideIndex];\n    this.titleText.setText(s.title);\n    this.bodyText.setText(s.body);\n    this.pageText.setText(`Preview ${this.slideIndex + 1}/${this.slides.length}`);\n\n    const isLast = this.slideIndex === this.slides.length - 1;\n    this.nextBtn.setFillStyle(isLast ? 0x16a34a : 0x1d4ed8, 0.98);\n    this.nextBtnText.setText(isLast ? \"Start Game\" : \"Next >\");\n  }\n\n  next() {\n    if (this.slideIndex < this.slides.length - 1) {\n      this.slideIndex += 1;\n      this.renderSlide();\n      return;\n    }\n    this.startGame();\n  }\n\n  startGame() {\n    Platformer.Settings.current.convenience.introSeen = true;\n    Platformer.Settings.save();\n\n    Platformer.beeper.unlock();\n    const difficulty = Platformer.Settings.current.gameplay.difficulty;\n    const baseLives = difficulty === \"easy\" ? 3 : (difficulty === \"hard\" ? 1 : 2);\n\n    if (this.scene.isActive(\"UIScene\") || this.scene.isPaused(\"UIScene\")) {\n      this.scene.stop(\"UIScene\");\n    }\n    if (this.scene.isActive(\"GameScene\") || this.scene.isPaused(\"GameScene\")) {\n      this.scene.stop(\"GameScene\");\n    }\n\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"health\", 3);\n    this.registry.set(\"lives\", baseLives);\n    this.registry.set(\"level\", 1);\n    this.scene.start(\"GameScene\", { level: 1 });\n    this.scene.launch(\"UIScene\");\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.OptionsScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"OptionsScene\");\n    this.awaitingControl = null;\n    this.rebindHint = null;\n    this.dom = null;\n    this.boundKeydown = null;\n    this.returnTo = \"menu\";\n    this.backBtn = null;\n    this.bgSky = null;\n    this.bgMid = null;\n    this.bgGround = null;\n    this.bgAccentTop = null;\n    this.bgAccentBottom = null;\n    this.bgOrbs = [];\n    this.bgLines = [];\n    this.onResize = null;\n    this.overlayShade = null;\n    this.titleText = null;\n    this.hintText = null;\n    this.backBtnText = null;\n    this.domWrap = null;\n    this.optScrollEl = null;\n    this.boundDomWheel = null;\n    this.domRecoveryUntil = 0;\n    this.domRecoveredOnce = false;\n    this.nativeViewport = null;\n    this.viewportPollEvent = null;\n  }\n\n  getResolutionPresets() {\n    return [\n      \"854x480\",\n      \"1024x576\",\n      \"1280x720\",\n      \"1366x768\",\n      \"1600x900\",\n      \"1920x1080\",\n      \"2560x1440\",\n      \"3840x2160\",\n    ];\n  }\n\n  parseResolutionPreset(text) {\n    const m = String(text || \"\").trim().match(/^(\\d{3,5})x(\\d{3,5})$/i);\n    if (!m) return null;\n    const w = Number(m[1]);\n    const h = Number(m[2]);\n    if (!Number.isFinite(w) || !Number.isFinite(h)) return null;\n    return { width: w, height: h };\n  }\n\n  init(data) {\n    this.returnTo = data && data.returnTo ? data.returnTo : \"menu\";\n    if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", `Opened (returnTo=${this.returnTo}).`);\n  }\n\n  create() {\n    try {\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.create\", \"Begin create.\");\n      const s = Platformer.Settings.current;\n      const cx = this.scale.width / 2;\n      const cy = this.scale.height / 2;\n\n    this.createMenuLikeBackdrop();\n    this.layoutBackdrop();\n    this.titleText = this.add.text(cx, 48, \"OPTIONS\", {\n      fontFamily: \"Verdana\",\n      fontSize: \"42px\",\n      color: \"#f8fafc\",\n      stroke: \"#0f172a\",\n      strokeThickness: 6,\n    }).setOrigin(0.5).setDepth(95);\n\n    this.rebindHint = this.add.text(cx, 92, \"Click a key button to rebind. Press ESC to return.\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#cbd5e1\",\n    }).setOrigin(0.5).setDepth(95);\n\n    const wrap = document.createElement(\"div\");\n    wrap.style.width = \"min(1180px, 94vw)\";\n    wrap.style.maxHeight = \"74vh\";\n    wrap.style.overflowY = \"hidden\";\n    wrap.style.padding = \"6px\";\n    wrap.style.display = \"flex\";\n    wrap.style.flexDirection = \"column\";\n    wrap.style.position = \"relative\";\n    wrap.style.fontFamily = \"Consolas, monospace\";\n    wrap.style.color = \"#e2e8f0\";\n\n    const css = `\n      <style>\n        .opt-grid { display:grid; grid-template-columns: repeat(2, minmax(340px, 1fr)); gap: 12px; }\n        .opt-scroll {\n          overflow-y:auto;\n          flex:1 1 auto;\n          min-height: 0;\n          height: 100%;\n          padding-right: 10px;\n          padding-bottom: 84px;\n          box-sizing: border-box;\n        }\n        .opt-card { background: rgba(15,23,42,0.82); border:2px solid #334155; border-radius:10px; padding: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.35); }\n        .opt-title { margin: 0 0 10px 0; color:#f8fafc; font-size: 22px; letter-spacing: 0.5px; }\n        .opt-row { display:flex; justify-content:space-between; align-items:center; gap:10px; margin: 8px 0; }\n        .opt-row > span { color:#cbd5e1; }\n        .opt-card select, .opt-card input[type=\"text\"], .opt-card button {\n          background:#1e293b; color:#e2e8f0; border:1px solid #475569; border-radius:6px; padding: 4px 8px; font-family:inherit;\n        }\n        .opt-card input[type=\"range\"] { width: 170px; }\n        .opt-actions {\n          display:flex; gap:10px; justify-content:flex-end;\n          position: absolute; left: 8px; right: 8px; bottom: 8px; z-index: 5;\n          background: rgba(2,6,23,0.92); border: 1px solid #334155; border-radius: 8px; padding: 10px;\n        }\n        .opt-actions button { background:#0f172a; color:#f8fafc; border:2px solid #64748b; border-radius:8px; padding:8px 12px; cursor:pointer; }\n        .opt-actions #saveBack { border-color:#22d3ee; }\n        @media (max-width: 900px) { .opt-grid { grid-template-columns: 1fr; } }\n      </style>\n    `;\n    const cardStart = (title) => `<section class=\"opt-card\"><h3 class=\"opt-title\">${title}</h3>`;\n    const cardEnd = () => `</section>`;\n    const row = (label, control) => `<div class=\"opt-row\"><span>${label}</span><span>${control}</span></div>`;\n\n    wrap.innerHTML = [\n      css,\n      `<div class=\"opt-scroll\"><div class=\"opt-grid\">`,\n      cardStart(\"Gameplay\"),\n      row(\"Difficulty\", `<select id=\"difficulty\"><option value=\"easy\">Easy</option><option value=\"normal\">Normal</option><option value=\"hard\">Hard</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Controls\"),\n      row(\"Left\", `<button data-bind=\"left\">${s.controls.left}</button>`),\n      row(\"Right\", `<button data-bind=\"right\">${s.controls.right}</button>`),\n      row(\"Jump\", `<button data-bind=\"jump\">${s.controls.jump}</button>`),\n      row(\"Dash\", `<button data-bind=\"dash\">${s.controls.dash}</button>`),\n      row(\"Attack\", `<button data-bind=\"attack\">${s.controls.attack}</button>`),\n      row(\"Interact\", `<button data-bind=\"interact\">${s.controls.interact}</button>`),\n      row(\"Pause\", `<button data-bind=\"pause\">${s.controls.pause}</button>`),\n      cardEnd(),\n\n      cardStart(\"Accessibility\"),\n      row(\"Text size\", `<select id=\"textSize\"><option value=\"small\">Small</option><option value=\"medium\">Medium</option><option value=\"large\">Large</option></select>`),\n      row(\"Colorblind mode\", `<select id=\"colorblindMode\"><option value=\"off\">Off</option><option value=\"protanopia\">Protanopia</option><option value=\"deuteranopia\">Deuteranopia</option><option value=\"tritanopia\">Tritanopia</option></select>`),\n      row(\"Reduce screen shake\", `<input id=\"reduceScreenShake\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"reduceScreenShakeVal\"></span>`),\n      row(\"Reduced motion\", `<select id=\"reducedMotion\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Flash reduction\", `<select id=\"flashReduction\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Subtitles\", `<select id=\"subtitles\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Audio cues\", `<select id=\"audioCues\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Video\"),\n      row(\"Display mode\", `<select id=\"fullscreen\"><option value=\"off\">Windowed</option><option value=\"borderless\">Borderless</option><option value=\"on\">Fullscreen</option></select>`),\n      row(\"Resolution\", `<select id=\"resolutionPreset\">${this.getResolutionPresets().map((p) => `<option value=\"${p}\">${p}</option>`).join(\"\")}</select>`),\n      row(\"Resolution scale\", `<input id=\"resolutionScale\" type=\"range\" min=\"50\" max=\"100\" step=\"1\" /><span id=\"resolutionScaleVal\"></span>`),\n      row(\"Pixel-perfect\", `<select id=\"pixelPerfect\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"VSync\", `<select id=\"vsync\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"FPS cap\", `<select id=\"fpsCap\"><option value=\"30\">30</option><option value=\"60\">60</option><option value=\"unlimited\">Unlimited</option></select>`),\n      row(\"Camera smoothing\", `<input id=\"cameraSmoothing\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"cameraSmoothingVal\"></span>`),\n      row(\"Brightness\", `<input id=\"brightness\" type=\"range\" min=\"0.8\" max=\"1.2\" step=\"0.01\" /><span id=\"brightnessVal\"></span>`),\n      cardEnd(),\n\n      cardStart(\"Audio\"),\n      row(\"Master volume\", `<input id=\"master\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"masterVal\"></span>`),\n      row(\"Music volume\", `<input id=\"music\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"musicVal\"></span>`),\n      row(\"SFX volume\", `<input id=\"sfx\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"sfxVal\"></span>`),\n      row(\"UI volume\", `<input id=\"ui\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"uiVal\"></span>`),\n      row(\"Dynamic range\", `<select id=\"dynamicRange\"><option value=\"night\">Night</option><option value=\"normal\">Normal</option><option value=\"wide\">Wide</option></select>`),\n      row(\"Mute when unfocused\", `<select id=\"muteWhenUnfocused\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Save / Convenience\"),\n      row(\"Auto-save\", `<select id=\"autoSave\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Checkpoint frequency\", `<select id=\"checkpointFrequency\"><option value=\"sparse\">Sparse</option><option value=\"standard\">Standard</option><option value=\"frequent\">Frequent</option></select>`),\n      row(\"Speedrun mode\", `<select id=\"speedrunMode\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Updates\"),\n      row(\"Online update check\", `<select id=\"updatesEnabled\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Auto update + restart\", `<select id=\"autoUpdate\"><option value=\"on\">On</option><option value=\"off\">Off</option></select>`),\n      row(\"Update source\", `<input id=\"updateSource\" type=\"text\" readonly style=\"opacity:0.85\" />`),\n      row(\"Current version\", `<input id=\"currentVersion\" type=\"text\" readonly style=\"opacity:0.85\" />`),\n      cardEnd(),\n      `</div></div>`,\n\n      `<div class=\"opt-actions\">`,\n      `<button id=\"resetDefaults\">Reset defaults</button>`,\n      `<button id=\"saveBack\">Save + Back</button>`,\n      `</div>`,\n    ].join(\"\");\n\n    this.domWrap = wrap;\n    this.dom = null;\n    wrap.style.position = \"fixed\";\n    wrap.style.left = \"50%\";\n    wrap.style.top = \"50%\";\n    wrap.style.transform = \"translate(-50%, -50%)\";\n    wrap.style.zIndex = \"1000000\";\n    wrap.style.display = \"block\";\n    wrap.style.opacity = \"1\";\n    wrap.style.visibility = \"visible\";\n    wrap.style.pointerEvents = \"auto\";\n    document.body.appendChild(wrap);\n    this.domRecoveryUntil = this.time.now + 1200;\n    this.domRecoveredOnce = false;\n    this.startNativeViewportPolling();\n    this.backBtn = this.add.rectangle(96, 44, 156, 46, 0xdc2626, 0.98)\n      .setStrokeStyle(3, 0xfee2e2)\n      .setOrigin(0, 0.5)\n      .setScrollFactor(0)\n      .setDepth(97)\n      .setInteractive({ useHandCursor: true });\n    this.backBtnText = this.add.text(96, 44, \"< BACK\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"28px\",\n      color: \"#ffffff\",\n      stroke: \"#450a0a\",\n      strokeThickness: 5,\n    }).setOrigin(0, 0.5).setDepth(98);\n    this.backBtn.on(\"pointerdown\", async () => {\n      await applyAndSave();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Back button pressed.\");\n      this.goBack();\n    });\n\n    const val = (id) => wrap.querySelector(`#${id}`);\n    this.optScrollEl = wrap.querySelector(\".opt-scroll\");\n    if (this.optScrollEl) {\n      this.boundDomWheel = (event) => {\n        this.optScrollEl.scrollTop += event.deltaY;\n        event.preventDefault();\n        event.stopPropagation();\n      };\n      this.optScrollEl.addEventListener(\"wheel\", this.boundDomWheel, { passive: false });\n    }\n    const setSelect = (id, v) => { val(id).value = v; };\n    const setRange = (id, v, suffix = \"%\") => {\n      val(id).value = String(v);\n      const txt = val(`${id}Val`);\n      if (txt) txt.textContent = `${v}${suffix}`;\n    };\n\n    setSelect(\"difficulty\", s.gameplay.difficulty);\n    setSelect(\"textSize\", s.accessibility.textSize);\n    setSelect(\"colorblindMode\", s.accessibility.colorblindMode);\n    setRange(\"reduceScreenShake\", s.accessibility.reduceScreenShake);\n    setSelect(\"reducedMotion\", s.accessibility.reducedMotion ? \"on\" : \"off\");\n    setSelect(\"flashReduction\", s.accessibility.flashReduction ? \"on\" : \"off\");\n    setSelect(\"subtitles\", s.accessibility.subtitles ? \"on\" : \"off\");\n    setSelect(\"audioCues\", s.accessibility.audioCues ? \"on\" : \"off\");\n\n    const displayMode = s.video.displayMode || (s.video.fullscreen ? \"fullscreen\" : \"windowed\");\n    setSelect(\"fullscreen\", displayMode === \"fullscreen\" ? \"on\" : (displayMode === \"borderless\" ? \"borderless\" : \"off\"));\n    setSelect(\"resolutionPreset\", s.video.resolutionPreset || \"1920x1080\");\n    setRange(\"resolutionScale\", s.video.resolutionScale);\n    setSelect(\"pixelPerfect\", s.video.pixelPerfect ? \"on\" : \"off\");\n    setSelect(\"vsync\", s.video.vsync ? \"on\" : \"off\");\n    setSelect(\"fpsCap\", s.video.fpsCap);\n    setRange(\"cameraSmoothing\", s.video.cameraSmoothing);\n    setRange(\"brightness\", s.video.brightness.toFixed(2), \"\");\n\n    setRange(\"master\", s.audio.master);\n    setRange(\"music\", s.audio.music);\n    setRange(\"sfx\", s.audio.sfx);\n    setRange(\"ui\", s.audio.ui);\n    setSelect(\"dynamicRange\", s.audio.dynamicRange);\n    setSelect(\"muteWhenUnfocused\", s.audio.muteWhenUnfocused ? \"on\" : \"off\");\n\n    setSelect(\"autoSave\", s.convenience.autoSave ? \"on\" : \"off\");\n    setSelect(\"checkpointFrequency\", s.convenience.checkpointFrequency);\n    setSelect(\"speedrunMode\", s.convenience.speedrunMode ? \"on\" : \"off\");\n    setSelect(\"updatesEnabled\", s.updates.enabled ? \"on\" : \"off\");\n    setSelect(\"autoUpdate\", s.updates.autoUpdate === false ? \"off\" : \"on\");\n    val(\"updateSource\").value = s.updates.source || \"GitHub Releases\";\n    val(\"currentVersion\").value = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || s.updates.currentVersion || \"1.0.0\";\n\n    [\"reduceScreenShake\", \"resolutionScale\", \"cameraSmoothing\", \"brightness\", \"master\", \"music\", \"sfx\", \"ui\"].forEach((id) => {\n      val(id).addEventListener(\"input\", () => {\n        const suffix = id === \"brightness\" ? \"\" : \"%\";\n        val(`${id}Val`).textContent = `${val(id).value}${suffix}`;\n      });\n    });\n\n    wrap.querySelectorAll(\"[data-bind]\").forEach((btn) => {\n      btn.addEventListener(\"click\", () => {\n        this.awaitingControl = btn.getAttribute(\"data-bind\");\n        if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.rebind\", `Awaiting key for ${this.awaitingControl}`);\n        this.rebindHint.setText(`Press a key for ${this.awaitingControl.toUpperCase()}...`);\n      });\n    });\n\n    const applyAndSave = async () => {\n      const c = Platformer.Settings.current;\n      c.gameplay.difficulty = val(\"difficulty\").value;\n\n      c.accessibility.textSize = val(\"textSize\").value;\n      c.accessibility.colorblindMode = val(\"colorblindMode\").value;\n      c.accessibility.reduceScreenShake = Number(val(\"reduceScreenShake\").value);\n      c.accessibility.reducedMotion = val(\"reducedMotion\").value === \"on\";\n      c.accessibility.flashReduction = val(\"flashReduction\").value === \"on\";\n      c.accessibility.subtitles = val(\"subtitles\").value === \"on\";\n      c.accessibility.audioCues = val(\"audioCues\").value === \"on\";\n\n      const fullscreenSel = val(\"fullscreen\").value;\n      c.video.displayMode = fullscreenSel === \"on\"\n        ? \"fullscreen\"\n        : (fullscreenSel === \"borderless\" ? \"borderless\" : \"windowed\");\n      c.video.fullscreen = c.video.displayMode === \"fullscreen\";\n      c.video.resolutionPreset = val(\"resolutionPreset\").value || \"1920x1080\";\n      c.video.resolutionScale = Number(val(\"resolutionScale\").value);\n      c.video.pixelPerfect = val(\"pixelPerfect\").value === \"on\";\n      c.video.vsync = val(\"vsync\").value === \"on\";\n      c.video.fpsCap = val(\"fpsCap\").value;\n      c.video.cameraSmoothing = Number(val(\"cameraSmoothing\").value);\n      c.video.brightness = Number(val(\"brightness\").value);\n\n      c.audio.master = Number(val(\"master\").value);\n      c.audio.music = Number(val(\"music\").value);\n      c.audio.sfx = Number(val(\"sfx\").value);\n      c.audio.ui = Number(val(\"ui\").value);\n      c.audio.dynamicRange = val(\"dynamicRange\").value;\n      c.audio.muteWhenUnfocused = val(\"muteWhenUnfocused\").value === \"on\";\n\n      c.convenience.autoSave = val(\"autoSave\").value === \"on\";\n      c.convenience.checkpointFrequency = val(\"checkpointFrequency\").value;\n      c.convenience.speedrunMode = val(\"speedrunMode\").value === \"on\";\n\n      c.updates.enabled = val(\"updatesEnabled\").value === \"on\";\n      c.updates.autoUpdate = val(\"autoUpdate\").value === \"on\";\n      c.updates.source = \"GitHub Releases\";\n      c.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      c.updates.manifestUrl = \"\";\n      c.updates.downloadUrl = \"\";\n\n      await Platformer.Settings.save();\n      try {\n        this.game.events.emit(\"settings-changed\", Platformer.deepClone(c));\n      } catch (err) {\n        if (Platformer.Debug) Platformer.Debug.error(\"OptionsScene.settings\", `Emit failed: ${err && err.message ? err.message : err}`);\n      }\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\n          \"OptionsScene.settings\",\n          `Saved audio(m=${c.audio.master},mu=${c.audio.music},sfx=${c.audio.sfx}) video(mode=${c.video.displayMode},preset=${c.video.resolutionPreset},resScale=${c.video.resolutionScale},bright=${c.video.brightness})`\n        );\n      }\n      this.applyRuntimeVideoSettings();\n    };\n\n    wrap.querySelector(\"#saveBack\").addEventListener(\"click\", async () => {\n      await applyAndSave();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Save + Back pressed.\");\n      this.goBack();\n    });\n\n    wrap.querySelector(\"#resetDefaults\").addEventListener(\"click\", () => {\n      Platformer.Settings.reset();\n      if (Platformer.Debug) Platformer.Debug.warn(\"OptionsScene\", \"Settings reset to defaults.\");\n      this.scene.restart();\n    });\n\n    this.boundKeydown = (event) => {\n      if (!this.awaitingControl) return;\n      event.preventDefault();\n      const key = this.normalizeKey(event);\n      Platformer.Settings.current.controls[this.awaitingControl] = key;\n      Platformer.Settings.save();\n      const btn = wrap.querySelector(`[data-bind=\"${this.awaitingControl}\"]`);\n      if (btn) btn.textContent = key;\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.rebind\", `${this.awaitingControl} -> ${key}`);\n      this.rebindHint.setText(`${this.awaitingControl.toUpperCase()} bound to ${key}`);\n      this.awaitingControl = null;\n    };\n\n    window.addEventListener(\"keydown\", this.boundKeydown, true);\n    this.events.once(\"shutdown\", () => this.cleanup());\n      this.onResize = () => this.layoutOptions();\n      this.scale.on(\"resize\", this.onResize);\n    this.layoutOptions();\n\n      this.input.keyboard.on(\"keydown-ESC\", async () => {\n      if (this.awaitingControl) {\n        this.awaitingControl = null;\n        if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.rebind\", \"Rebind cancelled with ESC.\");\n        this.rebindHint.setText(\"Click a key button to rebind. Press ESC to return.\");\n        return;\n      }\n      await applyAndSave();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"ESC save + back.\");\n      this.goBack();\n    });\n      this.game.events.emit(\"options-ready\");\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.create\", \"Ready.\");\n      this.time.delayedCall(16, () => {\n        try {\n          this.scene.bringToTop(\"OptionsScene\");\n          this.forceDomVisible(\"post-ready\");\n          if (Platformer.Debug) {\n            Platformer.Debug.log(\"OptionsScene.create\", `Post-ready visibility check dom=${!!this.domWrap} size=${this.scale.width}x${this.scale.height}`);\n          }\n        } catch (err2) {\n          if (Platformer.Debug) Platformer.Debug.error(\"OptionsScene.create\", `Post-ready check failed: ${err2 && err2.message ? err2.message : err2}`);\n        }\n      });\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"OptionsScene.create\", err && err.stack ? err.stack : String(err));\n      }\n      try {\n        this.game.events.emit(\"options-failed\", { message: err && err.message ? err.message : String(err) });\n      } catch (_e) {}\n      try {\n        this.cleanup();\n      } catch (_e) {}\n      // Ensure user is never stuck on a blank overlay if options init fails.\n      this.goBack();\n    }\n  }\n\n  createMenuLikeBackdrop() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.bgSky = this.add.rectangle(0, 0, w, h, 0x081336, 0.62).setOrigin(0, 0);\n    this.bgMid = this.add.rectangle(0, 0, w, 220, 0x132a56, 0.52).setOrigin(0, 0);\n    this.bgGround = this.add.rectangle(0, 0, w, 120, 0x0b6f49, 0.46).setOrigin(0, 0);\n    this.bgAccentTop = this.add.rectangle(0, 0, w, Math.round(h * 0.42), 0x1e3a8a, 0.16).setOrigin(0, 0);\n    this.bgAccentBottom = this.add.rectangle(0, 0, w, Math.round(h * 0.2), 0x34d399, 0.13).setOrigin(0, 0);\n\n    const orbA = this.add.circle(w * 0.78, h * 0.22, 150, 0x53e0ff, 0.08).setBlendMode(Phaser.BlendModes.ADD);\n    const orbB = this.add.circle(w * 0.2, h * 0.3, 110, 0xff71c7, 0.07).setBlendMode(Phaser.BlendModes.ADD);\n    this.bgOrbs = [orbA, orbB];\n\n    this.bgLines = [];\n    for (let i = 0; i < 10; i += 1) {\n      const line = this.add.rectangle(\n        Phaser.Math.Between(0, w),\n        Phaser.Math.Between(40, h - 80),\n        Phaser.Math.Between(70, 150),\n        2,\n        i % 3 === 0 ? 0xff71c7 : 0x53e0ff,\n        0.18\n      ).setOrigin(0, 0.5);\n      line.moveSpeed = Phaser.Math.FloatBetween(26, 62);\n      this.bgLines.push(line);\n    }\n  }\n\n  layoutBackdrop() {\n    if (!this.bgSky) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const cy = h / 2;\n    this.bgSky.setSize(w, h).setPosition(0, 0);\n    this.bgMid.setSize(w, 220).setPosition(0, cy + 160);\n    this.bgGround.setSize(w, 120).setPosition(0, cy + 220);\n    this.bgAccentTop.setSize(w, Math.round(h * 0.42)).setPosition(0, 0);\n    this.bgAccentBottom.setSize(w, Math.round(h * 0.2)).setPosition(0, h - Math.round(h * 0.24));\n  }\n\n  layoutOptions() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const vw = Math.max(640, (this.nativeViewport && this.nativeViewport.w) || window.innerWidth || w || 640);\n    const vh = Math.max(360, (this.nativeViewport && this.nativeViewport.h) || window.innerHeight || h || 360);\n    const cx = w / 2;\n    const cy = h / 2;\n    this.layoutBackdrop();\n    if (this.titleText) this.titleText.setPosition(cx, 48);\n    if (this.rebindHint) this.rebindHint.setPosition(cx, 92);\n\n    if (this.domWrap) {\n      const panelH = Math.floor(Math.max(320, vh * 0.74));\n      this.domWrap.style.width = `${Math.floor(Math.min(1180, vw * 0.94))}px`;\n      this.domWrap.style.maxHeight = `${panelH}px`;\n      this.domWrap.style.height = `${panelH}px`;\n    }\n    if (this.optScrollEl) {\n      this.optScrollEl.style.height = \"100%\";\n      this.optScrollEl.style.maxHeight = \"100%\";\n      this.optScrollEl.style.overflowY = \"auto\";\n    }\n    const topY = 130;\n    const panelH = Math.floor(Math.max(320, vh * 0.74));\n    const domY = Math.min((vh / 2) + 28, topY + (panelH / 2));\n    if (this.domWrap) {\n      this.domWrap.style.left = `${Math.round(vw / 2)}px`;\n      this.domWrap.style.top = `${Math.round(domY)}px`;\n      this.domWrap.style.transform = \"translate(-50%, -50%)\";\n      this.forceDomVisible(\"layout\");\n    }\n\n    if (this.backBtn) this.backBtn.setPosition(14, 44);\n    if (this.backBtnText) this.backBtnText.setPosition(36, 44);\n  }\n\n  goBack() {\n    if (this.returnTo === \"pause\") {\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Returning to pause menu.\");\n      this.scene.stop();\n      this.game.events.emit(\"options-closed-to-pause\");\n      return;\n    }\n    if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Returning to main menu.\");\n    this.scene.start(\"MenuScene\");\n  }\n\n  normalizeKey(event) {\n    const k = (event.key || \"\").toUpperCase();\n    if (k === \" \") return \"SPACE\";\n    if (k === \"ESCAPE\") return \"ESC\";\n    if (k === \"ARROWLEFT\") return \"LEFT\";\n    if (k === \"ARROWRIGHT\") return \"RIGHT\";\n    if (k === \"ARROWUP\") return \"UP\";\n    if (k === \"ARROWDOWN\") return \"DOWN\";\n    if (k === \"CONTROL\") return \"CTRL\";\n    return k;\n  }\n\n  applyRuntimeVideoSettings() {\n    const s = Platformer.Settings.current.video;\n    const mode = s.displayMode || (s.fullscreen ? \"fullscreen\" : \"windowed\");\n    const parsed = this.parseResolutionPreset(s.resolutionPreset || \"1920x1080\");\n    const targetW = parsed ? parsed.width : 1920;\n    const targetH = parsed ? parsed.height : 1080;\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.set_window_mode === \"function\") {\n      window.pywebview.api.set_window_mode(mode, targetW, targetH)\n        .then((res) => {\n          if (res && res.ok) {\n            if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", `native mode=${res.mode || mode} size=${res.width || targetW}x${res.height || targetH}`);\n          } else if (Platformer.Debug) {\n            Platformer.Debug.warn(\"Options.fullscreen\", (res && res.message) || \"native window mode call failed\");\n          }\n        })\n        .catch((err) => {\n          if (Platformer.Debug) Platformer.Debug.warn(\"Options.fullscreen\", `native window mode error: ${err && err.message ? err.message : err}`);\n        });\n      return;\n    }\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.set_fullscreen === \"function\") {\n      window.pywebview.api.set_fullscreen(mode === \"fullscreen\")\n        .then((res) => {\n          if (res && res.ok) {\n            if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", `native fullscreen=${res.fullscreen}`);\n          } else if (Platformer.Debug) {\n            Platformer.Debug.warn(\"Options.fullscreen\", (res && res.message) || \"native fullscreen call failed\");\n          }\n        })\n        .catch((err) => {\n          if (Platformer.Debug) Platformer.Debug.warn(\"Options.fullscreen\", `native fullscreen error: ${err && err.message ? err.message : err}`);\n        });\n      return;\n    }\n\n    if (mode === \"fullscreen\" && !this.scale.isFullscreen) {\n      this.scale.startFullscreen();\n      if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", \"browser fullscreen start requested\");\n    }\n    if (mode !== \"fullscreen\" && this.scale.isFullscreen) {\n      this.scale.stopFullscreen();\n      if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", \"browser fullscreen stop requested\");\n    }\n  }\n\n  shutdown() {\n    this.cleanup();\n  }\n\n  cleanup() {\n    if (this.onResize) {\n      this.scale.off(\"resize\", this.onResize);\n      this.onResize = null;\n    }\n    if (this.optScrollEl && this.boundDomWheel) {\n      this.optScrollEl.removeEventListener(\"wheel\", this.boundDomWheel);\n    }\n    this.boundDomWheel = null;\n    this.optScrollEl = null;\n    if (this.viewportPollEvent) {\n      this.viewportPollEvent.remove(false);\n      this.viewportPollEvent = null;\n    }\n    this.nativeViewport = null;\n    if (this.domWrap && this.domWrap.parentNode) {\n      this.domWrap.parentNode.removeChild(this.domWrap);\n    }\n    this.domWrap = null;\n    this.dom = null;\n    if (this.boundKeydown) {\n      window.removeEventListener(\"keydown\", this.boundKeydown, true);\n      this.boundKeydown = null;\n    }\n  }\n\n  forceDomVisible(reason = \"unknown\") {\n    if (!this.domWrap) return;\n    if (!this.domWrap.parentNode) {\n      document.body.appendChild(this.domWrap);\n    }\n    this.domWrap.style.position = \"fixed\";\n    this.domWrap.style.zIndex = \"1000000\";\n    this.domWrap.style.display = \"block\";\n    this.domWrap.style.opacity = \"1\";\n    this.domWrap.style.visibility = \"visible\";\n    this.domWrap.style.pointerEvents = \"auto\";\n    const rect = this.domWrap.getBoundingClientRect();\n    const likelyHidden = rect.width < 40 || rect.height < 40;\n    if (likelyHidden) {\n      const vw = Math.max(640, window.innerWidth || this.scale.width || 640);\n      const vh = Math.max(360, window.innerHeight || this.scale.height || 360);\n      this.domWrap.style.width = `${Math.floor(Math.min(1180, vw * 0.94))}px`;\n      this.domWrap.style.maxHeight = `${Math.floor(Math.max(320, vh * 0.74))}px`;\n      this.domWrap.style.height = `${Math.floor(Math.max(320, vh * 0.74))}px`;\n      this.domWrap.style.left = `${Math.round(vw / 2)}px`;\n      this.domWrap.style.top = `${Math.round(vh / 2)}px`;\n    }\n    if (!this.domRecoveredOnce && Platformer.Debug) {\n      Platformer.Debug.log(\n        \"OptionsScene.dom\",\n        `forceDomVisible(${reason}) rect=${Math.round(rect.width)}x${Math.round(rect.height)} at ${Math.round(rect.x)},${Math.round(rect.y)}`\n      );\n      this.domRecoveredOnce = true;\n    }\n  }\n\n  startNativeViewportPolling() {\n    if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.get_window_size === \"function\")) {\n      return;\n    }\n    let attempts = 0;\n    const pollOnce = () => {\n      if (!this.sys || !this.sys.settings || !this.sys.settings.active) return;\n      attempts += 1;\n      window.pywebview.api.get_window_size()\n        .then((res) => {\n          if (!res || !res.ok) return;\n          const nw = Math.max(640, Number(res.width) || 0);\n          const nh = Math.max(360, Number(res.height) || 0);\n          if (!Number.isFinite(nw) || !Number.isFinite(nh)) return;\n          const changed = !this.nativeViewport || this.nativeViewport.w !== nw || this.nativeViewport.h !== nh;\n          this.nativeViewport = { w: nw, h: nh };\n          if (changed) {\n            this.layoutOptions();\n            if (Platformer.Debug) {\n              Platformer.Debug.log(\"OptionsScene.viewport\", `native ${nw}x${nh} fullscreen=${!!res.fullscreen} attempt=${attempts}`);\n            }\n          }\n        })\n        .catch((err) => {\n          if (attempts <= 2 && Platformer.Debug) {\n            Platformer.Debug.warn(\"OptionsScene.viewport\", `native poll failed: ${err && err.message ? err.message : err}`);\n          }\n        });\n      if (attempts >= 12 && this.viewportPollEvent) {\n        this.viewportPollEvent.remove(false);\n        this.viewportPollEvent = null;\n      }\n    };\n    pollOnce();\n    this.viewportPollEvent = this.time.addEvent({ delay: 140, loop: true, callback: pollOnce });\n  }\n\n  update(time, delta) {\n    if (this.domWrap && time <= this.domRecoveryUntil) {\n      this.forceDomVisible(\"update-recovery\");\n    }\n    const dt = Math.max(0.001, delta / 1000);\n    const w = this.scale.width;\n    this.bgLines.forEach((line) => {\n      if (!line || !line.active) return;\n      line.x -= line.moveSpeed * dt;\n      if (line.x < -line.width - 10) line.x = w + Phaser.Math.Between(10, 80);\n    });\n    const t = time * 0.001;\n    if (this.bgOrbs && this.bgOrbs.length === 2) {\n      this.bgOrbs[0].x = this.scale.width * 0.78 + Math.cos(t * 0.6) * 16;\n      this.bgOrbs[1].x = this.scale.width * 0.2 + Math.sin(t * 0.75) * 18;\n    }\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.GameScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"GameScene\");\n    this.solids = null;\n    this.oneWays = null;\n    this.hazards = null;\n    this.coins = null;\n    this.enemies = null;\n    this.checkpoints = null;\n    this.player = null;\n    this.cursors = null;\n    this.keys = null;\n    this.respawnPoint = new Phaser.Math.Vector2(64, 64);\n    this.lastOnGroundTime = 0;\n    this.lastJumpPressedTime = -9999;\n    this.isJumpHeld = false;\n    this.jumpsUsed = 0;\n    this.lastDamageTime = -9999;\n    this.isDead = false;\n    this.spawnPoint = new Phaser.Math.Vector2(64, 64);\n    this.mapRows = [];\n    this.mapWidth = 0;\n    this.mapHeight = 0;\n    this.levelComplete = false;\n    this.parallax = [];\n    this.lastEnemyEdgeCheckTime = 0;\n    this.playerHealthBarBg = null;\n    this.playerHealthBarFill = null;\n    this.hazardProjectiles = null;\n    this.hazardShooters = [];\n    this.lastHazardShotAt = 0;\n    this.projectileIntervalMs = 1200;\n    this.projectileSpeed = 220;\n    this.levelTimeRemainingMs = 90000;\n    this.lastTickTime = 0;\n    this.lastTimerSecond = -1;\n    this.threatActive = false;\n    this.idleAnimWarned = false;\n    this.useImportedCharacter = false;\n    this.diagLastAt = 0;\n    this.diagCooldowns = {};\n    this.facingDir = 1;\n    this.isDashing = false;\n    this.dashEndsAt = 0;\n    this.lastDashAt = -9999;\n    this.attackActiveUntil = 0;\n    this.lastAttackAt = -9999;\n    this.wasGroundedLastFrame = false;\n    this.airbornePeakSpeedY = 0;\n    this.coinRewardState = {};\n    this.shieldCharges = 0;\n    this.lastAuxHudAt = 0;\n    this.onSettingsChanged = null;\n    this.jetpack = null;\n    this.jetpackFuelPercent = 100;\n    this.jetpackActive = false;\n    this.jetpackFlame = null;\n    this.jetpackFlameOffsetY = 22;\n    this.tinyGridMode = false;\n    this.playerTuning = null;\n    this.jetpackTuning = null;\n    this.hpBarCfg = null;\n    this.lastTileEmbedLogAt = 0;\n    this.tileEmbedFrames = 0;\n    this.playerBodyWorldW = 0;\n    this.playerBodyWorldH = 0;\n    this.playerHitboxProfile = { w: 9, h: 24, ox: 0, oy: -3 };\n    this.hitboxOverlay = null;\n    this.hitboxOverlayEnabled = false;\n    this.onHitboxesToggle = null;\n    this.onPlayerHitboxChanged = null;\n    this.lastHitboxDrawAt = 0;\n    this.ldtkVisualTiles = [];\n    this.usesLdtkLevel = false;\n  }\n\n  init(data) {\n    const settings = Platformer.Settings.current;\n    const difficulty = settings.gameplay.difficulty;\n    const startLives = difficulty === \"easy\" ? 3 : (difficulty === \"hard\" ? 1 : 2);\n    const timerSeconds = difficulty === \"easy\" ? 120 : (difficulty === \"hard\" ? 70 : 90);\n    const carryState = !!(data && data.carryState);\n\n    this.currentLevel = data.level || 1;\n    this.currentNodeId = data && data.nodeId ? String(data.nodeId) : null;\n    this.currentWorldId = data && data.worldId ? String(data.worldId) : null;\n    this.registry.set(\"level\", this.currentLevel);\n    if (!carryState) {\n      this.registry.set(\"health\", 3);\n      this.registry.set(\"lives\", startLives);\n    } else {\n      this.registry.set(\"health\", Math.max(1, this.registry.get(\"health\") || 3));\n      this.registry.set(\"lives\", Math.max(1, this.registry.get(\"lives\") || startLives));\n    }\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"timeLeft\", timerSeconds);\n    this.registry.set(\"threat\", \"CALM\");\n    this.registry.set(\"dashCd\", 0);\n    this.registry.set(\"shield\", 0);\n    this.registry.set(\"jetpackFuel\", 100);\n    this.isDead = false;\n    this.levelComplete = false;\n    this.levelTimeRemainingMs = timerSeconds * 1000;\n    this.lastTickTime = 0;\n    this.lastTimerSecond = -1;\n    this.lastHazardShotAt = 0;\n    this.threatActive = false;\n    this.facingDir = 1;\n    this.isDashing = false;\n    this.dashEndsAt = 0;\n    this.lastDashAt = -9999;\n    this.attackActiveUntil = 0;\n    this.lastAttackAt = -9999;\n    this.wasGroundedLastFrame = false;\n    this.airbornePeakSpeedY = 0;\n    this.coinRewardState = {};\n    this.shieldCharges = 0;\n    this.lastAuxHudAt = 0;\n    this.jetpackFuelPercent = 100;\n    this.jetpackActive = false;\n  }\n\n  create() {\n    const { PLAYER, TILE } = Platformer.Config;\n    const settings = Platformer.Settings.current;\n    const difficulty = settings.gameplay.difficulty;\n    const checkpointMode = settings.convenience.checkpointFrequency;\n    this.tinyGridMode = TILE <= 8;\n    this.playerTuning = this.buildPlayerTuning(PLAYER);\n    this.jetpackTuning = this.buildJetpackTuning(Platformer.Config.JETPACK);\n    const P = this.playerTuning;\n    const enemySpeedScale = this.tinyGridMode ? 0.34 : 1;\n\n    const ldtkLevelData = this.tryBuildLevelFromLdtk(this.currentLevel || 1);\n    if (ldtkLevelData && Array.isArray(ldtkLevelData.rows) && ldtkLevelData.rows.length) {\n      this.mapRows = ldtkLevelData.rows;\n      this.usesLdtkLevel = true;\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\"GameScene.ldtk\", `Using native LDtk map for level=${this.currentLevel} size=${ldtkLevelData.width}x${ldtkLevelData.height}`);\n      }\n    } else {\n      this.mapRows = Platformer.createLevelData(this.currentLevel || 1);\n      this.usesLdtkLevel = false;\n    }\n    this.mapHeight = this.mapRows.length;\n    this.mapWidth = this.mapRows[0].length;\n    this.normalizeTurretTiles();\n    this.normalizeEnemyTiles();\n\n    this.physics.world.gravity.y = P.gravity;\n    this.physics.world.setBounds(0, 0, this.mapWidth * TILE, this.mapHeight * TILE + 180);\n\n    if (this.usesLdtkLevel) {\n      this.cameras.main.setBackgroundColor(\"#0f132a\");\n      this.renderLdtkVisualTiles();\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\"GameScene.ldtk\", \"LDtk level active: placeholder ground rendering disabled (collision-only solids).\");\n      }\n    } else {\n      this.createTokyoBackdrop();\n    }\n\n    this.solids = this.physics.add.staticGroup();\n    this.oneWays = this.physics.add.staticGroup();\n    this.hazards = this.physics.add.staticGroup();\n    this.coins = this.physics.add.staticGroup();\n    this.checkpoints = this.physics.add.staticGroup();\n    this.enemies = this.physics.add.group({ allowGravity: true, immovable: false });\n    this.enemyPatrolSpeed = (difficulty === \"hard\" ? 95 : (difficulty === \"easy\" ? 48 : 60)) * enemySpeedScale;\n    this.hazardDamage = difficulty === \"hard\" ? 2 : 1;\n    this.hazardCooldownScale = difficulty === \"easy\" ? 1.35 : (difficulty === \"hard\" ? 0.8 : 1);\n    this.projectileIntervalMs = difficulty === \"hard\" ? 850 : (difficulty === \"easy\" ? 1500 : 1100);\n    this.projectileSpeed = (difficulty === \"hard\" ? 270 : (difficulty === \"easy\" ? 180 : 230)) * enemySpeedScale;\n    this.maxCheckpointCount = checkpointMode === \"sparse\" ? 1 : (checkpointMode === \"frequent\" ? 999 : (difficulty === \"hard\" ? 1 : 2));\n    this.spawnCheckpointOnStart = checkpointMode === \"frequent\" || difficulty === \"easy\";\n    this.hazardProjectiles = this.physics.add.group({ allowGravity: false, immovable: true });\n    let checkpointCount = 0;\n\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        const tile = this.mapRows[y][x];\n        const px = x * TILE;\n        const py = y * TILE;\n\n        if (tile === \"#\") {\n          const block = this.solids.create(px + TILE / 2, py + TILE / 2, \"ground\");\n          if (this.usesLdtkLevel) {\n            // Keep collider body but don't draw placeholder tile over LDtk visuals.\n            block.setVisible(false);\n            block.setAlpha(0);\n          }\n          block.refreshBody();\n        }\n\n        if (tile === \"=\") {\n          const platform = this.oneWays.create(px + TILE / 2, py + Math.max(2, Math.round(TILE * 0.38)), \"oneway\");\n          platform.refreshBody();\n        }\n\n        if (tile === \"^\") {\n          const spike = this.hazards.create(px + TILE / 2, py + TILE / 2, \"hazard\");\n          spike.setDisplaySize(TILE, TILE);\n          spike.refreshBody();\n        }\n\n        if (tile === \"C\") {\n          const coin = this.coins.create(px + TILE / 2, py + TILE / 2, \"coin\");\n          if (this.tinyGridMode) coin.setDisplaySize(Math.max(5, TILE * 0.85), Math.max(5, TILE * 0.85));\n          coin.refreshBody();\n        }\n\n        if (tile === \"E\" || tile === \"F\" || tile === \"G\" || tile === \"H\") {\n          const enemyType = tile;\n          const textureByType = { E: \"enemy-e\", F: \"enemy-f\", G: \"enemy-g\", H: \"enemy-h\" };\n          const speedByType = { E: this.enemyPatrolSpeed, F: this.enemyPatrolSpeed * 0.9, G: this.enemyPatrolSpeed * 1.2, H: this.enemyPatrolSpeed * 0.75 };\n          const enemy = this.enemies.create(px + TILE / 2, py + TILE / 2, textureByType[enemyType] || \"enemy\");\n          const patrol = this.computeEnemyPatrolBounds(x, y);\n          if (this.tinyGridMode) {\n            enemy.setDisplaySize(10, 10);\n            enemy.body.setSize(8, 8);\n          } else {\n            enemy.body.setSize(24, 24);\n          }\n          enemy.setBounce(0, 0);\n          enemy.setCollideWorldBounds(true);\n          enemy.setVelocityX(-speedByType[enemyType]);\n          enemy.setData(\"patrolSpeed\", speedByType[enemyType]);\n          enemy.setData(\"direction\", -1);\n          enemy.setData(\"turnCooldownUntil\", 0);\n          enemy.setData(\"patrolMinX\", patrol.minX);\n          enemy.setData(\"patrolMaxX\", patrol.maxX);\n          enemy.setData(\"useBoundedPatrol\", patrol.maxX - patrol.minX >= TILE * 2);\n          enemy.setData(\"enemyType\", enemyType);\n          enemy.setData(\"nextJumpAt\", this.time.now + 800 + x * 3);\n          enemy.setData(\"hp\", enemyType === \"H\" ? 2 : 1);\n          enemy.setData(\"lastX\", enemy.x);\n          enemy.setData(\"stuckSince\", this.time.now);\n          enemy.setData(\"aiState\", \"patrol\");\n          enemy.setData(\"stateUntil\", 0);\n          enemy.setData(\"attackCooldownUntil\", this.time.now + 700 + (x % 5) * 90);\n        }\n\n        if (tile === \"K\") {\n          if (checkpointCount >= this.maxCheckpointCount) {\n            continue;\n          }\n          const checkpoint = this.checkpoints.create(px + TILE / 2, py + TILE / 2, \"checkpoint\");\n          if (this.tinyGridMode) checkpoint.setDisplaySize(Math.max(4, TILE * 0.75), Math.max(12, TILE * 2));\n          checkpoint.setData(\"activeCheckpoint\", false);\n          checkpoint.refreshBody();\n          checkpointCount += 1;\n        }\n\n        if (tile === \"S\") {\n          this.spawnPoint.set(px + TILE / 2, py + TILE / 2);\n        }\n      }\n    }\n\n    this.player = this.physics.add.sprite(this.spawnPoint.x, this.spawnPoint.y, \"player-idle-1\");\n    if (this.textures.exists(\"player-idle-sheet\")) {\n      this.player.setTexture(\"player-idle-sheet\", 0);\n      this.useImportedCharacter = true;\n      if (Platformer.Debug) Platformer.Debug.log(\"GameScene.playerIdle\", \"Using imported player-idle-sheet.\");\n    } else if (Platformer.Debug) {\n      Platformer.Debug.warn(\"GameScene.playerIdle\", \"player-idle-sheet missing, using fallback idle textures.\");\n    }\n    const tinyGrid = TILE <= 8;\n    if (this.useImportedCharacter) {\n      if (tinyGrid) {\n        this.player.setDisplaySize(32, 32);\n        this.applyTinyPlayerHitboxProfile();\n      } else {\n        this.player.setDisplaySize(56, 56);\n        this.player.body.setSize(22, 44, true);\n      }\n    } else if (tinyGrid) {\n      this.player.setDisplaySize(32, 32);\n      this.applyTinyPlayerHitboxProfile();\n    } else {\n      this.player.setDisplaySize(28, 38);\n      this.player.body.setSize(20, 34);\n    }\n    this.alignPlayerBodyToFeet();\n    if (this.tinyGridMode && Platformer.Debug && this.player && this.player.body) {\n      Platformer.Debug.log(\n        \"GameScene.collision\",\n        `Tiny body initialized world=${this.player.body.width.toFixed(1)}x${this.player.body.height.toFixed(1)} scale=${this.player.scaleX.toFixed(3)},${this.player.scaleY.toFixed(3)}`\n      );\n    }\n    this.player.setCollideWorldBounds(true);\n    // Allow dash velocity to exceed normal run cap.\n    this.player.setMaxVelocity(Math.max(P.maxSpeed, P.dashSpeed + 60), P.maxFallSpeed || 760);\n    this.player.setDragX(P.drag);\n    this.player.setAccelerationY(0);\n    this.player.body.setGravityY(0);\n    this.resolvePlayerEmbedding(\"spawn\");\n\n    this.respawnPoint.copy(this.spawnPoint);\n    if (this.spawnCheckpointOnStart) {\n      const extraStartCheckpoint = this.checkpoints.create(\n        this.spawnPoint.x + (this.tinyGridMode ? TILE * 3 : 24),\n        this.spawnPoint.y - (this.tinyGridMode ? TILE * 2 : 20),\n        \"checkpoint\"\n      );\n      if (this.tinyGridMode) extraStartCheckpoint.setDisplaySize(Math.max(4, TILE * 0.75), Math.max(12, TILE * 2));\n      extraStartCheckpoint.setData(\"activeCheckpoint\", true);\n      extraStartCheckpoint.setTint(0x22c55e);\n      extraStartCheckpoint.refreshBody();\n    }\n\n    this.physics.add.collider(this.player, this.solids);\n    this.physics.add.collider(this.enemies, this.solids);\n    this.physics.add.collider(this.enemies, this.oneWays, null, this.enemyOneWayProcess, this);\n    this.physics.add.collider(this.player, this.oneWays, null, this.oneWayProcess, this);\n\n    this.physics.add.collider(this.player, this.hazards);\n    this.physics.add.collider(this.hazardProjectiles, this.solids, (projectile) => projectile.destroy(), null, this);\n    this.physics.add.collider(this.hazardProjectiles, this.oneWays, (projectile) => projectile.destroy(), null, this);\n    this.physics.add.overlap(this.player, this.coins, (_, coin) => this.collectCoin(coin), null, this);\n    this.physics.add.overlap(this.player, this.checkpoints, (_, cp) => this.activateCheckpoint(cp), null, this);\n    this.physics.add.overlap(this.player, this.enemies, (_, enemy) => this.handleEnemyContact(enemy), null, this);\n    this.physics.add.overlap(this.player, this.hazardProjectiles, (_, projectile) => {\n      projectile.destroy();\n      this.applyDamage(1);\n    }, null, this);\n\n    this.cameras.main.setBounds(0, 0, this.mapWidth * TILE, this.mapHeight * TILE);\n    const smooth = Phaser.Math.Clamp(settings.video.cameraSmoothing / 100, 0, 1);\n    const followLerp = this.tinyGridMode ? 1 : smooth;\n    this.cameras.main.startFollow(this.player, true, followLerp, followLerp);\n    this.cameras.main.roundPixels = !this.tinyGridMode;\n    this.cameras.main.setDeadzone(this.tinyGridMode ? 56 : 180, this.tinyGridMode ? 40 : 120);\n    this.cameras.main.setBackgroundColor(\"#0b1026\");\n    this.updateCameraFraming();\n    this.scale.on(\"resize\", this.updateCameraFraming, this);\n    this.applyVideoSettings();\n    this.createPlayerHealthBar();\n    this.createJetpackFx();\n    this.jetpack = new Platformer.JetpackController(this.jetpackTuning, {\n      onJetpackStart: () => {\n        if (Platformer.Debug) Platformer.Debug.log(\"GameScene.jetpack\", \"Jetpack thrust started.\");\n      },\n      onJetpackStop: (_scene, ctrl, reason) => {\n        if (Platformer.Debug) {\n          Platformer.Debug.log(\"GameScene.jetpack\", `Jetpack thrust stopped. reason=${reason} fuel=${Math.round(ctrl.fuelPercent)}%`);\n        }\n      },\n    });\n    this.jetpack.reset(true);\n    this.jetpackFuelPercent = this.jetpack.fuelPercent;\n    if (Platformer.Debug) {\n      const j = Platformer.Config.JETPACK || {};\n      Platformer.Debug.log(\n        \"GameScene.jetpack\",\n        `Init cap=${j.fuelCapacity}s drain=${j.drainRate}/s regen=${j.regenRate}/s tinyGrid=${this.tinyGridMode ? \"yes\" : \"no\"}`\n      );\n    }\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\n        \"GameScene.tuning\",\n        `tinyGrid=${this.tinyGridMode ? \"yes\" : \"no\"} speed=${P.maxSpeed.toFixed(1)} jump=${P.jumpVelocity.toFixed(1)} gravity=${P.gravity.toFixed(1)}`\n      );\n    }\n    this.registry.set(\"shield\", this.shieldCharges);\n    this.registry.set(\"jetpackFuel\", this.jetpackFuelPercent);\n    this.setupHitboxOverlay();\n\n    this.cursors = this.input.keyboard.createCursorKeys();\n    this.keys = this.input.keyboard.addKeys(this.buildControlKeyMap());\n    this.onSettingsChanged = (nextSettings) => this.applyRuntimeSettings(nextSettings);\n    this.game.events.on(\"settings-changed\", this.onSettingsChanged);\n    this.setupGameMusic();\n    this.setupHazardShooters();\n    this.initRuntimeDiagnostics();\n    this.onRestartLevel = () => {\n      if (Platformer.Debug) Platformer.Debug.warn(\"GameScene\", \"restart-level event received; restarting current level.\");\n      this.scene.restart({ level: this.currentLevel || 1 });\n    };\n    this.game.events.on(\"restart-level\", this.onRestartLevel);\n\n    this.events.emit(\"hud-update\");\n  }\n\n  initRuntimeDiagnostics() {\n    if (!Platformer.Debug) return;\n    Platformer.Debug.log(\n      \"GameScene.diag\",\n      `Level ${this.currentLevel} booted. map=${this.mapWidth}x${this.mapHeight} enemies=${this.enemies ? this.enemies.countActive(true) : 0} turrets=${this.hazards ? this.hazards.countActive(true) : 0}`\n    );\n  }\n\n  diagWarn(key, message, cooldownMs = 1600) {\n    if (!Platformer.Debug) return;\n    const now = this.time ? this.time.now : Date.now();\n    const last = this.diagCooldowns[key] || 0;\n    if (now - last < cooldownMs) return;\n    this.diagCooldowns[key] = now;\n    Platformer.Debug.warn(`GameScene.diag.${key}`, message);\n  }\n\n  runRuntimeDiagnostics(now) {\n    if (!Platformer.Debug) return;\n    if (!this.player || !this.player.body) {\n      this.diagWarn(\"player_missing\", \"Player body missing during update.\", 3000);\n      return;\n    }\n\n    const worldW = this.mapWidth * Platformer.Config.TILE;\n    const worldH = this.mapHeight * Platformer.Config.TILE + 200;\n    const { x, y } = this.player;\n    if (!Number.isFinite(x) || !Number.isFinite(y)) {\n      this.diagWarn(\"player_nan\", `Invalid player position x=${x} y=${y}`, 0);\n    }\n    if (x < -140 || x > worldW + 140 || y < -200 || y > worldH + 260) {\n      this.diagWarn(\"player_oob\", `Player out of expected bounds x=${Math.round(x)} y=${Math.round(y)} world=${worldW}x${worldH}`);\n    }\n\n    const health = this.registry.get(\"health\");\n    const lives = this.registry.get(\"lives\");\n    const coins = this.registry.get(\"coins\");\n    if (!Number.isFinite(health) || health < -1 || health > 3) this.diagWarn(\"health_invalid\", `health=${health}`);\n    if (!Number.isFinite(lives) || lives < -1 || lives > 9) this.diagWarn(\"lives_invalid\", `lives=${lives}`);\n    if (!Number.isFinite(coins) || coins < 0 || coins > 9999) this.diagWarn(\"coins_invalid\", `coins=${coins}`);\n\n    let groundedEnemies = 0;\n    let stuckEnemies = 0;\n    this.enemies.children.each((enemy) => {\n      if (!enemy || !enemy.active || !enemy.body) return;\n      const ex = enemy.x;\n      const ey = enemy.y;\n      if (!Number.isFinite(ex) || !Number.isFinite(ey)) {\n        this.diagWarn(\"enemy_nan\", `enemy invalid pos x=${ex} y=${ey}`, 0);\n        return;\n      }\n      if (ex < -80 || ex > worldW + 80 || ey > worldH + 200) {\n        this.diagWarn(\"enemy_oob\", `enemy out of bounds x=${Math.round(ex)} y=${Math.round(ey)}`);\n      }\n      if (enemy.body.blocked.down || enemy.body.touching.down) groundedEnemies += 1;\n      const speedX = Math.abs(enemy.body.velocity.x || 0);\n      if ((enemy.body.blocked.down || enemy.body.touching.down) && speedX < 8) stuckEnemies += 1;\n    });\n\n    if (this.enemies.countActive(true) > 0 && groundedEnemies === 0) {\n      this.diagWarn(\"enemies_airborne\", \"All enemies airborne; check spawn/support tiles.\", 2200);\n    }\n    if (stuckEnemies >= 2) {\n      this.diagWarn(\"enemies_stalling\", `${stuckEnemies} enemies currently stalled on ground.`, 1800);\n    }\n\n    this.hazards.children.each((hazard) => {\n      if (!hazard || !hazard.active) return;\n      const belowY = hazard.y + Platformer.Config.TILE * 0.55;\n      if (!this.hasSupportAtWorld(hazard.x, belowY)) {\n        this.diagWarn(\"turret_unsupported\", `Turret at (${Math.round(hazard.x)},${Math.round(hazard.y)}) has no support below.`);\n      }\n    });\n\n    if (this.hazardProjectiles && this.hazardShooters.length > 0 && now > 4500 && this.lastHazardShotAt <= 0) {\n      this.diagWarn(\"no_projectile_fire\", \"Turrets present but no projectile has fired yet.\", 5000);\n    }\n  }\n\n  setupGameMusic() {\n    const audioSettings = Platformer.Settings.current.audio;\n    const volume = (audioSettings.master / 100) * (audioSettings.music / 100);\n\n    if (Platformer.menuMusicHtml) {\n      Platformer.menuMusicHtml.pause();\n      Platformer.menuMusicHtml.currentTime = 0;\n      Platformer.menuMusicHtml = null;\n    }\n    this.sound.stopByKey(\"menu-bgm\");\n\n    const startPhaserMusic = () => {\n      let music = Platformer.gameMusic;\n      if (!music) {\n        music = this.sound.get(\"game-bgm\");\n        if (!music) {\n          try {\n            music = this.sound.add(\"game-bgm\", { loop: true, volume });\n          } catch (_e) {\n            this.setupHtmlGameMusicFallback(volume, audioSettings);\n            return;\n          }\n        }\n        Platformer.gameMusic = music;\n      }\n\n      music.setLoop(true);\n      music.setVolume(volume);\n      const tryPlay = () => {\n        if (!music || music.isPlaying) return;\n        try {\n          music.play();\n        } catch (_e) {\n          // Autoplay gating may block until first user input.\n        }\n      };\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    };\n\n    if (this.cache.audio.exists(\"game-bgm\")) {\n      startPhaserMusic();\n      return;\n    }\n\n    this.load.audio(\"game-bgm\", \"assets/Slaughter to Prevail - K (mp3cut.net).mp3\");\n    this.load.once(\"complete\", startPhaserMusic);\n    this.load.once(\"loaderror\", () => this.setupHtmlGameMusicFallback(volume, audioSettings));\n    this.load.start();\n  }\n\n  setupHtmlGameMusicFallback(volume, audioSettings) {\n    try {\n      if (!Platformer.gameMusicHtml) {\n        Platformer.gameMusicHtml = new Audio(\"assets/Slaughter to Prevail - K (mp3cut.net).mp3\");\n      }\n      const music = Platformer.gameMusicHtml;\n      music.loop = true;\n      music.volume = Phaser.Math.Clamp(volume, 0, 1);\n\n      const tryPlay = () => {\n        if (audioSettings.muteWhenUnfocused && document.hidden) return;\n        music.play().catch(() => {});\n      };\n\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    } catch (_e) {\n      // Keep game functional if audio fails.\n    }\n  }\n\n  createPlayerHealthBar() {\n    this.hpBarCfg = this.tinyGridMode\n      ? { yOff: 20, w: 16, h: 4, fillW: 14, fillH: 2 }\n      : { yOff: 34, w: 38, h: 7, fillW: 34, fillH: 5 };\n    this.playerHealthBarBg = this.add.rectangle(\n      this.player.x,\n      this.player.y - this.hpBarCfg.yOff,\n      this.hpBarCfg.w,\n      this.hpBarCfg.h,\n      0x111827,\n      0.92\n    )\n      .setStrokeStyle(1, 0xe2e8f0, 0.85)\n      .setDepth(55);\n    this.playerHealthBarFill = this.add.rectangle(\n      this.player.x - this.hpBarCfg.fillW / 2,\n      this.player.y - this.hpBarCfg.yOff,\n      this.hpBarCfg.fillW,\n      this.hpBarCfg.fillH,\n      0x22c55e,\n      1\n    )\n      .setOrigin(0, 0.5)\n      .setDepth(56);\n    this.updatePlayerHealthBar();\n  }\n\n  createJetpackFx() {\n    let key = this.textures.exists(\"jetpack-flame-1\") ? \"jetpack-flame-1\" : \"coin\";\n    if (this.tinyGridMode) {\n      if (!this.textures.exists(\"jetpack-flame-tiny\")) {\n        const g = this.make.graphics({ x: 0, y: 0, add: false });\n        g.fillStyle(0xfbbf24, 1);\n        g.fillTriangle(4, 0, 0, 7, 8, 7);\n        g.generateTexture(\"jetpack-flame-tiny\", 8, 8);\n        g.destroy();\n      }\n      key = \"jetpack-flame-tiny\";\n    }\n    this.jetpackFlameOffsetY = this.tinyGridMode ? 7 : 22;\n    this.jetpackFlame = this.add.sprite(this.player.x, this.player.y + 18, key)\n      .setDepth(54)\n      .setVisible(false);\n    this.jetpackFlame.setBlendMode(this.tinyGridMode ? Phaser.BlendModes.NORMAL : Phaser.BlendModes.ADD);\n    if (this.tinyGridMode) {\n      this.jetpackFlame.setDisplaySize(6, 6);\n    } else if (key === \"coin\") {\n      this.jetpackFlame.setDisplaySize(12, 12);\n    }\n  }\n\n  updateJetpackFx(now, active) {\n    if (!this.jetpackFlame || !this.player) return;\n    this.jetpackFlame.setPosition(this.player.x, this.player.y + this.jetpackFlameOffsetY);\n    if (!active) {\n      this.jetpackFlame.setVisible(false);\n      return;\n    }\n    this.jetpackFlame.setVisible(true);\n    if (!this.tinyGridMode && this.textures.exists(\"jetpack-flame-1\") && this.textures.exists(\"jetpack-flame-2\")) {\n      const frameKey = Math.floor(now / 75) % 2 === 0 ? \"jetpack-flame-1\" : \"jetpack-flame-2\";\n      this.jetpackFlame.setTexture(frameKey);\n    }\n    if (this.tinyGridMode) {\n      const pulse = 0.85 + Math.sin(now * 0.03) * 0.15;\n      this.jetpackFlame.setScale(this.facingDir < 0 ? -pulse : pulse, pulse);\n      this.jetpackFlame.setAlpha(0.9);\n      return;\n    }\n    this.jetpackFlame.setScale(this.facingDir < 0 ? -1 : 1, 1);\n  }\n\n  alignPlayerBodyToFeet() {\n    if (!this.player || !this.player.body || !this.tinyGridMode) return;\n    const sx = Math.max(0.0001, Math.abs(this.player.scaleX || 1));\n    const sy = Math.max(0.0001, Math.abs(this.player.scaleY || 1));\n    const bodyWorldW = this.playerBodyWorldW || this.player.body.width;\n    const bodyWorldH = this.playerBodyWorldH || this.player.body.height;\n    const p = this.playerHitboxProfile || { ox: 0, oy: 10 };\n    const oxWorld = Math.max(0, (this.player.displayWidth - bodyWorldW) * 0.5 + (p.ox || 0));\n    const oyWorld = Math.max(0, this.player.displayHeight - bodyWorldH + (p.oy || 0));\n    this.player.body.setOffset(oxWorld / sx, oyWorld / sy);\n  }\n\n  applyTinyPlayerHitboxProfile() {\n    if (!this.tinyGridMode || !this.player) return;\n    const fallback = { w: 9, h: 24, ox: 0, oy: -3 };\n    let source = \"fallback\";\n    let p = null;\n\n    // First source: host-backed settings (persistent across EXE restarts).\n    const settingsDebug = Platformer.Settings && Platformer.Settings.current\n      ? Platformer.Settings.current.debug\n      : null;\n    if (settingsDebug && settingsDebug.playerHitbox) {\n      p = {\n        w: Phaser.Math.Clamp(Number(settingsDebug.playerHitbox.w) || fallback.w, 4, 64),\n        h: Phaser.Math.Clamp(Number(settingsDebug.playerHitbox.h) || fallback.h, 4, 64),\n        ox: Phaser.Math.Clamp(Number(settingsDebug.playerHitbox.ox) || fallback.ox, -24, 24),\n        oy: Phaser.Math.Clamp(Number(settingsDebug.playerHitbox.oy) || fallback.oy, -24, 24),\n      };\n      source = \"settings\";\n    }\n\n    // Prefer the debug module profile when available.\n    if (!p && Platformer.Debug && typeof Platformer.Debug.getPlayerHitboxProfile === \"function\") {\n      p = Platformer.Debug.getPlayerHitboxProfile();\n      source = \"debug\";\n    }\n\n    // Robust fallback: load persisted profile directly even if Debug init order changes.\n    if (!p) {\n      try {\n        const raw = localStorage.getItem(\"platformer_player_hitbox\");\n        if (raw) {\n          const parsed = JSON.parse(raw);\n          p = {\n            w: Phaser.Math.Clamp(Number(parsed.w) || fallback.w, 4, 64),\n            h: Phaser.Math.Clamp(Number(parsed.h) || fallback.h, 4, 64),\n            ox: Phaser.Math.Clamp(Number(parsed.ox) || fallback.ox, -24, 24),\n            oy: Phaser.Math.Clamp(Number(parsed.oy) || fallback.oy, -24, 24),\n          };\n          source = \"localStorage\";\n        }\n      } catch (_e) {\n        // Ignore parse/storage errors and keep fallback.\n      }\n    }\n\n    this.playerHitboxProfile = { ...fallback, ...(p || {}) };\n    this.setPlayerBodyWorldSize(this.playerHitboxProfile.w, this.playerHitboxProfile.h, false);\n    this.alignPlayerBodyToFeet();\n    if (Platformer.Debug) {\n      Platformer.Debug.log(\n        \"GameScene.collision\",\n        `Hitbox profile loaded (${source}) w=${this.playerHitboxProfile.w} h=${this.playerHitboxProfile.h} ox=${this.playerHitboxProfile.ox} oy=${this.playerHitboxProfile.oy}`\n      );\n    }\n  }\n\n  setPlayerBodyWorldSize(worldW, worldH, center) {\n    if (!this.player || !this.player.body) return;\n    this.playerBodyWorldW = worldW;\n    this.playerBodyWorldH = worldH;\n    const sx = Math.max(0.0001, Math.abs(this.player.scaleX || 1));\n    const sy = Math.max(0.0001, Math.abs(this.player.scaleY || 1));\n    const rawW = Math.max(1, worldW / sx);\n    const rawH = Math.max(1, worldH / sy);\n    this.player.body.setSize(rawW, rawH, center);\n  }\n\n  resolvePlayerEmbedding(context) {\n    if (!this.tinyGridMode || !this.player || !this.player.body) return;\n    const body = this.player.body;\n    let overlapped = !!body.embedded;\n    if (!overlapped && this.physics && this.solids) {\n      overlapped = this.physics.overlap(this.player, this.solids);\n    }\n    if (!overlapped) return;\n\n    for (let i = 0; i < 64; i += 1) {\n      this.player.y -= 1;\n      if (typeof body.updateFromGameObject === \"function\") body.updateFromGameObject();\n      if (!this.physics.overlap(this.player, this.solids)) {\n        body.embedded = false;\n        break;\n      }\n    }\n    const stillOverlapped = this.physics && this.solids ? this.physics.overlap(this.player, this.solids) : false;\n    if (body.velocity.y > 0) body.velocity.y = 0;\n    if (Platformer.Debug) {\n      if (stillOverlapped) {\n        Platformer.Debug.error(\n          \"GameScene.collision\",\n          `Player still embedded after resolve (${context}) x=${this.player.x.toFixed(1)} y=${this.player.y.toFixed(1)} ` +\n          `bx=${body.x.toFixed(1)} by=${body.y.toFixed(1)} bw=${body.width} bh=${body.height} ` +\n          `vx=${body.velocity.x.toFixed(1)} vy=${body.velocity.y.toFixed(1)}`\n        );\n      } else {\n        Platformer.Debug.warn(\"GameScene.collision\", `Resolved embedded player (${context}).`);\n      }\n    }\n  }\n\n  logIfPlayerInsideTile(now) {\n    if (!this.player || !this.player.body || !this.solids || !this.physics) return;\n    const body = this.player.body;\n    const overlapped = !!body.embedded || this.physics.overlap(this.player, this.solids);\n    if (!overlapped) {\n      this.tileEmbedFrames = 0;\n      return;\n    }\n\n    this.tileEmbedFrames += 1;\n    if (this.tileEmbedFrames < 2) return;\n    if (now - this.lastTileEmbedLogAt < 500) return;\n    this.lastTileEmbedLogAt = now;\n\n    if (Platformer.Debug) {\n      Platformer.Debug.error(\n        \"GameScene.collision\",\n        `INSIDE_TILE detected x=${this.player.x.toFixed(1)} y=${this.player.y.toFixed(1)} ` +\n        `bx=${body.x.toFixed(1)} by=${body.y.toFixed(1)} bw=${body.width} bh=${body.height} ` +\n        `vx=${body.velocity.x.toFixed(1)} vy=${body.velocity.y.toFixed(1)} ` +\n        `blocked(d,l,r,u)=${body.blocked.down ? 1 : 0},${body.blocked.left ? 1 : 0},${body.blocked.right ? 1 : 0},${body.blocked.up ? 1 : 0}`\n      );\n    }\n  }\n\n  resolveGroundPenetration(now) {\n    if (!this.tinyGridMode || !this.player || !this.player.body || !this.solids || !this.physics) return;\n    const body = this.player.body;\n    if (!body.blocked.down || body.velocity.y < 0) return;\n    let top = Number.POSITIVE_INFINITY;\n    const hasOverlap = this.physics.overlap(this.player, this.solids, (_p, solid) => {\n      if (solid && solid.body) top = Math.min(top, solid.body.top);\n    });\n    if (!hasOverlap || !Number.isFinite(top)) return;\n\n    const penetration = body.bottom - top;\n    if (penetration <= 1.25) return;\n    const moved = Math.min(4, Math.ceil(penetration - 1));\n    this.player.y -= moved;\n    if (typeof body.updateFromGameObject === \"function\") body.updateFromGameObject();\n    if (moved > 0 && Platformer.Debug && now - this.lastTileEmbedLogAt > 250) {\n      this.lastTileEmbedLogAt = now;\n      Platformer.Debug.warn(\"GameScene.collision\", `Ground penetration corrected by ${moved}px`);\n    }\n  }\n\n  setupHitboxOverlay() {\n    this.hitboxOverlayEnabled = !!(Platformer.Debug && Platformer.Debug.hitboxesEnabled);\n    this.hitboxOverlay = this.add.graphics();\n    this.hitboxOverlay.setDepth(5000);\n    this.hitboxOverlay.setScrollFactor(1);\n    this.onHitboxesToggle = (ev) => {\n      this.hitboxOverlayEnabled = !!(ev && ev.detail && ev.detail.enabled);\n      if (Platformer.Debug) Platformer.Debug.log(\"GameScene.hitboxes\", `Overlay ${this.hitboxOverlayEnabled ? \"ON\" : \"OFF\"}`);\n      if (!this.hitboxOverlayEnabled && this.hitboxOverlay) this.hitboxOverlay.clear();\n    };\n    window.addEventListener(\"platformer:hitboxes-toggle\", this.onHitboxesToggle);\n    this.onPlayerHitboxChanged = (ev) => {\n      const p = ev && ev.detail ? ev.detail : null;\n      if (!p || !this.tinyGridMode || !this.player) return;\n      this.playerHitboxProfile = { ...this.playerHitboxProfile, ...p };\n      this.setPlayerBodyWorldSize(this.playerHitboxProfile.w, this.playerHitboxProfile.h, false);\n      this.alignPlayerBodyToFeet();\n      if (typeof this.player.body.updateFromGameObject === \"function\") this.player.body.updateFromGameObject();\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\n          \"GameScene.collision\",\n          `Player HB applied w=${this.playerHitboxProfile.w} h=${this.playerHitboxProfile.h} ox=${this.playerHitboxProfile.ox} oy=${this.playerHitboxProfile.oy}`\n        );\n      }\n    };\n    window.addEventListener(\"platformer:player-hitbox-changed\", this.onPlayerHitboxChanged);\n  }\n\n  drawHitboxOverlay(now) {\n    if (!this.hitboxOverlay) return;\n    if (!this.hitboxOverlayEnabled) {\n      this.hitboxOverlay.clear();\n      return;\n    }\n    if (now - this.lastHitboxDrawAt < 16) return;\n    this.lastHitboxDrawAt = now;\n\n    const g = this.hitboxOverlay;\n    g.clear();\n    const cam = this.cameras && this.cameras.main ? this.cameras.main : null;\n    const view = cam ? cam.worldView : null;\n    const inView = (b) => {\n      if (!view) return true;\n      return !(b.right < view.x - 24 || b.x > view.right + 24 || b.bottom < view.y - 24 || b.y > view.bottom + 24);\n    };\n\n    const drawBody = (body, color, width = 1) => {\n      if (!body) return;\n      if (!inView(body)) return;\n      g.lineStyle(width, color, 1);\n      g.strokeRect(body.x, body.y, body.width, body.height);\n    };\n\n    drawBody(this.player && this.player.body, 0x22c55e, 2);\n    this.solids && this.solids.children.each((o) => drawBody(o && o.body, 0x38bdf8, 1));\n    this.oneWays && this.oneWays.children.each((o) => drawBody(o && o.body, 0x06b6d4, 1));\n    this.hazards && this.hazards.children.each((o) => drawBody(o && o.body, 0xf97316, 1));\n    this.enemies && this.enemies.children.each((o) => drawBody(o && o.body, 0xef4444, 1));\n    this.hazardProjectiles && this.hazardProjectiles.children.each((o) => drawBody(o && o.body, 0xeab308, 1));\n  }\n\n  updatePlayerHealthBar() {\n    if (!this.player || !this.playerHealthBarBg || !this.playerHealthBarFill) {\n      return;\n    }\n\n    const health = Phaser.Math.Clamp(this.registry.get(\"health\"), 0, 3);\n    const ratio = health / 3;\n    const fillWidth = Math.max(0, (this.hpBarCfg ? this.hpBarCfg.fillW : 34) * ratio);\n    const color = ratio > 0.66 ? 0x22c55e : (ratio > 0.33 ? 0xf59e0b : 0xef4444);\n    const yOff = this.hpBarCfg ? this.hpBarCfg.yOff : 34;\n    const xOff = this.hpBarCfg ? this.hpBarCfg.fillW / 2 : 18;\n    this.playerHealthBarBg.setPosition(this.player.x, this.player.y - yOff);\n    this.playerHealthBarFill.setPosition(this.player.x - xOff, this.player.y - yOff);\n    this.playerHealthBarFill.width = fillWidth;\n    this.playerHealthBarFill.setFillStyle(color, 1);\n    this.playerHealthBarFill.setVisible(fillWidth > 0);\n  }\n\n  setupHazardShooters() {\n    this.hazardShooters = [];\n    let i = 0;\n    this.hazards.children.each((hazard) => {\n      // All turrets are active; stagger initial fire times for readability.\n      hazard.setData(\"nextShotAt\", this.time.now + i * 140);\n      this.hazardShooters.push(hazard);\n      i += 1;\n    });\n  }\n\n  spawnHazardProjectiles(now) {\n    if (!this.hazardShooters.length) {\n      return;\n    }\n\n    let fired = 0;\n    const maxShotsPerTick = 2;\n    for (let i = 0; i < this.hazardShooters.length; i += 1) {\n      if (fired >= maxShotsPerTick) {\n        break;\n      }\n\n      const shooter = this.hazardShooters[i];\n      if (!shooter || !shooter.active) {\n        continue;\n      }\n\n      const nextShotAt = shooter.getData(\"nextShotAt\") || 0;\n      if (now < nextShotAt) {\n        continue;\n      }\n\n      const inRangeX = Math.abs(shooter.x - this.player.x) < (this.tinyGridMode ? 220 : 540);\n      const inRangeY = Math.abs(shooter.y - this.player.y) < (this.tinyGridMode ? 120 : 260);\n      if (!inRangeX || !inRangeY) {\n        continue;\n      }\n\n      const projectile = this.hazardProjectiles.create(shooter.x, shooter.y - 8, \"hazard-projectile\");\n      projectile.setDepth(70);\n      projectile.body.setSize(this.tinyGridMode ? 4 : 10, this.tinyGridMode ? 4 : 10);\n      if (this.tinyGridMode) projectile.setDisplaySize(5, 5);\n      projectile.body.setAllowGravity(false);\n      projectile.setCollideWorldBounds(false);\n\n      const dir = this.player.x >= shooter.x ? 1 : -1;\n      const yAim = Phaser.Math.Clamp(this.player.y - shooter.y, -120, 90) * 0.35;\n      projectile.setVelocity(dir * this.projectileSpeed, yAim);\n\n      const stagger = (Math.floor(shooter.x / Platformer.Config.TILE) % 3) * 90;\n      shooter.setData(\"nextShotAt\", now + this.projectileIntervalMs + stagger);\n      fired += 1;\n      this.lastHazardShotAt = now;\n    }\n  }\n\n  updateProjectiles() {\n    const maxY = this.mapHeight * Platformer.Config.TILE + 200;\n    const minX = -120;\n    const maxX = this.mapWidth * Platformer.Config.TILE + 120;\n    this.hazardProjectiles.children.each((p) => {\n      if (!p.active) return;\n      if (p.x < minX || p.x > maxX || p.y > maxY) {\n        p.destroy();\n      }\n    });\n  }\n\n  updateLevelTimer(now) {\n    if (!this.lastTickTime) {\n      this.lastTickTime = now;\n      return;\n    }\n\n    const dt = now - this.lastTickTime;\n    this.lastTickTime = now;\n    this.levelTimeRemainingMs = Math.max(0, this.levelTimeRemainingMs - dt);\n    const secondsLeft = Math.ceil(this.levelTimeRemainingMs / 1000);\n    if (secondsLeft !== this.lastTimerSecond) {\n      this.lastTimerSecond = secondsLeft;\n      this.registry.set(\"timeLeft\", secondsLeft);\n    }\n\n    if (this.levelTimeRemainingMs <= 0 && !this.isDead) {\n      this.isDead = true;\n      this.game.events.emit(\"game-over\");\n      this.scene.pause();\n    }\n  }\n\n  createTokyoBackdrop() {\n    const { TILE } = Platformer.Config;\n    const worldW = this.mapWidth * TILE;\n\n    const skyTop = this.add.rectangle(worldW / 2, 120, worldW, 240, 0x111827).setDepth(-120).setScrollFactor(0);\n    const skyMid = this.add.rectangle(worldW / 2, 260, worldW, 280, 0x1e1b4b).setDepth(-119).setScrollFactor(0);\n    const skyGlow = this.add.rectangle(worldW / 2, 210, worldW, 180, 0x312e81, 0.35).setDepth(-118).setScrollFactor(0);\n    this.parallax.push(skyTop, skyMid, skyGlow);\n\n    const moon = this.add.circle(760, 88, 34, 0xfef3c7, 0.9).setDepth(-117).setScrollFactor(0.04);\n    const moonGlow = this.add.circle(760, 88, 52, 0xfef9c3, 0.18).setDepth(-118).setScrollFactor(0.04);\n    this.parallax.push(moon, moonGlow);\n\n    const farHeights = [110, 120, 100, 130, 95, 126, 106, 116];\n    for (let i = 0; i < 40; i += 1) {\n      const w = 90;\n      const h = farHeights[i % farHeights.length];\n      const x = i * 88;\n      const y = 320 - h / 2;\n      const b = this.add.rectangle(x, y, w, h, 0x0f172a).setOrigin(0, 0.5).setDepth(-90).setScrollFactor(0.2);\n      this.parallax.push(b);\n\n      for (let wx = 0; wx < 4; wx += 1) {\n        const color = (wx + i) % 2 === 0 ? 0x22d3ee : 0xf472b6;\n        const win = this.add.rectangle(x + 12 + wx * 18, y - h / 2 + 18 + ((i + wx) % 5) * 14, 9, 6, color, 0.8)\n          .setDepth(-89)\n          .setScrollFactor(0.2);\n        this.parallax.push(win);\n      }\n    }\n\n    const midHeights = [140, 170, 150, 188, 132, 168];\n    for (let i = 0; i < 26; i += 1) {\n      const w = 122;\n      const h = midHeights[i % midHeights.length];\n      const x = i * 118;\n      const y = 390 - h / 2;\n      const b = this.add.rectangle(x, y, w, h, 0x020617).setOrigin(0, 0.5).setDepth(-70).setScrollFactor(0.45);\n      this.parallax.push(b);\n\n      if (i % 4 === 1) {\n        const sign = this.add.rectangle(x + 70, y - h / 2 + 34, 58, 18, 0xdb2777, 0.9)\n          .setDepth(-69)\n          .setScrollFactor(0.45);\n        this.parallax.push(sign);\n      }\n    }\n\n    for (let i = 0; i < 24; i += 1) {\n      const line = this.add.rectangle(i * 170, 120 + (i % 5) * 72, 120, 4, 0xffffff, 0.28)\n        .setAngle(-16)\n        .setOrigin(0, 0.5)\n        .setDepth(-60)\n        .setScrollFactor(0.12);\n      this.parallax.push(line);\n    }\n  }\n\n  tryBuildLevelFromLdtk(levelNumber) {\n    if (Number(levelNumber) !== 5) return null;\n    try {\n      const ldtk = this.cache && this.cache.json ? this.cache.json.get(\"ldtk-test\") : null;\n      if (!ldtk || typeof ldtk !== \"object\") {\n        if (Platformer.Debug) Platformer.Debug.warn(\"GameScene.ldtk\", \"Missing cached ldtk-test JSON; falling back to classic level data.\");\n        return null;\n      }\n      const levels = Array.isArray(ldtk.levels) ? ldtk.levels : [];\n      const level = levels[0] || null;\n      if (!level) {\n        if (Platformer.Debug) Platformer.Debug.warn(\"GameScene.ldtk\", \"No levels in test.ldtk; falling back.\");\n        return null;\n      }\n      const layers = Array.isArray(level.layerInstances) ? level.layerInstances : [];\n      const intLayer = layers.find((li) => li && li.__type === \"IntGrid\") || null;\n      if (!intLayer) {\n        if (Platformer.Debug) Platformer.Debug.warn(\"GameScene.ldtk\", \"No IntGrid layer found in test.ldtk; falling back.\");\n        return null;\n      }\n      const width = Number(intLayer.__cWid || 0);\n      const height = Number(intLayer.__cHei || 0);\n      const csv = Array.isArray(intLayer.intGridCsv) ? intLayer.intGridCsv : [];\n      if (!width || !height || csv.length !== width * height) {\n        if (Platformer.Debug) Platformer.Debug.warn(\"GameScene.ldtk\", `Invalid IntGrid dimensions w=${width} h=${height} csv=${csv.length}; falling back.`);\n        return null;\n      }\n\n      const rowsChars = Array.from({ length: height }, () => Array.from({ length: width }, () => \".\"));\n      for (let y = 0; y < height; y += 1) {\n        for (let x = 0; x < width; x += 1) {\n          const v = Number(csv[y * width + x] || 0);\n          if (v !== 0) rowsChars[y][x] = \"#\";\n        }\n      }\n\n      // Find a sensible spawn above a solid tile.\n      let sx = 1;\n      let sy = 1;\n      for (let y = 1; y < height; y += 1) {\n        let found = false;\n        for (let x = 0; x < width; x += 1) {\n          if (rowsChars[y][x] === \".\" && rowsChars[y - 1][x] === \"#\") {\n            sx = x;\n            sy = y;\n            found = true;\n            break;\n          }\n        }\n        if (found) break;\n      }\n      rowsChars[sy][sx] = \"S\";\n\n      return {\n        width,\n        height,\n        rows: rowsChars.map((r) => r.join(\"\")),\n      };\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"GameScene.ldtk\", err && err.stack ? err.stack : String(err));\n      }\n      return null;\n    }\n  }\n\n  renderLdtkVisualTiles() {\n    try {\n      if (!this.textures.exists(\"ldtk-cavernas\")) {\n        if (Platformer.Debug) Platformer.Debug.warn(\"GameScene.ldtk\", \"ldtk-cavernas texture missing; visual tile render skipped.\");\n        return;\n      }\n      const ldtk = this.cache && this.cache.json ? this.cache.json.get(\"ldtk-test\") : null;\n      const level = ldtk && Array.isArray(ldtk.levels) ? ldtk.levels[0] : null;\n      const layers = level && Array.isArray(level.layerInstances) ? level.layerInstances : [];\n      const intLayer = layers.find((li) => li && li.__type === \"IntGrid\") || null;\n      if (!intLayer) return;\n      const autoTiles = Array.isArray(intLayer.autoLayerTiles) ? intLayer.autoLayerTiles : [];\n\n      const tex = this.textures.get(\"ldtk-cavernas\");\n      const src = tex && tex.getSourceImage ? tex.getSourceImage() : null;\n      const tileSize = Number(intLayer.__gridSize || Platformer.Config.TILE || 8);\n      const cols = src && src.width ? Math.max(1, Math.floor(src.width / tileSize)) : 1;\n\n      // Clear previous visuals if scene restarts.\n      if (Array.isArray(this.ldtkVisualTiles) && this.ldtkVisualTiles.length) {\n        this.ldtkVisualTiles.forEach((o) => { if (o && o.destroy) o.destroy(); });\n      }\n      this.ldtkVisualTiles = [];\n\n      for (let i = 0; i < autoTiles.length; i += 1) {\n        const t = autoTiles[i];\n        if (!t || !Array.isArray(t.px) || !Array.isArray(t.src)) continue;\n        const px = Number(t.px[0] || 0);\n        const py = Number(t.px[1] || 0);\n        const sx = Number(t.src[0] || 0);\n        const sy = Number(t.src[1] || 0);\n        const f = Number(t.f || 0);\n        const frame = Math.floor(sy / tileSize) * cols + Math.floor(sx / tileSize);\n        const img = this.add.image(px + tileSize / 2, py + tileSize / 2, \"ldtk-cavernas\", frame)\n          .setDepth(-40)\n          .setOrigin(0.5);\n        if ((f & 1) !== 0) img.setFlipX(true);\n        if ((f & 2) !== 0) img.setFlipY(true);\n        this.ldtkVisualTiles.push(img);\n      }\n\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\"GameScene.ldtk\", `Rendered LDtk auto tiles: ${this.ldtkVisualTiles.length}`);\n      }\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"GameScene.ldtk\", err && err.stack ? err.stack : String(err));\n      }\n    }\n  }\n\n  oneWayProcess(player, platform) {\n    const pBody = player.body;\n    const platBody = platform.body;\n    const wasAbove = pBody.bottom <= platBody.top + 6;\n    const isFalling = pBody.velocity.y >= 0;\n    return wasAbove && isFalling;\n  }\n\n  keyCodeFromName(name, fallback) {\n    if (!name) return fallback;\n    const upper = String(name).toUpperCase();\n    const direct = Phaser.Input.Keyboard.KeyCodes[upper];\n    if (typeof direct === \"number\") return direct;\n    if (upper.length === 1) {\n      const letter = Phaser.Input.Keyboard.KeyCodes[upper];\n      if (typeof letter === \"number\") return letter;\n    }\n    return fallback;\n  }\n\n  buildPlayerTuning(base) {\n    const b = base || {};\n    if (!this.tinyGridMode) return { ...b };\n    const s = 0.5;\n    return {\n      ...b,\n      maxSpeed: (b.maxSpeed || 164) * s,\n      acceleration: (b.acceleration || 1080) * (s * 1.35),\n      drag: (b.drag || 3200) * (s * 1.25),\n      jumpVelocity: (b.jumpVelocity || 420) * s,\n      gravity: (b.gravity || 1100) * s,\n      dashSpeed: (b.dashSpeed || 460) * s,\n      maxRiseSpeed: (b.maxRiseSpeed || 520) * s,\n      maxFallSpeed: (b.maxFallSpeed || 760) * s,\n      attackRange: Math.max(12, (b.attackRange || 44) * 0.45),\n    };\n  }\n\n  buildJetpackTuning(base) {\n    const b = { ...(base || {}) };\n    if (!this.tinyGridMode) return b;\n    const s = 0.5;\n    b.maxUpSpeed = Math.max(28, Number(b.maxUpSpeed || 220) * s);\n    b.momentumBoostSpeed = Math.max(12, Number(b.momentumBoostSpeed || 72) * s);\n    b.activationKickSpeed = Math.max(8, Number(b.activationKickSpeed || 34) * s);\n    b.maxAccel = Math.max(180, Number(b.maxAccel || 1320) * s);\n    b.maxThrustAccel = Math.max(180, Number(b.maxThrustAccel || 1300) * s);\n    b.brakeDecelMax = Math.max(120, Number(b.brakeDecelMax || 760) * s);\n    b.liftThresholdSpeed = Math.max(10, Number(b.liftThresholdSpeed || 56) * s);\n    return b;\n  }\n\n  buildControlKeyMap() {\n    const c = Platformer.Settings.current.controls;\n    return {\n      left: this.keyCodeFromName(c.left, Phaser.Input.Keyboard.KeyCodes.A),\n      right: this.keyCodeFromName(c.right, Phaser.Input.Keyboard.KeyCodes.D),\n      jump: this.keyCodeFromName(c.jump, Phaser.Input.Keyboard.KeyCodes.W),\n      dash: this.keyCodeFromName(c.dash, Phaser.Input.Keyboard.KeyCodes.SHIFT),\n      attack: this.keyCodeFromName(c.attack, Phaser.Input.Keyboard.KeyCodes.J),\n      interact: this.keyCodeFromName(c.interact, Phaser.Input.Keyboard.KeyCodes.E),\n      pause: this.keyCodeFromName(c.pause, Phaser.Input.Keyboard.KeyCodes.ESC),\n      jetpack: Phaser.Input.Keyboard.KeyCodes.SPACE,\n      demoWin: Phaser.Input.Keyboard.KeyCodes.F2,\n    };\n  }\n\n  applyVideoSettings() {\n    const s = Platformer.Settings.current;\n    const brightness = Phaser.Math.Clamp(s.video.brightness, 0.8, 1.2);\n    const shade = brightness >= 1 ? 0xffffff : 0x000000;\n    const alpha = Math.abs(1 - brightness) * 0.45;\n    const centerX = this.mapWidth * Platformer.Config.TILE / 2;\n    const centerY = this.mapHeight * Platformer.Config.TILE / 2;\n    const width = this.mapWidth * Platformer.Config.TILE + 800;\n    const height = this.mapHeight * Platformer.Config.TILE + 800;\n    if (this.brightnessOverlay && this.brightnessOverlay.active) {\n      this.brightnessOverlay.setPosition(centerX, centerY);\n      this.brightnessOverlay.setSize(width, height);\n      this.brightnessOverlay.setFillStyle(shade, alpha);\n    } else {\n      this.brightnessOverlay = this.add.rectangle(centerX, centerY, width, height, shade, alpha)\n        .setScrollFactor(0)\n        .setDepth(200);\n    }\n  }\n\n  applyRuntimeSettings(nextSettings) {\n    try {\n      const settings = nextSettings || Platformer.Settings.current || {};\n      const audio = settings.audio || { master: 80, music: 60 };\n      const volume = Phaser.Math.Clamp((Number(audio.master) / 100) * (Number(audio.music) / 100), 0, 1);\n\n      if (Platformer.gameMusic && typeof Platformer.gameMusic.setVolume === \"function\") {\n        Platformer.gameMusic.setVolume(volume);\n      }\n      if (Platformer.gameMusicHtml) {\n        Platformer.gameMusicHtml.volume = volume;\n      }\n      if (this.keys && this.input && this.input.keyboard) {\n        this.keys = this.input.keyboard.addKeys(this.buildControlKeyMap());\n      }\n      this.applyVideoSettings();\n      this.updateCameraFraming();\n      if (this.cameras && this.cameras.main && this.player) {\n        const smooth = Phaser.Math.Clamp((settings.video.cameraSmoothing || 0) / 100, 0, 1);\n        const followLerp = this.tinyGridMode ? 1 : smooth;\n        this.cameras.main.startFollow(this.player, true, followLerp, followLerp);\n        this.cameras.main.roundPixels = !this.tinyGridMode;\n      }\n      if (Platformer.Debug) {\n        Platformer.Debug.log(\"GameScene.settings\", `Applied runtime settings: gameVolume=${volume.toFixed(2)}`);\n      }\n    } catch (err) {\n      if (Platformer.Debug) {\n        Platformer.Debug.error(\"GameScene.settings\", err && err.stack ? err.stack : String(err));\n      }\n    }\n  }\n\n  updateCameraFraming() {\n    if (!this.cameras || !this.cameras.main) {\n      return;\n    }\n    const s = Platformer.Settings.current;\n    const baseZoom = this.scale.height / Platformer.Config.GAME_HEIGHT;\n    const resScale = Phaser.Math.Clamp(s.video.resolutionScale / 100, 0.5, 1);\n    const modeZoom = this.tinyGridMode ? 3.5 : 1;\n    const zoom = this.tinyGridMode\n      ? Phaser.Math.Clamp(baseZoom * resScale * modeZoom, 2.5, 7)\n      : Phaser.Math.Clamp(baseZoom * resScale * modeZoom, 0.75, 3);\n    this.cameras.main.setZoom(zoom);\n  }\n\n  normalizeTurretTiles() {\n    const grid = this.mapRows.map((row) => row.split(\"\"));\n    const inBounds = (x, y) => x >= 0 && x < this.mapWidth && y >= 0 && y < this.mapHeight;\n    const isSupport = (x, y) => {\n      if (!inBounds(x, y)) return false;\n      const ch = grid[y][x];\n      return ch === \"#\" || ch === \"=\";\n    };\n    const isWalkableSlot = (x, y) => {\n      if (!inBounds(x, y)) return false;\n      const ch = grid[y][x];\n      return ch === \".\" || ch === \"^\";\n    };\n    const findSpawnX = () => {\n      for (let yy = 0; yy < this.mapHeight; yy += 1) {\n        for (let xx = 0; xx < this.mapWidth; xx += 1) {\n          if (grid[yy][xx] === \"S\") return xx;\n        }\n      }\n      return 0;\n    };\n    const spawnX = findSpawnX();\n\n    const turrets = [];\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        if (grid[y][x] === \"^\") {\n          turrets.push({ x, y });\n          grid[y][x] = \".\";\n        }\n      }\n    }\n\n    const isSafeFromSpawn = (x) => Math.abs(x - spawnX) >= 8;\n    const tryPlace = (x, y) => {\n      if (isWalkableSlot(x, y) && isSupport(x, y + 1)) {\n        if (!isSafeFromSpawn(x)) {\n          return false;\n        }\n        grid[y][x] = \"^\";\n        return true;\n      }\n      return false;\n    };\n\n    turrets.forEach(({ x, y }) => {\n      let placed = false;\n      const preferredY = Phaser.Math.Clamp(y, 0, this.mapHeight - 2);\n\n      // Keep authored lane first for better level readability.\n      placed = tryPlace(x, preferredY);\n\n      // Then search nearby vertically only.\n      if (!placed) {\n        for (let d = 1; d <= 2 && !placed; d += 1) {\n          const up = preferredY - d;\n          const down = preferredY + d;\n          if (up >= 0) placed = tryPlace(x, up);\n          if (!placed && down <= this.mapHeight - 2) placed = tryPlace(x, down);\n        }\n      }\n    });\n\n    this.mapRows = grid.map((row) => row.join(\"\"));\n  }\n\n  normalizeEnemyTiles() {\n    const enemyChars = new Set([\"E\", \"F\", \"G\", \"H\"]);\n    const grid = this.mapRows.map((row) => row.split(\"\"));\n    const inBounds = (x, y) => x >= 0 && x < this.mapWidth && y >= 0 && y < this.mapHeight;\n    const chAt = (x, y) => (inBounds(x, y) ? grid[y][x] : \".\");\n    const isSupport = (x, y) => {\n      const ch = chAt(x, y);\n      return ch === \"#\" || ch === \"=\";\n    };\n    const isEnemySpotOpen = (x, y) => chAt(x, y) === \".\";\n    const isHazardAt = (x, y) => chAt(x, y) === \"^\";\n    const hasHeadroom = (x, y) => y <= 0 || chAt(x, y - 1) === \".\";\n    const canStandAt = (x, y) =>\n      inBounds(x, y)\n      && y < this.mapHeight - 1\n      && isEnemySpotOpen(x, y)\n      && isSupport(x, y + 1)\n      && !isHazardAt(x, y)\n      && hasHeadroom(x, y);\n    const patrolSpanAt = (x, y) => {\n      if (!canStandAt(x, y)) {\n        return 0;\n      }\n\n      let left = x;\n      let right = x;\n      while (canStandAt(left - 1, y)) left -= 1;\n      while (canStandAt(right + 1, y)) right += 1;\n      return right - left + 1;\n    };\n\n    let spawnX = 0;\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        if (grid[y][x] === \"S\") {\n          spawnX = x;\n        }\n      }\n    }\n\n    const turrets = [];\n    const enemies = [];\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        const ch = grid[y][x];\n        if (ch === \"^\") turrets.push({ x, y });\n        if (enemyChars.has(ch)) {\n          enemies.push({ x, y, type: ch });\n          grid[y][x] = \".\";\n        }\n      }\n    }\n\n    const isSafeFromTurrets = (x, y) => !turrets.some((t) => Math.abs(t.x - x) <= 5 && Math.abs(t.y - y) <= 2);\n    const isSafeFromSpawn = (x) => Math.abs(x - spawnX) >= 10;\n    const placedEnemies = [];\n    const isSafeFromOtherEnemies = (x, y) => !placedEnemies.some((e) => Math.abs(e.x - x) <= 4 && Math.abs(e.y - y) <= 2);\n    const hasPatrolRoom = (x, y) => {\n      const span = patrolSpanAt(x, y);\n      if (span < 6) return false;\n      return canStandAt(x - 1, y) || canStandAt(x + 1, y);\n    };\n    const canPlaceEnemy = (x, y) =>\n      canStandAt(x, y)\n      && hasPatrolRoom(x, y)\n      && isSafeFromTurrets(x, y)\n      && isSafeFromSpawn(x)\n      && isSafeFromOtherEnemies(x, y);\n\n    enemies.forEach((enemy) => {\n      let placed = false;\n      const tryOrder = [0, -1, 1];\n      for (const dy of tryOrder) {\n        const yy = enemy.y + dy;\n        for (let dx = 0; dx <= 6; dx += 1) {\n          const xs = dx === 0 ? [enemy.x] : [enemy.x - dx, enemy.x + dx];\n          for (const xx of xs) {\n            if (canPlaceEnemy(xx, yy)) {\n              grid[yy][xx] = enemy.type;\n              placedEnemies.push({ x: xx, y: yy });\n              placed = true;\n              break;\n            }\n          }\n          if (placed) break;\n        }\n        if (placed) break;\n      }\n\n      if (!placed) {\n        for (let y = 0; y < this.mapHeight - 1; y += 1) {\n          for (let x = 0; x < this.mapWidth; x += 1) {\n            if (canPlaceEnemy(x, y)) {\n              grid[y][x] = enemy.type;\n              placedEnemies.push({ x, y });\n              placed = true;\n              break;\n            }\n          }\n          if (placed) break;\n        }\n      }\n    });\n\n    this.mapRows = grid.map((row) => row.join(\"\"));\n  }\n\n  enemyOneWayProcess(enemy, platform) {\n    const eBody = enemy.body;\n    const pBody = platform.body;\n    return eBody.bottom <= pBody.top + 4 && eBody.velocity.y >= 0;\n  }\n\n  tileCharAtWorld(worldX, worldY) {\n    const { TILE } = Platformer.Config;\n    const tx = Math.floor(worldX / TILE);\n    const ty = Math.floor(worldY / TILE);\n    return this.tileCharAt(tx, ty);\n  }\n\n  tileCharAt(tileX, tileY) {\n    if (tileX < 0 || tileY < 0 || tileY >= this.mapHeight || tileX >= this.mapWidth) {\n      return \".\";\n    }\n    return this.mapRows[tileY][tileX];\n  }\n\n  hasSupportAtWorld(worldX, worldY) {\n    const ch = this.tileCharAtWorld(worldX, worldY);\n    return ch === \"#\" || ch === \"=\";\n  }\n\n  isHazardAtWorld(worldX, worldY) {\n    return this.tileCharAtWorld(worldX, worldY) === \"^\";\n  }\n\n  isSupportTile(tileX, tileY) {\n    const ch = this.tileCharAt(tileX, tileY);\n    return ch === \"#\" || ch === \"=\";\n  }\n\n  isHazardTile(tileX, tileY) {\n    return this.tileCharAt(tileX, tileY) === \"^\";\n  }\n\n  computeEnemyPatrolBounds(tileX, tileY) {\n    const { TILE } = Platformer.Config;\n    const supportY = tileY + 1;\n    let left = tileX;\n    let right = tileX;\n\n    while (this.isSupportTile(left - 1, supportY) && !this.isHazardTile(left - 1, tileY)) {\n      left -= 1;\n    }\n    while (this.isSupportTile(right + 1, supportY) && !this.isHazardTile(right + 1, tileY)) {\n      right += 1;\n    }\n\n    return {\n      minX: left * TILE + TILE / 2,\n      maxX: right * TILE + TILE / 2,\n    };\n  }\n\n  updateEnemyPatrol(enemy, now) {\n    if (!enemy.active) return;\n\n    let speed = enemy.getData(\"patrolSpeed\");\n    let dir = enemy.getData(\"direction\");\n    if (!dir) dir = enemy.body.velocity.x >= 0 ? 1 : -1;\n    const minX = enemy.getData(\"patrolMinX\");\n    const maxX = enemy.getData(\"patrolMaxX\");\n    const useBounded = !!enemy.getData(\"useBoundedPatrol\");\n    const turnCooldownUntil = enemy.getData(\"turnCooldownUntil\") || 0;\n    const grounded = enemy.body.blocked.down || enemy.body.touching.down;\n    const enemyType = enemy.getData(\"enemyType\") || \"E\";\n    const closeX = Math.abs(enemy.x - this.player.x) < (enemyType === \"G\" ? 260 : 190);\n    const closeY = Math.abs(enemy.y - this.player.y) < 70;\n    const aggressive = closeX && closeY;\n    let aiState = enemy.getData(\"aiState\") || \"patrol\";\n    let stateUntil = enemy.getData(\"stateUntil\") || 0;\n    let attackCooldownUntil = enemy.getData(\"attackCooldownUntil\") || 0;\n\n    if (aggressive) {\n      dir = this.player.x >= enemy.x ? 1 : -1;\n      const mult = enemyType === \"G\" ? 2.3 : (enemyType === \"H\" ? 1.55 : 1.8);\n      speed *= mult;\n      enemy.setTint(0xf87171);\n    } else {\n      enemy.clearTint();\n    }\n\n    if ((enemyType === \"G\" || enemyType === \"H\") && aggressive && grounded) {\n      if (aiState === \"patrol\" && now >= attackCooldownUntil) {\n        aiState = \"windup\";\n        stateUntil = now + (enemyType === \"G\" ? 210 : 280);\n      } else if (aiState === \"windup\" && now >= stateUntil) {\n        aiState = \"lunge\";\n        stateUntil = now + (enemyType === \"G\" ? 280 : 220);\n        dir = this.player.x >= enemy.x ? 1 : -1;\n      } else if (aiState === \"lunge\" && now >= stateUntil) {\n        aiState = \"recover\";\n        stateUntil = now + 240;\n        attackCooldownUntil = now + (enemyType === \"G\" ? 900 : 1200);\n      } else if (aiState === \"recover\" && now >= stateUntil) {\n        aiState = \"patrol\";\n      }\n    } else if (!aggressive && aiState !== \"patrol\") {\n      aiState = \"patrol\";\n    }\n\n    if (aiState === \"windup\") {\n      speed = 0;\n      enemy.setTint(0xfacc15);\n    } else if (aiState === \"lunge\") {\n      const burst = enemyType === \"G\" ? 3.2 : 2.5;\n      speed *= burst;\n      enemy.setTint(0xfb7185);\n    }\n\n    if (enemyType === \"F\" && grounded) {\n      const nextJumpAt = enemy.getData(\"nextJumpAt\") || 0;\n      if (now >= nextJumpAt) {\n        enemy.setVelocityY(-260);\n        enemy.setData(\"nextJumpAt\", now + 1150);\n      }\n    }\n\n    const hitLeft = enemy.body.blocked.left || enemy.body.touching.left;\n    const hitRight = enemy.body.blocked.right || enemy.body.touching.right;\n\n    if (hitLeft) {\n      dir = 1;\n      enemy.x += 1.5;\n    }\n    if (hitRight) {\n      dir = -1;\n      enemy.x -= 1.5;\n    }\n\n    if (useBounded) {\n      if (enemy.x <= minX + 2) {\n        dir = 1;\n      } else if (enemy.x >= maxX - 2) {\n        dir = -1;\n      }\n    }\n\n    if (grounded) {\n      const aheadX = enemy.x + dir * (enemy.body.width / 2 + 8);\n      const footY = enemy.body.bottom + 6;\n      const noGroundAhead = !this.hasSupportAtWorld(aheadX, footY);\n      const hazardAhead = this.isHazardAtWorld(aheadX, footY - 10);\n      if ((!useBounded && noGroundAhead) || hazardAhead) {\n        if (now >= turnCooldownUntil) {\n          dir *= -1;\n          enemy.setData(\"turnCooldownUntil\", now + 160);\n          enemy.x += dir * 4;\n        }\n      }\n    }\n\n    if (!grounded && !useBounded) {\n      const fallbackAheadX = enemy.x + dir * (enemy.body.width / 2 + 5);\n      const fallbackFootY = enemy.body.bottom + 10;\n      if (!this.hasSupportAtWorld(fallbackAheadX, fallbackFootY) && now >= turnCooldownUntil) {\n        dir *= -1;\n        enemy.setData(\"turnCooldownUntil\", now + 160);\n      }\n    }\n\n    enemy.setData(\"direction\", dir);\n    enemy.setVelocityX(dir * speed);\n    enemy.setData(\"isAggressive\", aggressive);\n    enemy.setData(\"aiState\", aiState);\n    enemy.setData(\"stateUntil\", stateUntil);\n    enemy.setData(\"attackCooldownUntil\", attackCooldownUntil);\n\n    // Stuck recovery: if enemy is grounded and not advancing, hop out of cracks.\n    const lastX = enemy.getData(\"lastX\");\n    let stuckSince = enemy.getData(\"stuckSince\") || now;\n    const moved = Math.abs(enemy.x - lastX) > 2;\n    if (moved) {\n      stuckSince = now;\n    }\n\n    if (grounded && !moved && Math.abs(enemy.body.velocity.x) < 14) {\n      if (now - stuckSince > 320) {\n        const jumpY = enemyType === \"H\" ? -210 : -260;\n        enemy.setVelocityY(jumpY);\n        dir *= -1;\n        enemy.setData(\"direction\", dir);\n        enemy.setVelocityX(dir * speed);\n        stuckSince = now;\n      }\n    }\n\n    enemy.setData(\"lastX\", enemy.x);\n    enemy.setData(\"stuckSince\", stuckSince);\n  }\n\n  showToast(message, color = 0xfef3c7) {\n    this.game.events.emit(\"toast-message\", { text: message, color });\n    if (Platformer.Debug) Platformer.Debug.log(\"GameScene.toast\", message);\n  }\n\n  applyCoinMilestoneReward(totalCoins) {\n    if (this.coinRewardState[totalCoins]) return;\n\n    if (totalCoins === 3) {\n      const before = this.registry.get(\"health\") || 0;\n      const after = Math.min(3, before + 1);\n      if (after > before) {\n        this.registry.set(\"health\", after);\n        this.showToast(\"Reward: +1 Health\", 0x86efac);\n      } else {\n        this.showToast(\"Reward: Health already full\", 0xbbf7d0);\n      }\n      this.coinRewardState[totalCoins] = true;\n      this.events.emit(\"hud-update\");\n      this.updatePlayerHealthBar();\n      return;\n    }\n\n    if (totalCoins === 6) {\n      this.levelTimeRemainingMs += 12000;\n      const secondsLeft = Math.ceil(this.levelTimeRemainingMs / 1000);\n      this.registry.set(\"timeLeft\", secondsLeft);\n      this.showToast(\"Reward: +12s Time\", 0x93c5fd);\n      this.coinRewardState[totalCoins] = true;\n      this.events.emit(\"hud-update\");\n      return;\n    }\n\n    if (totalCoins === 9) {\n      this.shieldCharges += 1;\n      this.registry.set(\"shield\", this.shieldCharges);\n      this.showToast(\"Reward: Shield x1\", 0xc4b5fd);\n      this.coinRewardState[totalCoins] = true;\n      this.events.emit(\"hud-update\");\n    }\n  }\n\n  tryStartDash(now, moveLeft, moveRight) {\n    const PLAYER = this.playerTuning || Platformer.Config.PLAYER;\n    const grounded = this.player.body.blocked.down || this.player.body.touching.down;\n    const canDash = now - this.lastDashAt >= PLAYER.dashCooldownMs;\n    if (!canDash || this.isDashing) return false;\n\n    let dir = this.facingDir || 1;\n    if (moveLeft && !moveRight) dir = -1;\n    if (moveRight && !moveLeft) dir = 1;\n\n    this.isDashing = true;\n    this.lastDashAt = now;\n    this.dashEndsAt = now + PLAYER.dashDurationMs;\n    this.player.setDragX(0);\n    this.player.setAccelerationX(0);\n    this.player.setVelocityX(dir * PLAYER.dashSpeed);\n    if (!grounded && this.player.body.velocity.y > 30) {\n      this.player.setVelocityY(30);\n    }\n    this.player.setTint(0x93c5fd);\n    this.registry.set(\"dashCd\", Math.ceil(PLAYER.dashCooldownMs / 1000));\n    Platformer.beeper.dash();\n    return true;\n  }\n\n  stopDash() {\n    if (!this.isDashing) return;\n    this.isDashing = false;\n    this.player.setDragX((this.playerTuning || Platformer.Config.PLAYER).drag);\n    this.player.clearTint();\n  }\n\n  tryAttack(now) {\n    const PLAYER = this.playerTuning || Platformer.Config.PLAYER;\n    if (now - this.lastAttackAt < PLAYER.attackCooldownMs) return;\n\n    this.lastAttackAt = now;\n    this.attackActiveUntil = now + 120;\n    this.player.setTint(0xfde68a);\n    Platformer.beeper.attack();\n\n    let hits = 0;\n    this.enemies.children.each((enemy) => {\n      if (!enemy || !enemy.active) return;\n      const dx = enemy.x - this.player.x;\n      const dy = Math.abs(enemy.y - this.player.y);\n      const inFront = this.facingDir > 0 ? dx >= -6 : dx <= 6;\n      const inRange = Math.abs(dx) <= PLAYER.attackRange && dy <= 28;\n      if (!inFront || !inRange) return;\n\n      const hp = enemy.getData(\"hp\") || 1;\n      if (hp <= 1) {\n        enemy.disableBody(true, true);\n      } else {\n        enemy.setData(\"hp\", hp - 1);\n        enemy.setTint(0xfca5a5);\n      }\n      hits += 1;\n    });\n\n    if (hits > 0) {\n      this.showToast(`Hit x${hits}`, 0xfef08a);\n    }\n  }\n\n  updateLandingFeedback() {\n    const grounded = this.player.body.blocked.down || this.player.body.touching.down;\n    const currentDownSpeed = Math.max(0, this.player.body.velocity.y);\n    if (!grounded) {\n      this.airbornePeakSpeedY = Math.max(this.airbornePeakSpeedY, currentDownSpeed);\n    } else if (!this.wasGroundedLastFrame) {\n      const impact = this.airbornePeakSpeedY;\n      if (impact > 200) {\n        // Screen shake removed: keep landing audio feedback only.\n        Platformer.beeper.land();\n      }\n      this.airbornePeakSpeedY = 0;\n    }\n    this.wasGroundedLastFrame = grounded;\n  }\n\n  updateAuxHud(now) {\n    if (now - this.lastAuxHudAt < 120) return;\n    this.lastAuxHudAt = now;\n\n    const dashLeft = Math.max(0, (Platformer.Config.PLAYER.dashCooldownMs - (now - this.lastDashAt)) / 1000);\n    this.registry.set(\"dashCd\", dashLeft);\n    this.registry.set(\"shield\", this.shieldCharges);\n    this.registry.set(\"jetpackFuel\", this.jetpackFuelPercent);\n  }\n\n  collectCoin(coin) {\n    coin.disableBody(true, true);\n    const updatedCoins = this.registry.get(\"coins\") + 1;\n    this.registry.set(\"coins\", updatedCoins);\n    Platformer.beeper.coin();\n    this.applyCoinMilestoneReward(updatedCoins);\n    this.events.emit(\"hud-update\");\n\n    if (updatedCoins >= Platformer.Config.WIN_COIN_TARGET && !this.levelComplete) {\n      this.completeLevel();\n    }\n  }\n\n  activateCheckpoint(checkpoint) {\n    if (checkpoint.getData(\"activeCheckpoint\")) {\n      return;\n    }\n\n    this.checkpoints.children.each((cp) => {\n      cp.clearTint();\n      cp.setData(\"activeCheckpoint\", false);\n    });\n\n    checkpoint.setTint(0x22c55e);\n    checkpoint.setData(\"activeCheckpoint\", true);\n    this.respawnPoint.set(checkpoint.x, checkpoint.y - (this.tinyGridMode ? 10 : 20));\n  }\n\n  onHazardHit() {\n    this.applyDamage(this.hazardDamage);\n  }\n\n  handleEnemyContact(enemy) {\n    const PLAYER = this.playerTuning || Platformer.Config.PLAYER;\n\n    if (!enemy.active || this.isDead) {\n      return;\n    }\n\n    if (this.isDashing) {\n      const hp = enemy.getData(\"hp\") || 1;\n      if (hp <= 1) {\n        enemy.disableBody(true, true);\n      } else {\n        enemy.setData(\"hp\", hp - 1);\n      }\n      this.player.setVelocityY(-PLAYER.jumpVelocity * 0.3);\n      this.showToast(\"Dash Break!\", 0x93c5fd);\n      return;\n    }\n\n    const playerBottom = this.player.body.bottom;\n    const enemyTop = enemy.body.top;\n    const isStomp = this.player.body.velocity.y > 40 && playerBottom <= enemyTop + 10;\n\n    if (isStomp) {\n      const hp = enemy.getData(\"hp\") || 1;\n      if (hp <= 1) {\n        enemy.disableBody(true, true);\n      } else {\n        enemy.setData(\"hp\", hp - 1);\n        enemy.setTint(0xfca5a5);\n      }\n      this.player.setVelocityY(-PLAYER.jumpVelocity * 0.55);\n      Platformer.beeper.stomp();\n      return;\n    }\n\n    const enemyType = enemy.getData(\"enemyType\") || \"E\";\n    const aiState = enemy.getData(\"aiState\") || \"patrol\";\n    const contactDamage = (enemyType === \"H\" || aiState === \"lunge\") ? 2 : 1;\n    this.applyDamage(contactDamage);\n  }\n\n  applyDamage(amount = 1) {\n    const PLAYER = this.playerTuning || Platformer.Config.PLAYER;\n    const settings = Platformer.Settings.current;\n\n    const now = this.time.now;\n    const invuln = Math.round(PLAYER.hurtInvulnMs * this.hazardCooldownScale);\n    if (now - this.lastDamageTime < invuln || this.isDead) {\n      return;\n    }\n\n    if (this.shieldCharges > 0) {\n      this.shieldCharges -= 1;\n      this.registry.set(\"shield\", this.shieldCharges);\n      this.lastDamageTime = now;\n      this.player.setTintFill(0xc4b5fd);\n      this.time.delayedCall(90, () => {\n        if (this.player && this.player.active) this.player.clearTint();\n      });\n      this.showToast(\"Shield blocked damage\", 0xc4b5fd);\n      return;\n    }\n\n    this.lastDamageTime = now;\n    const newHealth = this.registry.get(\"health\") - amount;\n    this.registry.set(\"health\", newHealth);\n    this.events.emit(\"hud-update\");\n    this.updatePlayerHealthBar();\n    Platformer.beeper.damage();\n\n    if (newHealth <= 0) {\n      const remainingLives = this.registry.get(\"lives\") - 1;\n      this.registry.set(\"lives\", remainingLives);\n\n      if (remainingLives <= 0) {\n        this.isDead = true;\n        this.game.events.emit(\"game-over\");\n        this.scene.pause();\n        return;\n      }\n\n      this.registry.set(\"health\", 3);\n      this.respawn();\n    } else {\n      this.player.setVelocity(-this.player.body.velocity.x * 0.35, this.tinyGridMode ? -75 : -220);\n      // Screen shake removed entirely.\n    }\n  }\n\n  respawn() {\n    const a11y = Platformer.Settings.current.accessibility;\n    this.player.setPosition(this.respawnPoint.x, this.respawnPoint.y);\n    this.alignPlayerBodyToFeet();\n    this.resolvePlayerEmbedding(\"respawn\");\n    this.player.setVelocity(0, 0);\n    this.player.setAccelerationX(0);\n    this.player.clearTint();\n    this.jumpsUsed = 0;\n    this.isJumpHeld = false;\n    this.isDashing = false;\n    this.attackActiveUntil = 0;\n    this.jetpackActive = false;\n    if (this.jetpack) this.jetpack.reset(true);\n    this.jetpackFuelPercent = this.jetpack ? this.jetpack.fuelPercent : 100;\n    this.registry.set(\"jetpackFuel\", this.jetpackFuelPercent);\n    this.player.setAccelerationY(0);\n    this.player.body.setGravityY(0);\n    if (this.jetpackFlame) this.jetpackFlame.setVisible(false);\n    if (!a11y.flashReduction) {\n      this.cameras.main.flash(120, 255, 255, 255);\n    }\n    this.updatePlayerHealthBar();\n    this.events.emit(\"hud-update\");\n  }\n\n  completeLevel() {\n    const a11y = Platformer.Settings.current.accessibility;\n    const timeLeft = Number(this.registry.get(\"timeLeft\") || 0);\n    const coins = Number(this.registry.get(\"coins\") || 0);\n    const payload = {\n      nodeId: this.currentNodeId,\n      worldId: this.currentWorldId,\n      level: this.registry.get(\"level\"),\n      coins,\n      timeLeft,\n      targetCoins: Platformer.Config.WIN_COIN_TARGET,\n    };\n\n    this.levelComplete = true;\n    this.player.setAccelerationX(0);\n    this.player.setVelocity(0, this.tinyGridMode ? -52 : -140);\n    this.jetpackActive = false;\n    if (this.jetpack) this.jetpack.reset(false);\n    this.jetpackFuelPercent = this.jetpack ? this.jetpack.fuelPercent : this.jetpackFuelPercent;\n    this.player.setAccelerationY(0);\n    this.player.body.setGravityY(0);\n    if (this.jetpackFlame) this.jetpackFlame.setVisible(false);\n    this.player.setTexture(\"player-run-1\");\n    this.player.setTint(0xfef08a);\n    this.physics.world.pause();\n    const baseZoom = this.cameras.main ? this.cameras.main.zoom : 1;\n    const targetZoom = this.tinyGridMode\n      ? baseZoom * (a11y.reducedMotion ? 1.01 : 1.05)\n      : (a11y.reducedMotion ? 1.02 : 1.15);\n    this.cameras.main.zoomTo(targetZoom, a11y.reducedMotion ? 220 : 550, \"Quad.easeOut\", true);\n    if (!a11y.flashReduction) {\n      this.cameras.main.flash(200, 255, 255, 255);\n    }\n    if (Platformer.Progress && typeof Platformer.Progress.markLevelCompleted === \"function\") {\n      try {\n        const resolvedNodeId = Platformer.Progress.markLevelCompleted(payload);\n        payload.resolvedNodeId = resolvedNodeId;\n      } catch (err) {\n        if (Platformer.Debug) {\n          Platformer.Debug.error(\"GameScene.completeLevel\", err && err.stack ? err.stack : String(err));\n        }\n      }\n    }\n\n    this.game.events.emit(\"level-complete\", payload);\n  }\n\n  update() {\n    const PLAYER = this.playerTuning || Platformer.Config.PLAYER;\n    const { WIN_COIN_TARGET } = Platformer.Config;\n\n    if (!this.player || this.isDead || this.levelComplete) {\n      return;\n    }\n\n    const now = this.time.now;\n    if (now - this.diagLastAt >= 450) {\n      this.diagLastAt = now;\n      this.runRuntimeDiagnostics(now);\n    }\n    this.updateLevelTimer(now);\n    this.spawnHazardProjectiles(now);\n    this.updateProjectiles();\n    this.updatePlayerHealthBar();\n    const moveLeft = this.keys.left.isDown || this.cursors.left.isDown;\n    const moveRight = this.keys.right.isDown || this.cursors.right.isDown;\n    const jumpPressed = Phaser.Input.Keyboard.JustDown(this.cursors.up)\n      || Phaser.Input.Keyboard.JustDown(this.cursors.space)\n      || Phaser.Input.Keyboard.JustDown(this.keys.jump);\n    const dashPressed = Phaser.Input.Keyboard.JustDown(this.keys.dash);\n    const attackPressed = Phaser.Input.Keyboard.JustDown(this.keys.attack);\n    const demoWinPressed = Phaser.Input.Keyboard.JustDown(this.keys.demoWin);\n    const grounded = this.player.body.blocked.down || this.player.body.touching.down;\n    const jumpHeld = this.cursors.up.isDown || this.cursors.space.isDown || this.keys.jump.isDown;\n    // Jetpack thrust is explicit: hold SPACE only.\n    const jetpackInputHeld = !grounded && (\n      this.cursors.space.isDown\n      || (this.keys.jetpack && this.keys.jetpack.isDown)\n    );\n    const dt = Math.max(0.001, this.game.loop.delta / 1000);\n\n    if (demoWinPressed && !this.levelComplete) {\n      this.registry.set(\"coins\", WIN_COIN_TARGET);\n      this.events.emit(\"hud-update\");\n      this.completeLevel();\n      return;\n    }\n\n    if (grounded) {\n      this.lastOnGroundTime = now;\n      this.jumpsUsed = 0;\n    }\n\n    if (jumpPressed) {\n      this.lastJumpPressedTime = now;\n    }\n\n    const canUseCoyote = now - this.lastOnGroundTime <= PLAYER.coyoteTimeMs;\n    const hasBufferedJump = now - this.lastJumpPressedTime <= PLAYER.jumpBufferMs;\n\n    // Prevent mid-air jump velocity resets: coyote jump is only valid before first jump is consumed.\n    if (!this.isDashing && this.jumpsUsed === 0 && canUseCoyote && hasBufferedJump) {\n      this.player.setVelocityY(-PLAYER.jumpVelocity);\n      this.jumpsUsed = 1;\n      this.lastOnGroundTime = -9999;\n      this.lastJumpPressedTime = -9999;\n      this.isJumpHeld = true;\n      Platformer.beeper.jump();\n    }\n    const jetpackStatus = this.jetpack\n      ? this.jetpack.update({\n        scene: this,\n        player: this.player,\n        now,\n        dt,\n        grounded,\n        jumpHeld,\n        thrustHeld: jetpackInputHeld,\n        worldGravity: PLAYER.gravity,\n        jumpVelocity: PLAYER.jumpVelocity,\n      })\n      : { isThrusting: false, fuelPercent: 0 };\n    this.jetpackActive = !!jetpackStatus.isThrusting;\n    this.jetpackFuelPercent = Phaser.Math.Clamp(Number(jetpackStatus.fuelPercent || 0), 0, 100);\n    if (this.jetpackActive) {\n      this.isJumpHeld = false;\n    }\n\n    // Safety clamp: prevent rare vertical-speed spikes from interactions/stacked forces.\n    const maxRiseSpeed = Math.max(120, Number(PLAYER.maxRiseSpeed || 520));\n    const maxFallSpeed = Math.max(200, Number(PLAYER.maxFallSpeed || 760));\n    if (this.player.body.velocity.y < -maxRiseSpeed) {\n      this.player.setVelocityY(-maxRiseSpeed);\n    } else if (this.player.body.velocity.y > maxFallSpeed) {\n      this.player.setVelocityY(maxFallSpeed);\n    }\n\n    if (!this.isDashing && !jumpHeld && this.isJumpHeld && this.player.body.velocity.y < -120) {\n      this.player.setVelocityY(this.player.body.velocity.y * 0.5);\n      this.isJumpHeld = false;\n    }\n\n    if (dashPressed) {\n      this.tryStartDash(now, moveLeft, moveRight);\n    }\n    if (attackPressed) {\n      this.tryAttack(now);\n    }\n\n    const opposingInput = moveLeft && moveRight;\n\n    if (this.isDashing) {\n      const dashDir = this.player.body.velocity.x >= 0 ? 1 : -1;\n      this.player.setVelocityX(dashDir * PLAYER.dashSpeed);\n      this.player.setAccelerationX(0);\n      this.player.setDragX(0);\n      if (now >= this.dashEndsAt) {\n        this.stopDash();\n      }\n    } else {\n      const moveSpeed = grounded ? PLAYER.maxSpeed : Math.floor(PLAYER.maxSpeed * 0.9);\n      this.player.setAccelerationX(0);\n      this.player.setDragX(0);\n\n      if (opposingInput || (!moveLeft && !moveRight)) {\n        // Digital stop: no inertia, no glide, no opposite-key slide.\n        this.player.setVelocityX(0);\n        if (this.player.body) this.player.body.velocity.x = 0;\n      } else if (moveLeft) {\n        this.player.setVelocityX(-moveSpeed);\n        this.player.setFlipX(false);\n        this.facingDir = -1;\n      } else if (moveRight) {\n        this.player.setVelocityX(moveSpeed);\n        this.player.setFlipX(true);\n        this.facingDir = 1;\n      }\n    }\n    if (this.tinyGridMode && this.player && this.player.body) {\n      const body = this.player.body;\n      if ((body.blocked.left && moveLeft && !moveRight) || (body.blocked.right && moveRight && !moveLeft)) {\n        this.player.setVelocityX(0);\n      }\n      if (body.embedded) {\n        this.resolvePlayerEmbedding(\"runtime\");\n      }\n    }\n    this.resolveGroundPenetration(now);\n    this.logIfPlayerInsideTile(now);\n    this.drawHitboxOverlay(now);\n    if (!this.isDashing && now > this.attackActiveUntil) {\n      this.player.clearTint();\n    }\n\n    this.updateJetpackFx(now, this.jetpackActive);\n\n    if (this.useImportedCharacter) {\n      if (!grounded) {\n        if (this.player.anims && this.player.anims.isPlaying) {\n          this.player.anims.stop();\n        }\n        if (this.player.texture && this.player.texture.key === \"player-idle-sheet\") {\n          const airborneFrame = this.jetpackActive ? ((Math.floor(now / 90) % 2 === 0) ? 1 : 2) : 2;\n          this.player.setFrame(airborneFrame);\n        }\n      } else if (this.anims.exists(\"playerIdleAnim\")) {\n        if (!this.player.anims.isPlaying || this.player.anims.getName() !== \"playerIdleAnim\") {\n          this.player.setTexture(\"player-idle-sheet\", 0);\n          this.player.play(\"playerIdleAnim\");\n        }\n      } else {\n        if (!this.idleAnimWarned && Platformer.Debug) {\n          Platformer.Debug.warn(\"GameScene.playerIdle\", \"playerIdleAnim not found; fallback idle in use.\");\n          this.idleAnimWarned = true;\n        }\n        this.player.setTexture((Math.floor(now / 360) % 2 === 0) ? \"player-idle-1\" : \"player-idle-2\");\n      }\n    } else if (this.jetpackActive || this.player.body.velocity.y < (this.tinyGridMode ? -8 : -25) || !this.player.body.blocked.down) {\n      if (this.player.anims && this.player.anims.isPlaying) {\n        this.player.anims.stop();\n      }\n      this.player.setTexture(\"player-jump\");\n    } else if (Math.abs(this.player.body.velocity.x) > (this.tinyGridMode ? 10 : 35)) {\n      if (this.player.anims && this.player.anims.isPlaying) {\n        this.player.anims.stop();\n      }\n      this.player.setTexture((Math.floor(now / 100) % 2 === 0) ? \"player-run-1\" : \"player-run-2\");\n    } else {\n      this.player.setTexture((Math.floor(now / 360) % 2 === 0) ? \"player-idle-1\" : \"player-idle-2\");\n    }\n\n    let anyAggressive = false;\n    this.enemies.children.each((enemy) => {\n      this.updateEnemyPatrol(enemy, now);\n      if (enemy.getData(\"isAggressive\")) {\n        anyAggressive = true;\n      }\n    });\n    const projectileThreat = this.hazardProjectiles && this.hazardProjectiles.countActive(true) > 0;\n    const threat = anyAggressive || projectileThreat;\n    if (threat !== this.threatActive) {\n      this.threatActive = threat;\n      this.registry.set(\"threat\", threat ? \"DANGER\" : \"CALM\");\n    }\n    this.updateLandingFeedback();\n    this.updateAuxHud(now);\n\n    if (this.player.y > this.mapHeight * Platformer.Config.TILE + 140) {\n      this.applyDamage();\n      if (!this.isDead) {\n        this.respawn();\n      }\n    }\n  }\n\n  shutdown() {\n    if (this.onRestartLevel) {\n      this.game.events.off(\"restart-level\", this.onRestartLevel);\n      this.onRestartLevel = null;\n    }\n    if (this.onSettingsChanged) {\n      this.game.events.off(\"settings-changed\", this.onSettingsChanged);\n      this.onSettingsChanged = null;\n    }\n    this.scale.off(\"resize\", this.updateCameraFraming, this);\n    if (this.jetpackFlame && this.jetpackFlame.destroy) {\n      this.jetpackFlame.destroy();\n      this.jetpackFlame = null;\n    }\n    if (this.onHitboxesToggle) {\n      window.removeEventListener(\"platformer:hitboxes-toggle\", this.onHitboxesToggle);\n      this.onHitboxesToggle = null;\n    }\n    if (this.onPlayerHitboxChanged) {\n      window.removeEventListener(\"platformer:player-hitbox-changed\", this.onPlayerHitboxChanged);\n      this.onPlayerHitboxChanged = null;\n    }\n    if (this.hitboxOverlay && this.hitboxOverlay.destroy) {\n      this.hitboxOverlay.destroy();\n      this.hitboxOverlay = null;\n    }\n    if (Array.isArray(this.ldtkVisualTiles) && this.ldtkVisualTiles.length) {\n      this.ldtkVisualTiles.forEach((o) => { if (o && o.destroy) o.destroy(); });\n      this.ldtkVisualTiles = [];\n    }\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.UIScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"UIScene\");\n    this.hudText = null;\n    this.pauseText = null;\n    this.gameOverText = null;\n    this.victoryText = null;\n    this.victorySubText = null;\n    this.victoryBars = [];\n    this.victorySpeedLines = [];\n    this.victoryCharacter = null;\n    this.transitionText = null;\n    this.toastText = null;\n    this.toastTween = null;\n    this.pausePanel = null;\n    this.pauseButtons = [];\n    this.pauseMusic = null;\n    this.pauseMusicHtml = null;\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n    this.onRegistryChanged = null;\n    this.gamePaused = false;\n    this.gameOver = false;\n    this.levelComplete = false;\n    this.onPauseKey = null;\n    this.onRestartKey = null;\n    this.onEnterKey = null;\n    this.onGameOver = null;\n    this.onLevelComplete = null;\n    this.onLevelTransition = null;\n    this.onOptionsClosed = null;\n    this.onToastMessage = null;\n    this.pauseKeyEventName = null;\n    this.lastLevelCompletePayload = null;\n    this.jetpackFuelBg = null;\n    this.jetpackFuelFill = null;\n    this.jetpackFuelLabel = null;\n    this.onResize = null;\n  }\n\n  init() {\n    // Register pause key early so it's ready before GameScene becomes interactive\n    const pauseKey = Platformer.Settings.current.controls.pause || \"ESC\";\n    this.pauseKeyEventName = `keydown-${pauseKey}`;\n  }\n\n  create() {\n    const textScale = Platformer.Settings.textScale();\n\n    this.hudText = this.add.text(16, 14, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(20 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#111827\",\n      strokeThickness: 4,\n    }).setScrollFactor(0);\n    this.jetpackFuelLabel = this.add.text(16, 46, \"Jetpack\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(16 * textScale)}px`,\n      color: \"#bfdbfe\",\n      stroke: \"#111827\",\n      strokeThickness: 3,\n    }).setScrollFactor(0);\n    this.jetpackFuelBg = this.add.rectangle(102, 58, 172, 12, 0x111827, 0.92)\n      .setOrigin(0, 0.5)\n      .setScrollFactor(0)\n      .setStrokeStyle(1, 0x93c5fd, 0.85);\n    this.jetpackFuelFill = this.add.rectangle(104, 58, 168, 8, 0x22d3ee, 1)\n      .setOrigin(0, 0.5)\n      .setScrollFactor(0);\n\n    this.pauseText = this.add.text(this.scale.width / 2, this.scale.height / 2, \"PAUSED\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(56 * textScale)}px`,\n      color: \"#fcd34d\",\n      stroke: \"#1f2937\",\n      strokeThickness: 6,\n    }).setOrigin(0.5).setScrollFactor(0).setVisible(false);\n    this.buildPauseMenu(textScale);\n\n    this.gameOverText = this.add.text(this.scale.width / 2, this.scale.height / 2,\n      \"GAME OVER\\nPress R to Restart\", {\n        fontFamily: \"Verdana\",\n        fontSize: `${Math.round(44 * textScale)}px`,\n        color: \"#fca5a5\",\n        align: \"center\",\n        stroke: \"#1f2937\",\n        strokeThickness: 6,\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false);\n\n    this.victoryText = this.add.text(this.scale.width / 2, this.scale.height / 2 - 24,\n      \"MISSION CLEAR!\", {\n        fontFamily: \"Impact, Haettenschweiler, Arial Narrow Bold, sans-serif\",\n        fontSize: `${Math.round(74 * textScale)}px`,\n        color: \"#fde047\",\n        stroke: \"#7f1d1d\",\n        strokeThickness: 12,\n        shadow: { offsetX: 0, offsetY: 0, color: \"#000000\", blur: 10, fill: true },\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false).setAlpha(0);\n\n    this.victorySubText = this.add.text(this.scale.width / 2, this.scale.height / 2 + 52,\n      \"Coins Secured. Press ENTER for World Map\", {\n        fontFamily: \"Consolas\",\n        fontSize: `${Math.round(26 * textScale)}px`,\n        color: \"#f8fafc\",\n        stroke: \"#111827\",\n        strokeThickness: 6,\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false).setAlpha(0);\n\n    this.transitionText = this.add.text(this.scale.width / 2, this.scale.height / 2,\n      \"\", {\n        fontFamily: \"Verdana\",\n        fontSize: `${Math.round(46 * textScale)}px`,\n        color: \"#fef08a\",\n        stroke: \"#1f2937\",\n        strokeThickness: 7,\n        align: \"center\",\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false).setDepth(120);\n\n    this.toastText = this.add.text(this.scale.width / 2, 74, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(24 * textScale)}px`,\n      color: \"#fef3c7\",\n      stroke: \"#111827\",\n      strokeThickness: 5,\n      align: \"center\",\n    }).setOrigin(0.5).setScrollFactor(0).setVisible(false).setDepth(130);\n\n    this.createVictoryFX();\n    this.layoutHud();\n    this.layoutPauseMenu();\n    this.updateHud();\n\n    this.onRegistryChanged = () => this.updateHud();\n    this.registry.events.on(\"changedata\", this.onRegistryChanged);\n\n    this.onGameOver = () => {\n      this.gameOver = true;\n      if (Platformer.Debug) Platformer.Debug.warn(\"UIScene\", \"Game over shown.\");\n      this.gameOverText.setVisible(true);\n      this.hidePauseMenu();\n    };\n    this.game.events.on(\"game-over\", this.onGameOver);\n\n    this.onLevelComplete = (payload) => {\n      this.levelComplete = true;\n      this.lastLevelCompletePayload = payload || null;\n      if (Platformer.Debug) Platformer.Debug.log(\"UIScene\", \"Level complete overlay shown.\");\n      this.hidePauseMenu();\n      this.showVictorySequence();\n    };\n    this.game.events.on(\"level-complete\", this.onLevelComplete);\n\n    this.onLevelTransition = (payload) => {\n      this.hidePauseMenu();\n      this.showLevelTransition(payload);\n    };\n    this.game.events.on(\"level-transition\", this.onLevelTransition);\n\n    this.onOptionsClosed = () => {\n      if (!this.gameOver && !this.levelComplete && this.scene.isPaused(\"GameScene\")) {\n        this.showPauseMenu();\n      }\n    };\n    this.game.events.on(\"options-closed-to-pause\", this.onOptionsClosed);\n\n    this.onToastMessage = (payload) => this.showToast(payload);\n    this.game.events.on(\"toast-message\", this.onToastMessage);\n\n    this.onPauseKey = () => {\n      if (this.scene.isActive(\"OptionsScene\")) return;\n      if (this.gameOver || this.levelComplete) return;\n      this.togglePauseMenu();\n    };\n    this.input.keyboard.on(this.pauseKeyEventName, this.onPauseKey);\n\n    this.onRestartKey = () => {\n      if (!this.gameOver) return;\n      this.gameOver = false;\n      this.gamePaused = false;\n      this.gameOverText.setVisible(false);\n      this.hidePauseMenu();\n      this.game.events.emit(\"restart-level\");\n    };\n    this.input.keyboard.on(\"keydown-R\", this.onRestartKey);\n\n    this.onEnterKey = () => {\n      if (!this.levelComplete) return;\n      this.levelComplete = false;\n      this.resetOverlayStates();\n      this.stopGameplayMusic();\n      this.scene.stop(\"GameScene\");\n      this.scene.stop();\n      const focusNodeId = this.lastLevelCompletePayload && (this.lastLevelCompletePayload.resolvedNodeId || this.lastLevelCompletePayload.nodeId);\n      this.scene.start(\"WorldMapScene\", { focusNodeId: focusNodeId || null });\n    };\n    this.input.keyboard.on(\"keydown-ENTER\", this.onEnterKey);\n\n    this.onResize = () => {\n      this.layoutHud();\n      this.layoutPauseMenu();\n    };\n    this.scale.on(\"resize\", this.onResize);\n  }\n\n  layoutHud() {\n    if (this.hudText) this.hudText.setPosition(16, 14);\n    if (this.jetpackFuelLabel) this.jetpackFuelLabel.setPosition(16, 46);\n    if (this.jetpackFuelBg) this.jetpackFuelBg.setPosition(102, 58);\n    if (this.jetpackFuelFill) this.jetpackFuelFill.setPosition(104, 58);\n  }\n\n  buildPauseMenu(textScale) {\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n\n    this.pausePanel = this.add.rectangle(cx, cy, 560, 340, 0x020617, 0.86)\n      .setStrokeStyle(2, 0x94a3b8, 0.8)\n      .setScrollFactor(0)\n      .setVisible(false)\n      .setDepth(100);\n\n    this.pauseText.setDepth(101);\n    this.pauseText.setY(cy - 118);\n\n    const createBtn = (y, label, onClick) => {\n      const offsetY = y - cy;\n      const box = this.add.rectangle(cx, y, 280, 50, 0x1d4ed8, 0.96)\n        .setStrokeStyle(2, 0x93c5fd, 0.9)\n        .setDepth(101)\n        .setScrollFactor(0)\n        .setVisible(false)\n        .setInteractive({ useHandCursor: true });\n      const text = this.add.text(cx, y, label, {\n        fontFamily: \"Consolas\",\n        fontSize: `${Math.round(28 * textScale)}px`,\n        color: \"#f8fafc\",\n      }).setOrigin(0.5).setDepth(102).setScrollFactor(0).setVisible(false);\n\n      box.on(\"pointerover\", () => box.setFillStyle(0x2563eb, 0.98));\n      box.on(\"pointerout\", () => box.setFillStyle(0x1d4ed8, 0.96));\n      box.on(\"pointerdown\", onClick);\n\n      this.pauseButtons.push({ box, text, offsetY, label });\n    };\n\n    createBtn(cy - 30, \"Resume\", () => this.resumeFromPause());\n    createBtn(cy + 35, \"Options\", () => {\n      this.hidePauseMenu();\n      this.scene.launch(\"OptionsScene\", { returnTo: \"pause\" });\n    });\n    createBtn(cy + 100, \"Return to Menu\", () => {\n      if (Platformer.Debug) Platformer.Debug.warn(\"UIScene.pause\", \"Return to Menu clicked.\");\n      this.stopPauseMusic();\n      this.stopGameplayMusic();\n      this.hidePauseMenu();\n      this.scene.stop(\"GameScene\");\n      if (this.scene.isActive(\"OptionsScene\")) this.scene.stop(\"OptionsScene\");\n      this.scene.stop();\n      this.scene.start(\"MenuScene\");\n    });\n  }\n\n  layoutPauseMenu() {\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n    if (this.pausePanel) this.pausePanel.setPosition(cx, cy);\n    if (this.pauseText) this.pauseText.setPosition(cx, cy - 118);\n    this.pauseButtons.forEach((b) => {\n      if (!b) return;\n      const targetY = cy + (Number.isFinite(b.offsetY) ? b.offsetY : 0);\n      if (b.box) b.box.setPosition(cx, targetY);\n      if (b.text) b.text.setPosition(cx, targetY);\n    });\n    if (this.gameOverText) this.gameOverText.setPosition(cx, cy);\n    if (this.transitionText) this.transitionText.setPosition(cx, cy);\n    if (this.toastText) this.toastText.setPosition(cx, 74);\n    if (this.victoryText) this.victoryText.setPosition(cx, cy - 24);\n    if (this.victorySubText) this.victorySubText.setPosition(cx, cy + 52);\n  }\n\n  showPauseMenu() {\n    if (Platformer.Debug) Platformer.Debug.log(\"UIScene.pause\", \"Pause menu opened.\");\n    this.layoutPauseMenu();\n    this.pauseGameplayMusic();\n    this.playPauseMusic();\n    this.pausePanel.setVisible(true);\n    this.pauseText.setVisible(true);\n    this.pauseButtons.forEach((b) => {\n      b.box.setVisible(true);\n      b.text.setVisible(true);\n    });\n    if (Platformer.Debug) {\n      try {\n        const ys = this.pauseButtons.map((b) => (b && b.box ? Math.round(b.box.y) : -1)).filter((y) => y >= 0);\n        const sorted = ys.slice().sort((a, b) => a - b);\n        const minGap = sorted.length > 1 ? Math.min(...sorted.slice(1).map((v, i) => v - sorted[i])) : 999;\n        Platformer.Debug.log(\"UIScene.pause\", `buttonYs=${ys.join(\",\")} minGap=${minGap}`);\n        if (minGap < 28) {\n          Platformer.Debug.warn(\"UIScene.pause.layout\", \"Pause buttons are too close/overlapping after layout.\");\n        }\n      } catch (err) {\n        Platformer.Debug.warn(\"UIScene.pause.layout\", `Diagnostics failed: ${err && err.message ? err.message : err}`);\n      }\n    }\n    this.gamePaused = true;\n  }\n\n  hidePauseMenu() {\n    if (this.pausePanel) this.pausePanel.setVisible(false);\n    this.pauseText.setVisible(false);\n    this.pauseButtons.forEach((b) => {\n      b.box.setVisible(false);\n      b.text.setVisible(false);\n    });\n    this.gamePaused = false;\n  }\n\n  togglePauseMenu() {\n    if (this.scene.isPaused(\"GameScene\")) {\n      this.resumeFromPause();\n    } else {\n      this.scene.pause(\"GameScene\");\n      this.showPauseMenu();\n    }\n  }\n\n  resumeFromPause() {\n    if (Platformer.Debug) Platformer.Debug.log(\"UIScene.pause\", \"Resuming gameplay from pause.\");\n    this.stopPauseMusic();\n    this.resumeGameplayMusic();\n    this.scene.resume(\"GameScene\");\n    this.hidePauseMenu();\n  }\n\n  pauseGameplayMusic() {\n    if (Platformer.gameMusic && Platformer.gameMusic.isPlaying) {\n      try {\n        Platformer.gameMusic.pause();\n        this.resumePhaserGameMusic = true;\n      } catch (_e) {\n        // Ignore; best effort.\n      }\n    }\n\n    if (Platformer.gameMusicHtml && !Platformer.gameMusicHtml.paused) {\n      try {\n        Platformer.gameMusicHtml.pause();\n        this.resumeHtmlGameMusic = true;\n      } catch (_e) {\n        // Ignore; best effort.\n      }\n    }\n  }\n\n  resumeGameplayMusic() {\n    if (this.resumePhaserGameMusic && Platformer.gameMusic) {\n      try {\n        Platformer.gameMusic.resume();\n      } catch (_e) {\n        // Ignore; best effort.\n      }\n    }\n\n    if (this.resumeHtmlGameMusic && Platformer.gameMusicHtml) {\n      Platformer.gameMusicHtml.play().catch(() => {});\n    }\n\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n  }\n\n  stopGameplayMusic() {\n    if (Platformer.Debug) Platformer.Debug.log(\"UIScene.audio\", \"Stopping gameplay music for scene transition.\");\n    if (Platformer.gameMusic) {\n      try {\n        if (Platformer.gameMusic.isPlaying) {\n          Platformer.gameMusic.stop();\n        } else if (typeof Platformer.gameMusic.pause === \"function\") {\n          Platformer.gameMusic.pause();\n        }\n      } catch (_e) {\n        // best effort\n      }\n      Platformer.gameMusic = null;\n    }\n    if (Platformer.gameMusicHtml) {\n      try {\n        Platformer.gameMusicHtml.pause();\n        Platformer.gameMusicHtml.currentTime = 0;\n      } catch (_e) {\n        // best effort\n      }\n      Platformer.gameMusicHtml = null;\n    }\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n  }\n\n  playPauseMusic() {\n    const audioSettings = Platformer.Settings.current.audio;\n    const volume = Phaser.Math.Clamp((audioSettings.master / 100) * (audioSettings.music / 100), 0, 1);\n\n    if (this.cache.audio.exists(\"pause-bgm\")) {\n      if (!this.pauseMusic) {\n        this.pauseMusic = this.sound.get(\"pause-bgm\");\n        if (!this.pauseMusic) {\n          try {\n            this.pauseMusic = this.sound.add(\"pause-bgm\", { loop: true, volume });\n          } catch (_e) {\n            this.pauseMusic = null;\n          }\n        }\n      }\n      if (this.pauseMusic) {\n        this.pauseMusic.setLoop(true);\n        this.pauseMusic.setVolume(volume);\n        if (!this.pauseMusic.isPlaying) {\n          try {\n            this.pauseMusic.play();\n          } catch (_e) {\n            // Autoplay gating: user already pressed ESC, so retry on next input if needed.\n          }\n        }\n        return;\n      }\n    }\n\n    // HTML audio fallback.\n    if (!this.pauseMusicHtml) {\n      try {\n        this.pauseMusicHtml = new Audio(\"assets/Elevator Music - So Chill (mp3cut.net).mp3\");\n        Platformer.pauseMusicHtml = this.pauseMusicHtml;\n        this.pauseMusicHtml.loop = true;\n      } catch (_e) {\n        this.pauseMusicHtml = null;\n      }\n    }\n    if (this.pauseMusicHtml) {\n      this.pauseMusicHtml.volume = volume;\n      this.pauseMusicHtml.play().catch(() => {});\n    }\n  }\n\n  stopPauseMusic() {\n    if (this.pauseMusic && this.pauseMusic.isPlaying) {\n      this.pauseMusic.stop();\n    }\n    if (this.pauseMusicHtml) {\n      this.pauseMusicHtml.pause();\n      this.pauseMusicHtml.currentTime = 0;\n      Platformer.pauseMusicHtml = null;\n    }\n  }\n\n  updateHud() {\n    if (!this.hudText || !this.hudText.active) {\n      return;\n    }\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) {\n      return;\n    }\n\n    const lives = this.registry.get(\"lives\");\n    const health = this.registry.get(\"health\");\n    const coins = this.registry.get(\"coins\");\n    const level = this.registry.get(\"level\");\n    const timeLeft = this.registry.get(\"timeLeft\");\n    const threat = this.registry.get(\"threat\");\n    const dashCd = Number(this.registry.get(\"dashCd\") || 0);\n    const shield = Math.max(0, Number(this.registry.get(\"shield\") || 0));\n    const jetpackFuel = Phaser.Math.Clamp(Number(this.registry.get(\"jetpackFuel\") || 0), 0, 100);\n    const { WIN_COIN_TARGET } = Platformer.Config;\n    const dashTxt = dashCd <= 0.06 ? \"READY\" : `${dashCd.toFixed(1)}s`;\n\n    try {\n      this.hudText.setText(\n        `Level: ${level}   Lives: ${Math.max(0, lives)}   Health: ${Math.max(0, health)}   Coins: ${coins}/${WIN_COIN_TARGET}   Time: ${Math.max(0, timeLeft || 0)}   Threat: ${threat || \"CALM\"}   Dash: ${dashTxt}   Shield: ${shield}   Fuel: ${Math.round(jetpackFuel)}%`\n      );\n      if (this.jetpackFuelFill && this.jetpackFuelBg) {\n        const fillW = Math.max(0, Math.round(168 * (jetpackFuel / 100)));\n        this.jetpackFuelFill.width = fillW;\n        const color = jetpackFuel > 60 ? 0x22d3ee : (jetpackFuel > 28 ? 0xf59e0b : 0xef4444);\n        this.jetpackFuelFill.setFillStyle(color, 1);\n      }\n    } catch (err) {\n      const msg = err && err.stack ? err.stack : String(err);\n      if (Platformer.Debug && Platformer.Debug.error) {\n        Platformer.Debug.error(\"UIScene.updateHud\", msg);\n      }\n    }\n  }\n\n  showToast(payload) {\n    if (!payload || !this.toastText) return;\n    const text = String(payload.text || \"\").trim();\n    if (!text) return;\n    const color = payload.color || 0xfef3c7;\n    this.toastText.setText(text);\n    this.toastText.setColor(`#${color.toString(16).padStart(6, \"0\")}`);\n    this.toastText.setAlpha(1);\n    this.toastText.setVisible(true);\n    if (this.toastTween) {\n      this.toastTween.stop();\n      this.toastTween = null;\n    }\n    this.toastTween = this.tweens.add({\n      targets: this.toastText,\n      y: 58,\n      alpha: 0,\n      duration: 900,\n      ease: \"Quad.easeOut\",\n      onComplete: () => {\n        if (this.toastText) {\n          this.toastText.setVisible(false);\n          this.toastText.setY(74);\n        }\n      },\n    });\n  }\n\n  createVictoryFX() {\n    const topBar = this.add.rectangle(this.scale.width / 2, -45, this.scale.width, 90, 0x020617, 0.92)\n      .setScrollFactor(0).setVisible(false);\n    const bottomBar = this.add.rectangle(this.scale.width / 2, this.scale.height + 45, this.scale.width, 90, 0x020617, 0.92)\n      .setScrollFactor(0).setVisible(false);\n    this.victoryBars = [topBar, bottomBar];\n\n    const lineColor = 0xffffff;\n    for (let i = 0; i < 16; i += 1) {\n      const y = 40 + i * 30;\n      const line = this.add.rectangle(-220, y, 190, 4, lineColor, 0.22)\n        .setAngle(-16)\n        .setScrollFactor(0)\n        .setVisible(false);\n      this.victorySpeedLines.push(line);\n    }\n\n    this.victoryCharacter = this.buildVictoryCharacter(this.scale.width - 210, this.scale.height - 210);\n    this.victoryCharacter.setVisible(false).setAlpha(0).setScale(0.8);\n  }\n\n  buildVictoryCharacter(x, y) {\n    const style = [\n      \"width:236px\",\n      \"height:236px\",\n      \"border:4px solid #fde047\",\n      \"background:rgba(15,23,42,0.86)\",\n      \"display:flex\",\n      \"align-items:center\",\n      \"justify-content:center\",\n      \"overflow:hidden\",\n      \"box-sizing:border-box\",\n    ].join(\";\");\n\n    const dom = this.add.dom(x, y, \"div\", style, \"\").setScrollFactor(0);\n    const img = document.createElement(\"img\");\n    img.src = \"./assets/kawaii-anime-girl.gif\";\n    img.alt = \"Victory Girl\";\n    img.style.width = \"220px\";\n    img.style.height = \"220px\";\n    img.style.objectFit = \"cover\";\n    img.onerror = () => {\n      dom.node.innerHTML = \"<span style='font-family:Consolas;color:#f8fafc;font-size:32px'>VICTORY</span>\";\n    };\n    dom.node.appendChild(img);\n\n    return dom;\n  }\n\n  showVictorySequence() {\n    if (this.victoryCharacter) {\n      this.victoryCharacter.destroy();\n    }\n    this.victoryCharacter = this.buildVictoryCharacter(this.scale.width - 210, this.scale.height - 210);\n    this.victoryCharacter.setVisible(false).setAlpha(0).setScale(0.8);\n\n    this.pauseText.setVisible(false);\n    this.gameOverText.setVisible(false);\n    this.victoryBars.forEach((bar) => bar.setVisible(true));\n    this.victorySpeedLines.forEach((line) => line.setVisible(true));\n    this.victoryText.setVisible(true);\n    this.victorySubText.setVisible(true);\n    this.victoryCharacter.setVisible(true);\n\n    this.tweens.add({\n      targets: this.victoryBars[0],\n      y: 40,\n      duration: 320,\n      ease: \"Cubic.easeOut\",\n    });\n    this.tweens.add({\n      targets: this.victoryBars[1],\n      y: this.scale.height - 40,\n      duration: 320,\n      ease: \"Cubic.easeOut\",\n    });\n\n    this.victorySpeedLines.forEach((line, idx) => {\n      line.x = -220 - idx * 36;\n      this.tweens.add({\n        targets: line,\n        x: this.scale.width + 220,\n        duration: 360 + idx * 22,\n        ease: \"Linear\",\n        repeat: -1,\n        delay: idx * 20,\n      });\n    });\n\n    this.tweens.add({\n      targets: this.victoryText,\n      alpha: 1,\n      scaleX: { from: 1.65, to: 1 },\n      scaleY: { from: 0.35, to: 1 },\n      angle: { from: -8, to: 0 },\n      duration: 280,\n      ease: \"Back.easeOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victorySubText,\n      alpha: 1,\n      y: this.victorySubText.y + 10,\n      duration: 240,\n      delay: 180,\n      ease: \"Quad.easeOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victoryText,\n      scale: 1.05,\n      yoyo: true,\n      duration: 620,\n      repeat: -1,\n      ease: \"Sine.easeInOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victoryCharacter,\n      alpha: 1,\n      scale: 1,\n      x: this.scale.width - 196,\n      duration: 300,\n      ease: \"Back.easeOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victoryCharacter,\n      y: this.victoryCharacter.y - 8,\n      yoyo: true,\n      repeat: -1,\n      duration: 900,\n      ease: \"Sine.easeInOut\",\n    });\n  }\n\n  showLevelTransition(payload) {\n    const from = payload && payload.from ? payload.from : \"?\";\n    const to = payload && payload.to ? payload.to : \"?\";\n    this.transitionText\n      .setText(`LEVEL ${from} CLEAR\\\\nNEXT: LEVEL ${to}`)\n      .setVisible(true)\n      .setAlpha(0)\n      .setScale(1.1);\n\n    this.tweens.add({\n      targets: this.transitionText,\n      alpha: 1,\n      scale: 1,\n      duration: 220,\n      yoyo: true,\n      hold: 350,\n      onComplete: () => this.transitionText.setVisible(false),\n    });\n  }\n\n  resetOverlayStates() {\n    this.gameOverText.setVisible(false);\n    this.pauseText.setVisible(false);\n    this.hidePauseMenu();\n    this.stopPauseMusic();\n    this.victoryText.setVisible(false).setAlpha(0).setScale(1).setAngle(0);\n    if (this.transitionText) {\n      this.transitionText.setVisible(false).setAlpha(0).setScale(1);\n    }\n    this.victorySubText.setVisible(false).setAlpha(0).setY(this.scale.height / 2 + 52);\n    this.victoryBars[0].setVisible(false).setY(-45);\n    this.victoryBars[1].setVisible(false).setY(this.scale.height + 45);\n    this.victorySpeedLines.forEach((line) => line.setVisible(false));\n\n    if (this.victoryCharacter) {\n      this.victoryCharacter.setVisible(false).setAlpha(0).setScale(0.8);\n      this.victoryCharacter.setPosition(this.scale.width - 210, this.scale.height - 210);\n    }\n\n    this.tweens.killAll();\n  }\n\n  shutdown() {\n    this.stopPauseMusic();\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n    if (this.toastTween) {\n      this.toastTween.stop();\n      this.toastTween = null;\n    }\n    if (this.onRegistryChanged) {\n      this.registry.events.off(\"changedata\", this.onRegistryChanged);\n      this.onRegistryChanged = null;\n    }\n    if (this.onGameOver) this.game.events.off(\"game-over\", this.onGameOver);\n    if (this.onLevelComplete) this.game.events.off(\"level-complete\", this.onLevelComplete);\n    if (this.onLevelTransition) this.game.events.off(\"level-transition\", this.onLevelTransition);\n    if (this.onOptionsClosed) this.game.events.off(\"options-closed-to-pause\", this.onOptionsClosed);\n    if (this.onToastMessage) this.game.events.off(\"toast-message\", this.onToastMessage);\n    if (this.onPauseKey && this.pauseKeyEventName) this.input.keyboard.off(this.pauseKeyEventName, this.onPauseKey);\n    if (this.onRestartKey) this.input.keyboard.off(\"keydown-R\", this.onRestartKey);\n    if (this.onEnterKey) this.input.keyboard.off(\"keydown-ENTER\", this.onEnterKey);\n    if (this.onResize) this.scale.off(\"resize\", this.onResize);\n    this.onPauseKey = null;\n    this.onRestartKey = null;\n    this.onEnterKey = null;\n    this.onGameOver = null;\n    this.onLevelComplete = null;\n    this.onLevelTransition = null;\n    this.onOptionsClosed = null;\n    this.onToastMessage = null;\n    this.pauseKeyEventName = null;\n    this.onResize = null;\n  }\n};\n","window.Platformer = window.Platformer || {};\n\n(async () => {\n  if (!Platformer.BUILD_VERSION || typeof Platformer.BUILD_VERSION !== \"string\") {\n    document.body.innerHTML = \"<div style='font-family:Consolas,monospace;padding:24px;color:#fee2e2;background:#1f2937'>Build metadata missing. Rebuild the game package.</div>\";\n    throw new Error(\"BUILD_VERSION missing.\");\n  }\n  await Platformer.Settings.bootstrap();\n  const { PLAYER } = Platformer.Config;\n  const settings = Platformer.Settings.current;\n  const fpsTarget = settings.video.fpsCap === \"unlimited\" ? 0 : Number(settings.video.fpsCap);\n  const isFileProtocol = window.location.protocol === \"file:\";\n  const isDesktopHost = !!(window.pywebview && window.pywebview.api);\n  const dpr = isDesktopHost ? 1 : Math.max(1, Math.min(2, Math.round((window.devicePixelRatio || 1) * 100) / 100));\n  const getViewportSize = () => {\n    const root = document.getElementById(\"game-root\");\n    const rootW = root && root.clientWidth ? root.clientWidth : 0;\n    const rootH = root && root.clientHeight ? root.clientHeight : 0;\n    const docW = document.documentElement && document.documentElement.clientWidth ? document.documentElement.clientWidth : 0;\n    const docH = document.documentElement && document.documentElement.clientHeight ? document.documentElement.clientHeight : 0;\n    const w = Math.max(rootW, docW, 640);\n    const h = Math.max(rootH, docH, 360);\n    return { w, h };\n  };\n  const initial = getViewportSize();\n  Platformer.Debug.init();\n  if (Platformer.BUILD_VERSION) {\n    Platformer.Debug.log(\"Build\", `version=${Platformer.BUILD_VERSION} time=${Platformer.BUILD_TIME_UTC || \"n/a\"}`);\n  }\n  if (isFileProtocol && !isDesktopHost) Platformer.Debug.log(\"Runtime\", \"file:// mode detected.\");\n  if (isDesktopHost) Platformer.Debug.log(\"Runtime\", \"Desktop host mode detected.\");\n\n  const SafeBootScene = Platformer.wrapSceneSafety(Platformer.BootScene, \"BootScene\");\n  const SafeMenuScene = Platformer.wrapSceneSafety(Platformer.MenuScene, \"MenuScene\");\n  const SafeWorldMapScene = Platformer.wrapSceneSafety(Platformer.WorldMapScene, \"WorldMapScene\");\n  const SafeExtrasScene = Platformer.wrapSceneSafety(Platformer.ExtrasScene, \"ExtrasScene\");\n  const SafeIntroScene = Platformer.wrapSceneSafety(Platformer.IntroScene, \"IntroScene\");\n  const SafeOptionsScene = Platformer.wrapSceneSafety(Platformer.OptionsScene, \"OptionsScene\");\n  const SafeGameScene = Platformer.wrapSceneSafety(Platformer.GameScene, \"GameScene\");\n  const SafeUIScene = Platformer.wrapSceneSafety(Platformer.UIScene, \"UIScene\");\n\n  const config = {\n    type: Phaser.AUTO,\n    width: initial.w,\n    height: initial.h,\n    parent: \"game-root\",\n    pixelArt: settings.video.pixelPerfect,\n    resolution: dpr,\n    scale: {\n      mode: Phaser.Scale.RESIZE,\n      width: initial.w,\n      height: initial.h,\n      zoom: 1,\n    },\n    backgroundColor: \"#7dd3fc\",\n    autoRound: true,\n    render: {\n      antialias: false,\n      antialiasGL: false,\n      pixelArt: true,\n      roundPixels: true,\n      powerPreference: \"high-performance\",\n    },\n    physics: {\n      default: \"arcade\",\n      arcade: {\n        gravity: { y: PLAYER.gravity },\n        debug: false,\n      },\n    },\n    fps: {\n      target: fpsTarget || 60,\n      forceSetTimeOut: !settings.video.vsync,\n    },\n    dom: {\n      createContainer: true,\n    },\n    scene: [\n      SafeBootScene,\n      SafeMenuScene,\n      SafeWorldMapScene,\n      SafeExtrasScene,\n      SafeIntroScene,\n      SafeOptionsScene,\n      SafeGameScene,\n      SafeUIScene,\n    ],\n  };\n\n  const game = new Phaser.Game(config);\n  window.AnimePlatformerGame = {\n    play() { if (game && game.scene) game.scene.resume(\"GameScene\"); },\n    pause() { if (game && game.scene) game.scene.pause(\"GameScene\"); },\n    settings() { return Platformer.Settings.current; },\n  };\n  Platformer.Debug.attachGameMonitors(game);\n  let lastW = initial.w;\n  let lastH = initial.h;\n\n  const forceActiveSceneRelayout = (w, h) => {\n    if (!(game && game.scene && game.scene.getScenes)) return;\n    const activeScenes = game.scene.getScenes(true);\n    activeScenes.forEach((scene) => {\n      if (!scene || !scene.sys || !scene.sys.settings || !scene.sys.settings.active) return;\n      try {\n        if (typeof scene.handleResize === \"function\") scene.handleResize(w, h);\n        else if (typeof scene.layoutMenu === \"function\") scene.layoutMenu();\n        else if (typeof scene.layoutOptions === \"function\") scene.layoutOptions();\n        if (scene.ui && typeof scene.ui.resize === \"function\") scene.ui.resize();\n      } catch (e) {\n        if (Platformer.Debug && Platformer.Debug.warn) {\n          Platformer.Debug.warn(\"ResizeSync\", `Scene relayout failed (${scene.scene ? scene.scene.key : \"unknown\"}): ${e && e.message ? e.message : e}`);\n        }\n      }\n    });\n  };\n\n  const applySize = (wRaw, hRaw, source = \"window\") => {\n    const vp = getViewportSize();\n    const w = Math.max(640, Number(wRaw) || vp.w);\n    const h = Math.max(360, Number(hRaw) || vp.h);\n    if (w === lastW && h === lastH) return;\n    lastW = w;\n    lastH = h;\n    Platformer.Debug.log(\"ResizeSync\", `${source} -> ${w}x${h}`);\n\n    if (game && game.scale) {\n      game.scale.resize(w, h);\n      if (typeof game.scale.refresh === \"function\") {\n        game.scale.refresh();\n      }\n      if (game.input && game.input.manager && typeof game.input.manager.resize === \"function\") {\n        game.input.manager.resize(w, h);\n      }\n      forceActiveSceneRelayout(w, h);\n    }\n  };\n  const syncGameSize = () => {\n    const vp = getViewportSize();\n    applySize(vp.w, vp.h, \"viewport\");\n  };\n\n  window.addEventListener(\"resize\", syncGameSize);\n  window.addEventListener(\"orientationchange\", syncGameSize);\n  window.addEventListener(\"online\", () => {\n    const scene = game && game.scene ? game.scene.getScene(\"MenuScene\") : null;\n    if (scene && typeof scene.autoCheckUpdatesForBottomLeft === \"function\") {\n      scene.autoCheckUpdatesForBottomLeft();\n    }\n  });\n  // Keep a lightweight heartbeat for wrappers that occasionally miss resize events.\n  setInterval(syncGameSize, 1200);\n  // Startup relayout pulses for desktop wrappers where initial viewport can be stale until first input.\n  setTimeout(syncGameSize, 60);\n  setTimeout(syncGameSize, 180);\n  setTimeout(syncGameSize, 420);\n  setTimeout(syncGameSize, 900);\n\n  const startupDisplayMode = settings.video.displayMode || (settings.video.fullscreen ? \"fullscreen\" : \"windowed\");\n  // Desktop wrapper controls fullscreen natively; avoid browser fullscreen API there.\n  if (!isDesktopHost && startupDisplayMode === \"fullscreen\") {\n    game.events.once(\"ready\", () => {\n      if (!game.scale.isFullscreen) {\n        game.scale.startFullscreen();\n      }\n    });\n  } else if (isDesktopHost && startupDisplayMode === \"fullscreen\" && Platformer.Debug) {\n    Platformer.Debug.log(\"StartupDisplay\", \"Desktop host fullscreen handled natively.\");\n  }\n})();\n\n\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACzEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC3UA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC5iBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC9MA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC1NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC5NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACnmBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACjFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACvWA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AClEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AClEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC3LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACzJA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC7NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AChCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AChCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACpDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC7WA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACvxCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACn9BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACjVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC1IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACzqBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACtoEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACjuBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;"}