{"version":3,"file":"app.bundle.js","sourceRoot":"","sources":["core/constants.js","core/build-info.js","core/settings.js","core/debug.js","core/updater.js","systems/beeper.js","level/level-1.js","level/level-2.js","level/level-3.js","level/level-4.js","level/level-data.js","scenes/boot-scene.js","scenes/menu-scene.js","scenes/intro-scene.js","scenes/options-scene.js","scenes/game-scene.js","scenes/ui-scene.js","main.js"],"sourcesContent":["\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.Config = {\n  GAME_WIDTH: 960,\n  GAME_HEIGHT: 540,\n  TILE: 32,\n  WIN_COIN_TARGET: 10,\n  PLAYER: {\n    maxSpeed: 220,\n    acceleration: 950,\n    drag: 1300,\n    jumpVelocity: 420,\n    maxJumps: 2,\n    gravity: 1100,\n    coyoteTimeMs: 110,\n    jumpBufferMs: 130,\n    hurtInvulnMs: 900,\n    dashSpeed: 460,\n    dashDurationMs: 140,\n    dashCooldownMs: 900,\n    attackRange: 44,\n    attackCooldownMs: 320,\n  },\n};\n","window.Platformer = window.Platformer || {};\n\n// Auto-generated by scripts/write_build_info.py during packaging.\nPlatformer.BUILD_VERSION = \"2026.02.15.1536\";\nPlatformer.BUILD_TIME_UTC = \"2026-02-15T15:36:44.866136Z\";\nPlatformer.BUILD_UPDATE_REPO = \"\";\nPlatformer.BUILD_UPDATE_CHANNEL = \"stable\";\nPlatformer.BUILD_UPDATE_ENABLED = true;\nPlatformer.BUILD_DEBUG = false;\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.DEFAULT_SETTINGS = {\n  settingsVersion: 2,\n  gameplay: {\n    difficulty: \"normal\",\n  },\n  controls: {\n    left: \"A\",\n    right: \"D\",\n    jump: \"W\",\n    dash: \"SHIFT\",\n    attack: \"J\",\n    interact: \"E\",\n    pause: \"ESC\",\n  },\n  accessibility: {\n    textSize: \"medium\",\n    colorblindMode: \"off\",\n    reduceScreenShake: 50,\n    reducedMotion: false,\n    flashReduction: false,\n    subtitles: true,\n    audioCues: true,\n  },\n  video: {\n    fullscreen: false,\n    resolutionScale: 100,\n    pixelPerfect: true,\n    vsync: true,\n    fpsCap: \"60\",\n    cameraSmoothing: 35,\n    brightness: 1.0,\n  },\n  audio: {\n    master: 80,\n    music: 60,\n    sfx: 85,\n    ui: 70,\n    dynamicRange: \"normal\",\n    muteWhenUnfocused: false,\n  },\n  convenience: {\n    autoSave: true,\n    checkpointFrequency: \"standard\",\n    speedrunMode: false,\n    introSeen: false,\n  },\n  updates: {\n    enabled: true,\n    autoUpdate: true,\n    currentVersion: \"1.0.0\",\n    source: \"GitHub Releases\",\n    manifestUrl: \"\",\n    downloadUrl: \"\",\n  },\n};\n\nPlatformer.deepClone = function deepClone(obj) {\n  return JSON.parse(JSON.stringify(obj));\n};\n\nPlatformer.deepMerge = function deepMerge(base, incoming) {\n  const out = Platformer.deepClone(base);\n  const mergeInto = (target, source) => {\n    if (!source || typeof source !== \"object\") return;\n    Object.keys(source).forEach((key) => {\n      const src = source[key];\n      if (src && typeof src === \"object\" && !Array.isArray(src)) {\n        if (!target[key] || typeof target[key] !== \"object\") {\n          target[key] = {};\n        }\n        mergeInto(target[key], src);\n      } else {\n        target[key] = src;\n      }\n    });\n  };\n  mergeInto(out, incoming);\n  return out;\n};\n\nPlatformer.Settings = {\n  key: \"anime_platformer_settings_v2\",\n  legacyKeys: [\"anime_platformer_settings_v1\"],\n  prefix: \"anime_platformer_settings_\",\n  current: Platformer.deepClone(Platformer.DEFAULT_SETTINGS),\n  _bootstrapped: false,\n\n  waitForBridgeReady(timeoutMs = 2500) {\n    return new Promise((resolve) => {\n      const isReady = () => !!(window.pywebview && window.pywebview.api);\n      if (isReady()) {\n        resolve(true);\n        return;\n      }\n      let done = false;\n      const finish = (ok) => {\n        if (done) return;\n        done = true;\n        try { window.removeEventListener(\"pywebviewready\", onReady); } catch (_e) {}\n        clearInterval(timer);\n        clearTimeout(expire);\n        resolve(ok);\n      };\n      const onReady = () => finish(true);\n      try { window.addEventListener(\"pywebviewready\", onReady, { once: true }); } catch (_e) {}\n      const timer = setInterval(() => {\n        if (isReady()) finish(true);\n      }, 100);\n      const expire = setTimeout(() => finish(isReady()), Math.max(200, Number(timeoutMs) || 2500));\n    });\n  },\n\n  migrate(parsed) {\n    const input = parsed && typeof parsed === \"object\" ? Platformer.deepClone(parsed) : {};\n    const ver = Number(input.settingsVersion || 1);\n    const out = input;\n\n    if (ver < 2) {\n      // v2: deprecate player-editable update URLs and lock source label.\n      if (!out.updates || typeof out.updates !== \"object\") out.updates = {};\n      out.updates.source = \"GitHub Releases\";\n      out.updates.manifestUrl = \"\";\n      out.updates.downloadUrl = \"\";\n      out.settingsVersion = 2;\n    }\n    out.settingsVersion = 2;\n    return out;\n  },\n\n  archiveLegacySnapshot(raw) {\n    if (!raw || !window.indexedDB) return;\n    try {\n      const req = window.indexedDB.open(\"anime_platformer_archive\", 1);\n      req.onupgradeneeded = (e) => {\n        const db = e.target.result;\n        if (!db.objectStoreNames.contains(\"settings\")) {\n          db.createObjectStore(\"settings\", { keyPath: \"id\", autoIncrement: true });\n        }\n      };\n      req.onsuccess = () => {\n        try {\n          const db = req.result;\n          const tx = db.transaction(\"settings\", \"readwrite\");\n          tx.objectStore(\"settings\").add({ at: Date.now(), payload: String(raw).slice(0, 2048) });\n          tx.oncomplete = () => db.close();\n          tx.onerror = () => db.close();\n        } catch (_e) {\n          // best effort\n        }\n      };\n    } catch (_e) {\n      // best effort\n    }\n  },\n\n  cleanupObsoleteStorage() {\n    try {\n      const keep = new Set([this.key, ...this.legacyKeys]);\n      Object.keys(localStorage).forEach((k) => {\n        if (k && k.startsWith(this.prefix) && !keep.has(k)) {\n          localStorage.removeItem(k);\n        }\n      });\n    } catch (_e) {\n      // ignore\n    }\n  },\n\n  load() {\n    try {\n      const buildVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      const buildUpdateEnabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n      let raw = localStorage.getItem(this.key);\n      if (!raw) {\n        for (const legacy of this.legacyKeys) {\n          raw = localStorage.getItem(legacy);\n          if (raw) break;\n        }\n      }\n      if (!raw) {\n        this.current = Platformer.deepClone(Platformer.DEFAULT_SETTINGS);\n        this.current.updates.currentVersion = buildVersion;\n        this.current.updates.enabled = buildUpdateEnabled;\n        this.current.updates.source = \"GitHub Releases\";\n        return this.current;\n      }\n      this.archiveLegacySnapshot(raw);\n      const parsed = this.migrate(JSON.parse(raw));\n      this.current = Platformer.deepMerge(Platformer.DEFAULT_SETTINGS, parsed);\n      // Session-only flag: always reset on full page refresh.\n      this.current.convenience.introSeen = false;\n      // Always bind current version to packaged build, not stale localStorage.\n      this.current.updates.currentVersion = buildVersion;\n      // Build config is authoritative for whether updates are enabled.\n      this.current.updates.enabled = buildUpdateEnabled;\n      this.current.updates.source = \"GitHub Releases\";\n      this.cleanupObsoleteStorage();\n      this.persistLocal();\n      return this.current;\n    } catch (_e) {\n      const buildVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      const buildUpdateEnabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n      this.current = Platformer.deepClone(Platformer.DEFAULT_SETTINGS);\n      this.current.convenience.introSeen = false;\n      this.current.updates.currentVersion = buildVersion;\n      this.current.updates.enabled = buildUpdateEnabled;\n      this.current.updates.source = \"GitHub Releases\";\n      return this.current;\n    }\n  },\n\n  persistLocal() {\n    // Do not persist introSeen; keep it session-only.\n    const toSave = Platformer.deepClone(this.current);\n    toSave.convenience.introSeen = false;\n    toSave.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n    toSave.updates.source = \"GitHub Releases\";\n    // Legacy player-editable URLs are intentionally not persisted anymore.\n    toSave.updates.manifestUrl = \"\";\n    toSave.updates.downloadUrl = \"\";\n    this.current.updates.currentVersion = toSave.updates.currentVersion;\n    this.current.updates.source = toSave.updates.source;\n    this.current.updates.manifestUrl = \"\";\n    this.current.updates.downloadUrl = \"\";\n    const compact = JSON.stringify(toSave);\n    localStorage.setItem(this.key, compact);\n    this.legacyKeys.forEach((k) => localStorage.removeItem(k));\n    this.cleanupObsoleteStorage();\n  },\n\n  async save() {\n    this.persistLocal();\n    await this.persistHost();\n  },\n\n  async persistHost() {\n    try {\n      await this.waitForBridgeReady(2000);\n      if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.write_settings_blob === \"function\")) {\n        return;\n      }\n      const payload = JSON.stringify(this.current);\n      const res = await window.pywebview.api.write_settings_blob(payload);\n      if (Platformer.Debug && (!res || !res.ok)) {\n        Platformer.Debug.warn(\"Settings.host\", (res && res.message) || \"Failed writing host settings.\");\n      }\n    } catch (e) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"Settings.host\", `write failed: ${e && e.message ? e.message : e}`);\n    }\n  },\n\n  async bootstrap() {\n    this.load();\n    if (this._bootstrapped) return this.current;\n    this._bootstrapped = true;\n    try {\n      await this.waitForBridgeReady(3000);\n      if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.read_settings_blob === \"function\")) {\n        return this.current;\n      }\n      const res = await window.pywebview.api.read_settings_blob();\n      if (!res || !res.ok || !res.data) return this.current;\n      const parsed = this.migrate(JSON.parse(String(res.data)));\n      this.current = Platformer.deepMerge(Platformer.DEFAULT_SETTINGS, parsed);\n      this.current.convenience.introSeen = false;\n      this.current.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      this.current.updates.enabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n      this.current.updates.source = \"GitHub Releases\";\n      this.persistLocal();\n      if (Platformer.Debug) Platformer.Debug.log(\"Settings.host\", \"Loaded persisted settings from desktop host.\");\n    } catch (e) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"Settings.host\", `bootstrap failed: ${e && e.message ? e.message : e}`);\n    }\n    return this.current;\n  },\n\n  reset() {\n    this.current = Platformer.deepClone(Platformer.DEFAULT_SETTINGS);\n    this.current.convenience.introSeen = false;\n    this.current.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n    this.current.updates.enabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n    this.current.updates.source = \"GitHub Releases\";\n    this.current.updates.manifestUrl = \"\";\n    this.current.updates.downloadUrl = \"\";\n    this.save();\n    return this.current;\n  },\n\n  textScale() {\n    const size = this.current.accessibility.textSize;\n    if (size === \"small\") return 0.9;\n    if (size === \"large\") return 1.2;\n    return 1;\n  },\n};\n\nPlatformer.Settings.load();\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.Debug = {\n  initialized: false,\n  enabled: false,\n  lines: [],\n  maxLines: 300,\n  panel: null,\n  logEl: null,\n  statusEl: null,\n  copyBtn: null,\n  latestErrorBlock: \"\",\n  _monitorsAttached: false,\n  _nativeLogInFlight: 0,\n  _nativeLogDropped: 0,\n  _lastMismatchKey: \"\",\n  _lastMismatchAt: 0,\n\n  init() {\n    if (this.initialized) return;\n    this.initialized = true;\n    const desktopHost = !!(window.pywebview && window.pywebview.api);\n    this.enabled = !!(window.DEBUG_MODE || Platformer.BUILD_DEBUG || desktopHost);\n    if (!this.enabled) return;\n\n    const root = document.createElement(\"div\");\n    root.style.position = \"fixed\";\n    root.style.right = \"12px\";\n    root.style.bottom = \"12px\";\n    root.style.zIndex = \"999999\";\n    root.style.fontFamily = \"Consolas, monospace\";\n\n    const toggle = document.createElement(\"button\");\n    toggle.textContent = \"DEBUG\";\n    toggle.style.padding = \"8px 10px\";\n    toggle.style.background = \"#111827\";\n    toggle.style.color = \"#e5e7eb\";\n    toggle.style.border = \"1px solid #374151\";\n    toggle.style.cursor = \"pointer\";\n    toggle.style.borderRadius = \"6px\";\n\n    const panel = document.createElement(\"div\");\n    panel.style.display = \"none\";\n    panel.style.marginTop = \"8px\";\n    panel.style.width = \"min(920px, 92vw)\";\n    panel.style.height = \"min(46vh, 420px)\";\n    panel.style.background = \"rgba(0,0,0,0.92)\";\n    panel.style.color = \"#86efac\";\n    panel.style.border = \"1px solid #374151\";\n    panel.style.borderRadius = \"8px\";\n    panel.style.padding = \"10px\";\n    panel.style.boxSizing = \"border-box\";\n    panel.style.display = \"none\";\n\n    const topBar = document.createElement(\"div\");\n    topBar.style.display = \"flex\";\n    topBar.style.justifyContent = \"space-between\";\n    topBar.style.alignItems = \"center\";\n    topBar.style.marginBottom = \"8px\";\n\n    const title = document.createElement(\"div\");\n    title.textContent = \"Runtime Debug Console\";\n    title.style.color = \"#f9fafb\";\n\n    const right = document.createElement(\"div\");\n    right.style.display = \"flex\";\n    right.style.gap = \"8px\";\n\n    const copyBtn = document.createElement(\"button\");\n    copyBtn.textContent = \"Copy latest error\";\n    copyBtn.style.padding = \"6px 8px\";\n    copyBtn.style.background = \"#1f2937\";\n    copyBtn.style.color = \"#f9fafb\";\n    copyBtn.style.border = \"1px solid #4b5563\";\n    copyBtn.style.cursor = \"pointer\";\n\n    const clearBtn = document.createElement(\"button\");\n    clearBtn.textContent = \"Clear\";\n    clearBtn.style.padding = \"6px 8px\";\n    clearBtn.style.background = \"#1f2937\";\n    clearBtn.style.color = \"#f9fafb\";\n    clearBtn.style.border = \"1px solid #4b5563\";\n    clearBtn.style.cursor = \"pointer\";\n\n    right.appendChild(copyBtn);\n    right.appendChild(clearBtn);\n\n    topBar.appendChild(title);\n    topBar.appendChild(right);\n\n    const status = document.createElement(\"div\");\n    status.style.marginBottom = \"6px\";\n    status.style.color = \"#93c5fd\";\n    status.textContent = \"No errors yet.\";\n\n    const log = document.createElement(\"pre\");\n    log.style.margin = \"0\";\n    log.style.height = \"calc(100% - 58px)\";\n    log.style.overflow = \"auto\";\n    log.style.whiteSpace = \"pre-wrap\";\n    log.style.fontSize = \"12px\";\n    log.style.lineHeight = \"1.32\";\n    log.textContent = \"Debug console ready.\\n\";\n\n    panel.appendChild(topBar);\n    panel.appendChild(status);\n    panel.appendChild(log);\n    root.appendChild(toggle);\n    root.appendChild(panel);\n    document.body.appendChild(root);\n\n    toggle.addEventListener(\"click\", () => {\n      panel.style.display = panel.style.display === \"none\" ? \"block\" : \"none\";\n    });\n    window.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"F1\") {\n        e.preventDefault();\n        panel.style.display = panel.style.display === \"none\" ? \"block\" : \"none\";\n      }\n    });\n\n    clearBtn.addEventListener(\"click\", () => {\n      this.lines = [];\n      log.textContent = \"\";\n      status.textContent = \"Cleared.\";\n    });\n\n    copyBtn.addEventListener(\"click\", async () => {\n      const text = this.latestErrorBlock || \"No captured error block yet.\";\n      try {\n        await navigator.clipboard.writeText(text);\n        status.textContent = \"Latest error copied to clipboard.\";\n      } catch (_e) {\n        status.textContent = \"Copy failed. Select text manually from logs.\";\n      }\n    });\n\n    this.panel = panel;\n    this.logEl = log;\n    this.statusEl = status;\n    this.copyBtn = copyBtn;\n\n    window.addEventListener(\"error\", (event) => {\n      // Resource load failures (scripts, audio, images) come through error events too.\n      if (event && event.target && event.target !== window) {\n        const t = event.target;\n        const tag = t.tagName || \"UNKNOWN\";\n        const src = t.src || t.href || \"(no src/href)\";\n        this.error(\"resource.error\", `TAG: ${tag}\\nSOURCE: ${src}`);\n        return;\n      }\n\n      const msg = event.message || \"Unknown window error\";\n      const file = event.filename || \"(no filename)\";\n      const line = event.lineno || 0;\n      const col = event.colno || 0;\n      const stack = event.error && event.error.stack ? event.error.stack : \"(no stack)\";\n      this.error(\"window.onerror\", `MESSAGE: ${msg}\\nFILE: ${file}:${line}:${col}\\n${stack}`);\n    }, true);\n\n    window.addEventListener(\"unhandledrejection\", (event) => {\n      const reason = event.reason;\n      const msg = reason && reason.message ? reason.message : String(reason);\n      const stack = reason && reason.stack ? reason.stack : \"(no stack)\";\n      this.error(\"unhandledrejection\", `${msg}\\n${stack}`);\n    });\n\n    this.patchConsole();\n  },\n\n  patchConsole() {\n    if (console.__platformerDebugPatched) return;\n    console.__platformerDebugPatched = true;\n\n    const origLog = console.log.bind(console);\n    const origWarn = console.warn.bind(console);\n    const origErr = console.error.bind(console);\n\n    console.log = (...args) => {\n      this.log(\"console.log\", this.stringifyArgs(args));\n      origLog(...args);\n    };\n    console.warn = (...args) => {\n      this.warn(\"console.warn\", this.stringifyArgs(args));\n      origWarn(...args);\n    };\n    console.error = (...args) => {\n      this.error(\"console.error\", this.stringifyArgs(args));\n      origErr(...args);\n    };\n  },\n\n  stringifyArgs(args) {\n    return args.map((a) => {\n      if (typeof a === \"string\") return a;\n      try {\n        return JSON.stringify(a);\n      } catch (_e) {\n        return String(a);\n      }\n    }).join(\" \");\n  },\n\n  timestamp() {\n    return new Date().toISOString().slice(11, 19);\n  },\n\n  append(type, label, message) {\n    if (!this.enabled) return;\n    const line = `[${this.timestamp()}] [${type}] ${label}: ${message}`;\n    this.lines.push(line);\n    if (this.lines.length > this.maxLines) {\n      this.lines.shift();\n    }\n    if (this.logEl) {\n      this.logEl.textContent = this.lines.join(\"\\n\");\n      this.logEl.scrollTop = this.logEl.scrollHeight;\n    }\n    this.forwardToNativeConsole(type, label, message);\n  },\n\n  forwardToNativeConsole(type, label, message) {\n    try {\n      if (!(window.pywebview && window.pywebview.api && typeof window.pywebview.api.log_event === \"function\")) {\n        return;\n      }\n      // Avoid flooding host bridge on high-frequency logs.\n      if (this._nativeLogInFlight > 10) {\n        this._nativeLogDropped += 1;\n        if (this._nativeLogDropped % 25 === 0) {\n          window.pywebview.api.log_event(\"WARN\", \"DebugBridge\", `Dropped ${this._nativeLogDropped} log lines (bridge saturated)`).catch(() => {});\n        }\n        return;\n      }\n      this._nativeLogInFlight += 1;\n      window.pywebview.api.log_event(type, label, String(message)).catch(() => {})\n        .finally(() => {\n          this._nativeLogInFlight = Math.max(0, this._nativeLogInFlight - 1);\n        });\n    } catch (_e) {\n      // best effort\n    }\n  },\n\n  log(label, message) {\n    this.append(\"INFO\", label, message);\n  },\n\n  warn(label, message) {\n    this.append(\"WARN\", label, message);\n  },\n\n  error(label, message) {\n    this.append(\"ERROR\", label, message);\n    this.latestErrorBlock = [\n      \"=== COPY_THIS_TO_ASSISTANT ===\",\n      `TIME: ${new Date().toISOString()}`,\n      `SOURCE: ${label}`,\n      \"DETAILS:\",\n      message,\n      \"=== END_COPY ===\",\n    ].join(\"\\n\");\n    if (this.statusEl) {\n      this.statusEl.textContent = \"Error captured. Click 'Copy latest error'.\";\n      this.statusEl.style.color = \"#fca5a5\";\n    }\n  },\n\n  attachGameMonitors(game) {\n    if (!this.enabled) return;\n    if (this._monitorsAttached || !game) return;\n    this._monitorsAttached = true;\n\n    try {\n      const sm = game.scene && game.scene.events ? game.scene.events : null;\n      if (sm) {\n        const sceneEvent = (name) => (scene) => {\n          const key = scene && scene.scene && scene.scene.key ? scene.scene.key : \"unknown\";\n          this.log(\"Scene\", `${name}: ${key}`);\n        };\n        sm.on(\"start\", sceneEvent(\"start\"));\n        sm.on(\"ready\", sceneEvent(\"ready\"));\n        sm.on(\"pause\", sceneEvent(\"pause\"));\n        sm.on(\"resume\", sceneEvent(\"resume\"));\n        sm.on(\"sleep\", sceneEvent(\"sleep\"));\n        sm.on(\"wake\", sceneEvent(\"wake\"));\n        sm.on(\"shutdown\", sceneEvent(\"shutdown\"));\n        sm.on(\"destroy\", sceneEvent(\"destroy\"));\n      }\n    } catch (e) {\n      this.warn(\"Debug.attachGameMonitors\", `Scene monitor attach failed: ${e && e.message ? e.message : e}`);\n    }\n\n    try {\n      if (game.scale && game.scale.on) {\n        game.scale.on(\"resize\", (sz) => {\n          this.log(\"Scale.resize\", `${Math.round(sz.width)}x${Math.round(sz.height)}`);\n        });\n      }\n    } catch (e) {\n      this.warn(\"Debug.attachGameMonitors\", `Scale monitor attach failed: ${e && e.message ? e.message : e}`);\n    }\n\n    try {\n      document.addEventListener(\"visibilitychange\", () => {\n        this.log(\"Visibility\", document.hidden ? \"hidden\" : \"visible\");\n      });\n    } catch (_e) {\n      // best effort\n    }\n\n    // Detect black bars / stale canvas sizing (common in desktop wrappers).\n    setInterval(() => {\n      try {\n        if (!game.canvas) return;\n        const root = document.getElementById(\"game-root\");\n        const vw = (root && root.clientWidth) || (document.documentElement && document.documentElement.clientWidth) || window.innerWidth || 0;\n        const vh = (root && root.clientHeight) || (document.documentElement && document.documentElement.clientHeight) || window.innerHeight || 0;\n        const cw = game.canvas.clientWidth || game.canvas.width || 0;\n        const ch = game.canvas.clientHeight || game.canvas.height || 0;\n        const dx = Math.abs(cw - vw);\n        const dy = Math.abs(ch - vh);\n        if (dx > 8 || dy > 8) {\n          const now = Date.now();\n          const key = `${vw}x${vh}|${cw}x${ch}`;\n          if (key !== this._lastMismatchKey || now - this._lastMismatchAt > 5000) {\n            this._lastMismatchKey = key;\n            this._lastMismatchAt = now;\n            this.warn(\"ViewportMismatch\", `viewport=${vw}x${vh} canvas=${cw}x${ch} (dx=${dx},dy=${dy})`);\n          }\n        }\n      } catch (_e) {\n        // best effort\n      }\n    }, 1200);\n  },\n\n  safe(label, fn, ctx, args) {\n    if (!this.enabled) {\n      return fn.apply(ctx, args || []);\n    }\n    try {\n      return fn.apply(ctx, args || []);\n    } catch (err) {\n      const stack = err && err.stack ? err.stack : String(err);\n      this.error(label, stack);\n      return undefined;\n    }\n  },\n};\n\nPlatformer.wrapSceneSafety = function wrapSceneSafety(SceneClass, sceneName) {\n  if (!SceneClass || SceneClass.__safeWrapped) return SceneClass;\n\n  class SafeScene extends SceneClass {\n    preload(...args) {\n      const fn = SceneClass.prototype.preload;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.preload`, fn, this, args);\n    }\n\n    init(...args) {\n      const fn = SceneClass.prototype.init;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.init`, fn, this, args);\n    }\n\n    create(...args) {\n      const fn = SceneClass.prototype.create;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.create`, fn, this, args);\n    }\n\n    update(...args) {\n      const fn = SceneClass.prototype.update;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.update`, fn, this, args);\n    }\n\n    shutdown(...args) {\n      const fn = SceneClass.prototype.shutdown;\n      if (typeof fn !== \"function\") return undefined;\n      return Platformer.Debug.safe(`${sceneName}.shutdown`, fn, this, args);\n    }\n  }\n\n  SafeScene.__safeWrapped = true;\n  return SafeScene;\n};\n","window.Platformer = window.Platformer || {};\n\nPlatformer.Updater = {\n  resolveSource() {\n    const cfg = Platformer.Settings.current.updates || {};\n    const defaultRepo = \"zyynx-hub/Platformer\";\n    const buildRepo = String(Platformer.BUILD_UPDATE_REPO || \"\").trim().replace(/^\\/+|\\/+$/g, \"\");\n    const buildChannel = String(Platformer.BUILD_UPDATE_CHANNEL || \"stable\").trim() || \"stable\";\n    const buildEnabled = Platformer.BUILD_UPDATE_ENABLED !== false;\n    const repo = buildRepo || defaultRepo;\n    return {\n      enabled: buildEnabled && cfg.enabled !== false,\n      kind: \"github\",\n      repo,\n      channel: buildChannel,\n      currentVersion: cfg.currentVersion || \"0.0.0\",\n      fallbackDownloadUrl: cfg.downloadUrl || \"\",\n    };\n  },\n\n  friendlyError(message) {\n    const raw = String(message || \"\").toLowerCase();\n    if (!raw) return \"Update check failed.\";\n    if (raw.includes(\"no public release\")) {\n      return \"No public release found yet.\";\n    }\n    if (raw.includes(\"winerror 87\") || raw.includes(\"parameter is incorrect\")) {\n      return \"Network/proxy config issue. Retry or disable proxy/VPN.\";\n    }\n    if (raw.includes(\"timed out\") || raw.includes(\"network\") || raw.includes(\"offline\") || raw.includes(\"failed to fetch\")) {\n      return \"Offline, retrying later.\";\n    }\n    if (raw.includes(\"rate limit\") || raw.includes(\"403\")) {\n      return \"Update server busy, try later.\";\n    }\n    if (raw.includes(\"404\")) {\n      return \"No public release found yet.\";\n    }\n    return \"Can't reach update server.\";\n  },\n\n  wait(ms) {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  },\n\n  compareVersions(a, b) {\n    const norm = (v) => String(v || \"0\")\n      .split(\".\")\n      .map((p) => parseInt(p, 10))\n      .map((n) => (Number.isFinite(n) ? n : 0));\n\n    const aa = norm(a);\n    const bb = norm(b);\n    const len = Math.max(aa.length, bb.length);\n    for (let i = 0; i < len; i += 1) {\n      const av = aa[i] || 0;\n      const bv = bb[i] || 0;\n      if (av > bv) return 1;\n      if (av < bv) return -1;\n    }\n    return 0;\n  },\n\n  async check() {\n    const source = this.resolveSource();\n    if (!source.enabled) {\n      return { ok: true, enabled: false, message: \"Auto updates are off.\" };\n    }\n\n    if (source.kind === \"github\" && window.pywebview && window.pywebview.api) {\n      if (typeof window.pywebview.api.check_update_github !== \"function\") {\n        return { ok: false, enabled: true, transient: true, message: \"Update bridge not ready yet.\" };\n      }\n      try {\n        const res = await window.pywebview.api.check_update_github(\n          source.repo,\n          source.currentVersion,\n          source.channel,\n        );\n        if (res && res.ok) {\n          return {\n            ok: true,\n            enabled: true,\n            hasUpdate: !!res.hasUpdate,\n            latestVersion: res.latestVersion || source.currentVersion,\n            downloadUrl: res.downloadUrl || source.fallbackDownloadUrl || \"\",\n            checksumSha256: res.checksumSha256 || \"\",\n            releaseNotes: res.releaseNotes || \"\",\n            releasePublishedAt: res.releasePublishedAt || \"\",\n            message: res.message || (res.hasUpdate ? \"Update found.\" : \"You're up to date.\"),\n          };\n        }\n        return {\n          ok: false,\n          enabled: true,\n          message: this.friendlyError((res && res.message) || \"Can't reach update server.\"),\n        };\n      } catch (e) {\n        return { ok: false, enabled: true, message: this.friendlyError(e && e.message ? e.message : e) };\n      }\n    }\n\n    return { ok: false, enabled: true, message: \"Update service not ready in this runtime.\" };\n  },\n\n  openDownload(url) {\n    if (!url) return false;\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.open_url === \"function\") {\n      window.pywebview.api.open_url(url);\n      return true;\n    }\n    try {\n      window.open(url, \"_blank\", \"noopener,noreferrer\");\n      return true;\n    } catch (_e) {\n      return false;\n    }\n  },\n\n  canInAppApply() {\n    return !!(\n      window.pywebview\n      && window.pywebview.api\n      && typeof window.pywebview.api.start_update_download === \"function\"\n      && typeof window.pywebview.api.get_update_progress === \"function\"\n      && typeof window.pywebview.api.apply_downloaded_update === \"function\"\n    );\n  },\n\n  async updateAndRestart(downloadUrl, onProgress) {\n    if (!this.canInAppApply()) {\n      return { ok: false, message: \"In-app updater API unavailable.\" };\n    }\n    if (!downloadUrl) {\n      return { ok: false, message: \"Update package URL missing.\" };\n    }\n\n    const sendProgress = (payload) => {\n      if (typeof onProgress === \"function\") onProgress(payload);\n    };\n\n    try {\n      if (Platformer.Debug) Platformer.Debug.log(\"Updater\", `Starting in-app update: ${downloadUrl}`);\n      const start = await window.pywebview.api.start_update_download(\n        downloadUrl,\n        Platformer.Updater.latestChecksumSha256 || \"\",\n      );\n      if (!start || !start.ok) {\n        const msg = (start && start.message) || \"Failed to start update download.\";\n        if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n        return { ok: false, message: msg };\n      }\n\n      sendProgress({ stage: \"downloading\", progress: 0, message: \"Downloading update...\" });\n\n      for (let i = 0; i < 1200; i += 1) {\n        const status = await window.pywebview.api.get_update_progress();\n        if (!status || !status.ok) {\n          const msg = (status && status.message) || \"Failed to read update progress.\";\n          if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n          return { ok: false, message: msg };\n        }\n\n        sendProgress(status);\n\n        if (status.stage === \"error\") {\n          const msg = status.message || \"Update download failed.\";\n          if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n          return { ok: false, message: msg };\n        }\n        if (status.stage === \"downloaded\") {\n          break;\n        }\n        await this.wait(250);\n      }\n\n      sendProgress({ stage: \"applying\", progress: 100, message: \"Restarting to finish update...\" });\n      if (Platformer.Debug) Platformer.Debug.log(\"Updater\", \"Download complete. Applying update.\");\n      const applied = await window.pywebview.api.apply_downloaded_update();\n      if (!applied || !applied.ok) {\n        const msg = (applied && applied.message) || \"Failed to apply update.\";\n        if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n        return { ok: false, message: msg };\n      }\n\n      if (Platformer.Debug) Platformer.Debug.log(\"Updater\", \"Updater helper launched; app is restarting.\");\n      return { ok: true, message: applied.message || \"Restarting to finish update...\" };\n    } catch (e) {\n      const msg = `Update flow failed: ${e && e.message ? e.message : e}`;\n      if (Platformer.Debug) Platformer.Debug.error(\"Updater\", msg);\n      return { ok: false, message: msg };\n    }\n  },\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.Beeper = class {\n  constructor() {\n    this.ctx = null;\n    this.enabled = true;\n  }\n\n  unlock() {\n    if (!this.enabled) return;\n    if (!this.ctx) {\n      const AudioCtx = window.AudioContext || window.webkitAudioContext;\n      if (!AudioCtx) {\n        this.enabled = false;\n        return;\n      }\n      this.ctx = new AudioCtx();\n    }\n    if (this.ctx.state === \"suspended\") {\n      this.ctx.resume();\n    }\n  }\n\n  tone(freq, duration, type = \"square\", gainValue = 0.05) {\n    if (!this.ctx || !this.enabled) return;\n    const settings = Platformer.Settings ? Platformer.Settings.current : null;\n    if (settings && !settings.accessibility.audioCues) return;\n\n    let mix = 1;\n    if (settings) {\n      mix = (settings.audio.master / 100) * (settings.audio.sfx / 100);\n      if (settings.audio.muteWhenUnfocused && document.hidden) {\n        mix = 0;\n      }\n    }\n    if (mix <= 0) return;\n\n    const now = this.ctx.currentTime;\n    const osc = this.ctx.createOscillator();\n    const gain = this.ctx.createGain();\n    osc.type = type;\n    osc.frequency.setValueAtTime(freq, now);\n    gain.gain.setValueAtTime(gainValue * mix, now);\n    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);\n    osc.connect(gain);\n    gain.connect(this.ctx.destination);\n    osc.start(now);\n    osc.stop(now + duration);\n  }\n\n  jump() {\n    this.tone(420, 0.08, \"square\", 0.05);\n  }\n\n  coin() {\n    this.tone(880, 0.06, \"triangle\", 0.06);\n    this.tone(1320, 0.08, \"triangle\", 0.045);\n  }\n\n  damage() {\n    this.tone(180, 0.14, \"sawtooth\", 0.06);\n  }\n\n  stomp() {\n    this.tone(240, 0.09, \"square\", 0.055);\n  }\n\n  dash() {\n    this.tone(520, 0.05, \"triangle\", 0.05);\n    this.tone(340, 0.06, \"square\", 0.035);\n  }\n\n  attack() {\n    this.tone(300, 0.04, \"sawtooth\", 0.045);\n    this.tone(220, 0.05, \"square\", 0.03);\n  }\n\n  land() {\n    this.tone(140, 0.05, \"square\", 0.03);\n  }\n};\n\nPlatformer.beeper = new Platformer.Beeper();\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[1] = function buildLevel1(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Ground with wide, readable gaps.\n  line(12, 15, 17, \".\");\n  line(34, 37, 17, \".\");\n  line(58, 61, 17, \".\");\n  line(78, 81, 17, \".\");\n\n  // Broad patrol islands.\n  rect(0, 16, 7, 16, \"#\");\n  rect(18, 16, 25, 16, \"#\");\n  rect(40, 16, 47, 16, \"#\");\n  rect(64, 16, 71, 16, \"#\");\n  rect(84, 16, 89, 16, \"#\");\n\n  // Platforms.\n  line(8, 13, 12, \"=\");\n  line(23, 29, 11, \"=\");\n  line(44, 50, 10, \"=\");\n  line(66, 73, 9, \"=\");\n\n  many([[3, 16]], \"S\");\n  many([[27, 10], [69, 8]], \"K\");\n  many([[10, 11], [24, 10], [28, 10], [45, 9], [49, 9], [67, 8], [72, 8], [86, 15], [88, 15], [20, 15]], \"C\");\n  many([[25, 10], [46, 9], [68, 8], [86, 15]], \"^\");\n  manyEnemies([[20, 16, \"E\"], [43, 16, \"E\"], [66, 16, \"E\"], [86, 16, \"E\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[2] = function buildLevel2(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Vertical rooftop style with wide landing zones.\n  line(14, 18, 17, \".\");\n  line(38, 42, 17, \".\");\n  line(62, 66, 17, \".\");\n\n  rect(0, 16, 10, 16, \"#\");\n  rect(22, 16, 30, 16, \"#\");\n  rect(46, 16, 54, 16, \"#\");\n  rect(70, 16, 89, 16, \"#\");\n\n  rect(14, 14, 18, 14, \"#\");\n  rect(38, 13, 42, 13, \"#\");\n  rect(62, 12, 66, 12, \"#\");\n\n  line(9, 15, 12, \"=\");\n  line(27, 34, 10, \"=\");\n  line(49, 56, 8, \"=\");\n  line(71, 79, 7, \"=\");\n\n  many([[4, 16]], \"S\");\n  many([[33, 9], [74, 6]], \"K\");\n  many([[12, 11], [29, 9], [33, 9], [50, 7], [55, 7], [72, 6], [78, 6], [86, 15], [25, 15], [47, 15]], \"C\");\n  many([[31, 9], [53, 7], [75, 6], [85, 15]], \"^\");\n  manyEnemies([[24, 16, \"F\"], [48, 16, \"F\"], [72, 16, \"F\"], [84, 16, \"F\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[3] = function buildLevel3(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Dash-pressure lanes, but no trap cracks for enemies.\n  line(10, 13, 17, \".\");\n  line(28, 31, 17, \".\");\n  line(46, 49, 17, \".\");\n  line(64, 67, 17, \".\");\n  line(80, 83, 17, \".\");\n\n  rect(0, 16, 6, 16, \"#\");\n  rect(16, 16, 23, 16, \"#\");\n  rect(34, 16, 41, 16, \"#\");\n  rect(52, 16, 59, 16, \"#\");\n  rect(70, 16, 77, 16, \"#\");\n  rect(86, 16, 89, 16, \"#\");\n\n  line(7, 12, 13, \"=\");\n  line(21, 27, 12, \"=\");\n  line(39, 45, 11, \"=\");\n  line(57, 63, 10, \"=\");\n  line(75, 82, 9, \"=\");\n\n  many([[2, 16]], \"S\");\n  many([[27, 11], [77, 8]], \"K\");\n  many([[9, 12], [23, 11], [26, 11], [40, 10], [44, 10], [58, 9], [62, 9], [76, 8], [81, 8], [88, 15]], \"C\");\n  many([[24, 11], [42, 10], [60, 9], [78, 8]], \"^\");\n  manyEnemies([[18, 16, \"G\"], [36, 16, \"G\"], [54, 16, \"G\"], [72, 16, \"G\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\n\nPlatformer.LevelBuilders[4] = function buildLevel4(api) {\n  const { line, rect, many, manyEnemies } = api;\n\n  // Fortress layout: layered routes, tank enemies, clean patrol lanes.\n  line(12, 16, 17, \".\");\n  line(36, 40, 17, \".\");\n  line(60, 64, 17, \".\");\n\n  rect(0, 16, 8, 16, \"#\");\n  rect(20, 16, 28, 16, \"#\");\n  rect(44, 16, 52, 16, \"#\");\n  rect(68, 16, 76, 16, \"#\");\n  rect(84, 16, 89, 16, \"#\");\n\n  rect(30, 14, 34, 14, \"#\");\n  rect(54, 13, 58, 13, \"#\");\n  rect(78, 12, 82, 12, \"#\");\n\n  line(9, 16, 12, \"=\");\n  line(26, 34, 10, \"=\");\n  line(48, 57, 8, \"=\");\n  line(70, 80, 7, \"=\");\n\n  many([[3, 16]], \"S\");\n  many([[32, 9], [74, 6]], \"K\");\n  many([[11, 11], [28, 9], [33, 9], [49, 7], [56, 7], [71, 6], [79, 6], [86, 15], [22, 15], [45, 15]], \"C\");\n  many([[30, 9], [52, 7], [75, 6], [86, 15]], \"^\");\n  manyEnemies([[22, 16, \"H\"], [46, 16, \"H\"], [70, 16, \"H\"], [85, 16, \"H\"]]);\n};\n\n","window.Platformer = window.Platformer || {};\nPlatformer.LevelBuilders = Platformer.LevelBuilders || {};\nPlatformer.LevelJsonCache = Platformer.LevelJsonCache || {};\n\nPlatformer.createLevelData = function createLevelData(level = 1) {\n  const jsonLevel = Platformer.LevelJsonCache[level] || null;\n  const width = Number((jsonLevel && jsonLevel.width) || 90);\n  const height = Number((jsonLevel && jsonLevel.height) || 18);\n  const rows = Array.from({ length: height }, () => Array.from({ length: width }, () => \".\"));\n\n  const inBounds = (x, y) => x >= 0 && x < width && y >= 0 && y < height;\n  const put = (x, y, ch) => {\n    if (inBounds(x, y)) rows[y][x] = ch;\n  };\n  const line = (x1, x2, y, ch) => {\n    for (let x = x1; x <= x2; x += 1) put(x, y, ch);\n  };\n  const rect = (x1, y1, x2, y2, ch) => {\n    for (let y = y1; y <= y2; y += 1) {\n      for (let x = x1; x <= x2; x += 1) put(x, y, ch);\n    }\n  };\n  const many = (items, ch) => items.forEach(([x, y]) => put(x, y, ch));\n  const manyEnemies = (items) => items.forEach(([x, y, ch]) => put(x, y, ch));\n\n  // Base floor.\n  line(0, width - 1, height - 1, \"#\");\n\n  if (jsonLevel && Array.isArray(jsonLevel.commands)) {\n    jsonLevel.commands.forEach((cmd) => {\n      const op = String((cmd && cmd.op) || \"\");\n      if (op === \"line\") line(Number(cmd.x1), Number(cmd.x2), Number(cmd.y), String(cmd.ch || \".\"));\n      if (op === \"rect\") rect(Number(cmd.x1), Number(cmd.y1), Number(cmd.x2), Number(cmd.y2), String(cmd.ch || \".\"));\n      if (op === \"many\") many(Array.isArray(cmd.items) ? cmd.items : [], String(cmd.ch || \".\"));\n      if (op === \"manyEnemies\") manyEnemies(Array.isArray(cmd.items) ? cmd.items : []);\n    });\n  } else {\n    const builder = Platformer.LevelBuilders[level] || Platformer.LevelBuilders[1];\n    if (builder) {\n      builder({\n        width,\n        height,\n        put,\n        line,\n        rect,\n        many,\n        manyEnemies,\n      });\n    }\n  }\n\n  return rows.map((r) => r.join(\"\"));\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.BootScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"BootScene\");\n    this.playerIdleLoadFailed = false;\n    this.playerIdleWarned = false;\n  }\n\n  preload() {\n    this.load.audio(\"game-bgm\", \"assets/Slaughter to Prevail - K (mp3cut.net).mp3\");\n    this.load.audio(\"pause-bgm\", \"assets/Elevator Music - So Chill (mp3cut.net).mp3\");\n    this.load.image(\"player-idle-raw\", \"assets/IFFY_IDLE.png\");\n    this.load.json(\"level-1\", \"assets/levels/level-1.json\");\n    this.load.json(\"level-2\", \"assets/levels/level-2.json\");\n    this.load.json(\"level-3\", \"assets/levels/level-3.json\");\n    this.load.json(\"level-4\", \"assets/levels/level-4.json\");\n    this.load.on(\"loaderror\", (fileObj) => {\n      if (fileObj && fileObj.key === \"player-idle-raw\") {\n        this.playerIdleLoadFailed = true;\n        if (Platformer.Debug && !this.playerIdleWarned) {\n          this.playerIdleWarned = true;\n          Platformer.Debug.warn(\"BootScene.playerIdle\", \"Optional asset missing: assets/IFFY_IDLE.png. Using built-in fallback character.\");\n        }\n      }\n      if (fileObj && /^level-\\d+$/.test(fileObj.key || \"\")) {\n        Platformer.Debug.warn(\"BootScene.levels\", `Level JSON missing for ${fileObj.key}; using built-in fallback.`);\n      }\n    });\n  }\n\n  createRectTexture(key, width, height, fillColor, borderColor = null) {\n    const g = this.add.graphics();\n    g.fillStyle(fillColor, 1);\n    g.fillRect(0, 0, width, height);\n    if (borderColor !== null) {\n      g.lineStyle(2, borderColor, 1);\n      g.strokeRect(1, 1, width - 2, height - 2);\n    }\n    g.generateTexture(key, width, height);\n    g.destroy();\n  }\n\n  createCircleTexture(key, diameter, fillColor, borderColor = null) {\n    const g = this.add.graphics();\n    g.fillStyle(fillColor, 1);\n    g.fillCircle(diameter / 2, diameter / 2, diameter / 2);\n    if (borderColor !== null) {\n      g.lineStyle(2, borderColor, 1);\n      g.strokeCircle(diameter / 2, diameter / 2, diameter / 2 - 1);\n    }\n    g.generateTexture(key, diameter, diameter);\n    g.destroy();\n  }\n\n  createHazardTexture(key, size, baseColor, accentColor) {\n    const g = this.add.graphics();\n    // Base mount\n    g.fillStyle(0x111827, 1);\n    g.fillRoundedRect(2, size - 12, size - 4, 10, 3);\n\n    // Turret body\n    g.fillStyle(baseColor, 1);\n    g.fillRoundedRect(5, 8, size - 10, size - 10, 4);\n\n    // Barrel and muzzle glow\n    g.fillStyle(0x1f2937, 1);\n    g.fillRect(size / 2 - 2, 2, 4, 8);\n    g.fillStyle(accentColor, 1);\n    g.fillCircle(size / 2, 4, 3);\n    g.fillStyle(0xfef08a, 0.85);\n    g.fillCircle(size / 2, 4, 1.3);\n\n    // Warning chevrons\n    g.fillStyle(0x450a0a, 1);\n    g.fillTriangle(8, size - 6, 12, size - 10, 16, size - 6);\n    g.fillTriangle(size - 16, size - 6, size - 12, size - 10, size - 8, size - 6);\n\n    g.lineStyle(2, 0x0b1220, 1);\n    g.strokeRoundedRect(5, 8, size - 10, size - 10, 4);\n    g.lineStyle(1, 0xe2e8f0, 0.6);\n    g.strokeCircle(size / 2, 4, 3);\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  drawCreatureEnemy(g, size, palette) {\n    const outline = palette.outline || 0x0f172a;\n    const hood = palette.body || 0x6477ff;\n    const hoodDark = palette.inner || 0x4652d9;\n    const face = palette.face || 0xf8fafc;\n    const skin = palette.skin || 0xf4cda6;\n    const eye = palette.eye || 0x020617;\n\n    // Hood/body.\n    g.fillStyle(hood, 1);\n    g.fillRoundedRect(3, 7, size - 6, size - 9, 8);\n    g.fillEllipse(size * 0.50, size * 0.46, size * 0.86, size * 0.82);\n    g.fillTriangle(size * 0.50, 1, size * 0.36, 9, size * 0.62, 9);\n\n    // Face area.\n    g.fillStyle(face, 1);\n    g.fillEllipse(size * 0.50, size * 0.52, size * 0.54, size * 0.56);\n\n    // Eyes.\n    g.fillStyle(eye, 1);\n    g.fillEllipse(size * 0.37, size * 0.51, size * 0.16, size * 0.24);\n    g.fillEllipse(size * 0.63, size * 0.51, size * 0.16, size * 0.24);\n    g.fillStyle(0xffffff, 0.95);\n    g.fillCircle(size * 0.35, size * 0.45, 1.2);\n    g.fillCircle(size * 0.61, size * 0.45, 1.2);\n\n    // Mouth/muzzle area.\n    g.fillStyle(skin, 1);\n    g.fillRoundedRect(size * 0.41, size * 0.60, size * 0.18, size * 0.10, 2);\n\n    // Legs.\n    g.fillStyle(hoodDark, 1);\n    g.fillRoundedRect(size * 0.30, size - 8, size * 0.14, 7, 2);\n    g.fillRoundedRect(size * 0.56, size - 8, size * 0.14, 7, 2);\n\n    // Outline.\n    g.lineStyle(2, outline, 1);\n    g.strokeRoundedRect(3, 7, size - 6, size - 9, 8);\n    g.lineStyle(2, outline, 0.95);\n    g.strokeEllipse(size * 0.50, size * 0.46, size * 0.86, size * 0.82);\n    g.lineStyle(1.5, outline, 0.95);\n    g.strokeEllipse(size * 0.50, size * 0.52, size * 0.54, size * 0.56);\n  }\n\n  createEnemyTexture(key, size, bodyColor, accentColor) {\n    const g = this.add.graphics();\n    this.drawCreatureEnemy(g, size, {\n      body: bodyColor,\n      inner: Phaser.Display.Color.IntegerToColor(bodyColor).darken(25).color,\n      face: 0xf8fafc,\n      skin: 0xf4cda6,\n      eye: 0x020617,\n      outline: accentColor || 0x0f172a,\n    });\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  createEnemyTextureVariant(key, size, palette) {\n    const g = this.add.graphics();\n    this.drawCreatureEnemy(g, size, {\n      body: palette.body,\n      inner: palette.inner,\n      face: 0xf8fafc,\n      skin: 0xf4cda6,\n      eye: 0x020617,\n      outline: palette.horns || 0x0f172a,\n    });\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  createProjectileTexture(key, size) {\n    const g = this.add.graphics();\n    g.fillStyle(0x7f1d1d, 1);\n    g.fillCircle(size / 2, size / 2, size / 2);\n    g.fillStyle(0xf97316, 1);\n    g.fillCircle(size / 2, size / 2, size / 2 - 2);\n    g.fillStyle(0xfef08a, 1);\n    g.fillCircle(size / 2 + 1, size / 2 - 1, size / 2 - 5);\n    g.lineStyle(1, 0x111827, 0.8);\n    g.strokeCircle(size / 2, size / 2, size / 2 - 1);\n    g.generateTexture(key, size, size);\n    g.destroy();\n  }\n\n  createAnimeGirlTexture(key, pose) {\n    const g = this.add.graphics();\n    const hairColor = pose.jump ? 0xf59e0b : 0xfbbf24;\n    const dressColor = pose.jump ? 0x1d4ed8 : 0x2563eb;\n    const skin = 0xffddc7;\n\n    g.fillStyle(hairColor, 1);\n    g.fillEllipse(14, 10, 20, 16);\n    g.fillEllipse(8, 11, 8, 8);\n    g.fillEllipse(20, 11, 8, 8);\n\n    g.fillStyle(skin, 1);\n    g.fillEllipse(14, 11, 13, 12);\n\n    g.fillStyle(0x111827, 1);\n    g.fillCircle(11, pose.blink ? 11 : 10, pose.blink ? 1 : 1.6);\n    g.fillCircle(17, pose.blink ? 11 : 10, pose.blink ? 1 : 1.6);\n\n    g.lineStyle(1.5, 0xe11d48, 1);\n    g.beginPath();\n    g.moveTo(12, 14);\n    g.lineTo(16, 14);\n    g.strokePath();\n\n    g.fillStyle(dressColor, 1);\n    g.fillRoundedRect(9, 17, 10, 10, 2);\n\n    g.fillStyle(0xffffff, 1);\n    g.fillRect(11, 19, 6, 3);\n\n    const armLeftY = pose.armLeftY ?? 21;\n    const armRightY = pose.armRightY ?? 21;\n    g.fillStyle(skin, 1);\n    g.fillRect(6, armLeftY, 3, 8);\n    g.fillRect(19, armRightY, 3, 8);\n\n    g.fillStyle(0x0f172a, 1);\n    g.fillRect(8, 27, 12, 5);\n\n    const legLeftY = pose.legLeftY ?? 32;\n    const legRightY = pose.legRightY ?? 32;\n    g.fillStyle(0x111827, 1);\n    g.fillRect(10, legLeftY, 3, 6);\n    g.fillRect(15, legRightY, 3, 6);\n\n    g.fillStyle(0xec4899, 1);\n    g.fillRect(6, 4, 4, 2);\n    g.fillRect(18, 4, 4, 2);\n\n    g.generateTexture(key, 28, 38);\n    g.destroy();\n  }\n\n  createPlayerTextures() {\n    this.createAnimeGirlTexture(\"player-idle-1\", {\n      armLeftY: 21, armRightY: 21, legLeftY: 32, legRightY: 32, blink: false, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-idle-2\", {\n      armLeftY: 22, armRightY: 22, legLeftY: 32, legRightY: 32, blink: true, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-run-1\", {\n      armLeftY: 19, armRightY: 23, legLeftY: 31, legRightY: 33, blink: false, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-run-2\", {\n      armLeftY: 23, armRightY: 19, legLeftY: 33, legRightY: 31, blink: false, jump: false,\n    });\n    this.createAnimeGirlTexture(\"player-jump\", {\n      armLeftY: 17, armRightY: 17, legLeftY: 30, legRightY: 30, blink: false, jump: true,\n    });\n  }\n\n  create() {\n    const { TILE } = Platformer.Config;\n    const cbMode = Platformer.Settings.current.accessibility.colorblindMode;\n    const hazardColor = cbMode === \"off\" ? 0xdc2626 : (cbMode === \"tritanopia\" ? 0xf59e0b : 0x2563eb);\n    const laserAccent = cbMode === \"off\" ? 0xfca5a5 : 0xfef08a;\n    const coinColor = cbMode === \"deuteranopia\" ? 0xf9a8d4 : 0xfacc15;\n    const enemyColor = cbMode === \"protanopia\" ? 0x22d3ee : 0xfb923c;\n    const enemyFangColor = cbMode === \"protanopia\" ? 0xfef08a : 0xffffff;\n\n    this.createPlayerTextures();\n    this.createRectTexture(\"ground\", TILE, TILE, 0x8b5a2b, 0x5a3a1d);\n    this.createRectTexture(\"platform\", TILE, TILE, 0x6b7280, 0x374151);\n    this.createRectTexture(\"oneway\", TILE, 12, 0x38bdf8, 0x0369a1);\n    this.createHazardTexture(\"hazard\", TILE, hazardColor, laserAccent);\n    this.setupPlayerIdleAnimation();\n    this.createCircleTexture(\"coin\", 16, coinColor, 0xa16207);\n    this.createEnemyTexture(\"enemy\", 24, enemyColor, enemyFangColor);\n    this.createEnemyTextureVariant(\"enemy-e\", 24, { body: 0xfb923c, inner: 0x7f1d1d, accent: 0xffffff, horns: 0xfef08a });\n    this.createEnemyTextureVariant(\"enemy-f\", 24, { body: 0x22d3ee, inner: 0x164e63, accent: 0xfef08a, horns: 0xe2e8f0 });\n    this.createEnemyTextureVariant(\"enemy-g\", 24, { body: 0xf43f5e, inner: 0x4c0519, accent: 0xfef2f2, horns: 0xfda4af });\n    this.createEnemyTextureVariant(\"enemy-h\", 24, { body: 0xa855f7, inner: 0x3b0764, accent: 0xfef08a, horns: 0xd8b4fe });\n    this.createProjectileTexture(\"hazard-projectile\", 14);\n    this.createRectTexture(\"checkpoint\", 16, 40, 0xa855f7, 0x581c87);\n\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"health\", 3);\n    this.registry.set(\"lives\", 2);\n    this.registry.set(\"level\", 1);\n    Platformer.LevelJsonCache = {};\n    [1, 2, 3, 4].forEach((n) => {\n      const key = `level-${n}`;\n      const json = this.cache.json.get(key);\n      if (json && typeof json === \"object\") {\n        Platformer.LevelJsonCache[n] = json;\n      }\n    });\n\n    this.scene.start(\"MenuScene\");\n  }\n\n  setupPlayerIdleAnimation() {\n    if (!this.textures.exists(\"player-idle-raw\")) {\n      if (Platformer.Debug && !this.playerIdleWarned) {\n        this.playerIdleWarned = true;\n        const msg = this.playerIdleLoadFailed\n          ? \"Player idle spritesheet failed to preload. Using built-in fallback character.\"\n          : \"Player idle spritesheet not found. Using built-in fallback character.\";\n        Platformer.Debug.warn(\"BootScene.playerIdle\", msg);\n      }\n      return;\n    }\n\n    const source = this.textures.get(\"player-idle-raw\").getSourceImage();\n    if (!source || !source.width || !source.height) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"BootScene.playerIdle\", \"player-idle-raw source has invalid dimensions.\");\n      return;\n    }\n\n    const frames = 4;\n    const frameWidth = Math.floor(source.width / frames);\n    const frameHeight = source.height;\n    if (frameWidth < 1 || frameHeight < 1) {\n      if (Platformer.Debug) Platformer.Debug.warn(\"BootScene.playerIdle\", `Invalid frame size: ${frameWidth}x${frameHeight}`);\n      return;\n    }\n\n    if (this.textures.exists(\"player-idle-sheet\")) {\n      this.textures.remove(\"player-idle-sheet\");\n    }\n    this.textures.addSpriteSheet(\"player-idle-sheet\", source, {\n      frameWidth,\n      frameHeight,\n      endFrame: frames - 1,\n    });\n\n    if (this.anims.exists(\"playerIdleAnim\")) {\n      this.anims.remove(\"playerIdleAnim\");\n    }\n    this.anims.create({\n      key: \"playerIdleAnim\",\n      frames: this.anims.generateFrameNumbers(\"player-idle-sheet\", { start: 0, end: frames - 1 }),\n      frameRate: 6,\n      repeat: -1,\n    });\n    if (Platformer.Debug) Platformer.Debug.log(\"BootScene.playerIdle\", `Loaded IFFY idle sheet ${source.width}x${source.height}, frames=${frames}`);\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.MenuScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"MenuScene\");\n    this.menuMusic = null;\n    this.menuMusicHtml = null;\n    this.updateButton = null;\n    this.updateButtonText = null;\n    this.versionInfoText = null;\n    this.changeButton = null;\n    this.changeButtonText = null;\n    this.changePanel = null;\n    this.changePanelTitle = null;\n    this.changePanelBody = null;\n    this.changePanelOpen = false;\n    this.latestReleaseNotes = [\n      \"No update details yet.\",\n      \"\",\n      \"Recent changes:\",\n      \"- Live animated menu lane (runner + enemy stomps)\",\n      \"- Menu hit feedback (red blink + knockback, non-lethal)\",\n      \"- Menu ambient state persists after Options return\",\n      \"- Options opens as live overlay over animated menu\",\n      \"- Reworked Options into standalone category cards\",\n      \"- Resize-safe Options layout and anchored back button\",\n      \"- Stable Options scrolling with fixed action footer\",\n      \"- Save + Back / Reset defaults always visible\",\n      \"\",\n      \"If online notes are available, this panel auto-refreshes from GitHub Releases.\",\n    ].join(\"\\n\");\n    this.latestReleaseTag = \"\";\n    this.pendingUpdateUrl = \"\";\n    this.updateInProgress = false;\n    this.bgSky = null;\n    this.bgMid = null;\n    this.bgGround = null;\n    this.bgAccentTop = null;\n    this.bgAccentBottom = null;\n    this.bgOrbs = [];\n    this.menuCard = null;\n    this.titleText = null;\n    this.titleShadow = null;\n    this.comingSoonText = null;\n    this.menuButtons = {};\n    this.onResize = null;\n    this.menuUiElements = [];\n    this.menuInteractive = false;\n    this.introFx = null;\n    this.introParticles = null;\n    this.introLines = [];\n    this.introGlow = null;\n    this.menuIntroInProgress = false;\n    this.menuIntroUiFadeCall = null;\n    this.menuIntroDoneCall = null;\n    this.menuStage = null;\n    this.menuRunner = null;\n    this.menuRunnerFace = 1;\n    this.menuRunnerGroundY = 0;\n    this.menuRunnerSpeed = 82;\n    this.menuRunnerJumpVy = -270;\n    this.menuRunnerVy = 0;\n    this.menuRunnerGravity = 700;\n    this.menuRunnerJumpCooldown = 0;\n    this.menuRunnerActionTimer = 0;\n    this.menuRunnerDamageCooldown = 0;\n    this.menuRunnerDamageFlashUntil = 0;\n    this.menuEnemies = [];\n    this.introConfig = {\n      totalMs: 1800,\n      uiFadeMs: 260,\n      titleRevealDelayMs: 80,\n      titleRevealMs: 420,\n      buttonStaggerMs: 90,\n      buttonMovePx: 18,\n      skyColor: 0x081336,\n      midColor: 0x132a56,\n      groundColor: 0x0b6f49,\n      glowCyan: 0x53e0ff,\n      glowPink: 0xff71c7,\n    };\n  }\n\n  create() {\n    const textScale = Platformer.Settings.textScale();\n\n    this.bgSky = this.add.rectangle(0, 0, 10, 10, this.introConfig.skyColor, 1).setOrigin(0, 0);\n    this.bgMid = this.add.rectangle(0, 0, 10, 10, this.introConfig.midColor, 1).setOrigin(0, 0);\n    this.bgGround = this.add.rectangle(0, 0, 10, 10, this.introConfig.groundColor, 1).setOrigin(0, 0);\n    this.bgAccentTop = this.add.rectangle(0, 0, 10, 10, 0x1e3a8a, 0.24).setOrigin(0, 0);\n    this.bgAccentBottom = this.add.rectangle(0, 0, 10, 10, 0x34d399, 0.22).setOrigin(0, 0);\n    this.createPrettyBackdrop();\n\n    this.titleShadow = this.add.text(0, 74, \"ANIME PLATFORMER\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(46 * textScale)}px`,\n      color: \"#67e8f9\",\n      stroke: \"#020617\",\n      strokeThickness: 12,\n    }).setOrigin(0.5).setDepth(13).setAlpha(0.26);\n\n    this.titleText = this.add.text(0, 72, \"ANIME PLATFORMER\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(46 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#1e293b\",\n      strokeThickness: 7,\n    }).setOrigin(0.5).setDepth(14);\n    this.setupMenuMusic();\n\n    const makeButton = (id, y, label, onClick, opts = {}) => {\n      const disabled = !!opts.disabled;\n      const glow = this.add.rectangle(0, y, 286, 56, 0x22d3ee, disabled ? 0.08 : 0.14)\n        .setDepth(9)\n        .setBlendMode(Phaser.BlendModes.ADD);\n      const box = this.add.rectangle(0, y, 280, 50, disabled ? 0x475569 : 0x243b67, 0.96)\n        .setStrokeStyle(3, disabled ? 0x64748b : 0x7dd3fc, 0.95)\n        .setDepth(10);\n      const txt = this.add.text(0, y, label, {\n        fontFamily: \"Consolas\",\n        fontSize: `${Math.round(30 * textScale)}px`,\n        color: disabled ? \"#cbd5e1\" : \"#f8fafc\",\n        stroke: disabled ? \"#334155\" : \"#0f172a\",\n        strokeThickness: 2,\n      }).setOrigin(0.5).setDepth(11);\n\n      if (!disabled) {\n        box.setInteractive({ useHandCursor: true });\n        box.on(\"pointerover\", () => {\n          box.setFillStyle(0x2f4f86, 1);\n          glow.setAlpha(0.26);\n          this.tweens.add({ targets: [box, txt, glow], scaleX: 1.03, scaleY: 1.03, duration: 120, ease: \"Sine.Out\" });\n        });\n        box.on(\"pointerout\", () => {\n          box.setFillStyle(0x243b67, 0.96);\n          glow.setAlpha(0.14);\n          this.tweens.add({ targets: [box, txt, glow], scaleX: 1, scaleY: 1, duration: 120, ease: \"Sine.Out\" });\n        });\n        box.on(\"pointerdown\", onClick);\n      }\n\n      this.menuButtons[id] = { box, txt, glow };\n      return this.menuButtons[id];\n    };\n\n    const launchGameplay = () => {\n      this.stopMenuMusic();\n      const difficulty = Platformer.Settings.current.gameplay.difficulty;\n      const baseLives = difficulty === \"easy\" ? 3 : (difficulty === \"hard\" ? 1 : 2);\n\n      if (this.scene.isActive(\"UIScene\") || this.scene.isPaused(\"UIScene\")) {\n        this.scene.stop(\"UIScene\");\n      }\n      if (this.scene.isActive(\"GameScene\") || this.scene.isPaused(\"GameScene\")) {\n        this.scene.stop(\"GameScene\");\n      }\n\n      this.registry.set(\"coins\", 0);\n      this.registry.set(\"health\", 3);\n      this.registry.set(\"lives\", baseLives);\n      this.registry.set(\"level\", 1);\n          this.scene.start(\"GameScene\", { level: 1 });\n      this.scene.launch(\"UIScene\");\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Play -> GameScene launched.\");\n    };\n\n    const startGame = () => {\n      if (!this.menuInteractive) return;\n      Platformer.beeper.unlock();\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Play clicked.\");\n      if (this.sound && this.sound.context && this.sound.context.state === \"suspended\") {\n        this.sound.context.resume().catch(() => {});\n      }\n\n      const seen = !!Platformer.Settings.current.convenience.introSeen;\n      if (seen) {\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Intro already seen; starting gameplay directly.\");\n        launchGameplay();\n      } else {\n        this.stopMenuMusic();\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Starting IntroScene before gameplay.\");\n        this.scene.start(\"IntroScene\");\n      }\n    };\n\n    makeButton(\"play\", 0, \"PLAY\", startGame);\n    makeButton(\"continue\", 0, \"CONTINUE\", null, { disabled: true });\n    this.comingSoonText = this.add.text(0, 0, \"Coming soon ^^\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(17 * textScale)}px`,\n      color: \"#fef3c7\",\n      stroke: \"#78350f\",\n      strokeThickness: 3,\n    }).setOrigin(0.5).setDepth(12);\n\n    makeButton(\"options\", 0, \"OPTIONS\", () => {\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Opening OptionsScene from menu.\");\n      this.setMenuUiVisible(false);\n      this.setMenuInteractive(false);\n      this.scene.launch(\"OptionsScene\", { returnTo: \"menuOverlay\" });\n    });\n    makeButton(\"credits\", 0, \"CREDITS\", () => this.showCredits());\n    makeButton(\"exit\", 0, \"EXIT\", () => this.handleExit());\n    this.createBottomLeftVersionInfo();\n    this.createMenuUpdateWidget();\n    this.createWhatsChangedWidget();\n    this.createMenuMiniStage();\n    this.menuCard = this.add.rectangle(0, 0, 360, 390, 0x0b1731, 0.46)\n      .setStrokeStyle(2, 0x7dd3fc, 0.38)\n      .setDepth(8.5);\n    this.collectMenuUiElements();\n    const shouldPlayMenuIntro = !Platformer._menuBootIntroPlayed;\n    if (shouldPlayMenuIntro) {\n      Platformer._menuBootIntroPlayed = true;\n      this.setMenuUiVisible(false);\n      this.setMenuInteractive(false);\n    } else {\n      this.setMenuUiVisible(true);\n      this.setMenuInteractive(true);\n    }\n    this.createMenuIntroFx();\n    this.layoutMenu();\n    this.onResize = () => this.handleResize();\n    this.scale.on(\"resize\", this.onResize);\n    if (shouldPlayMenuIntro) this.playMenuIntro();\n\n    this.input.keyboard.on(\"keydown-ENTER\", startGame);\n  }\n\n  layoutMenu() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const cx = w / 2;\n    const cy = h / 2;\n\n    this.bgSky.setSize(w, h).setPosition(0, 0);\n    this.bgMid.setSize(w, 220).setPosition(0, cy + 160);\n    this.bgGround.setSize(w, 120).setPosition(0, cy + 220);\n    this.bgAccentTop.setSize(w, Math.round(h * 0.42)).setPosition(0, 0);\n    this.bgAccentBottom.setSize(w, Math.round(h * 0.2)).setPosition(0, h - Math.round(h * 0.24));\n    this.titleShadow.setPosition(cx, 74);\n    this.titleText.setPosition(cx, 72);\n\n    const y0 = cy - 40;\n    const spacing = 60;\n    const p = this.menuButtons.play;\n    const c = this.menuButtons.continue;\n    const o = this.menuButtons.options;\n    const cr = this.menuButtons.credits;\n    const e = this.menuButtons.exit;\n    const place = (item, y) => {\n      if (!item) return;\n      if (item.glow) item.glow.setPosition(cx, y);\n      item.box.setPosition(cx, y);\n      item.txt.setPosition(cx, y);\n    };\n    place(p, y0);\n    place(c, y0 + spacing);\n    place(o, y0 + spacing * 2);\n    place(cr, y0 + spacing * 3);\n    place(e, y0 + spacing * 4);\n    if (this.menuCard) this.menuCard.setPosition(cx, y0 + spacing * 2).setSize(360, 356);\n    if (this.comingSoonText) this.comingSoonText.setPosition(cx + 210, y0 + spacing);\n\n    if (this.updateButton && this.updateButtonText) {\n      const ux = w - 96;\n      const uy = 38;\n      this.updateButton.setPosition(ux, uy);\n      this.updateButtonText.setPosition(ux, uy);\n    }\n    if (this.changeButton && this.changeButtonText) {\n      const cxRight = w - 96;\n      const cyTop = 84;\n      this.changeButton.setPosition(cxRight, cyTop);\n      this.changeButtonText.setPosition(cxRight, cyTop);\n    }\n    if (this.changePanel && this.changePanelTitle && this.changePanelBody) {\n      const panelW = Math.min(560, Math.max(380, Math.round(w * 0.34)));\n      const panelH = Math.min(430, Math.max(240, Math.round(h * 0.5)));\n      const px = w - panelW / 2 - 20;\n      const py = Math.min(116 + panelH / 2, h - panelH / 2 - 20);\n      this.changePanel.setSize(panelW, panelH).setPosition(px, py);\n      this.changePanelTitle.setPosition(px - panelW / 2 + 16, py - panelH / 2 + 12);\n      this.changePanelBody\n        .setPosition(px - panelW / 2 + 16, py - panelH / 2 + 44)\n        .setWordWrapWidth(panelW - 32);\n    }\n    if (this.versionInfoText) this.versionInfoText.setPosition(14, h - 12);\n    this.layoutMenuMiniStage();\n    this.layoutMenuIntroFx();\n  }\n\n  createMenuMiniStage() {\n    this.menuStage = this.add.container(0, 0).setDepth(7.8);\n\n    // Invisible logical lane: runner/enemies stay inside the existing green menu band.\n    const lane = this.add.rectangle(0, 0, 10, 10, 0x12815f, 0).setOrigin(0, 0.5);\n    const topStrip = this.add.rectangle(0, 0, 10, 8, 0x4ade80, 0).setOrigin(0, 1);\n    const laneShade = this.add.rectangle(0, 0, 10, 10, 0x0c5e45, 0).setOrigin(0, 0.5);\n    this.menuStage.add([lane, topStrip]);\n    this.menuStage.lane = lane;\n    this.menuStage.topStrip = topStrip;\n    this.menuStage.laneShade = laneShade;\n    this.menuStage.add(laneShade);\n\n    this.menuRunner = this.add.sprite(0, 0, this.textureOr(\"player-run-1\", \"player\")).setDepth(8.2);\n    this.menuRunner.setDisplaySize(48, 64);\n    this.menuStage.add(this.menuRunner);\n\n    this.menuEnemies = [];\n    for (let i = 0; i < 4; i += 1) {\n      const enemy = this.add.sprite(0, 0, this.textureOr(\"enemy-e\", \"enemy\")).setDepth(8.15);\n      enemy.setDisplaySize(34, 34);\n      enemy.menuX = 0;\n      enemy.menuDir = i % 2 === 0 ? 1 : -1;\n      enemy.menuSpeed = 30 + (i * 8);\n      enemy.alive = true;\n      enemy.respawnAt = 0;\n      this.menuEnemies.push(enemy);\n      this.menuStage.add(enemy);\n    }\n    this.restoreMenuMiniStageState();\n  }\n\n  layoutMenuMiniStage() {\n    if (!this.menuStage || !this.menuStage.lane || !this.menuStage.topStrip) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const baseGroundTop = this.bgGround ? this.bgGround.y : (h - 160);\n    const baseGroundH = this.bgGround ? this.bgGround.height : 120;\n    const laneY = baseGroundTop + Math.round(baseGroundH * 0.44);\n    const laneH = Math.max(30, Math.round(baseGroundH * 0.34));\n    const margin = 26;\n    const laneX = margin;\n    const laneW = Math.max(280, w - margin * 2);\n    this.menuRunnerGroundY = laneY - 6;\n\n    this.menuStage.lane.setPosition(laneX, laneY).setSize(laneW, laneH);\n    this.menuStage.topStrip.setPosition(laneX, laneY).setSize(laneW, 8);\n    this.menuStage.laneShade.setPosition(laneX, laneY + 12).setSize(laneW, laneH - 12);\n\n    if (this.menuRunner) {\n      if (!Number.isFinite(this.menuRunner.menuX)) {\n        this.menuRunner.menuX = laneX + 60;\n      }\n      this.menuRunner.y = this.menuRunnerGroundY;\n    }\n\n    const slot = laneW / (this.menuEnemies.length + 1);\n    this.menuEnemies.forEach((enemy, idx) => {\n      if (!enemy) return;\n      if (!enemy.alive && this.time.now < enemy.respawnAt) return;\n      enemy.alive = true;\n      enemy.menuX = laneX + slot * (idx + 1) + Phaser.Math.Between(-26, 26);\n      enemy.y = this.menuRunnerGroundY + 2;\n      enemy.setVisible(true);\n      enemy.setAlpha(1);\n    });\n  }\n\n  restoreMenuMiniStageState() {\n    const s = Platformer._menuAmbientState;\n    if (!s) return;\n    if (this.menuRunner && Number.isFinite(s.runnerX)) {\n      this.menuRunner.menuX = s.runnerX;\n      this.menuRunner.y = Number.isFinite(s.runnerY) ? s.runnerY : this.menuRunnerGroundY;\n      this.menuRunnerFace = s.runnerFace === -1 ? -1 : 1;\n      this.menuRunnerVy = Number.isFinite(s.runnerVy) ? s.runnerVy : 0;\n      this.menuRunnerJumpCooldown = Number.isFinite(s.runnerJumpCooldown) ? s.runnerJumpCooldown : 0;\n      this.menuRunnerDamageCooldown = Number.isFinite(s.runnerDamageCooldown) ? s.runnerDamageCooldown : 0;\n      this.menuRunnerActionTimer = Number.isFinite(s.runnerActionTimer) ? s.runnerActionTimer : 0;\n    }\n    if (Array.isArray(s.enemies) && this.menuEnemies && this.menuEnemies.length) {\n      this.menuEnemies.forEach((enemy, idx) => {\n        const se = s.enemies[idx];\n        if (!enemy || !se) return;\n        enemy.menuX = Number.isFinite(se.x) ? se.x : enemy.menuX;\n        enemy.menuDir = se.dir === -1 ? -1 : 1;\n        enemy.alive = se.alive !== false;\n        enemy.respawnAt = Number.isFinite(se.respawnAt) ? se.respawnAt : 0;\n        enemy.setVisible(enemy.alive);\n        if (enemy.alive) {\n          enemy.setAlpha(1);\n          enemy.setScale(1, 1);\n        }\n      });\n    }\n  }\n\n  saveMenuMiniStageState() {\n    Platformer._menuAmbientState = {\n      runnerX: this.menuRunner && Number.isFinite(this.menuRunner.menuX) ? this.menuRunner.menuX : null,\n      runnerY: this.menuRunner ? this.menuRunner.y : null,\n      runnerFace: this.menuRunnerFace,\n      runnerVy: this.menuRunnerVy,\n      runnerJumpCooldown: this.menuRunnerJumpCooldown,\n      runnerDamageCooldown: this.menuRunnerDamageCooldown,\n      runnerActionTimer: this.menuRunnerActionTimer,\n      enemies: (this.menuEnemies || []).map((enemy) => ({\n        x: enemy && Number.isFinite(enemy.menuX) ? enemy.menuX : null,\n        dir: enemy && enemy.menuDir === -1 ? -1 : 1,\n        alive: !!(enemy && enemy.alive),\n        respawnAt: enemy && Number.isFinite(enemy.respawnAt) ? enemy.respawnAt : 0,\n      })),\n    };\n  }\n\n  handleResize() {\n    this.layoutMenu();\n    if (this.menuIntroInProgress) {\n      this.forceCompleteMenuIntro();\n    }\n  }\n\n  createMenuUpdateWidget() {\n    const x = this.scale.width - 96;\n    const y = 38;\n    this.updateButton = this.add.rectangle(x, y, 160, 38, 0x334155, 0.95)\n      .setStrokeStyle(2, 0x67e8f9, 0.95)\n      .setDepth(20)\n      .setInteractive({ useHandCursor: true });\n    this.updateButtonText = this.add.text(x, y, \"Update\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"22px\",\n      color: \"#f8fafc\",\n    }).setOrigin(0.5).setDepth(21);\n    this.updateButton.on(\"pointerover\", () => this.updateButton.setFillStyle(0x3b4f73, 0.98));\n    this.updateButton.on(\"pointerout\", () => this.updateButton.setFillStyle(0x334155, 0.95));\n    this.updateButton.on(\"pointerdown\", async () => {\n      if (this.updateInProgress) {\n        // Top-right status text intentionally hidden; bottom-left remains source of truth.\n        return;\n      }\n\n      if (this.pendingUpdateUrl) {\n        if (Platformer.Updater.canInAppApply()) {\n          const result = await this.startInAppUpdate(this.pendingUpdateUrl, \"Updating game...\");\n          if (!result.ok && Platformer.Debug) {\n            Platformer.Debug.error(\"MenuScene.update\", result.message || \"Update failed.\");\n          }\n          return;\n        }\n\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.update\", `In-app updater unavailable; opening URL: ${this.pendingUpdateUrl}`);\n        const opened = Platformer.Updater.openDownload(this.pendingUpdateUrl);\n        this.setBottomLeftUpdateStatus(opened ? \"Downloading update...\" : \"Update download failed\");\n        return;\n      }\n\n      this.setBottomLeftUpdateStatus(\"Checking for updates...\");\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.update\", \"Manual update check requested.\");\n      const result = await Platformer.Updater.check();\n      if (!result.ok) {\n        this.setBottomLeftUpdateStatus(result.message || \"Can't reach update server.\");\n        return;\n      }\n      this.setLatestChangesFromResult(result);\n      if (!result.enabled) {\n        this.setBottomLeftUpdateStatus(\"Auto updates are off.\");\n        return;\n      }\n      if (result.hasUpdate) {\n        this.pendingUpdateUrl = result.downloadUrl || \"\";\n        Platformer.Updater.latestChecksumSha256 = result.checksumSha256 || \"\";\n        this.updateButtonText.setText(this.pendingUpdateUrl ? \"Update + Restart\" : \"Update\");\n        const v = result.latestVersion ? `v${result.latestVersion}` : \"new\";\n        this.setBottomLeftUpdateStatus(`Update found (${v}).`);\n        if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene.update\", `Update available: ${v}`);\n      } else {\n        this.pendingUpdateUrl = \"\";\n        Platformer.Updater.latestChecksumSha256 = \"\";\n        this.updateButtonText.setText(\"Update\");\n        this.setBottomLeftUpdateStatus(\"You're up to date.\");\n        if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.update\", \"No update available.\");\n      }\n    });\n\n    this.time.delayedCall(100, () => this.autoCheckUpdatesForBottomLeft());\n  }\n\n  async startInAppUpdate(downloadUrl, startMessage = \"Preparing update...\") {\n    this.updateInProgress = true;\n    this.updateButton.disableInteractive();\n    this.updateButtonText.setText(\"Updating...\");\n    this.setBottomLeftUpdateStatus(startMessage);\n    if (Platformer.Debug) Platformer.Debug.log(\"MenuScene.update\", startMessage);\n\n    const result = await Platformer.Updater.updateAndRestart(downloadUrl, (status) => {\n      const pct = Number(status.progress || 0);\n      const msg = status.message || status.stage || \"Updating...\";\n      const compact = status.stage === \"downloading\" && Number.isFinite(pct)\n        ? `${msg} (${pct.toFixed(1)}%)`\n        : msg;\n      this.setBottomLeftUpdateStatus(compact);\n    });\n\n    if (!result.ok) {\n      this.updateInProgress = false;\n      this.updateButton.setInteractive({ useHandCursor: true });\n      this.updateButtonText.setText(\"Update + Restart\");\n      this.setBottomLeftUpdateStatus(result.message || \"Update failed.\");\n      return { ok: false, message: result.message || \"Update failed.\" };\n    }\n\n    this.setBottomLeftUpdateStatus(result.message || \"Restarting to finish update...\");\n    return { ok: true, message: result.message || \"Restarting to finish update...\" };\n  }\n\n  createBottomLeftVersionInfo() {\n    const currentVersion = ((Platformer.Settings.current.updates || {}).currentVersion || \"1.0.0\").trim();\n    this.versionInfoText = this.add.text(14, this.scale.height - 12, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#e2e8f0\",\n      stroke: \"#0f172a\",\n      strokeThickness: 4,\n      align: \"left\",\n    }).setOrigin(0, 1).setDepth(25);\n\n    this.setBottomLeftUpdateStatus(\"Checking for updates...\");\n    this.versionInfoText.setText(`Version: ${currentVersion}\\nUpdate: Checking for updates...`);\n  }\n\n  setBottomLeftUpdateStatus(statusText) {\n    if (!this.versionInfoText) return;\n    const currentVersion = ((Platformer.Settings.current.updates || {}).currentVersion || \"1.0.0\").trim();\n    const safeStatus = statusText || \"Unknown\";\n    this.versionInfoText.setText(`Version: ${currentVersion}\\nUpdate: ${safeStatus}`);\n  }\n\n  async autoCheckUpdatesForBottomLeft() {\n    const cfg = Platformer.Settings.current.updates || {};\n    if (!cfg.enabled) {\n      this.setBottomLeftUpdateStatus(\"Auto updates are off.\");\n      return;\n    }\n\n      this.setBottomLeftUpdateStatus(\"Checking for updates...\");\n    const result = await Platformer.Updater.check();\n    if (!result.ok) {\n      if (result.transient) {\n        this.setBottomLeftUpdateStatus(\"Checking for updates...\");\n        this.time.delayedCall(1200, () => this.autoCheckUpdatesForBottomLeft());\n        return;\n      }\n      this.setBottomLeftUpdateStatus(result.message || \"Can't reach update server.\");\n      return;\n    }\n    if (!result.enabled) {\n      this.setBottomLeftUpdateStatus(\"Auto updates are off.\");\n      return;\n    }\n    this.setLatestChangesFromResult(result);\n\n    if (result.hasUpdate) {\n      const v = result.latestVersion ? `v${result.latestVersion}` : \"new version\";\n      this.pendingUpdateUrl = result.downloadUrl || \"\";\n      Platformer.Updater.latestChecksumSha256 = result.checksumSha256 || \"\";\n      this.updateButtonText.setText(this.pendingUpdateUrl ? \"Update + Restart\" : \"Update\");\n      this.setBottomLeftUpdateStatus(`Update found (${v}). Press Update.`);\n    } else {\n      this.setBottomLeftUpdateStatus(\"You're up to date.\");\n      Platformer.Updater.latestChecksumSha256 = \"\";\n      this.updateButtonText.setText(\"Update\");\n    }\n  }\n\n  createWhatsChangedWidget() {\n    const x = this.scale.width - 96;\n    const y = 84;\n    this.changeButton = this.add.rectangle(x, y, 160, 34, 0x1e293b, 0.95)\n      .setStrokeStyle(2, 0x67e8f9, 0.95)\n      .setDepth(20)\n      .setInteractive({ useHandCursor: true });\n    this.changeButtonText = this.add.text(x, y, \"What's Changed\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#e2e8f0\",\n    }).setOrigin(0.5).setDepth(21);\n\n    this.changePanel = this.add.rectangle(0, 0, 480, 290, 0x0f172a, 0.92)\n      .setStrokeStyle(2, 0x67e8f9)\n      .setDepth(22)\n      .setVisible(false);\n    this.changePanelTitle = this.add.text(0, 0, \"What's Changed\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"20px\",\n      color: \"#f8fafc\",\n    }).setOrigin(0, 0).setDepth(23).setVisible(false);\n    this.changePanelBody = this.add.text(0, 0, this.latestReleaseNotes, {\n      fontFamily: \"Consolas\",\n      fontSize: \"15px\",\n      color: \"#cbd5e1\",\n      align: \"left\",\n      wordWrap: { width: 440, useAdvancedWrap: true },\n    }).setOrigin(0, 0).setDepth(23).setVisible(false);\n\n    this.changeButton.on(\"pointerover\", () => this.changeButton.setFillStyle(0x334155, 0.98));\n    this.changeButton.on(\"pointerout\", () => this.changeButton.setFillStyle(0x1e293b, 0.95));\n    this.changeButton.on(\"pointerdown\", () => {\n      this.changePanelOpen = !this.changePanelOpen;\n      const on = this.changePanelOpen;\n      this.changePanel.setVisible(on);\n      this.changePanelTitle.setVisible(on);\n      this.changePanelBody.setVisible(on);\n      if (on) {\n        this.changeButtonText.setText(\"Hide Changes\");\n      } else {\n        this.changeButtonText.setText(\"What's Changed\");\n      }\n    });\n  }\n\n  collectMenuUiElements() {\n    this.menuUiElements = [];\n    if (this.titleText) this.menuUiElements.push(this.titleText);\n    if (this.titleShadow) this.menuUiElements.push(this.titleShadow);\n    if (this.menuCard) this.menuUiElements.push(this.menuCard);\n    Object.values(this.menuButtons).forEach((b) => {\n      if (b && b.glow) this.menuUiElements.push(b.glow);\n      if (b && b.box) this.menuUiElements.push(b.box);\n      if (b && b.txt) this.menuUiElements.push(b.txt);\n    });\n    if (this.comingSoonText) this.menuUiElements.push(this.comingSoonText);\n    if (this.updateButton) this.menuUiElements.push(this.updateButton);\n    if (this.updateButtonText) this.menuUiElements.push(this.updateButtonText);\n    if (this.changeButton) this.menuUiElements.push(this.changeButton);\n    if (this.changeButtonText) this.menuUiElements.push(this.changeButtonText);\n    if (this.changePanel) this.menuUiElements.push(this.changePanel);\n    if (this.changePanelTitle) this.menuUiElements.push(this.changePanelTitle);\n    if (this.changePanelBody) this.menuUiElements.push(this.changePanelBody);\n    if (this.versionInfoText) this.menuUiElements.push(this.versionInfoText);\n  }\n\n  setMenuUiVisible(visible) {\n    const a = visible ? 1 : 0;\n    this.menuUiElements.forEach((el) => {\n      if (!el || !el.active) return;\n      el.setAlpha(a);\n      if (this.changePanelOpen && (el === this.changePanel || el === this.changePanelTitle || el === this.changePanelBody)) {\n        el.setVisible(visible);\n      }\n    });\n  }\n\n  setMenuInteractive(enabled) {\n    this.menuInteractive = !!enabled;\n    const interactiveIds = [\"play\", \"options\", \"credits\", \"exit\"];\n    interactiveIds.forEach((id) => {\n      const b = this.menuButtons[id];\n      if (!b || !b.box) return;\n      if (enabled) b.box.setInteractive({ useHandCursor: true });\n      else b.box.disableInteractive();\n    });\n    if (this.updateButton) {\n      if (enabled) this.updateButton.setInteractive({ useHandCursor: true });\n      else this.updateButton.disableInteractive();\n    }\n    if (this.changeButton) {\n      if (enabled) this.changeButton.setInteractive({ useHandCursor: true });\n      else this.changeButton.disableInteractive();\n    }\n  }\n\n  ensureMenuIntroTextures() {\n    if (!this.textures.exists(\"menu-intro-dot\")) {\n      const g = this.make.graphics({ x: 0, y: 0, add: false });\n      g.fillStyle(0xffffff, 1);\n      g.fillCircle(4, 4, 4);\n      g.generateTexture(\"menu-intro-dot\", 8, 8);\n      g.destroy();\n    }\n    if (!this.textures.exists(\"menu-intro-line\")) {\n      const g = this.make.graphics({ x: 0, y: 0, add: false });\n      g.fillStyle(0xffffff, 1);\n      g.fillRect(0, 0, 140, 2);\n      g.generateTexture(\"menu-intro-line\", 140, 2);\n      g.destroy();\n    }\n  }\n\n  createMenuIntroFx() {\n    this.ensureMenuIntroTextures();\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.introFx = this.add.container(0, 0).setDepth(9);\n    this.introLines = [];\n\n    for (let i = 0; i < 12; i += 1) {\n      const isPink = i % 3 === 0;\n      const line = this.add.image(\n        Phaser.Math.Between(0, w),\n        Phaser.Math.Between(40, h - 80),\n        \"menu-intro-line\"\n      )\n        .setOrigin(0, 0.5)\n        .setTint(isPink ? this.introConfig.glowPink : this.introConfig.glowCyan)\n        .setAlpha(isPink ? 0.18 : 0.24)\n        .setBlendMode(Phaser.BlendModes.SCREEN);\n      line.introSpeed = Phaser.Math.FloatBetween(38, 90);\n      line.introParallax = Phaser.Math.FloatBetween(0.3, 1);\n      this.introLines.push(line);\n      this.introFx.add(line);\n    }\n\n    this.introParticles = this.add.particles(0, 0, \"menu-intro-dot\", {\n      x: { min: 0, max: w },\n      y: { min: 0, max: h * 0.72 },\n      lifespan: { min: 1500, max: 3600 },\n      speedX: { min: -8, max: 8 },\n      speedY: { min: -36, max: -10 },\n      scale: { start: 0.55, end: 0 },\n      alpha: { start: 0.36, end: 0 },\n      tint: [this.introConfig.glowCyan, this.introConfig.glowPink, 0xffffff],\n      blendMode: \"ADD\",\n      frequency: 90,\n      quantity: 1,\n    }).setDepth(10);\n  }\n\n  layoutMenuIntroFx() {\n    if (!this.introParticles) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.introParticles.setConfig({\n      x: { min: 0, max: w },\n      y: { min: 0, max: h * 0.72 },\n    });\n  }\n\n  playMenuIntro() {\n    if (!this.titleText) return;\n    this.menuIntroInProgress = true;\n\n    this.titleText.setAlpha(0).setScale(0.94).setY(42);\n    this.cameras.main.fadeIn(520, 0, 0, 0);\n\n    this.tweens.add({\n      targets: this.titleText,\n      delay: this.introConfig.titleRevealDelayMs,\n      y: 72,\n      alpha: 1,\n      scaleX: 1,\n      scaleY: 1,\n      ease: \"Cubic.Out\",\n      duration: this.introConfig.titleRevealMs,\n    });\n\n    this.introGlow = this.add.circle(this.scale.width / 2, 86, 220, this.introConfig.glowCyan, 0.08)\n      .setBlendMode(Phaser.BlendModes.ADD)\n      .setDepth(13);\n    this.tweens.add({\n      targets: this.introGlow,\n      alpha: { from: 0.15, to: 0.03 },\n      scale: { from: 0.8, to: 1.14 },\n      ease: \"Sine.InOut\",\n      yoyo: true,\n      repeat: -1,\n      duration: 2200,\n    });\n\n    const orderedButtons = [\"play\", \"continue\", \"options\", \"credits\", \"exit\"]\n      .map((id) => this.menuButtons[id])\n      .filter((b) => !!b);\n    const buttonTargets = [];\n    orderedButtons.forEach((b) => {\n      if (b.glow) buttonTargets.push(b.glow);\n      if (b.box) buttonTargets.push(b.box);\n      if (b.txt) buttonTargets.push(b.txt);\n    });\n\n    buttonTargets.forEach((obj) => {\n      obj.y += this.introConfig.buttonMovePx;\n      obj.setAlpha(0);\n    });\n\n    const titleEndAt = this.introConfig.titleRevealDelayMs + this.introConfig.titleRevealMs;\n    orderedButtons.forEach((b, idx) => {\n      const delay = titleEndAt + idx * this.introConfig.buttonStaggerMs;\n      this.tweens.add({\n        targets: [b.box, b.txt].filter(Boolean),\n        y: `-=${this.introConfig.buttonMovePx}`,\n        alpha: 1,\n        duration: this.introConfig.uiFadeMs,\n        ease: \"Cubic.Out\",\n        delay,\n      });\n    });\n\n    const remainingUi = this.menuUiElements.filter((el) => {\n      if (el === this.titleText) return false;\n      if (buttonTargets.includes(el)) return false;\n      return true;\n    });\n    this.menuIntroUiFadeCall = this.time.delayedCall(titleEndAt + orderedButtons.length * this.introConfig.buttonStaggerMs - 40, () => {\n      this.tweens.add({\n        targets: remainingUi,\n        alpha: 1,\n        duration: this.introConfig.uiFadeMs,\n        ease: \"Sine.Out\",\n      });\n    });\n\n    this.menuIntroDoneCall = this.time.delayedCall(this.introConfig.totalMs, () => {\n      this.menuIntroInProgress = false;\n      this.setMenuInteractive(true);\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Menu intro complete. UI interactive.\");\n    });\n  }\n\n  forceCompleteMenuIntro() {\n    if (!this.menuIntroInProgress) return;\n    this.menuIntroInProgress = false;\n\n    if (this.menuIntroUiFadeCall) this.menuIntroUiFadeCall.remove(false);\n    if (this.menuIntroDoneCall) this.menuIntroDoneCall.remove(false);\n    this.menuIntroUiFadeCall = null;\n    this.menuIntroDoneCall = null;\n\n    const targets = [\n      this.titleText,\n      this.titleShadow,\n      this.menuCard,\n      this.comingSoonText,\n      this.updateButton,\n      this.updateButtonText,\n      this.changeButton,\n      this.changeButtonText,\n      this.changePanel,\n      this.changePanelTitle,\n      this.changePanelBody,\n      this.versionInfoText,\n    ];\n    Object.values(this.menuButtons).forEach((b) => {\n      if (!b) return;\n      targets.push(b.glow, b.box, b.txt);\n    });\n    this.tweens.killTweensOf(targets.filter(Boolean));\n    if (this.introGlow) this.tweens.killTweensOf(this.introGlow);\n\n    this.layoutMenu();\n    this.setMenuUiVisible(true);\n    this.setMenuInteractive(true);\n    if (Platformer.Debug) Platformer.Debug.warn(\"MenuScene\", \"Intro auto-completed due to resize.\");\n  }\n\n  createPrettyBackdrop() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const orbA = this.add.circle(w * 0.78, h * 0.22, 150, this.introConfig.glowCyan, 0.11)\n      .setBlendMode(Phaser.BlendModes.ADD)\n      .setDepth(2);\n    const orbB = this.add.circle(w * 0.2, h * 0.3, 110, this.introConfig.glowPink, 0.1)\n      .setBlendMode(Phaser.BlendModes.ADD)\n      .setDepth(2);\n    this.bgOrbs = [orbA, orbB];\n    this.bgOrbs.forEach((orb, idx) => {\n      this.tweens.add({\n        targets: orb,\n        alpha: { from: orb.alpha * 0.8, to: orb.alpha * 1.35 },\n        scale: { from: 0.88 + idx * 0.08, to: 1.12 + idx * 0.12 },\n        duration: 2800 + idx * 800,\n        yoyo: true,\n        repeat: -1,\n        ease: \"Sine.InOut\",\n      });\n    });\n  }\n\n  normalizeReleaseNotes(rawText) {\n    const text = String(rawText || \"\").replace(/\\r/g, \"\").trim();\n    const isPlaceholder = text.toLowerCase() === \"none\" || text.toLowerCase() === \"null\" || text === \"-\";\n    if (!text || isPlaceholder) {\n      return \"Changelog unavailable for this check.\\n\\nOpen GitHub Releases for full patch notes.\";\n    }\n\n    const withoutTail = text\n      .replace(/\\*\\*?\\s*full\\s*changelog\\s*\\*?\\s*:?\\s*[\\s\\S]*$/i, \"\")\n      .replace(/full\\s*changelog\\s*:?\\s*[\\s\\S]*$/i, \"\")\n      .trim();\n\n    const lines = withoutTail\n      .split(\"\\n\")\n      .filter((line) => !/full\\s*changelog/i.test(line))\n      .filter((line) => !/github\\.com\\/.+\\/compare\\//i.test(line))\n      .filter((line) => !/github\\.com\\/.+\\/releases\\/download\\//i.test(line))\n      .filter((line) => !/^\\s*https?:\\/\\/\\S+\\s*$/i.test(line))\n      .map((line) => line.replace(/https?:\\/\\/\\S+/g, \"\"))\n      .map((line) => line.length > 68 ? `${line.slice(0, 68)}...` : line)\n      .filter((line) => line.trim().length > 0);\n\n    const compact = lines.join(\"\\n\").trim();\n    const capped = compact.length > 460 ? `${compact.slice(0, 460)}\\n...` : compact;\n    return capped || \"Changelog unavailable for this check.\\n\\nOpen GitHub Releases for full patch notes.\";\n  }\n\n  setLatestChangesFromResult(result) {\n    if (!result) return;\n    const v = result.latestVersion ? String(result.latestVersion) : \"\";\n    const notes = this.normalizeReleaseNotes(result.releaseNotes || \"\");\n    this.latestReleaseTag = v;\n    this.latestReleaseNotes = v ? `Release ${v}\\n\\n${notes}` : notes;\n    if (this.changePanelBody) this.changePanelBody.setText(this.latestReleaseNotes);\n  }\n\n  showCredits() {\n    if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Credits opened.\");\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n    const back = this.add.rectangle(cx, cy, 640, 250, 0x0f172a, 0.88)\n      .setStrokeStyle(2, 0x94a3b8)\n      .setDepth(30)\n      .setInteractive();\n    const txt = this.add.text(cx, cy - 10,\n      \"Credits\\nCode + Design: Robin + Codex\\nFramework: Phaser 3\\n\\nClick panel to close\", {\n        fontFamily: \"Consolas\",\n        fontSize: \"28px\",\n        color: \"#e2e8f0\",\n        align: \"center\",\n      }\n    ).setOrigin(0.5).setDepth(31);\n\n    back.on(\"pointerdown\", () => {\n      back.destroy();\n      txt.destroy();\n      if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Credits closed.\");\n    });\n  }\n\n  handleExit() {\n    if (Platformer.Debug) Platformer.Debug.log(\"MenuScene\", \"Exit requested.\");\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.exit_app === \"function\") {\n      window.pywebview.api.exit_app();\n      return;\n    }\n\n    const hint = this.add.text(this.scale.width / 2, this.scale.height - 36,\n      \"Exit is disabled in browser. Close tab/window.\", {\n        fontFamily: \"Consolas\",\n        fontSize: \"20px\",\n        color: \"#0f172a\",\n        stroke: \"#f8fafc\",\n        strokeThickness: 4,\n      }\n    ).setOrigin(0.5);\n\n    this.time.delayedCall(2200, () => hint.destroy());\n  }\n\n  setupMenuMusic() {\n    const settings = Platformer.Settings.current.audio;\n    const volume = (settings.master / 100) * (settings.music / 100);\n\n    this.sound.stopByKey(\"pause-bgm\");\n    if (Platformer.pauseMusicHtml) {\n      Platformer.pauseMusicHtml.pause();\n      Platformer.pauseMusicHtml.currentTime = 0;\n      Platformer.pauseMusicHtml = null;\n    }\n\n    if (Platformer.gameMusic) {\n      Platformer.gameMusic.stop();\n      Platformer.gameMusic = null;\n    }\n    if (Platformer.gameMusicHtml) {\n      Platformer.gameMusicHtml.pause();\n      Platformer.gameMusicHtml.currentTime = 0;\n      Platformer.gameMusicHtml = null;\n    }\n\n    const wirePlayback = () => {\n      this.menuMusic = this.sound.get(\"menu-bgm\");\n      if (!this.menuMusic) {\n        try {\n          this.menuMusic = this.sound.add(\"menu-bgm\", { loop: true, volume });\n        } catch (_e) {\n          return;\n        }\n      } else {\n        this.menuMusic.setVolume(volume);\n        this.menuMusic.setLoop(true);\n      }\n\n      const tryPlay = () => {\n        if (!this.menuMusic) return;\n        if (settings.muteWhenUnfocused && document.hidden) return;\n        if (this.menuMusic.isPlaying) return;\n        try {\n          this.menuMusic.play();\n        } catch (_e) {\n          // Autoplay restrictions are expected; user input handler below retries.\n        }\n      };\n\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    };\n\n    // If HTML fallback is already active, just update its volume and keep playing.\n    if (Platformer.menuMusicHtml) {\n      this.menuMusicHtml = Platformer.menuMusicHtml;\n      this.menuMusicHtml.volume = Phaser.Math.Clamp(volume, 0, 1);\n      return;\n    }\n\n    if (this.cache.audio.exists(\"menu-bgm\")) {\n      wirePlayback();\n      return;\n    }\n\n    this.load.audio(\"menu-bgm\", \"assets/nickpanek-energetic-chiptune-video-game-music-platformer-8-bit-318348.mp3\");\n    this.load.once(\"complete\", wirePlayback);\n    this.load.once(\"loaderror\", () => {\n      this.setupHtmlAudioFallback(volume, settings);\n    });\n    this.load.start();\n  }\n\n  setupHtmlAudioFallback(volume, settings) {\n    try {\n      if (Platformer.menuMusicHtml) {\n        this.menuMusicHtml = Platformer.menuMusicHtml;\n        this.menuMusicHtml.volume = Phaser.Math.Clamp(volume, 0, 1);\n        return;\n      }\n\n      this.menuMusicHtml = new Audio(\"assets/nickpanek-energetic-chiptune-video-game-music-platformer-8-bit-318348.mp3\");\n      Platformer.menuMusicHtml = this.menuMusicHtml;\n      this.menuMusicHtml.loop = true;\n      this.menuMusicHtml.volume = Phaser.Math.Clamp(volume, 0, 1);\n\n      const tryPlay = () => {\n        if (!this.menuMusicHtml) return;\n        if (settings.muteWhenUnfocused && document.hidden) return;\n        this.menuMusicHtml.play().catch(() => {});\n      };\n\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    } catch (_e) {\n      // Keep menu functional with no music.\n    }\n  }\n\n  stopMenuMusic() {\n    if (this.menuMusic && this.menuMusic.isPlaying) {\n      this.menuMusic.stop();\n    }\n    if (this.menuMusicHtml) {\n      this.menuMusicHtml.pause();\n      this.menuMusicHtml.currentTime = 0;\n      this.menuMusicHtml = null;\n    }\n    if (Platformer.menuMusicHtml) {\n      Platformer.menuMusicHtml.pause();\n      Platformer.menuMusicHtml.currentTime = 0;\n      Platformer.menuMusicHtml = null;\n    }\n  }\n\n  update(_time, delta) {\n    if (!this.introLines || this.introLines.length === 0) return;\n    const w = this.scale.width;\n    const dt = Math.max(0.001, delta / 1000);\n    this.introLines.forEach((line) => {\n      if (!line || !line.active) return;\n      line.x -= line.introSpeed * line.introParallax * dt;\n      if (line.x < -line.width - 10) {\n        line.x = w + Phaser.Math.Between(10, 80);\n      }\n    });\n    const t = _time * 0.001;\n    if (this.bgOrbs && this.bgOrbs.length === 2) {\n      this.bgOrbs[0].x = this.scale.width * 0.78 + Math.cos(t * 0.6) * 16;\n      this.bgOrbs[1].x = this.scale.width * 0.2 + Math.sin(t * 0.75) * 18;\n    }\n    this.updateMenuMiniStage(delta);\n  }\n\n  updateMenuMiniStage(delta) {\n    if (!this.menuRunner || !this.menuStage || !this.menuStage.lane) return;\n    const dt = Math.max(0.001, delta / 1000);\n    const lane = this.menuStage.lane;\n    const minX = lane.x + 26;\n    const maxX = lane.x + lane.width - 26;\n\n    if (!Number.isFinite(this.menuRunner.menuX)) this.menuRunner.menuX = minX + 40;\n    this.menuRunner.menuX += this.menuRunnerFace * this.menuRunnerSpeed * dt;\n    if (this.menuRunner.menuX <= minX) {\n      this.menuRunner.menuX = minX;\n      this.menuRunnerFace = 1;\n    } else if (this.menuRunner.menuX >= maxX) {\n      this.menuRunner.menuX = maxX;\n      this.menuRunnerFace = -1;\n    }\n\n    this.menuRunnerJumpCooldown -= delta;\n    this.menuRunnerDamageCooldown -= delta;\n    this.menuRunnerActionTimer -= delta;\n    const target = this.menuEnemies.find((e) => {\n      if (!e || !e.alive) return false;\n      const dx = e.menuX - this.menuRunner.menuX;\n      if (Math.abs(dx) > 120) return false;\n      return dx * this.menuRunnerFace > 0;\n    });\n    const grounded = this.menuRunner.y >= this.menuRunnerGroundY - 0.5;\n    const freestyleJump = grounded && this.menuRunnerActionTimer <= 0 && this.menuRunnerJumpCooldown <= 0 && Phaser.Math.Between(0, 100) < 12;\n    if ((target || freestyleJump) && grounded && this.menuRunnerJumpCooldown <= 0) {\n      this.menuRunnerVy = this.menuRunnerJumpVy;\n      this.menuRunnerJumpCooldown = target ? 520 : 900;\n      this.menuRunnerActionTimer = Phaser.Math.Between(650, 1300);\n    }\n\n    this.menuRunnerVy += this.menuRunnerGravity * dt;\n    this.menuRunner.y += this.menuRunnerVy * dt;\n    if (this.menuRunner.y > this.menuRunnerGroundY) {\n      this.menuRunner.y = this.menuRunnerGroundY;\n      this.menuRunnerVy = 0;\n    }\n\n    this.menuRunner.setFlipX(this.menuRunnerFace < 0);\n    if (this.menuRunnerVy < -30) this.menuRunner.setTexture(this.textureOr(\"player-jump\", \"player\"));\n    else if (this.menuRunnerVy > 70 && this.menuRunner.y < this.menuRunnerGroundY) this.menuRunner.setTexture(this.textureOr(\"player-jump\", \"player\"));\n    else this.menuRunner.setTexture(this.textureOr(Math.floor(this.time.now / 130) % 2 === 0 ? \"player-run-1\" : \"player-run-2\", \"player\"));\n    this.menuRunner.x = this.menuRunner.menuX;\n    if (this.time.now < this.menuRunnerDamageFlashUntil) {\n      const blinkOn = Math.floor(this.time.now / 70) % 2 === 0;\n      if (blinkOn) this.menuRunner.setTint(0xff4d4d);\n      else this.menuRunner.clearTint();\n    } else {\n      this.menuRunner.clearTint();\n    }\n\n    this.menuEnemies.forEach((enemy) => {\n      if (!enemy) return;\n      if (!enemy.alive) {\n        if (this.time.now >= enemy.respawnAt) {\n          enemy.alive = true;\n          enemy.setVisible(true);\n          enemy.setAlpha(1);\n          enemy.setScale(1, 1);\n          enemy.y = this.menuRunnerGroundY + 2;\n          enemy.menuX = Phaser.Math.Between(minX + 40, maxX - 40);\n          enemy.menuDir = Phaser.Math.Between(0, 1) ? 1 : -1;\n        }\n        return;\n      }\n\n      enemy.menuX += enemy.menuDir * enemy.menuSpeed * dt;\n      if (enemy.menuX <= minX + 18) {\n        enemy.menuX = minX + 18;\n        enemy.menuDir = 1;\n      } else if (enemy.menuX >= maxX - 18) {\n        enemy.menuX = maxX - 18;\n        enemy.menuDir = -1;\n      }\n      enemy.x = enemy.menuX;\n      enemy.setFlipX(enemy.menuDir < 0);\n      const stomp = Math.abs(this.menuRunner.x - enemy.x) < 18\n        && this.menuRunner.y < enemy.y - 10\n        && this.menuRunnerVy > 60;\n      if (stomp) {\n        enemy.alive = false;\n        enemy.respawnAt = this.time.now + Phaser.Math.Between(1300, 2200);\n        this.tweens.add({\n          targets: enemy,\n          scaleX: 1.35,\n          scaleY: 0.45,\n          alpha: 0.25,\n          duration: 120,\n          onComplete: () => {\n            if (enemy && enemy.active) enemy.setVisible(false);\n          },\n        });\n        const puff = this.add.circle(enemy.x, enemy.y - 6, 6, 0xffffff, 0.95).setDepth(8.25).setBlendMode(Phaser.BlendModes.ADD);\n        this.menuStage.add(puff);\n        this.tweens.add({\n          targets: puff,\n          scale: 3.1,\n          alpha: 0,\n          duration: 260,\n          ease: \"Cubic.Out\",\n          onComplete: () => puff.destroy(),\n        });\n        this.menuRunnerVy = -190;\n        return;\n      }\n\n      const sideHit = Math.abs(this.menuRunner.x - enemy.x) < 22\n        && Math.abs(this.menuRunner.y - enemy.y) < 24\n        && this.menuRunnerDamageCooldown <= 0;\n      if (sideHit) {\n        this.menuRunnerDamageCooldown = 700;\n        this.menuRunnerDamageFlashUntil = this.time.now + 420;\n        this.menuRunnerVy = -120;\n        this.menuRunnerFace = this.menuRunner.x < enemy.x ? -1 : 1;\n        this.menuRunner.menuX += this.menuRunnerFace * 20;\n        this.menuRunner.menuX = Phaser.Math.Clamp(this.menuRunner.menuX, minX, maxX);\n      }\n    });\n    this.saveMenuMiniStageState();\n  }\n\n  textureOr(textureKey, fallbackKey) {\n    if (textureKey && this.textures.exists(textureKey)) return textureKey;\n    if (fallbackKey && this.textures.exists(fallbackKey)) return fallbackKey;\n    return \"__WHITE\";\n  }\n\n  shutdown() {\n    // Keep menu music alive across Menu <-> Options transitions.\n    this.saveMenuMiniStageState();\n    if (this.onResize) {\n      this.scale.off(\"resize\", this.onResize);\n      this.onResize = null;\n    }\n    if (this.introParticles) {\n      this.introParticles.destroy();\n      this.introParticles = null;\n    }\n    if (this.introFx) {\n      this.introFx.destroy(true);\n      this.introFx = null;\n    }\n    if (this.introGlow) {\n      this.introGlow.destroy();\n      this.introGlow = null;\n    }\n    if (this.menuStage) {\n      this.menuStage.destroy(true);\n      this.menuStage = null;\n    }\n    this.menuRunner = null;\n    this.menuEnemies = [];\n    this.bgOrbs = [];\n    this.introLines = [];\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.IntroScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"IntroScene\");\n    this.slideIndex = 0;\n    this.slides = [];\n  }\n\n  create() {\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n    const textScale = Platformer.Settings.textScale();\n\n    this.slides = [\n      {\n        title: \"Mission Briefing\",\n        body: \"Complete 4 levels by collecting 10 coins each.\\nBeat the timer and use checkpoints to survive.\",\n      },\n      {\n        title: \"Hazards + Enemies\",\n        body: \"Laser turrets launch fireballs.\\nEnemy types per level: Walker, Hopper, Dasher, Tank.\\nStomp enemies from above to defeat.\",\n      },\n      {\n        title: \"Controls\",\n        body: \"Move: Left/Right\\nJump: Jump key (rebindable)\\nDash: Dash key (burst + enemy break)\\nAttack: Attack key (close-range hit)\\nPause: Pause key\\nTip: F2 = demo instant win\",\n      },\n      {\n        title: \"Coin Rewards\",\n        body: \"3 Coins: +1 Health\\n6 Coins: +12s Time\\n9 Coins: +1 Shield block\\n10 Coins: Level clear\",\n      },\n    ];\n\n    this.add.rectangle(cx, cy, this.scale.width, this.scale.height, 0x020617, 0.55);\n\n    this.add.text(cx, 70, \"LEVEL PREVIEW\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(42 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#0f172a\",\n      strokeThickness: 6,\n    }).setOrigin(0.5);\n\n    this.panel = this.add.rectangle(cx, cy + 10, 760, 320, 0x0f172a, 0.58)\n      .setStrokeStyle(2, 0x94a3b8, 0.9);\n\n    this.titleText = this.add.text(cx, cy - 86, \"\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(34 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#111827\",\n      strokeThickness: 4,\n    }).setOrigin(0.5);\n\n    this.bodyText = this.add.text(cx, cy - 4, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(24 * textScale)}px`,\n      color: \"#e2e8f0\",\n      align: \"center\",\n      lineSpacing: 10,\n    }).setOrigin(0.5);\n\n    this.pageText = this.add.text(cx - 340, cy + 136, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(18 * textScale)}px`,\n      color: \"#cbd5e1\",\n    }).setOrigin(0, 0.5);\n\n    this.nextBtn = this.add.rectangle(cx + 280, cy + 136, 170, 44, 0x1d4ed8, 0.98)\n      .setStrokeStyle(2, 0x93c5fd)\n      .setInteractive({ useHandCursor: true });\n    this.nextBtnText = this.add.text(cx + 280, cy + 136, \"Next >\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(25 * textScale)}px`,\n      color: \"#f8fafc\",\n    }).setOrigin(0.5);\n\n    this.skipBtn = this.add.rectangle(cx + 90, cy + 136, 140, 44, 0x475569, 0.96)\n      .setStrokeStyle(2, 0x94a3b8)\n      .setInteractive({ useHandCursor: true });\n    this.skipText = this.add.text(cx + 90, cy + 136, \"Skip\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(24 * textScale)}px`,\n      color: \"#f8fafc\",\n    }).setOrigin(0.5);\n\n    this.nextBtn.on(\"pointerdown\", () => this.next());\n    this.skipBtn.on(\"pointerdown\", () => this.startGame());\n\n    this.input.keyboard.on(\"keydown-ENTER\", () => this.next());\n    this.input.keyboard.on(\"keydown-SPACE\", () => this.next());\n    this.input.keyboard.on(\"keydown-ESC\", () => this.scene.start(\"MenuScene\"));\n\n    this.renderSlide();\n  }\n\n  renderSlide() {\n    const s = this.slides[this.slideIndex];\n    this.titleText.setText(s.title);\n    this.bodyText.setText(s.body);\n    this.pageText.setText(`Preview ${this.slideIndex + 1}/${this.slides.length}`);\n\n    const isLast = this.slideIndex === this.slides.length - 1;\n    this.nextBtn.setFillStyle(isLast ? 0x16a34a : 0x1d4ed8, 0.98);\n    this.nextBtnText.setText(isLast ? \"Start Game\" : \"Next >\");\n  }\n\n  next() {\n    if (this.slideIndex < this.slides.length - 1) {\n      this.slideIndex += 1;\n      this.renderSlide();\n      return;\n    }\n    this.startGame();\n  }\n\n  startGame() {\n    Platformer.Settings.current.convenience.introSeen = true;\n    Platformer.Settings.save();\n\n    Platformer.beeper.unlock();\n    const difficulty = Platformer.Settings.current.gameplay.difficulty;\n    const baseLives = difficulty === \"easy\" ? 3 : (difficulty === \"hard\" ? 1 : 2);\n\n    if (this.scene.isActive(\"UIScene\") || this.scene.isPaused(\"UIScene\")) {\n      this.scene.stop(\"UIScene\");\n    }\n    if (this.scene.isActive(\"GameScene\") || this.scene.isPaused(\"GameScene\")) {\n      this.scene.stop(\"GameScene\");\n    }\n\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"health\", 3);\n    this.registry.set(\"lives\", baseLives);\n    this.registry.set(\"level\", 1);\n    this.scene.start(\"GameScene\", { level: 1 });\n    this.scene.launch(\"UIScene\");\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.OptionsScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"OptionsScene\");\n    this.awaitingControl = null;\n    this.rebindHint = null;\n    this.dom = null;\n    this.boundKeydown = null;\n    this.returnTo = \"menu\";\n    this.backBtn = null;\n    this.bgSky = null;\n    this.bgMid = null;\n    this.bgGround = null;\n    this.bgAccentTop = null;\n    this.bgAccentBottom = null;\n    this.bgOrbs = [];\n    this.bgLines = [];\n    this.onResize = null;\n    this.overlayShade = null;\n    this.titleText = null;\n    this.hintText = null;\n    this.backBtnText = null;\n    this.domWrap = null;\n    this.optScrollEl = null;\n    this.boundDomWheel = null;\n  }\n\n  init(data) {\n    this.returnTo = data && data.returnTo ? data.returnTo : \"menu\";\n    if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", `Opened (returnTo=${this.returnTo}).`);\n  }\n\n  create() {\n    const s = Platformer.Settings.current;\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n\n    if (this.returnTo === \"menuOverlay\") {\n      // Menu scene stays running underneath for a live transparent backdrop.\n      this.overlayShade = this.add.rectangle(cx, cy, this.scale.width, this.scale.height, 0x020617, 0.42)\n        .setDepth(0)\n        .setInteractive();\n    } else {\n      this.createMenuLikeBackdrop();\n      this.layoutBackdrop();\n    }\n    this.titleText = this.add.text(cx, 48, \"OPTIONS\", {\n      fontFamily: \"Verdana\",\n      fontSize: \"42px\",\n      color: \"#f8fafc\",\n      stroke: \"#0f172a\",\n      strokeThickness: 6,\n    }).setOrigin(0.5);\n\n    this.rebindHint = this.add.text(cx, 92, \"Click a key button to rebind. Press ESC to return.\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"18px\",\n      color: \"#cbd5e1\",\n    }).setOrigin(0.5);\n\n    const wrap = document.createElement(\"div\");\n    wrap.style.width = \"min(1180px, 94vw)\";\n    wrap.style.maxHeight = \"74vh\";\n    wrap.style.overflowY = \"hidden\";\n    wrap.style.padding = \"6px\";\n    wrap.style.display = \"flex\";\n    wrap.style.flexDirection = \"column\";\n    wrap.style.position = \"relative\";\n    wrap.style.fontFamily = \"Consolas, monospace\";\n    wrap.style.color = \"#e2e8f0\";\n\n    const css = `\n      <style>\n        .opt-grid { display:grid; grid-template-columns: repeat(2, minmax(340px, 1fr)); gap: 12px; }\n        .opt-scroll {\n          overflow-y:auto;\n          flex:1 1 auto;\n          min-height: 0;\n          height: 100%;\n          padding-right: 10px;\n          padding-bottom: 84px;\n          box-sizing: border-box;\n        }\n        .opt-card { background: rgba(15,23,42,0.82); border:2px solid #334155; border-radius:10px; padding: 12px; box-shadow: 0 6px 18px rgba(2,6,23,0.35); }\n        .opt-title { margin: 0 0 10px 0; color:#f8fafc; font-size: 22px; letter-spacing: 0.5px; }\n        .opt-row { display:flex; justify-content:space-between; align-items:center; gap:10px; margin: 8px 0; }\n        .opt-row > span { color:#cbd5e1; }\n        .opt-card select, .opt-card input[type=\"text\"], .opt-card button {\n          background:#1e293b; color:#e2e8f0; border:1px solid #475569; border-radius:6px; padding: 4px 8px; font-family:inherit;\n        }\n        .opt-card input[type=\"range\"] { width: 170px; }\n        .opt-actions {\n          display:flex; gap:10px; justify-content:flex-end;\n          position: absolute; left: 8px; right: 8px; bottom: 8px; z-index: 5;\n          background: rgba(2,6,23,0.92); border: 1px solid #334155; border-radius: 8px; padding: 10px;\n        }\n        .opt-actions button { background:#0f172a; color:#f8fafc; border:2px solid #64748b; border-radius:8px; padding:8px 12px; cursor:pointer; }\n        .opt-actions #saveBack { border-color:#22d3ee; }\n        @media (max-width: 900px) { .opt-grid { grid-template-columns: 1fr; } }\n      </style>\n    `;\n    const cardStart = (title) => `<section class=\"opt-card\"><h3 class=\"opt-title\">${title}</h3>`;\n    const cardEnd = () => `</section>`;\n    const row = (label, control) => `<div class=\"opt-row\"><span>${label}</span><span>${control}</span></div>`;\n\n    wrap.innerHTML = [\n      css,\n      `<div class=\"opt-scroll\"><div class=\"opt-grid\">`,\n      cardStart(\"Gameplay\"),\n      row(\"Difficulty\", `<select id=\"difficulty\"><option value=\"easy\">Easy</option><option value=\"normal\">Normal</option><option value=\"hard\">Hard</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Controls\"),\n      row(\"Left\", `<button data-bind=\"left\">${s.controls.left}</button>`),\n      row(\"Right\", `<button data-bind=\"right\">${s.controls.right}</button>`),\n      row(\"Jump\", `<button data-bind=\"jump\">${s.controls.jump}</button>`),\n      row(\"Dash\", `<button data-bind=\"dash\">${s.controls.dash}</button>`),\n      row(\"Attack\", `<button data-bind=\"attack\">${s.controls.attack}</button>`),\n      row(\"Interact\", `<button data-bind=\"interact\">${s.controls.interact}</button>`),\n      row(\"Pause\", `<button data-bind=\"pause\">${s.controls.pause}</button>`),\n      cardEnd(),\n\n      cardStart(\"Accessibility\"),\n      row(\"Text size\", `<select id=\"textSize\"><option value=\"small\">Small</option><option value=\"medium\">Medium</option><option value=\"large\">Large</option></select>`),\n      row(\"Colorblind mode\", `<select id=\"colorblindMode\"><option value=\"off\">Off</option><option value=\"protanopia\">Protanopia</option><option value=\"deuteranopia\">Deuteranopia</option><option value=\"tritanopia\">Tritanopia</option></select>`),\n      row(\"Reduce screen shake\", `<input id=\"reduceScreenShake\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"reduceScreenShakeVal\"></span>`),\n      row(\"Reduced motion\", `<select id=\"reducedMotion\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Flash reduction\", `<select id=\"flashReduction\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Subtitles\", `<select id=\"subtitles\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Audio cues\", `<select id=\"audioCues\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Video\"),\n      row(\"Fullscreen\", `<select id=\"fullscreen\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Resolution scale\", `<input id=\"resolutionScale\" type=\"range\" min=\"50\" max=\"100\" step=\"1\" /><span id=\"resolutionScaleVal\"></span>`),\n      row(\"Pixel-perfect\", `<select id=\"pixelPerfect\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"VSync\", `<select id=\"vsync\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"FPS cap\", `<select id=\"fpsCap\"><option value=\"30\">30</option><option value=\"60\">60</option><option value=\"unlimited\">Unlimited</option></select>`),\n      row(\"Camera smoothing\", `<input id=\"cameraSmoothing\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"cameraSmoothingVal\"></span>`),\n      row(\"Brightness\", `<input id=\"brightness\" type=\"range\" min=\"0.8\" max=\"1.2\" step=\"0.01\" /><span id=\"brightnessVal\"></span>`),\n      cardEnd(),\n\n      cardStart(\"Audio\"),\n      row(\"Master volume\", `<input id=\"master\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"masterVal\"></span>`),\n      row(\"Music volume\", `<input id=\"music\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"musicVal\"></span>`),\n      row(\"SFX volume\", `<input id=\"sfx\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"sfxVal\"></span>`),\n      row(\"UI volume\", `<input id=\"ui\" type=\"range\" min=\"0\" max=\"100\" step=\"1\" /><span id=\"uiVal\"></span>`),\n      row(\"Dynamic range\", `<select id=\"dynamicRange\"><option value=\"night\">Night</option><option value=\"normal\">Normal</option><option value=\"wide\">Wide</option></select>`),\n      row(\"Mute when unfocused\", `<select id=\"muteWhenUnfocused\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Save / Convenience\"),\n      row(\"Auto-save\", `<select id=\"autoSave\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Checkpoint frequency\", `<select id=\"checkpointFrequency\"><option value=\"sparse\">Sparse</option><option value=\"standard\">Standard</option><option value=\"frequent\">Frequent</option></select>`),\n      row(\"Speedrun mode\", `<select id=\"speedrunMode\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      cardEnd(),\n\n      cardStart(\"Updates\"),\n      row(\"Online update check\", `<select id=\"updatesEnabled\"><option value=\"off\">Off</option><option value=\"on\">On</option></select>`),\n      row(\"Auto update + restart\", `<select id=\"autoUpdate\"><option value=\"on\">On</option><option value=\"off\">Off</option></select>`),\n      row(\"Update source\", `<input id=\"updateSource\" type=\"text\" readonly style=\"opacity:0.85\" />`),\n      row(\"Current version\", `<input id=\"currentVersion\" type=\"text\" readonly style=\"opacity:0.85\" />`),\n      cardEnd(),\n      `</div></div>`,\n\n      `<div class=\"opt-actions\">`,\n      `<button id=\"resetDefaults\">Reset defaults</button>`,\n      `<button id=\"saveBack\">Save + Back</button>`,\n      `</div>`,\n    ].join(\"\");\n\n    this.domWrap = wrap;\n    this.dom = this.add.dom(cx, cy + 28, wrap);\n    this.backBtn = this.add.rectangle(96, 44, 156, 46, 0xdc2626, 0.98)\n      .setStrokeStyle(3, 0xfee2e2)\n      .setOrigin(0, 0.5)\n      .setScrollFactor(0)\n      .setDepth(40)\n      .setInteractive({ useHandCursor: true });\n    this.backBtnText = this.add.text(96, 44, \"< BACK\", {\n      fontFamily: \"Consolas\",\n      fontSize: \"28px\",\n      color: \"#ffffff\",\n      stroke: \"#450a0a\",\n      strokeThickness: 5,\n    }).setOrigin(0, 0.5).setDepth(41);\n    this.backBtn.on(\"pointerdown\", async () => {\n      await applyAndSave();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Back button pressed.\");\n      this.goBack();\n    });\n\n    const val = (id) => wrap.querySelector(`#${id}`);\n    this.optScrollEl = wrap.querySelector(\".opt-scroll\");\n    if (this.optScrollEl) {\n      this.boundDomWheel = (event) => {\n        this.optScrollEl.scrollTop += event.deltaY;\n        event.preventDefault();\n        event.stopPropagation();\n      };\n      this.optScrollEl.addEventListener(\"wheel\", this.boundDomWheel, { passive: false });\n    }\n    const setSelect = (id, v) => { val(id).value = v; };\n    const setRange = (id, v, suffix = \"%\") => {\n      val(id).value = String(v);\n      const txt = val(`${id}Val`);\n      if (txt) txt.textContent = `${v}${suffix}`;\n    };\n\n    setSelect(\"difficulty\", s.gameplay.difficulty);\n    setSelect(\"textSize\", s.accessibility.textSize);\n    setSelect(\"colorblindMode\", s.accessibility.colorblindMode);\n    setRange(\"reduceScreenShake\", s.accessibility.reduceScreenShake);\n    setSelect(\"reducedMotion\", s.accessibility.reducedMotion ? \"on\" : \"off\");\n    setSelect(\"flashReduction\", s.accessibility.flashReduction ? \"on\" : \"off\");\n    setSelect(\"subtitles\", s.accessibility.subtitles ? \"on\" : \"off\");\n    setSelect(\"audioCues\", s.accessibility.audioCues ? \"on\" : \"off\");\n\n    setSelect(\"fullscreen\", s.video.fullscreen ? \"on\" : \"off\");\n    setRange(\"resolutionScale\", s.video.resolutionScale);\n    setSelect(\"pixelPerfect\", s.video.pixelPerfect ? \"on\" : \"off\");\n    setSelect(\"vsync\", s.video.vsync ? \"on\" : \"off\");\n    setSelect(\"fpsCap\", s.video.fpsCap);\n    setRange(\"cameraSmoothing\", s.video.cameraSmoothing);\n    setRange(\"brightness\", s.video.brightness.toFixed(2), \"\");\n\n    setRange(\"master\", s.audio.master);\n    setRange(\"music\", s.audio.music);\n    setRange(\"sfx\", s.audio.sfx);\n    setRange(\"ui\", s.audio.ui);\n    setSelect(\"dynamicRange\", s.audio.dynamicRange);\n    setSelect(\"muteWhenUnfocused\", s.audio.muteWhenUnfocused ? \"on\" : \"off\");\n\n    setSelect(\"autoSave\", s.convenience.autoSave ? \"on\" : \"off\");\n    setSelect(\"checkpointFrequency\", s.convenience.checkpointFrequency);\n    setSelect(\"speedrunMode\", s.convenience.speedrunMode ? \"on\" : \"off\");\n    setSelect(\"updatesEnabled\", s.updates.enabled ? \"on\" : \"off\");\n    setSelect(\"autoUpdate\", s.updates.autoUpdate === false ? \"off\" : \"on\");\n    val(\"updateSource\").value = s.updates.source || \"GitHub Releases\";\n    val(\"currentVersion\").value = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || s.updates.currentVersion || \"1.0.0\";\n\n    [\"reduceScreenShake\", \"resolutionScale\", \"cameraSmoothing\", \"brightness\", \"master\", \"music\", \"sfx\", \"ui\"].forEach((id) => {\n      val(id).addEventListener(\"input\", () => {\n        const suffix = id === \"brightness\" ? \"\" : \"%\";\n        val(`${id}Val`).textContent = `${val(id).value}${suffix}`;\n      });\n    });\n\n    wrap.querySelectorAll(\"[data-bind]\").forEach((btn) => {\n      btn.addEventListener(\"click\", () => {\n        this.awaitingControl = btn.getAttribute(\"data-bind\");\n        if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.rebind\", `Awaiting key for ${this.awaitingControl}`);\n        this.rebindHint.setText(`Press a key for ${this.awaitingControl.toUpperCase()}...`);\n      });\n    });\n\n    const applyAndSave = async () => {\n      const c = Platformer.Settings.current;\n      c.gameplay.difficulty = val(\"difficulty\").value;\n\n      c.accessibility.textSize = val(\"textSize\").value;\n      c.accessibility.colorblindMode = val(\"colorblindMode\").value;\n      c.accessibility.reduceScreenShake = Number(val(\"reduceScreenShake\").value);\n      c.accessibility.reducedMotion = val(\"reducedMotion\").value === \"on\";\n      c.accessibility.flashReduction = val(\"flashReduction\").value === \"on\";\n      c.accessibility.subtitles = val(\"subtitles\").value === \"on\";\n      c.accessibility.audioCues = val(\"audioCues\").value === \"on\";\n\n      c.video.fullscreen = val(\"fullscreen\").value === \"on\";\n      c.video.resolutionScale = Number(val(\"resolutionScale\").value);\n      c.video.pixelPerfect = val(\"pixelPerfect\").value === \"on\";\n      c.video.vsync = val(\"vsync\").value === \"on\";\n      c.video.fpsCap = val(\"fpsCap\").value;\n      c.video.cameraSmoothing = Number(val(\"cameraSmoothing\").value);\n      c.video.brightness = Number(val(\"brightness\").value);\n\n      c.audio.master = Number(val(\"master\").value);\n      c.audio.music = Number(val(\"music\").value);\n      c.audio.sfx = Number(val(\"sfx\").value);\n      c.audio.ui = Number(val(\"ui\").value);\n      c.audio.dynamicRange = val(\"dynamicRange\").value;\n      c.audio.muteWhenUnfocused = val(\"muteWhenUnfocused\").value === \"on\";\n\n      c.convenience.autoSave = val(\"autoSave\").value === \"on\";\n      c.convenience.checkpointFrequency = val(\"checkpointFrequency\").value;\n      c.convenience.speedrunMode = val(\"speedrunMode\").value === \"on\";\n\n      c.updates.enabled = val(\"updatesEnabled\").value === \"on\";\n      c.updates.autoUpdate = val(\"autoUpdate\").value === \"on\";\n      c.updates.source = \"GitHub Releases\";\n      c.updates.currentVersion = (Platformer.BUILD_VERSION && String(Platformer.BUILD_VERSION).trim()) || \"1.0.0\";\n      c.updates.manifestUrl = \"\";\n      c.updates.downloadUrl = \"\";\n\n      await Platformer.Settings.save();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Settings saved.\");\n      this.applyRuntimeVideoSettings();\n    };\n\n    wrap.querySelector(\"#saveBack\").addEventListener(\"click\", async () => {\n      await applyAndSave();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Save + Back pressed.\");\n      this.goBack();\n    });\n\n    wrap.querySelector(\"#resetDefaults\").addEventListener(\"click\", () => {\n      Platformer.Settings.reset();\n      if (Platformer.Debug) Platformer.Debug.warn(\"OptionsScene\", \"Settings reset to defaults.\");\n      this.scene.restart();\n    });\n\n    this.boundKeydown = (event) => {\n      if (!this.awaitingControl) return;\n      event.preventDefault();\n      const key = this.normalizeKey(event);\n      Platformer.Settings.current.controls[this.awaitingControl] = key;\n      Platformer.Settings.save();\n      const btn = wrap.querySelector(`[data-bind=\"${this.awaitingControl}\"]`);\n      if (btn) btn.textContent = key;\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.rebind\", `${this.awaitingControl} -> ${key}`);\n      this.rebindHint.setText(`${this.awaitingControl.toUpperCase()} bound to ${key}`);\n      this.awaitingControl = null;\n    };\n\n    window.addEventListener(\"keydown\", this.boundKeydown, true);\n    this.events.once(\"shutdown\", () => this.cleanup());\n    if (this.returnTo !== \"menuOverlay\") {\n      this.onResize = () => this.layoutOptions();\n      this.scale.on(\"resize\", this.onResize);\n    } else {\n      this.onResize = () => this.layoutOptions();\n      this.scale.on(\"resize\", this.onResize);\n    }\n    this.layoutOptions();\n\n    this.input.keyboard.on(\"keydown-ESC\", async () => {\n      if (this.awaitingControl) {\n        this.awaitingControl = null;\n        if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene.rebind\", \"Rebind cancelled with ESC.\");\n        this.rebindHint.setText(\"Click a key button to rebind. Press ESC to return.\");\n        return;\n      }\n      await applyAndSave();\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"ESC save + back.\");\n      this.goBack();\n    });\n  }\n\n  createMenuLikeBackdrop() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    this.bgSky = this.add.rectangle(0, 0, w, h, 0x081336, 0.62).setOrigin(0, 0);\n    this.bgMid = this.add.rectangle(0, 0, w, 220, 0x132a56, 0.52).setOrigin(0, 0);\n    this.bgGround = this.add.rectangle(0, 0, w, 120, 0x0b6f49, 0.46).setOrigin(0, 0);\n    this.bgAccentTop = this.add.rectangle(0, 0, w, Math.round(h * 0.42), 0x1e3a8a, 0.16).setOrigin(0, 0);\n    this.bgAccentBottom = this.add.rectangle(0, 0, w, Math.round(h * 0.2), 0x34d399, 0.13).setOrigin(0, 0);\n\n    const orbA = this.add.circle(w * 0.78, h * 0.22, 150, 0x53e0ff, 0.08).setBlendMode(Phaser.BlendModes.ADD);\n    const orbB = this.add.circle(w * 0.2, h * 0.3, 110, 0xff71c7, 0.07).setBlendMode(Phaser.BlendModes.ADD);\n    this.bgOrbs = [orbA, orbB];\n\n    this.bgLines = [];\n    for (let i = 0; i < 10; i += 1) {\n      const line = this.add.rectangle(\n        Phaser.Math.Between(0, w),\n        Phaser.Math.Between(40, h - 80),\n        Phaser.Math.Between(70, 150),\n        2,\n        i % 3 === 0 ? 0xff71c7 : 0x53e0ff,\n        0.18\n      ).setOrigin(0, 0.5);\n      line.moveSpeed = Phaser.Math.FloatBetween(26, 62);\n      this.bgLines.push(line);\n    }\n  }\n\n  layoutBackdrop() {\n    if (!this.bgSky) return;\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const cy = h / 2;\n    this.bgSky.setSize(w, h).setPosition(0, 0);\n    this.bgMid.setSize(w, 220).setPosition(0, cy + 160);\n    this.bgGround.setSize(w, 120).setPosition(0, cy + 220);\n    this.bgAccentTop.setSize(w, Math.round(h * 0.42)).setPosition(0, 0);\n    this.bgAccentBottom.setSize(w, Math.round(h * 0.2)).setPosition(0, h - Math.round(h * 0.24));\n  }\n\n  layoutOptions() {\n    const w = this.scale.width;\n    const h = this.scale.height;\n    const cx = w / 2;\n    const cy = h / 2;\n    this.layoutBackdrop();\n    if (this.overlayShade) {\n      this.overlayShade.setPosition(cx, cy).setSize(w, h);\n    }\n    if (this.titleText) this.titleText.setPosition(cx, 48);\n    if (this.rebindHint) this.rebindHint.setPosition(cx, 92);\n\n    if (this.domWrap) {\n      const panelH = Math.floor(Math.max(320, h * 0.74));\n      this.domWrap.style.width = `${Math.floor(Math.min(1180, w * 0.94))}px`;\n      this.domWrap.style.maxHeight = `${panelH}px`;\n      this.domWrap.style.height = `${panelH}px`;\n    }\n    if (this.optScrollEl) {\n      this.optScrollEl.style.height = \"100%\";\n      this.optScrollEl.style.maxHeight = \"100%\";\n      this.optScrollEl.style.overflowY = \"auto\";\n    }\n    const topY = 130;\n    const panelH = Math.floor(Math.max(320, h * 0.74));\n    const domY = Math.min(cy + 28, topY + (panelH / 2));\n    if (this.dom) {\n      this.dom.setPosition(cx, domY);\n      if (typeof this.dom.updateSize === \"function\") this.dom.updateSize();\n    }\n\n    if (this.backBtn) this.backBtn.setPosition(14, 44);\n    if (this.backBtnText) this.backBtnText.setPosition(36, 44);\n  }\n\n  goBack() {\n    if (this.returnTo === \"menuOverlay\") {\n      const menuScene = this.scene.get(\"MenuScene\");\n      if (menuScene && typeof menuScene.setMenuInteractive === \"function\") {\n        if (typeof menuScene.setMenuUiVisible === \"function\") menuScene.setMenuUiVisible(true);\n        menuScene.setMenuInteractive(true);\n      }\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Returning to live main menu overlay.\");\n      this.scene.stop();\n      return;\n    }\n    if (this.returnTo === \"pause\") {\n      if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Returning to pause menu.\");\n      this.scene.stop();\n      this.game.events.emit(\"options-closed-to-pause\");\n      return;\n    }\n    if (Platformer.Debug) Platformer.Debug.log(\"OptionsScene\", \"Returning to main menu.\");\n    this.scene.start(\"MenuScene\");\n  }\n\n  normalizeKey(event) {\n    const k = (event.key || \"\").toUpperCase();\n    if (k === \" \") return \"SPACE\";\n    if (k === \"ESCAPE\") return \"ESC\";\n    if (k === \"ARROWLEFT\") return \"LEFT\";\n    if (k === \"ARROWRIGHT\") return \"RIGHT\";\n    if (k === \"ARROWUP\") return \"UP\";\n    if (k === \"ARROWDOWN\") return \"DOWN\";\n    if (k === \"CONTROL\") return \"CTRL\";\n    return k;\n  }\n\n  applyRuntimeVideoSettings() {\n    const s = Platformer.Settings.current.video;\n    if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.set_fullscreen === \"function\") {\n      window.pywebview.api.set_fullscreen(!!s.fullscreen)\n        .then((res) => {\n          if (res && res.ok) {\n            if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", `native fullscreen=${res.fullscreen}`);\n          } else if (Platformer.Debug) {\n            Platformer.Debug.warn(\"Options.fullscreen\", (res && res.message) || \"native fullscreen call failed\");\n          }\n        })\n        .catch((err) => {\n          if (Platformer.Debug) Platformer.Debug.warn(\"Options.fullscreen\", `native fullscreen error: ${err && err.message ? err.message : err}`);\n        });\n      return;\n    }\n\n    if (s.fullscreen && !this.scale.isFullscreen) {\n      this.scale.startFullscreen();\n      if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", \"browser fullscreen start requested\");\n    }\n    if (!s.fullscreen && this.scale.isFullscreen) {\n      this.scale.stopFullscreen();\n      if (Platformer.Debug) Platformer.Debug.log(\"Options.fullscreen\", \"browser fullscreen stop requested\");\n    }\n  }\n\n  shutdown() {\n    this.cleanup();\n  }\n\n  cleanup() {\n    if (this.returnTo === \"menuOverlay\") {\n      const menuScene = this.scene.get(\"MenuScene\");\n      if (menuScene) {\n        if (typeof menuScene.setMenuUiVisible === \"function\") menuScene.setMenuUiVisible(true);\n        if (typeof menuScene.setMenuInteractive === \"function\") menuScene.setMenuInteractive(true);\n      }\n    }\n    if (this.onResize) {\n      this.scale.off(\"resize\", this.onResize);\n      this.onResize = null;\n    }\n    if (this.optScrollEl && this.boundDomWheel) {\n      this.optScrollEl.removeEventListener(\"wheel\", this.boundDomWheel);\n    }\n    this.boundDomWheel = null;\n    this.optScrollEl = null;\n    if (this.boundKeydown) {\n      window.removeEventListener(\"keydown\", this.boundKeydown, true);\n      this.boundKeydown = null;\n    }\n  }\n\n  update(time, delta) {\n    const dt = Math.max(0.001, delta / 1000);\n    const w = this.scale.width;\n    this.bgLines.forEach((line) => {\n      if (!line || !line.active) return;\n      line.x -= line.moveSpeed * dt;\n      if (line.x < -line.width - 10) line.x = w + Phaser.Math.Between(10, 80);\n    });\n    const t = time * 0.001;\n    if (this.bgOrbs && this.bgOrbs.length === 2) {\n      this.bgOrbs[0].x = this.scale.width * 0.78 + Math.cos(t * 0.6) * 16;\n      this.bgOrbs[1].x = this.scale.width * 0.2 + Math.sin(t * 0.75) * 18;\n    }\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.GameScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"GameScene\");\n    this.solids = null;\n    this.oneWays = null;\n    this.hazards = null;\n    this.coins = null;\n    this.enemies = null;\n    this.checkpoints = null;\n    this.player = null;\n    this.cursors = null;\n    this.keys = null;\n    this.respawnPoint = new Phaser.Math.Vector2(64, 64);\n    this.lastOnGroundTime = 0;\n    this.lastJumpPressedTime = -9999;\n    this.isJumpHeld = false;\n    this.jumpsUsed = 0;\n    this.lastDamageTime = -9999;\n    this.isDead = false;\n    this.spawnPoint = new Phaser.Math.Vector2(64, 64);\n    this.mapRows = [];\n    this.mapWidth = 0;\n    this.mapHeight = 0;\n    this.levelComplete = false;\n    this.parallax = [];\n    this.lastEnemyEdgeCheckTime = 0;\n    this.playerHealthBarBg = null;\n    this.playerHealthBarFill = null;\n    this.hazardProjectiles = null;\n    this.hazardShooters = [];\n    this.lastHazardShotAt = 0;\n    this.projectileIntervalMs = 1200;\n    this.projectileSpeed = 220;\n    this.levelTimeRemainingMs = 90000;\n    this.lastTickTime = 0;\n    this.lastTimerSecond = -1;\n    this.threatActive = false;\n    this.idleAnimWarned = false;\n    this.useImportedCharacter = false;\n    this.diagLastAt = 0;\n    this.diagCooldowns = {};\n    this.facingDir = 1;\n    this.isDashing = false;\n    this.dashEndsAt = 0;\n    this.lastDashAt = -9999;\n    this.attackActiveUntil = 0;\n    this.lastAttackAt = -9999;\n    this.wasGroundedLastFrame = false;\n    this.airbornePeakSpeedY = 0;\n    this.coinRewardState = {};\n    this.shieldCharges = 0;\n    this.lastAuxHudAt = 0;\n  }\n\n  init(data) {\n    const settings = Platformer.Settings.current;\n    const difficulty = settings.gameplay.difficulty;\n    const startLives = difficulty === \"easy\" ? 3 : (difficulty === \"hard\" ? 1 : 2);\n    const timerSeconds = difficulty === \"easy\" ? 120 : (difficulty === \"hard\" ? 70 : 90);\n    const carryState = !!(data && data.carryState);\n\n    this.currentLevel = data.level || 1;\n    this.registry.set(\"level\", this.currentLevel);\n    if (!carryState) {\n      this.registry.set(\"health\", 3);\n      this.registry.set(\"lives\", startLives);\n    } else {\n      this.registry.set(\"health\", Math.max(1, this.registry.get(\"health\") || 3));\n      this.registry.set(\"lives\", Math.max(1, this.registry.get(\"lives\") || startLives));\n    }\n    this.registry.set(\"coins\", 0);\n    this.registry.set(\"timeLeft\", timerSeconds);\n    this.registry.set(\"threat\", \"CALM\");\n    this.registry.set(\"dashCd\", 0);\n    this.registry.set(\"shield\", 0);\n    this.isDead = false;\n    this.levelComplete = false;\n    this.levelTimeRemainingMs = timerSeconds * 1000;\n    this.lastTickTime = 0;\n    this.lastTimerSecond = -1;\n    this.lastHazardShotAt = 0;\n    this.threatActive = false;\n    this.facingDir = 1;\n    this.isDashing = false;\n    this.dashEndsAt = 0;\n    this.lastDashAt = -9999;\n    this.attackActiveUntil = 0;\n    this.lastAttackAt = -9999;\n    this.wasGroundedLastFrame = false;\n    this.airbornePeakSpeedY = 0;\n    this.coinRewardState = {};\n    this.shieldCharges = 0;\n    this.lastAuxHudAt = 0;\n  }\n\n  create() {\n    const { PLAYER, TILE } = Platformer.Config;\n    const settings = Platformer.Settings.current;\n    const difficulty = settings.gameplay.difficulty;\n    const checkpointMode = settings.convenience.checkpointFrequency;\n\n    this.mapRows = Platformer.createLevelData(this.currentLevel || 1);\n    this.mapHeight = this.mapRows.length;\n    this.mapWidth = this.mapRows[0].length;\n    this.normalizeTurretTiles();\n    this.normalizeEnemyTiles();\n\n    this.physics.world.gravity.y = PLAYER.gravity;\n    this.physics.world.setBounds(0, 0, this.mapWidth * TILE, this.mapHeight * TILE + 180);\n\n    this.createTokyoBackdrop();\n\n    this.solids = this.physics.add.staticGroup();\n    this.oneWays = this.physics.add.staticGroup();\n    this.hazards = this.physics.add.staticGroup();\n    this.coins = this.physics.add.staticGroup();\n    this.checkpoints = this.physics.add.staticGroup();\n    this.enemies = this.physics.add.group({ allowGravity: true, immovable: false });\n    this.enemyPatrolSpeed = difficulty === \"hard\" ? 95 : (difficulty === \"easy\" ? 48 : 60);\n    this.hazardDamage = difficulty === \"hard\" ? 2 : 1;\n    this.hazardCooldownScale = difficulty === \"easy\" ? 1.35 : (difficulty === \"hard\" ? 0.8 : 1);\n    this.projectileIntervalMs = difficulty === \"hard\" ? 850 : (difficulty === \"easy\" ? 1500 : 1100);\n    this.projectileSpeed = difficulty === \"hard\" ? 270 : (difficulty === \"easy\" ? 180 : 230);\n    this.maxCheckpointCount = checkpointMode === \"sparse\" ? 1 : (checkpointMode === \"frequent\" ? 999 : (difficulty === \"hard\" ? 1 : 2));\n    this.spawnCheckpointOnStart = checkpointMode === \"frequent\" || difficulty === \"easy\";\n    this.hazardProjectiles = this.physics.add.group({ allowGravity: false, immovable: true });\n    let checkpointCount = 0;\n\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        const tile = this.mapRows[y][x];\n        const px = x * TILE;\n        const py = y * TILE;\n\n        if (tile === \"#\") {\n          const block = this.solids.create(px + TILE / 2, py + TILE / 2, \"ground\");\n          block.refreshBody();\n        }\n\n        if (tile === \"=\") {\n          const platform = this.oneWays.create(px + TILE / 2, py + 10, \"oneway\");\n          platform.refreshBody();\n        }\n\n        if (tile === \"^\") {\n          const spike = this.hazards.create(px + TILE / 2, py + TILE / 2, \"hazard\");\n          spike.setDisplaySize(TILE, TILE);\n          spike.refreshBody();\n        }\n\n        if (tile === \"C\") {\n          const coin = this.coins.create(px + TILE / 2, py + TILE / 2, \"coin\");\n          coin.refreshBody();\n        }\n\n        if (tile === \"E\" || tile === \"F\" || tile === \"G\" || tile === \"H\") {\n          const enemyType = tile;\n          const textureByType = { E: \"enemy-e\", F: \"enemy-f\", G: \"enemy-g\", H: \"enemy-h\" };\n          const speedByType = { E: this.enemyPatrolSpeed, F: this.enemyPatrolSpeed * 0.9, G: this.enemyPatrolSpeed * 1.2, H: this.enemyPatrolSpeed * 0.75 };\n          const enemy = this.enemies.create(px + TILE / 2, py + TILE / 2, textureByType[enemyType] || \"enemy\");\n          const patrol = this.computeEnemyPatrolBounds(x, y);\n          enemy.body.setSize(24, 24);\n          enemy.setBounce(0, 0);\n          enemy.setCollideWorldBounds(true);\n          enemy.setVelocityX(-speedByType[enemyType]);\n          enemy.setData(\"patrolSpeed\", speedByType[enemyType]);\n          enemy.setData(\"direction\", -1);\n          enemy.setData(\"turnCooldownUntil\", 0);\n          enemy.setData(\"patrolMinX\", patrol.minX);\n          enemy.setData(\"patrolMaxX\", patrol.maxX);\n          enemy.setData(\"useBoundedPatrol\", patrol.maxX - patrol.minX >= TILE * 2);\n          enemy.setData(\"enemyType\", enemyType);\n          enemy.setData(\"nextJumpAt\", this.time.now + 800 + x * 3);\n          enemy.setData(\"hp\", enemyType === \"H\" ? 2 : 1);\n          enemy.setData(\"lastX\", enemy.x);\n          enemy.setData(\"stuckSince\", this.time.now);\n          enemy.setData(\"aiState\", \"patrol\");\n          enemy.setData(\"stateUntil\", 0);\n          enemy.setData(\"attackCooldownUntil\", this.time.now + 700 + (x % 5) * 90);\n        }\n\n        if (tile === \"K\") {\n          if (checkpointCount >= this.maxCheckpointCount) {\n            continue;\n          }\n          const checkpoint = this.checkpoints.create(px + TILE / 2, py + TILE / 2, \"checkpoint\");\n          checkpoint.setData(\"activeCheckpoint\", false);\n          checkpoint.refreshBody();\n          checkpointCount += 1;\n        }\n\n        if (tile === \"S\") {\n          this.spawnPoint.set(px + TILE / 2, py + TILE / 2);\n        }\n      }\n    }\n\n    this.player = this.physics.add.sprite(this.spawnPoint.x, this.spawnPoint.y, \"player-idle-1\");\n    if (this.textures.exists(\"player-idle-sheet\")) {\n      this.player.setTexture(\"player-idle-sheet\", 0);\n      this.useImportedCharacter = true;\n      if (Platformer.Debug) Platformer.Debug.log(\"GameScene.playerIdle\", \"Using imported player-idle-sheet.\");\n    } else if (Platformer.Debug) {\n      Platformer.Debug.warn(\"GameScene.playerIdle\", \"player-idle-sheet missing, using fallback idle textures.\");\n    }\n    if (this.useImportedCharacter) {\n      this.player.setDisplaySize(56, 56);\n      this.player.body.setSize(22, 44, true);\n    } else {\n      this.player.setDisplaySize(28, 38);\n      this.player.body.setSize(20, 34);\n    }\n    this.player.setCollideWorldBounds(true);\n    // Allow dash velocity to exceed normal run cap.\n    this.player.setMaxVelocity(Math.max(PLAYER.maxSpeed, PLAYER.dashSpeed + 60), 700);\n    this.player.setDragX(PLAYER.drag);\n\n    this.respawnPoint.copy(this.spawnPoint);\n    if (this.spawnCheckpointOnStart) {\n      const extraStartCheckpoint = this.checkpoints.create(this.spawnPoint.x + 24, this.spawnPoint.y - 20, \"checkpoint\");\n      extraStartCheckpoint.setData(\"activeCheckpoint\", true);\n      extraStartCheckpoint.setTint(0x22c55e);\n      extraStartCheckpoint.refreshBody();\n    }\n\n    this.physics.add.collider(this.player, this.solids);\n    this.physics.add.collider(this.enemies, this.solids);\n    this.physics.add.collider(this.enemies, this.oneWays, null, this.enemyOneWayProcess, this);\n    this.physics.add.collider(this.player, this.oneWays, null, this.oneWayProcess, this);\n\n    this.physics.add.collider(this.player, this.hazards);\n    this.physics.add.collider(this.hazardProjectiles, this.solids, (projectile) => projectile.destroy(), null, this);\n    this.physics.add.collider(this.hazardProjectiles, this.oneWays, (projectile) => projectile.destroy(), null, this);\n    this.physics.add.overlap(this.player, this.coins, (_, coin) => this.collectCoin(coin), null, this);\n    this.physics.add.overlap(this.player, this.checkpoints, (_, cp) => this.activateCheckpoint(cp), null, this);\n    this.physics.add.overlap(this.player, this.enemies, (_, enemy) => this.handleEnemyContact(enemy), null, this);\n    this.physics.add.overlap(this.player, this.hazardProjectiles, (_, projectile) => {\n      projectile.destroy();\n      this.applyDamage(1);\n    }, null, this);\n\n    this.cameras.main.setBounds(0, 0, this.mapWidth * TILE, this.mapHeight * TILE);\n    const smooth = Phaser.Math.Clamp(settings.video.cameraSmoothing / 100, 0, 1);\n    this.cameras.main.startFollow(this.player, true, smooth, smooth);\n    this.cameras.main.setDeadzone(180, 120);\n    this.cameras.main.setBackgroundColor(\"#0b1026\");\n    this.updateCameraFraming();\n    this.scale.on(\"resize\", this.updateCameraFraming, this);\n    this.applyVideoSettings();\n    this.createPlayerHealthBar();\n    this.registry.set(\"shield\", this.shieldCharges);\n\n    this.cursors = this.input.keyboard.createCursorKeys();\n    this.keys = this.input.keyboard.addKeys(this.buildControlKeyMap());\n    this.setupGameMusic();\n    this.setupHazardShooters();\n    this.initRuntimeDiagnostics();\n    this.onRestartLevel = () => {\n      if (Platformer.Debug) Platformer.Debug.warn(\"GameScene\", \"restart-level event received; restarting current level.\");\n      this.scene.restart({ level: this.currentLevel || 1 });\n    };\n    this.game.events.on(\"restart-level\", this.onRestartLevel);\n\n    this.events.emit(\"hud-update\");\n  }\n\n  initRuntimeDiagnostics() {\n    if (!Platformer.Debug) return;\n    Platformer.Debug.log(\n      \"GameScene.diag\",\n      `Level ${this.currentLevel} booted. map=${this.mapWidth}x${this.mapHeight} enemies=${this.enemies ? this.enemies.countActive(true) : 0} turrets=${this.hazards ? this.hazards.countActive(true) : 0}`\n    );\n  }\n\n  diagWarn(key, message, cooldownMs = 1600) {\n    if (!Platformer.Debug) return;\n    const now = this.time ? this.time.now : Date.now();\n    const last = this.diagCooldowns[key] || 0;\n    if (now - last < cooldownMs) return;\n    this.diagCooldowns[key] = now;\n    Platformer.Debug.warn(`GameScene.diag.${key}`, message);\n  }\n\n  runRuntimeDiagnostics(now) {\n    if (!Platformer.Debug) return;\n    if (!this.player || !this.player.body) {\n      this.diagWarn(\"player_missing\", \"Player body missing during update.\", 3000);\n      return;\n    }\n\n    const worldW = this.mapWidth * Platformer.Config.TILE;\n    const worldH = this.mapHeight * Platformer.Config.TILE + 200;\n    const { x, y } = this.player;\n    if (!Number.isFinite(x) || !Number.isFinite(y)) {\n      this.diagWarn(\"player_nan\", `Invalid player position x=${x} y=${y}`, 0);\n    }\n    if (x < -140 || x > worldW + 140 || y < -200 || y > worldH + 260) {\n      this.diagWarn(\"player_oob\", `Player out of expected bounds x=${Math.round(x)} y=${Math.round(y)} world=${worldW}x${worldH}`);\n    }\n\n    const health = this.registry.get(\"health\");\n    const lives = this.registry.get(\"lives\");\n    const coins = this.registry.get(\"coins\");\n    if (!Number.isFinite(health) || health < -1 || health > 3) this.diagWarn(\"health_invalid\", `health=${health}`);\n    if (!Number.isFinite(lives) || lives < -1 || lives > 9) this.diagWarn(\"lives_invalid\", `lives=${lives}`);\n    if (!Number.isFinite(coins) || coins < 0 || coins > 9999) this.diagWarn(\"coins_invalid\", `coins=${coins}`);\n\n    let groundedEnemies = 0;\n    let stuckEnemies = 0;\n    this.enemies.children.each((enemy) => {\n      if (!enemy || !enemy.active || !enemy.body) return;\n      const ex = enemy.x;\n      const ey = enemy.y;\n      if (!Number.isFinite(ex) || !Number.isFinite(ey)) {\n        this.diagWarn(\"enemy_nan\", `enemy invalid pos x=${ex} y=${ey}`, 0);\n        return;\n      }\n      if (ex < -80 || ex > worldW + 80 || ey > worldH + 200) {\n        this.diagWarn(\"enemy_oob\", `enemy out of bounds x=${Math.round(ex)} y=${Math.round(ey)}`);\n      }\n      if (enemy.body.blocked.down || enemy.body.touching.down) groundedEnemies += 1;\n      const speedX = Math.abs(enemy.body.velocity.x || 0);\n      if ((enemy.body.blocked.down || enemy.body.touching.down) && speedX < 8) stuckEnemies += 1;\n    });\n\n    if (this.enemies.countActive(true) > 0 && groundedEnemies === 0) {\n      this.diagWarn(\"enemies_airborne\", \"All enemies airborne; check spawn/support tiles.\", 2200);\n    }\n    if (stuckEnemies >= 2) {\n      this.diagWarn(\"enemies_stalling\", `${stuckEnemies} enemies currently stalled on ground.`, 1800);\n    }\n\n    this.hazards.children.each((hazard) => {\n      if (!hazard || !hazard.active) return;\n      const belowY = hazard.y + Platformer.Config.TILE * 0.55;\n      if (!this.hasSupportAtWorld(hazard.x, belowY)) {\n        this.diagWarn(\"turret_unsupported\", `Turret at (${Math.round(hazard.x)},${Math.round(hazard.y)}) has no support below.`);\n      }\n    });\n\n    if (this.hazardProjectiles && this.hazardShooters.length > 0 && now > 4500 && this.lastHazardShotAt <= 0) {\n      this.diagWarn(\"no_projectile_fire\", \"Turrets present but no projectile has fired yet.\", 5000);\n    }\n  }\n\n  setupGameMusic() {\n    const audioSettings = Platformer.Settings.current.audio;\n    const volume = (audioSettings.master / 100) * (audioSettings.music / 100);\n\n    if (Platformer.menuMusicHtml) {\n      Platformer.menuMusicHtml.pause();\n      Platformer.menuMusicHtml.currentTime = 0;\n      Platformer.menuMusicHtml = null;\n    }\n    this.sound.stopByKey(\"menu-bgm\");\n\n    const startPhaserMusic = () => {\n      let music = Platformer.gameMusic;\n      if (!music) {\n        music = this.sound.get(\"game-bgm\");\n        if (!music) {\n          try {\n            music = this.sound.add(\"game-bgm\", { loop: true, volume });\n          } catch (_e) {\n            this.setupHtmlGameMusicFallback(volume, audioSettings);\n            return;\n          }\n        }\n        Platformer.gameMusic = music;\n      }\n\n      music.setLoop(true);\n      music.setVolume(volume);\n      const tryPlay = () => {\n        if (!music || music.isPlaying) return;\n        try {\n          music.play();\n        } catch (_e) {\n          // Autoplay gating may block until first user input.\n        }\n      };\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    };\n\n    if (this.cache.audio.exists(\"game-bgm\")) {\n      startPhaserMusic();\n      return;\n    }\n\n    this.load.audio(\"game-bgm\", \"assets/Slaughter to Prevail - K (mp3cut.net).mp3\");\n    this.load.once(\"complete\", startPhaserMusic);\n    this.load.once(\"loaderror\", () => this.setupHtmlGameMusicFallback(volume, audioSettings));\n    this.load.start();\n  }\n\n  setupHtmlGameMusicFallback(volume, audioSettings) {\n    try {\n      if (!Platformer.gameMusicHtml) {\n        Platformer.gameMusicHtml = new Audio(\"assets/Slaughter to Prevail - K (mp3cut.net).mp3\");\n      }\n      const music = Platformer.gameMusicHtml;\n      music.loop = true;\n      music.volume = Phaser.Math.Clamp(volume, 0, 1);\n\n      const tryPlay = () => {\n        if (audioSettings.muteWhenUnfocused && document.hidden) return;\n        music.play().catch(() => {});\n      };\n\n      this.input.once(\"pointerdown\", tryPlay);\n      this.input.keyboard.once(\"keydown\", tryPlay);\n      tryPlay();\n    } catch (_e) {\n      // Keep game functional if audio fails.\n    }\n  }\n\n  createPlayerHealthBar() {\n    this.playerHealthBarBg = this.add.rectangle(this.player.x, this.player.y - 34, 38, 7, 0x111827, 0.92)\n      .setStrokeStyle(1, 0xe2e8f0, 0.85)\n      .setDepth(55);\n    this.playerHealthBarFill = this.add.rectangle(this.player.x - 18, this.player.y - 34, 34, 5, 0x22c55e, 1)\n      .setOrigin(0, 0.5)\n      .setDepth(56);\n    this.updatePlayerHealthBar();\n  }\n\n  updatePlayerHealthBar() {\n    if (!this.player || !this.playerHealthBarBg || !this.playerHealthBarFill) {\n      return;\n    }\n\n    const health = Phaser.Math.Clamp(this.registry.get(\"health\"), 0, 3);\n    const ratio = health / 3;\n    const fillWidth = Math.max(0, 34 * ratio);\n    const color = ratio > 0.66 ? 0x22c55e : (ratio > 0.33 ? 0xf59e0b : 0xef4444);\n\n    this.playerHealthBarBg.setPosition(this.player.x, this.player.y - 34);\n    this.playerHealthBarFill.setPosition(this.player.x - 18, this.player.y - 34);\n    this.playerHealthBarFill.width = fillWidth;\n    this.playerHealthBarFill.setFillStyle(color, 1);\n    this.playerHealthBarFill.setVisible(fillWidth > 0);\n  }\n\n  setupHazardShooters() {\n    this.hazardShooters = [];\n    let i = 0;\n    this.hazards.children.each((hazard) => {\n      // All turrets are active; stagger initial fire times for readability.\n      hazard.setData(\"nextShotAt\", this.time.now + i * 140);\n      this.hazardShooters.push(hazard);\n      i += 1;\n    });\n  }\n\n  spawnHazardProjectiles(now) {\n    if (!this.hazardShooters.length) {\n      return;\n    }\n\n    let fired = 0;\n    const maxShotsPerTick = 2;\n    for (let i = 0; i < this.hazardShooters.length; i += 1) {\n      if (fired >= maxShotsPerTick) {\n        break;\n      }\n\n      const shooter = this.hazardShooters[i];\n      if (!shooter || !shooter.active) {\n        continue;\n      }\n\n      const nextShotAt = shooter.getData(\"nextShotAt\") || 0;\n      if (now < nextShotAt) {\n        continue;\n      }\n\n      const inRangeX = Math.abs(shooter.x - this.player.x) < 540;\n      const inRangeY = Math.abs(shooter.y - this.player.y) < 260;\n      if (!inRangeX || !inRangeY) {\n        continue;\n      }\n\n      const projectile = this.hazardProjectiles.create(shooter.x, shooter.y - 8, \"hazard-projectile\");\n      projectile.setDepth(70);\n      projectile.body.setSize(10, 10);\n      projectile.body.setAllowGravity(false);\n      projectile.setCollideWorldBounds(false);\n\n      const dir = this.player.x >= shooter.x ? 1 : -1;\n      const yAim = Phaser.Math.Clamp(this.player.y - shooter.y, -120, 90) * 0.35;\n      projectile.setVelocity(dir * this.projectileSpeed, yAim);\n\n      const stagger = (Math.floor(shooter.x / Platformer.Config.TILE) % 3) * 90;\n      shooter.setData(\"nextShotAt\", now + this.projectileIntervalMs + stagger);\n      fired += 1;\n      this.lastHazardShotAt = now;\n    }\n  }\n\n  updateProjectiles() {\n    const maxY = this.mapHeight * Platformer.Config.TILE + 200;\n    const minX = -120;\n    const maxX = this.mapWidth * Platformer.Config.TILE + 120;\n    this.hazardProjectiles.children.each((p) => {\n      if (!p.active) return;\n      if (p.x < minX || p.x > maxX || p.y > maxY) {\n        p.destroy();\n      }\n    });\n  }\n\n  updateLevelTimer(now) {\n    if (!this.lastTickTime) {\n      this.lastTickTime = now;\n      return;\n    }\n\n    const dt = now - this.lastTickTime;\n    this.lastTickTime = now;\n    this.levelTimeRemainingMs = Math.max(0, this.levelTimeRemainingMs - dt);\n    const secondsLeft = Math.ceil(this.levelTimeRemainingMs / 1000);\n    if (secondsLeft !== this.lastTimerSecond) {\n      this.lastTimerSecond = secondsLeft;\n      this.registry.set(\"timeLeft\", secondsLeft);\n    }\n\n    if (this.levelTimeRemainingMs <= 0 && !this.isDead) {\n      this.isDead = true;\n      this.game.events.emit(\"game-over\");\n      this.scene.pause();\n    }\n  }\n\n  createTokyoBackdrop() {\n    const { TILE } = Platformer.Config;\n    const worldW = this.mapWidth * TILE;\n\n    const skyTop = this.add.rectangle(worldW / 2, 120, worldW, 240, 0x111827).setDepth(-120).setScrollFactor(0);\n    const skyMid = this.add.rectangle(worldW / 2, 260, worldW, 280, 0x1e1b4b).setDepth(-119).setScrollFactor(0);\n    const skyGlow = this.add.rectangle(worldW / 2, 210, worldW, 180, 0x312e81, 0.35).setDepth(-118).setScrollFactor(0);\n    this.parallax.push(skyTop, skyMid, skyGlow);\n\n    const moon = this.add.circle(760, 88, 34, 0xfef3c7, 0.9).setDepth(-117).setScrollFactor(0.04);\n    const moonGlow = this.add.circle(760, 88, 52, 0xfef9c3, 0.18).setDepth(-118).setScrollFactor(0.04);\n    this.parallax.push(moon, moonGlow);\n\n    const farHeights = [110, 120, 100, 130, 95, 126, 106, 116];\n    for (let i = 0; i < 40; i += 1) {\n      const w = 90;\n      const h = farHeights[i % farHeights.length];\n      const x = i * 88;\n      const y = 320 - h / 2;\n      const b = this.add.rectangle(x, y, w, h, 0x0f172a).setOrigin(0, 0.5).setDepth(-90).setScrollFactor(0.2);\n      this.parallax.push(b);\n\n      for (let wx = 0; wx < 4; wx += 1) {\n        const color = (wx + i) % 2 === 0 ? 0x22d3ee : 0xf472b6;\n        const win = this.add.rectangle(x + 12 + wx * 18, y - h / 2 + 18 + ((i + wx) % 5) * 14, 9, 6, color, 0.8)\n          .setDepth(-89)\n          .setScrollFactor(0.2);\n        this.parallax.push(win);\n      }\n    }\n\n    const midHeights = [140, 170, 150, 188, 132, 168];\n    for (let i = 0; i < 26; i += 1) {\n      const w = 122;\n      const h = midHeights[i % midHeights.length];\n      const x = i * 118;\n      const y = 390 - h / 2;\n      const b = this.add.rectangle(x, y, w, h, 0x020617).setOrigin(0, 0.5).setDepth(-70).setScrollFactor(0.45);\n      this.parallax.push(b);\n\n      if (i % 4 === 1) {\n        const sign = this.add.rectangle(x + 70, y - h / 2 + 34, 58, 18, 0xdb2777, 0.9)\n          .setDepth(-69)\n          .setScrollFactor(0.45);\n        this.parallax.push(sign);\n      }\n    }\n\n    for (let i = 0; i < 24; i += 1) {\n      const line = this.add.rectangle(i * 170, 120 + (i % 5) * 72, 120, 4, 0xffffff, 0.28)\n        .setAngle(-16)\n        .setOrigin(0, 0.5)\n        .setDepth(-60)\n        .setScrollFactor(0.12);\n      this.parallax.push(line);\n    }\n  }\n\n  oneWayProcess(player, platform) {\n    const pBody = player.body;\n    const platBody = platform.body;\n    const wasAbove = pBody.bottom <= platBody.top + 6;\n    const isFalling = pBody.velocity.y >= 0;\n    return wasAbove && isFalling;\n  }\n\n  keyCodeFromName(name, fallback) {\n    if (!name) return fallback;\n    const upper = String(name).toUpperCase();\n    const direct = Phaser.Input.Keyboard.KeyCodes[upper];\n    if (typeof direct === \"number\") return direct;\n    if (upper.length === 1) {\n      const letter = Phaser.Input.Keyboard.KeyCodes[upper];\n      if (typeof letter === \"number\") return letter;\n    }\n    return fallback;\n  }\n\n  buildControlKeyMap() {\n    const c = Platformer.Settings.current.controls;\n    return {\n      left: this.keyCodeFromName(c.left, Phaser.Input.Keyboard.KeyCodes.A),\n      right: this.keyCodeFromName(c.right, Phaser.Input.Keyboard.KeyCodes.D),\n      jump: this.keyCodeFromName(c.jump, Phaser.Input.Keyboard.KeyCodes.W),\n      dash: this.keyCodeFromName(c.dash, Phaser.Input.Keyboard.KeyCodes.SHIFT),\n      attack: this.keyCodeFromName(c.attack, Phaser.Input.Keyboard.KeyCodes.J),\n      interact: this.keyCodeFromName(c.interact, Phaser.Input.Keyboard.KeyCodes.E),\n      pause: this.keyCodeFromName(c.pause, Phaser.Input.Keyboard.KeyCodes.ESC),\n      demoWin: Phaser.Input.Keyboard.KeyCodes.F2,\n    };\n  }\n\n  applyVideoSettings() {\n    const s = Platformer.Settings.current;\n    const brightness = Phaser.Math.Clamp(s.video.brightness, 0.8, 1.2);\n    const shade = brightness >= 1 ? 0xffffff : 0x000000;\n    const alpha = Math.abs(1 - brightness) * 0.45;\n    this.brightnessOverlay = this.add.rectangle(\n      this.mapWidth * Platformer.Config.TILE / 2,\n      this.mapHeight * Platformer.Config.TILE / 2,\n      this.mapWidth * Platformer.Config.TILE + 800,\n      this.mapHeight * Platformer.Config.TILE + 800,\n      shade,\n      alpha\n    ).setScrollFactor(0).setDepth(200);\n  }\n\n  updateCameraFraming() {\n    if (!this.cameras || !this.cameras.main) {\n      return;\n    }\n    const s = Platformer.Settings.current;\n    const baseZoom = this.scale.height / Platformer.Config.GAME_HEIGHT;\n    const resScale = Phaser.Math.Clamp(s.video.resolutionScale / 100, 0.5, 1);\n    const zoom = Phaser.Math.Clamp(baseZoom * resScale, 0.75, 3);\n    this.cameras.main.setZoom(zoom);\n  }\n\n  normalizeTurretTiles() {\n    const grid = this.mapRows.map((row) => row.split(\"\"));\n    const inBounds = (x, y) => x >= 0 && x < this.mapWidth && y >= 0 && y < this.mapHeight;\n    const isSupport = (x, y) => {\n      if (!inBounds(x, y)) return false;\n      const ch = grid[y][x];\n      return ch === \"#\" || ch === \"=\";\n    };\n    const isWalkableSlot = (x, y) => {\n      if (!inBounds(x, y)) return false;\n      const ch = grid[y][x];\n      return ch === \".\" || ch === \"^\";\n    };\n    const findSpawnX = () => {\n      for (let yy = 0; yy < this.mapHeight; yy += 1) {\n        for (let xx = 0; xx < this.mapWidth; xx += 1) {\n          if (grid[yy][xx] === \"S\") return xx;\n        }\n      }\n      return 0;\n    };\n    const spawnX = findSpawnX();\n\n    const turrets = [];\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        if (grid[y][x] === \"^\") {\n          turrets.push({ x, y });\n          grid[y][x] = \".\";\n        }\n      }\n    }\n\n    const isSafeFromSpawn = (x) => Math.abs(x - spawnX) >= 8;\n    const tryPlace = (x, y) => {\n      if (isWalkableSlot(x, y) && isSupport(x, y + 1)) {\n        if (!isSafeFromSpawn(x)) {\n          return false;\n        }\n        grid[y][x] = \"^\";\n        return true;\n      }\n      return false;\n    };\n\n    turrets.forEach(({ x, y }) => {\n      let placed = false;\n      const preferredY = Phaser.Math.Clamp(y, 0, this.mapHeight - 2);\n\n      // Keep authored lane first for better level readability.\n      placed = tryPlace(x, preferredY);\n\n      // Then search nearby vertically only.\n      if (!placed) {\n        for (let d = 1; d <= 2 && !placed; d += 1) {\n          const up = preferredY - d;\n          const down = preferredY + d;\n          if (up >= 0) placed = tryPlace(x, up);\n          if (!placed && down <= this.mapHeight - 2) placed = tryPlace(x, down);\n        }\n      }\n    });\n\n    this.mapRows = grid.map((row) => row.join(\"\"));\n  }\n\n  normalizeEnemyTiles() {\n    const enemyChars = new Set([\"E\", \"F\", \"G\", \"H\"]);\n    const grid = this.mapRows.map((row) => row.split(\"\"));\n    const inBounds = (x, y) => x >= 0 && x < this.mapWidth && y >= 0 && y < this.mapHeight;\n    const chAt = (x, y) => (inBounds(x, y) ? grid[y][x] : \".\");\n    const isSupport = (x, y) => {\n      const ch = chAt(x, y);\n      return ch === \"#\" || ch === \"=\";\n    };\n    const isEnemySpotOpen = (x, y) => chAt(x, y) === \".\";\n    const isHazardAt = (x, y) => chAt(x, y) === \"^\";\n    const hasHeadroom = (x, y) => y <= 0 || chAt(x, y - 1) === \".\";\n    const canStandAt = (x, y) =>\n      inBounds(x, y)\n      && y < this.mapHeight - 1\n      && isEnemySpotOpen(x, y)\n      && isSupport(x, y + 1)\n      && !isHazardAt(x, y)\n      && hasHeadroom(x, y);\n    const patrolSpanAt = (x, y) => {\n      if (!canStandAt(x, y)) {\n        return 0;\n      }\n\n      let left = x;\n      let right = x;\n      while (canStandAt(left - 1, y)) left -= 1;\n      while (canStandAt(right + 1, y)) right += 1;\n      return right - left + 1;\n    };\n\n    let spawnX = 0;\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        if (grid[y][x] === \"S\") {\n          spawnX = x;\n        }\n      }\n    }\n\n    const turrets = [];\n    const enemies = [];\n    for (let y = 0; y < this.mapHeight; y += 1) {\n      for (let x = 0; x < this.mapWidth; x += 1) {\n        const ch = grid[y][x];\n        if (ch === \"^\") turrets.push({ x, y });\n        if (enemyChars.has(ch)) {\n          enemies.push({ x, y, type: ch });\n          grid[y][x] = \".\";\n        }\n      }\n    }\n\n    const isSafeFromTurrets = (x, y) => !turrets.some((t) => Math.abs(t.x - x) <= 5 && Math.abs(t.y - y) <= 2);\n    const isSafeFromSpawn = (x) => Math.abs(x - spawnX) >= 10;\n    const placedEnemies = [];\n    const isSafeFromOtherEnemies = (x, y) => !placedEnemies.some((e) => Math.abs(e.x - x) <= 4 && Math.abs(e.y - y) <= 2);\n    const hasPatrolRoom = (x, y) => {\n      const span = patrolSpanAt(x, y);\n      if (span < 6) return false;\n      return canStandAt(x - 1, y) || canStandAt(x + 1, y);\n    };\n    const canPlaceEnemy = (x, y) =>\n      canStandAt(x, y)\n      && hasPatrolRoom(x, y)\n      && isSafeFromTurrets(x, y)\n      && isSafeFromSpawn(x)\n      && isSafeFromOtherEnemies(x, y);\n\n    enemies.forEach((enemy) => {\n      let placed = false;\n      const tryOrder = [0, -1, 1];\n      for (const dy of tryOrder) {\n        const yy = enemy.y + dy;\n        for (let dx = 0; dx <= 6; dx += 1) {\n          const xs = dx === 0 ? [enemy.x] : [enemy.x - dx, enemy.x + dx];\n          for (const xx of xs) {\n            if (canPlaceEnemy(xx, yy)) {\n              grid[yy][xx] = enemy.type;\n              placedEnemies.push({ x: xx, y: yy });\n              placed = true;\n              break;\n            }\n          }\n          if (placed) break;\n        }\n        if (placed) break;\n      }\n\n      if (!placed) {\n        for (let y = 0; y < this.mapHeight - 1; y += 1) {\n          for (let x = 0; x < this.mapWidth; x += 1) {\n            if (canPlaceEnemy(x, y)) {\n              grid[y][x] = enemy.type;\n              placedEnemies.push({ x, y });\n              placed = true;\n              break;\n            }\n          }\n          if (placed) break;\n        }\n      }\n    });\n\n    this.mapRows = grid.map((row) => row.join(\"\"));\n  }\n\n  enemyOneWayProcess(enemy, platform) {\n    const eBody = enemy.body;\n    const pBody = platform.body;\n    return eBody.bottom <= pBody.top + 4 && eBody.velocity.y >= 0;\n  }\n\n  tileCharAtWorld(worldX, worldY) {\n    const { TILE } = Platformer.Config;\n    const tx = Math.floor(worldX / TILE);\n    const ty = Math.floor(worldY / TILE);\n    return this.tileCharAt(tx, ty);\n  }\n\n  tileCharAt(tileX, tileY) {\n    if (tileX < 0 || tileY < 0 || tileY >= this.mapHeight || tileX >= this.mapWidth) {\n      return \".\";\n    }\n    return this.mapRows[tileY][tileX];\n  }\n\n  hasSupportAtWorld(worldX, worldY) {\n    const ch = this.tileCharAtWorld(worldX, worldY);\n    return ch === \"#\" || ch === \"=\";\n  }\n\n  isHazardAtWorld(worldX, worldY) {\n    return this.tileCharAtWorld(worldX, worldY) === \"^\";\n  }\n\n  isSupportTile(tileX, tileY) {\n    const ch = this.tileCharAt(tileX, tileY);\n    return ch === \"#\" || ch === \"=\";\n  }\n\n  isHazardTile(tileX, tileY) {\n    return this.tileCharAt(tileX, tileY) === \"^\";\n  }\n\n  computeEnemyPatrolBounds(tileX, tileY) {\n    const { TILE } = Platformer.Config;\n    const supportY = tileY + 1;\n    let left = tileX;\n    let right = tileX;\n\n    while (this.isSupportTile(left - 1, supportY) && !this.isHazardTile(left - 1, tileY)) {\n      left -= 1;\n    }\n    while (this.isSupportTile(right + 1, supportY) && !this.isHazardTile(right + 1, tileY)) {\n      right += 1;\n    }\n\n    return {\n      minX: left * TILE + TILE / 2,\n      maxX: right * TILE + TILE / 2,\n    };\n  }\n\n  updateEnemyPatrol(enemy, now) {\n    if (!enemy.active) return;\n\n    let speed = enemy.getData(\"patrolSpeed\");\n    let dir = enemy.getData(\"direction\");\n    if (!dir) dir = enemy.body.velocity.x >= 0 ? 1 : -1;\n    const minX = enemy.getData(\"patrolMinX\");\n    const maxX = enemy.getData(\"patrolMaxX\");\n    const useBounded = !!enemy.getData(\"useBoundedPatrol\");\n    const turnCooldownUntil = enemy.getData(\"turnCooldownUntil\") || 0;\n    const grounded = enemy.body.blocked.down || enemy.body.touching.down;\n    const enemyType = enemy.getData(\"enemyType\") || \"E\";\n    const closeX = Math.abs(enemy.x - this.player.x) < (enemyType === \"G\" ? 260 : 190);\n    const closeY = Math.abs(enemy.y - this.player.y) < 70;\n    const aggressive = closeX && closeY;\n    let aiState = enemy.getData(\"aiState\") || \"patrol\";\n    let stateUntil = enemy.getData(\"stateUntil\") || 0;\n    let attackCooldownUntil = enemy.getData(\"attackCooldownUntil\") || 0;\n\n    if (aggressive) {\n      dir = this.player.x >= enemy.x ? 1 : -1;\n      const mult = enemyType === \"G\" ? 2.3 : (enemyType === \"H\" ? 1.55 : 1.8);\n      speed *= mult;\n      enemy.setTint(0xf87171);\n    } else {\n      enemy.clearTint();\n    }\n\n    if ((enemyType === \"G\" || enemyType === \"H\") && aggressive && grounded) {\n      if (aiState === \"patrol\" && now >= attackCooldownUntil) {\n        aiState = \"windup\";\n        stateUntil = now + (enemyType === \"G\" ? 210 : 280);\n      } else if (aiState === \"windup\" && now >= stateUntil) {\n        aiState = \"lunge\";\n        stateUntil = now + (enemyType === \"G\" ? 280 : 220);\n        dir = this.player.x >= enemy.x ? 1 : -1;\n      } else if (aiState === \"lunge\" && now >= stateUntil) {\n        aiState = \"recover\";\n        stateUntil = now + 240;\n        attackCooldownUntil = now + (enemyType === \"G\" ? 900 : 1200);\n      } else if (aiState === \"recover\" && now >= stateUntil) {\n        aiState = \"patrol\";\n      }\n    } else if (!aggressive && aiState !== \"patrol\") {\n      aiState = \"patrol\";\n    }\n\n    if (aiState === \"windup\") {\n      speed = 0;\n      enemy.setTint(0xfacc15);\n    } else if (aiState === \"lunge\") {\n      const burst = enemyType === \"G\" ? 3.2 : 2.5;\n      speed *= burst;\n      enemy.setTint(0xfb7185);\n    }\n\n    if (enemyType === \"F\" && grounded) {\n      const nextJumpAt = enemy.getData(\"nextJumpAt\") || 0;\n      if (now >= nextJumpAt) {\n        enemy.setVelocityY(-260);\n        enemy.setData(\"nextJumpAt\", now + 1150);\n      }\n    }\n\n    const hitLeft = enemy.body.blocked.left || enemy.body.touching.left;\n    const hitRight = enemy.body.blocked.right || enemy.body.touching.right;\n\n    if (hitLeft) {\n      dir = 1;\n      enemy.x += 1.5;\n    }\n    if (hitRight) {\n      dir = -1;\n      enemy.x -= 1.5;\n    }\n\n    if (useBounded) {\n      if (enemy.x <= minX + 2) {\n        dir = 1;\n      } else if (enemy.x >= maxX - 2) {\n        dir = -1;\n      }\n    }\n\n    if (grounded) {\n      const aheadX = enemy.x + dir * (enemy.body.width / 2 + 8);\n      const footY = enemy.body.bottom + 6;\n      const noGroundAhead = !this.hasSupportAtWorld(aheadX, footY);\n      const hazardAhead = this.isHazardAtWorld(aheadX, footY - 10);\n      if ((!useBounded && noGroundAhead) || hazardAhead) {\n        if (now >= turnCooldownUntil) {\n          dir *= -1;\n          enemy.setData(\"turnCooldownUntil\", now + 160);\n          enemy.x += dir * 4;\n        }\n      }\n    }\n\n    if (!grounded && !useBounded) {\n      const fallbackAheadX = enemy.x + dir * (enemy.body.width / 2 + 5);\n      const fallbackFootY = enemy.body.bottom + 10;\n      if (!this.hasSupportAtWorld(fallbackAheadX, fallbackFootY) && now >= turnCooldownUntil) {\n        dir *= -1;\n        enemy.setData(\"turnCooldownUntil\", now + 160);\n      }\n    }\n\n    enemy.setData(\"direction\", dir);\n    enemy.setVelocityX(dir * speed);\n    enemy.setData(\"isAggressive\", aggressive);\n    enemy.setData(\"aiState\", aiState);\n    enemy.setData(\"stateUntil\", stateUntil);\n    enemy.setData(\"attackCooldownUntil\", attackCooldownUntil);\n\n    // Stuck recovery: if enemy is grounded and not advancing, hop out of cracks.\n    const lastX = enemy.getData(\"lastX\");\n    let stuckSince = enemy.getData(\"stuckSince\") || now;\n    const moved = Math.abs(enemy.x - lastX) > 2;\n    if (moved) {\n      stuckSince = now;\n    }\n\n    if (grounded && !moved && Math.abs(enemy.body.velocity.x) < 14) {\n      if (now - stuckSince > 320) {\n        const jumpY = enemyType === \"H\" ? -210 : -260;\n        enemy.setVelocityY(jumpY);\n        dir *= -1;\n        enemy.setData(\"direction\", dir);\n        enemy.setVelocityX(dir * speed);\n        stuckSince = now;\n      }\n    }\n\n    enemy.setData(\"lastX\", enemy.x);\n    enemy.setData(\"stuckSince\", stuckSince);\n  }\n\n  showToast(message, color = 0xfef3c7) {\n    this.game.events.emit(\"toast-message\", { text: message, color });\n    if (Platformer.Debug) Platformer.Debug.log(\"GameScene.toast\", message);\n  }\n\n  applyCoinMilestoneReward(totalCoins) {\n    if (this.coinRewardState[totalCoins]) return;\n\n    if (totalCoins === 3) {\n      const before = this.registry.get(\"health\") || 0;\n      const after = Math.min(3, before + 1);\n      if (after > before) {\n        this.registry.set(\"health\", after);\n        this.showToast(\"Reward: +1 Health\", 0x86efac);\n      } else {\n        this.showToast(\"Reward: Health already full\", 0xbbf7d0);\n      }\n      this.coinRewardState[totalCoins] = true;\n      this.events.emit(\"hud-update\");\n      this.updatePlayerHealthBar();\n      return;\n    }\n\n    if (totalCoins === 6) {\n      this.levelTimeRemainingMs += 12000;\n      const secondsLeft = Math.ceil(this.levelTimeRemainingMs / 1000);\n      this.registry.set(\"timeLeft\", secondsLeft);\n      this.showToast(\"Reward: +12s Time\", 0x93c5fd);\n      this.coinRewardState[totalCoins] = true;\n      this.events.emit(\"hud-update\");\n      return;\n    }\n\n    if (totalCoins === 9) {\n      this.shieldCharges += 1;\n      this.registry.set(\"shield\", this.shieldCharges);\n      this.showToast(\"Reward: Shield x1\", 0xc4b5fd);\n      this.coinRewardState[totalCoins] = true;\n      this.events.emit(\"hud-update\");\n    }\n  }\n\n  tryStartDash(now, moveLeft, moveRight) {\n    const { PLAYER } = Platformer.Config;\n    const grounded = this.player.body.blocked.down || this.player.body.touching.down;\n    const canDash = now - this.lastDashAt >= PLAYER.dashCooldownMs;\n    if (!canDash || this.isDashing) return false;\n\n    let dir = this.facingDir || 1;\n    if (moveLeft && !moveRight) dir = -1;\n    if (moveRight && !moveLeft) dir = 1;\n\n    this.isDashing = true;\n    this.lastDashAt = now;\n    this.dashEndsAt = now + PLAYER.dashDurationMs;\n    this.player.setDragX(0);\n    this.player.setAccelerationX(0);\n    this.player.setVelocityX(dir * PLAYER.dashSpeed);\n    if (!grounded && this.player.body.velocity.y > 30) {\n      this.player.setVelocityY(30);\n    }\n    this.player.setTint(0x93c5fd);\n    this.registry.set(\"dashCd\", Math.ceil(PLAYER.dashCooldownMs / 1000));\n    Platformer.beeper.dash();\n    return true;\n  }\n\n  stopDash() {\n    if (!this.isDashing) return;\n    this.isDashing = false;\n    this.player.setDragX(Platformer.Config.PLAYER.drag);\n    this.player.clearTint();\n  }\n\n  tryAttack(now) {\n    const { PLAYER } = Platformer.Config;\n    if (now - this.lastAttackAt < PLAYER.attackCooldownMs) return;\n\n    this.lastAttackAt = now;\n    this.attackActiveUntil = now + 120;\n    this.player.setTint(0xfde68a);\n    Platformer.beeper.attack();\n\n    let hits = 0;\n    this.enemies.children.each((enemy) => {\n      if (!enemy || !enemy.active) return;\n      const dx = enemy.x - this.player.x;\n      const dy = Math.abs(enemy.y - this.player.y);\n      const inFront = this.facingDir > 0 ? dx >= -6 : dx <= 6;\n      const inRange = Math.abs(dx) <= PLAYER.attackRange && dy <= 28;\n      if (!inFront || !inRange) return;\n\n      const hp = enemy.getData(\"hp\") || 1;\n      if (hp <= 1) {\n        enemy.disableBody(true, true);\n      } else {\n        enemy.setData(\"hp\", hp - 1);\n        enemy.setTint(0xfca5a5);\n      }\n      hits += 1;\n    });\n\n    if (hits > 0) {\n      this.showToast(`Hit x${hits}`, 0xfef08a);\n    }\n  }\n\n  updateLandingFeedback() {\n    const grounded = this.player.body.blocked.down || this.player.body.touching.down;\n    const currentDownSpeed = Math.max(0, this.player.body.velocity.y);\n    if (!grounded) {\n      this.airbornePeakSpeedY = Math.max(this.airbornePeakSpeedY, currentDownSpeed);\n    } else if (!this.wasGroundedLastFrame) {\n      const impact = this.airbornePeakSpeedY;\n      if (impact > 200) {\n        const power = Phaser.Math.Clamp(impact / 700, 0.08, 0.24);\n        const reduce = Platformer.Settings.current.accessibility.reduceScreenShake / 100;\n        this.cameras.main.shake(80, power * 0.015 * reduce, true);\n        Platformer.beeper.land();\n      }\n      this.airbornePeakSpeedY = 0;\n    }\n    this.wasGroundedLastFrame = grounded;\n  }\n\n  updateAuxHud(now) {\n    if (now - this.lastAuxHudAt < 120) return;\n    this.lastAuxHudAt = now;\n\n    const dashLeft = Math.max(0, (Platformer.Config.PLAYER.dashCooldownMs - (now - this.lastDashAt)) / 1000);\n    this.registry.set(\"dashCd\", dashLeft);\n    this.registry.set(\"shield\", this.shieldCharges);\n  }\n\n  collectCoin(coin) {\n    coin.disableBody(true, true);\n    const updatedCoins = this.registry.get(\"coins\") + 1;\n    this.registry.set(\"coins\", updatedCoins);\n    Platformer.beeper.coin();\n    this.applyCoinMilestoneReward(updatedCoins);\n    this.events.emit(\"hud-update\");\n\n    if (updatedCoins >= Platformer.Config.WIN_COIN_TARGET && !this.levelComplete) {\n      this.completeLevel();\n    }\n  }\n\n  activateCheckpoint(checkpoint) {\n    if (checkpoint.getData(\"activeCheckpoint\")) {\n      return;\n    }\n\n    this.checkpoints.children.each((cp) => {\n      cp.clearTint();\n      cp.setData(\"activeCheckpoint\", false);\n    });\n\n    checkpoint.setTint(0x22c55e);\n    checkpoint.setData(\"activeCheckpoint\", true);\n    this.respawnPoint.set(checkpoint.x, checkpoint.y - 20);\n  }\n\n  onHazardHit() {\n    this.applyDamage(this.hazardDamage);\n  }\n\n  handleEnemyContact(enemy) {\n    const { PLAYER } = Platformer.Config;\n\n    if (!enemy.active || this.isDead) {\n      return;\n    }\n\n    if (this.isDashing) {\n      const hp = enemy.getData(\"hp\") || 1;\n      if (hp <= 1) {\n        enemy.disableBody(true, true);\n      } else {\n        enemy.setData(\"hp\", hp - 1);\n      }\n      this.player.setVelocityY(-PLAYER.jumpVelocity * 0.3);\n      this.showToast(\"Dash Break!\", 0x93c5fd);\n      return;\n    }\n\n    const playerBottom = this.player.body.bottom;\n    const enemyTop = enemy.body.top;\n    const isStomp = this.player.body.velocity.y > 40 && playerBottom <= enemyTop + 10;\n\n    if (isStomp) {\n      const hp = enemy.getData(\"hp\") || 1;\n      if (hp <= 1) {\n        enemy.disableBody(true, true);\n      } else {\n        enemy.setData(\"hp\", hp - 1);\n        enemy.setTint(0xfca5a5);\n      }\n      this.player.setVelocityY(-PLAYER.jumpVelocity * 0.55);\n      Platformer.beeper.stomp();\n      return;\n    }\n\n    const enemyType = enemy.getData(\"enemyType\") || \"E\";\n    const aiState = enemy.getData(\"aiState\") || \"patrol\";\n    const contactDamage = (enemyType === \"H\" || aiState === \"lunge\") ? 2 : 1;\n    this.applyDamage(contactDamage);\n  }\n\n  applyDamage(amount = 1) {\n    const { PLAYER } = Platformer.Config;\n    const settings = Platformer.Settings.current;\n\n    const now = this.time.now;\n    const invuln = Math.round(PLAYER.hurtInvulnMs * this.hazardCooldownScale);\n    if (now - this.lastDamageTime < invuln || this.isDead) {\n      return;\n    }\n\n    if (this.shieldCharges > 0) {\n      this.shieldCharges -= 1;\n      this.registry.set(\"shield\", this.shieldCharges);\n      this.lastDamageTime = now;\n      this.player.setTintFill(0xc4b5fd);\n      this.time.delayedCall(90, () => {\n        if (this.player && this.player.active) this.player.clearTint();\n      });\n      this.showToast(\"Shield blocked damage\", 0xc4b5fd);\n      return;\n    }\n\n    this.lastDamageTime = now;\n    const newHealth = this.registry.get(\"health\") - amount;\n    this.registry.set(\"health\", newHealth);\n    this.events.emit(\"hud-update\");\n    this.updatePlayerHealthBar();\n    Platformer.beeper.damage();\n\n    if (newHealth <= 0) {\n      const remainingLives = this.registry.get(\"lives\") - 1;\n      this.registry.set(\"lives\", remainingLives);\n\n      if (remainingLives <= 0) {\n        this.isDead = true;\n        this.game.events.emit(\"game-over\");\n        this.scene.pause();\n        return;\n      }\n\n      this.registry.set(\"health\", 3);\n      this.respawn();\n    } else {\n      this.player.setVelocity(-this.player.body.velocity.x * 0.35, -220);\n      if (settings.accessibility.reduceScreenShake > 0) {\n        this.cameras.main.shake(\n          90,\n          0.0018 * (settings.accessibility.reduceScreenShake / 100),\n          true\n        );\n      }\n    }\n  }\n\n  respawn() {\n    const a11y = Platformer.Settings.current.accessibility;\n    this.player.setPosition(this.respawnPoint.x, this.respawnPoint.y);\n    this.player.setVelocity(0, 0);\n    this.player.setAccelerationX(0);\n    this.player.clearTint();\n    this.jumpsUsed = 0;\n    this.isJumpHeld = false;\n    this.isDashing = false;\n    this.attackActiveUntil = 0;\n    if (!a11y.flashReduction) {\n      this.cameras.main.flash(120, 255, 255, 255);\n    }\n    this.updatePlayerHealthBar();\n    this.events.emit(\"hud-update\");\n  }\n\n  completeLevel() {\n    const a11y = Platformer.Settings.current.accessibility;\n    const maxLevels = 4;\n    this.levelComplete = true;\n    this.player.setAccelerationX(0);\n    this.player.setVelocity(0, -140);\n    this.player.setTexture(\"player-run-1\");\n    this.player.setTint(0xfef08a);\n    this.physics.world.pause();\n    this.cameras.main.zoomTo(a11y.reducedMotion ? 1.02 : 1.15, a11y.reducedMotion ? 220 : 550, \"Quad.easeOut\", true);\n    if (!a11y.flashReduction) {\n      this.cameras.main.flash(200, 255, 255, 255);\n    }\n    if (this.currentLevel < maxLevels) {\n      const nextLevel = this.currentLevel + 1;\n      this.game.events.emit(\"level-transition\", { from: this.currentLevel, to: nextLevel });\n      this.time.delayedCall(a11y.reducedMotion ? 450 : 900, () => {\n        this.scene.restart({ level: nextLevel, carryState: true });\n      });\n    } else {\n      this.game.events.emit(\"level-complete\", {\n        level: this.registry.get(\"level\"),\n        coins: this.registry.get(\"coins\"),\n        targetCoins: Platformer.Config.WIN_COIN_TARGET,\n      });\n    }\n  }\n\n  update() {\n    const { PLAYER, WIN_COIN_TARGET } = Platformer.Config;\n\n    if (!this.player || this.isDead || this.levelComplete) {\n      return;\n    }\n\n    const now = this.time.now;\n    if (now - this.diagLastAt >= 450) {\n      this.diagLastAt = now;\n      this.runRuntimeDiagnostics(now);\n    }\n    this.updateLevelTimer(now);\n    this.spawnHazardProjectiles(now);\n    this.updateProjectiles();\n    this.updatePlayerHealthBar();\n    const moveLeft = this.keys.left.isDown || this.cursors.left.isDown;\n    const moveRight = this.keys.right.isDown || this.cursors.right.isDown;\n    const jumpPressed = Phaser.Input.Keyboard.JustDown(this.cursors.up)\n      || Phaser.Input.Keyboard.JustDown(this.cursors.space)\n      || Phaser.Input.Keyboard.JustDown(this.keys.jump);\n    const dashPressed = Phaser.Input.Keyboard.JustDown(this.keys.dash);\n    const attackPressed = Phaser.Input.Keyboard.JustDown(this.keys.attack);\n    const demoWinPressed = Phaser.Input.Keyboard.JustDown(this.keys.demoWin);\n    const jumpHeld = this.cursors.up.isDown || this.cursors.space.isDown || this.keys.jump.isDown;\n    const grounded = this.player.body.blocked.down || this.player.body.touching.down;\n\n    if (demoWinPressed && !this.levelComplete) {\n      this.registry.set(\"coins\", WIN_COIN_TARGET);\n      this.events.emit(\"hud-update\");\n      this.completeLevel();\n      return;\n    }\n\n    if (grounded) {\n      this.lastOnGroundTime = now;\n      this.jumpsUsed = 0;\n    }\n\n    if (jumpPressed) {\n      this.lastJumpPressedTime = now;\n    }\n\n    const canUseCoyote = now - this.lastOnGroundTime <= PLAYER.coyoteTimeMs;\n    const hasBufferedJump = now - this.lastJumpPressedTime <= PLAYER.jumpBufferMs;\n\n    if (!this.isDashing && canUseCoyote && hasBufferedJump) {\n      this.player.setVelocityY(-PLAYER.jumpVelocity);\n      this.jumpsUsed = 1;\n      this.lastOnGroundTime = -9999;\n      this.lastJumpPressedTime = -9999;\n      this.isJumpHeld = true;\n      Platformer.beeper.jump();\n    } else if (!this.isDashing && jumpPressed && this.jumpsUsed < PLAYER.maxJumps) {\n      this.player.setVelocityY(-PLAYER.jumpVelocity);\n      this.jumpsUsed += 1;\n      this.lastJumpPressedTime = -9999;\n      this.isJumpHeld = true;\n      Platformer.beeper.jump();\n    }\n\n    if (!this.isDashing && !jumpHeld && this.isJumpHeld && this.player.body.velocity.y < -120) {\n      this.player.setVelocityY(this.player.body.velocity.y * 0.5);\n      this.isJumpHeld = false;\n    }\n\n    if (dashPressed) {\n      this.tryStartDash(now, moveLeft, moveRight);\n    }\n    if (attackPressed) {\n      this.tryAttack(now);\n    }\n\n    if (this.isDashing) {\n      const dashDir = this.player.body.velocity.x >= 0 ? 1 : -1;\n      this.player.setVelocityX(dashDir * PLAYER.dashSpeed);\n      this.player.setAccelerationX(0);\n      if (now >= this.dashEndsAt) {\n        this.stopDash();\n      }\n    } else if (moveLeft && !moveRight) {\n      this.player.setAccelerationX(-PLAYER.acceleration);\n      this.player.setFlipX(false);\n      this.facingDir = -1;\n    } else if (moveRight && !moveLeft) {\n      this.player.setAccelerationX(PLAYER.acceleration);\n      this.player.setFlipX(true);\n      this.facingDir = 1;\n    } else {\n      this.player.setAccelerationX(0);\n    }\n    if (!this.isDashing && now > this.attackActiveUntil) {\n      this.player.clearTint();\n    }\n\n    if (this.useImportedCharacter) {\n      if (!grounded) {\n        if (this.player.anims && this.player.anims.isPlaying) {\n          this.player.anims.stop();\n        }\n        if (this.player.texture && this.player.texture.key === \"player-idle-sheet\") {\n          this.player.setFrame(2);\n        }\n      } else if (this.anims.exists(\"playerIdleAnim\")) {\n        if (!this.player.anims.isPlaying || this.player.anims.getName() !== \"playerIdleAnim\") {\n          this.player.setTexture(\"player-idle-sheet\", 0);\n          this.player.play(\"playerIdleAnim\");\n        }\n      } else {\n        if (!this.idleAnimWarned && Platformer.Debug) {\n          Platformer.Debug.warn(\"GameScene.playerIdle\", \"playerIdleAnim not found; fallback idle in use.\");\n          this.idleAnimWarned = true;\n        }\n        this.player.setTexture((Math.floor(now / 360) % 2 === 0) ? \"player-idle-1\" : \"player-idle-2\");\n      }\n    } else if (this.player.body.velocity.y < -25 || !this.player.body.blocked.down) {\n      if (this.player.anims && this.player.anims.isPlaying) {\n        this.player.anims.stop();\n      }\n      this.player.setTexture(\"player-jump\");\n    } else if (Math.abs(this.player.body.velocity.x) > 35) {\n      if (this.player.anims && this.player.anims.isPlaying) {\n        this.player.anims.stop();\n      }\n      this.player.setTexture((Math.floor(now / 100) % 2 === 0) ? \"player-run-1\" : \"player-run-2\");\n    } else {\n      this.player.setTexture((Math.floor(now / 360) % 2 === 0) ? \"player-idle-1\" : \"player-idle-2\");\n    }\n\n    let anyAggressive = false;\n    this.enemies.children.each((enemy) => {\n      this.updateEnemyPatrol(enemy, now);\n      if (enemy.getData(\"isAggressive\")) {\n        anyAggressive = true;\n      }\n    });\n    const projectileThreat = this.hazardProjectiles && this.hazardProjectiles.countActive(true) > 0;\n    const threat = anyAggressive || projectileThreat;\n    if (threat !== this.threatActive) {\n      this.threatActive = threat;\n      this.registry.set(\"threat\", threat ? \"DANGER\" : \"CALM\");\n    }\n    this.updateLandingFeedback();\n    this.updateAuxHud(now);\n\n    if (this.player.y > this.mapHeight * Platformer.Config.TILE + 140) {\n      this.applyDamage();\n      if (!this.isDead) {\n        this.respawn();\n      }\n    }\n  }\n\n  shutdown() {\n    if (this.onRestartLevel) {\n      this.game.events.off(\"restart-level\", this.onRestartLevel);\n      this.onRestartLevel = null;\n    }\n    this.scale.off(\"resize\", this.updateCameraFraming, this);\n  }\n};\n","\ufeffwindow.Platformer = window.Platformer || {};\n\nPlatformer.UIScene = class extends Phaser.Scene {\n  constructor() {\n    super(\"UIScene\");\n    this.hudText = null;\n    this.pauseText = null;\n    this.gameOverText = null;\n    this.victoryText = null;\n    this.victorySubText = null;\n    this.victoryBars = [];\n    this.victorySpeedLines = [];\n    this.victoryCharacter = null;\n    this.transitionText = null;\n    this.toastText = null;\n    this.toastTween = null;\n    this.pausePanel = null;\n    this.pauseButtons = [];\n    this.pauseMusic = null;\n    this.pauseMusicHtml = null;\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n    this.onRegistryChanged = null;\n    this.gamePaused = false;\n    this.gameOver = false;\n    this.levelComplete = false;\n    this.onPauseKey = null;\n    this.onRestartKey = null;\n    this.onEnterKey = null;\n    this.onGameOver = null;\n    this.onLevelComplete = null;\n    this.onLevelTransition = null;\n    this.onOptionsClosed = null;\n    this.onToastMessage = null;\n    this.pauseKeyEventName = null;\n  }\n\n  create() {\n    const textScale = Platformer.Settings.textScale();\n    const pauseKey = Platformer.Settings.current.controls.pause || \"ESC\";\n    this.pauseKeyEventName = `keydown-${pauseKey}`;\n\n    this.hudText = this.add.text(16, 14, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(20 * textScale)}px`,\n      color: \"#f8fafc\",\n      stroke: \"#111827\",\n      strokeThickness: 4,\n    }).setScrollFactor(0);\n\n    this.pauseText = this.add.text(this.scale.width / 2, this.scale.height / 2, \"PAUSED\", {\n      fontFamily: \"Verdana\",\n      fontSize: `${Math.round(56 * textScale)}px`,\n      color: \"#fcd34d\",\n      stroke: \"#1f2937\",\n      strokeThickness: 6,\n    }).setOrigin(0.5).setScrollFactor(0).setVisible(false);\n    this.buildPauseMenu(textScale);\n\n    this.gameOverText = this.add.text(this.scale.width / 2, this.scale.height / 2,\n      \"GAME OVER\\nPress R to Restart\", {\n        fontFamily: \"Verdana\",\n        fontSize: `${Math.round(44 * textScale)}px`,\n        color: \"#fca5a5\",\n        align: \"center\",\n        stroke: \"#1f2937\",\n        strokeThickness: 6,\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false);\n\n    this.victoryText = this.add.text(this.scale.width / 2, this.scale.height / 2 - 24,\n      \"MISSION CLEAR!\", {\n        fontFamily: \"Impact, Haettenschweiler, Arial Narrow Bold, sans-serif\",\n        fontSize: `${Math.round(74 * textScale)}px`,\n        color: \"#fde047\",\n        stroke: \"#7f1d1d\",\n        strokeThickness: 12,\n        shadow: { offsetX: 0, offsetY: 0, color: \"#000000\", blur: 10, fill: true },\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false).setAlpha(0);\n\n    this.victorySubText = this.add.text(this.scale.width / 2, this.scale.height / 2 + 52,\n      \"Coins Secured. Press ENTER for Menu\", {\n        fontFamily: \"Consolas\",\n        fontSize: `${Math.round(26 * textScale)}px`,\n        color: \"#f8fafc\",\n        stroke: \"#111827\",\n        strokeThickness: 6,\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false).setAlpha(0);\n\n    this.transitionText = this.add.text(this.scale.width / 2, this.scale.height / 2,\n      \"\", {\n        fontFamily: \"Verdana\",\n        fontSize: `${Math.round(46 * textScale)}px`,\n        color: \"#fef08a\",\n        stroke: \"#1f2937\",\n        strokeThickness: 7,\n        align: \"center\",\n      }\n    ).setOrigin(0.5).setScrollFactor(0).setVisible(false).setDepth(120);\n\n    this.toastText = this.add.text(this.scale.width / 2, 74, \"\", {\n      fontFamily: \"Consolas\",\n      fontSize: `${Math.round(24 * textScale)}px`,\n      color: \"#fef3c7\",\n      stroke: \"#111827\",\n      strokeThickness: 5,\n      align: \"center\",\n    }).setOrigin(0.5).setScrollFactor(0).setVisible(false).setDepth(130);\n\n    this.createVictoryFX();\n    this.updateHud();\n\n    this.onRegistryChanged = () => this.updateHud();\n    this.registry.events.on(\"changedata\", this.onRegistryChanged);\n\n    this.onGameOver = () => {\n      this.gameOver = true;\n      if (Platformer.Debug) Platformer.Debug.warn(\"UIScene\", \"Game over shown.\");\n      this.gameOverText.setVisible(true);\n      this.hidePauseMenu();\n    };\n    this.game.events.on(\"game-over\", this.onGameOver);\n\n    this.onLevelComplete = () => {\n      this.levelComplete = true;\n      if (Platformer.Debug) Platformer.Debug.log(\"UIScene\", \"Level complete overlay shown.\");\n      this.hidePauseMenu();\n      this.showVictorySequence();\n    };\n    this.game.events.on(\"level-complete\", this.onLevelComplete);\n\n    this.onLevelTransition = (payload) => {\n      this.hidePauseMenu();\n      this.showLevelTransition(payload);\n    };\n    this.game.events.on(\"level-transition\", this.onLevelTransition);\n\n    this.onOptionsClosed = () => {\n      if (!this.gameOver && !this.levelComplete && this.scene.isPaused(\"GameScene\")) {\n        this.showPauseMenu();\n      }\n    };\n    this.game.events.on(\"options-closed-to-pause\", this.onOptionsClosed);\n\n    this.onToastMessage = (payload) => this.showToast(payload);\n    this.game.events.on(\"toast-message\", this.onToastMessage);\n\n    this.onPauseKey = () => {\n      if (this.scene.isActive(\"OptionsScene\")) return;\n      if (this.gameOver || this.levelComplete) return;\n      this.togglePauseMenu();\n    };\n    this.input.keyboard.on(this.pauseKeyEventName, this.onPauseKey);\n\n    this.onRestartKey = () => {\n      if (!this.gameOver) return;\n      this.gameOver = false;\n      this.gamePaused = false;\n      this.gameOverText.setVisible(false);\n      this.hidePauseMenu();\n      this.game.events.emit(\"restart-level\");\n    };\n    this.input.keyboard.on(\"keydown-R\", this.onRestartKey);\n\n    this.onEnterKey = () => {\n      if (!this.levelComplete) return;\n      this.levelComplete = false;\n      this.resetOverlayStates();\n      this.scene.stop(\"GameScene\");\n      this.scene.stop();\n      this.scene.start(\"MenuScene\");\n    };\n    this.input.keyboard.on(\"keydown-ENTER\", this.onEnterKey);\n  }\n\n  buildPauseMenu(textScale) {\n    const cx = this.scale.width / 2;\n    const cy = this.scale.height / 2;\n\n    this.pausePanel = this.add.rectangle(cx, cy, 560, 340, 0x020617, 0.86)\n      .setStrokeStyle(2, 0x94a3b8, 0.8)\n      .setScrollFactor(0)\n      .setVisible(false)\n      .setDepth(100);\n\n    this.pauseText.setDepth(101);\n    this.pauseText.setY(cy - 118);\n\n    const createBtn = (y, label, onClick) => {\n      const box = this.add.rectangle(cx, y, 280, 50, 0x1d4ed8, 0.96)\n        .setStrokeStyle(2, 0x93c5fd, 0.9)\n        .setDepth(101)\n        .setScrollFactor(0)\n        .setVisible(false)\n        .setInteractive({ useHandCursor: true });\n      const text = this.add.text(cx, y, label, {\n        fontFamily: \"Consolas\",\n        fontSize: `${Math.round(28 * textScale)}px`,\n        color: \"#f8fafc\",\n      }).setOrigin(0.5).setDepth(102).setScrollFactor(0).setVisible(false);\n\n      box.on(\"pointerover\", () => box.setFillStyle(0x2563eb, 0.98));\n      box.on(\"pointerout\", () => box.setFillStyle(0x1d4ed8, 0.96));\n      box.on(\"pointerdown\", onClick);\n\n      this.pauseButtons.push({ box, text });\n    };\n\n    createBtn(cy - 30, \"Resume\", () => this.resumeFromPause());\n    createBtn(cy + 35, \"Options\", () => {\n      this.hidePauseMenu();\n      this.scene.launch(\"OptionsScene\", { returnTo: \"pause\" });\n    });\n    createBtn(cy + 100, \"Return to Menu\", () => {\n      if (Platformer.Debug) Platformer.Debug.warn(\"UIScene.pause\", \"Return to Menu clicked.\");\n      this.stopPauseMusic();\n      this.hidePauseMenu();\n      this.scene.stop(\"GameScene\");\n      if (this.scene.isActive(\"OptionsScene\")) this.scene.stop(\"OptionsScene\");\n      this.scene.stop();\n      this.scene.start(\"MenuScene\");\n    });\n  }\n\n  showPauseMenu() {\n    if (Platformer.Debug) Platformer.Debug.log(\"UIScene.pause\", \"Pause menu opened.\");\n    this.pauseGameplayMusic();\n    this.playPauseMusic();\n    this.pausePanel.setVisible(true);\n    this.pauseText.setVisible(true);\n    this.pauseButtons.forEach((b) => {\n      b.box.setVisible(true);\n      b.text.setVisible(true);\n    });\n    this.gamePaused = true;\n  }\n\n  hidePauseMenu() {\n    if (this.pausePanel) this.pausePanel.setVisible(false);\n    this.pauseText.setVisible(false);\n    this.pauseButtons.forEach((b) => {\n      b.box.setVisible(false);\n      b.text.setVisible(false);\n    });\n    this.gamePaused = false;\n  }\n\n  togglePauseMenu() {\n    if (this.scene.isPaused(\"GameScene\")) {\n      this.resumeFromPause();\n    } else {\n      this.scene.pause(\"GameScene\");\n      this.showPauseMenu();\n    }\n  }\n\n  resumeFromPause() {\n    if (Platformer.Debug) Platformer.Debug.log(\"UIScene.pause\", \"Resuming gameplay from pause.\");\n    this.stopPauseMusic();\n    this.resumeGameplayMusic();\n    this.scene.resume(\"GameScene\");\n    this.hidePauseMenu();\n  }\n\n  pauseGameplayMusic() {\n    if (Platformer.gameMusic && Platformer.gameMusic.isPlaying) {\n      try {\n        Platformer.gameMusic.pause();\n        this.resumePhaserGameMusic = true;\n      } catch (_e) {\n        // Ignore; best effort.\n      }\n    }\n\n    if (Platformer.gameMusicHtml && !Platformer.gameMusicHtml.paused) {\n      try {\n        Platformer.gameMusicHtml.pause();\n        this.resumeHtmlGameMusic = true;\n      } catch (_e) {\n        // Ignore; best effort.\n      }\n    }\n  }\n\n  resumeGameplayMusic() {\n    if (this.resumePhaserGameMusic && Platformer.gameMusic) {\n      try {\n        Platformer.gameMusic.resume();\n      } catch (_e) {\n        // Ignore; best effort.\n      }\n    }\n\n    if (this.resumeHtmlGameMusic && Platformer.gameMusicHtml) {\n      Platformer.gameMusicHtml.play().catch(() => {});\n    }\n\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n  }\n\n  playPauseMusic() {\n    const audioSettings = Platformer.Settings.current.audio;\n    const volume = Phaser.Math.Clamp((audioSettings.master / 100) * (audioSettings.music / 100), 0, 1);\n\n    if (this.cache.audio.exists(\"pause-bgm\")) {\n      if (!this.pauseMusic) {\n        this.pauseMusic = this.sound.get(\"pause-bgm\");\n        if (!this.pauseMusic) {\n          try {\n            this.pauseMusic = this.sound.add(\"pause-bgm\", { loop: true, volume });\n          } catch (_e) {\n            this.pauseMusic = null;\n          }\n        }\n      }\n      if (this.pauseMusic) {\n        this.pauseMusic.setLoop(true);\n        this.pauseMusic.setVolume(volume);\n        if (!this.pauseMusic.isPlaying) {\n          try {\n            this.pauseMusic.play();\n          } catch (_e) {\n            // Autoplay gating: user already pressed ESC, so retry on next input if needed.\n          }\n        }\n        return;\n      }\n    }\n\n    // HTML audio fallback.\n    if (!this.pauseMusicHtml) {\n      try {\n        this.pauseMusicHtml = new Audio(\"assets/Elevator Music - So Chill (mp3cut.net).mp3\");\n        Platformer.pauseMusicHtml = this.pauseMusicHtml;\n        this.pauseMusicHtml.loop = true;\n      } catch (_e) {\n        this.pauseMusicHtml = null;\n      }\n    }\n    if (this.pauseMusicHtml) {\n      this.pauseMusicHtml.volume = volume;\n      this.pauseMusicHtml.play().catch(() => {});\n    }\n  }\n\n  stopPauseMusic() {\n    if (this.pauseMusic && this.pauseMusic.isPlaying) {\n      this.pauseMusic.stop();\n    }\n    if (this.pauseMusicHtml) {\n      this.pauseMusicHtml.pause();\n      this.pauseMusicHtml.currentTime = 0;\n      Platformer.pauseMusicHtml = null;\n    }\n  }\n\n  updateHud() {\n    if (!this.hudText || !this.hudText.active) {\n      return;\n    }\n    if (!this.sys || !this.sys.settings || !this.sys.settings.active) {\n      return;\n    }\n\n    const lives = this.registry.get(\"lives\");\n    const health = this.registry.get(\"health\");\n    const coins = this.registry.get(\"coins\");\n    const level = this.registry.get(\"level\");\n    const timeLeft = this.registry.get(\"timeLeft\");\n    const threat = this.registry.get(\"threat\");\n    const dashCd = Number(this.registry.get(\"dashCd\") || 0);\n    const shield = Math.max(0, Number(this.registry.get(\"shield\") || 0));\n    const { WIN_COIN_TARGET } = Platformer.Config;\n    const dashTxt = dashCd <= 0.06 ? \"READY\" : `${dashCd.toFixed(1)}s`;\n\n    try {\n      this.hudText.setText(\n        `Level: ${level}   Lives: ${Math.max(0, lives)}   Health: ${Math.max(0, health)}   Coins: ${coins}/${WIN_COIN_TARGET}   Time: ${Math.max(0, timeLeft || 0)}   Threat: ${threat || \"CALM\"}   Dash: ${dashTxt}   Shield: ${shield}`\n      );\n    } catch (err) {\n      const msg = err && err.stack ? err.stack : String(err);\n      if (Platformer.Debug && Platformer.Debug.error) {\n        Platformer.Debug.error(\"UIScene.updateHud\", msg);\n      }\n    }\n  }\n\n  showToast(payload) {\n    if (!payload || !this.toastText) return;\n    const text = String(payload.text || \"\").trim();\n    if (!text) return;\n    const color = payload.color || 0xfef3c7;\n    this.toastText.setText(text);\n    this.toastText.setColor(`#${color.toString(16).padStart(6, \"0\")}`);\n    this.toastText.setAlpha(1);\n    this.toastText.setVisible(true);\n    if (this.toastTween) {\n      this.toastTween.stop();\n      this.toastTween = null;\n    }\n    this.toastTween = this.tweens.add({\n      targets: this.toastText,\n      y: 58,\n      alpha: 0,\n      duration: 900,\n      ease: \"Quad.easeOut\",\n      onComplete: () => {\n        if (this.toastText) {\n          this.toastText.setVisible(false);\n          this.toastText.setY(74);\n        }\n      },\n    });\n  }\n\n  createVictoryFX() {\n    const topBar = this.add.rectangle(this.scale.width / 2, -45, this.scale.width, 90, 0x020617, 0.92)\n      .setScrollFactor(0).setVisible(false);\n    const bottomBar = this.add.rectangle(this.scale.width / 2, this.scale.height + 45, this.scale.width, 90, 0x020617, 0.92)\n      .setScrollFactor(0).setVisible(false);\n    this.victoryBars = [topBar, bottomBar];\n\n    const lineColor = 0xffffff;\n    for (let i = 0; i < 16; i += 1) {\n      const y = 40 + i * 30;\n      const line = this.add.rectangle(-220, y, 190, 4, lineColor, 0.22)\n        .setAngle(-16)\n        .setScrollFactor(0)\n        .setVisible(false);\n      this.victorySpeedLines.push(line);\n    }\n\n    this.victoryCharacter = this.buildVictoryCharacter(this.scale.width - 210, this.scale.height - 210);\n    this.victoryCharacter.setVisible(false).setAlpha(0).setScale(0.8);\n  }\n\n  buildVictoryCharacter(x, y) {\n    const style = [\n      \"width:236px\",\n      \"height:236px\",\n      \"border:4px solid #fde047\",\n      \"background:rgba(15,23,42,0.86)\",\n      \"display:flex\",\n      \"align-items:center\",\n      \"justify-content:center\",\n      \"overflow:hidden\",\n      \"box-sizing:border-box\",\n    ].join(\";\");\n\n    const dom = this.add.dom(x, y, \"div\", style, \"\").setScrollFactor(0);\n    const img = document.createElement(\"img\");\n    img.src = \"./assets/kawaii-anime-girl.gif\";\n    img.alt = \"Victory Girl\";\n    img.style.width = \"220px\";\n    img.style.height = \"220px\";\n    img.style.objectFit = \"cover\";\n    img.onerror = () => {\n      dom.node.innerHTML = \"<span style='font-family:Consolas;color:#f8fafc;font-size:32px'>VICTORY</span>\";\n    };\n    dom.node.appendChild(img);\n\n    return dom;\n  }\n\n  showVictorySequence() {\n    if (this.victoryCharacter) {\n      this.victoryCharacter.destroy();\n    }\n    this.victoryCharacter = this.buildVictoryCharacter(this.scale.width - 210, this.scale.height - 210);\n    this.victoryCharacter.setVisible(false).setAlpha(0).setScale(0.8);\n\n    this.pauseText.setVisible(false);\n    this.gameOverText.setVisible(false);\n    this.victoryBars.forEach((bar) => bar.setVisible(true));\n    this.victorySpeedLines.forEach((line) => line.setVisible(true));\n    this.victoryText.setVisible(true);\n    this.victorySubText.setVisible(true);\n    this.victoryCharacter.setVisible(true);\n\n    this.tweens.add({\n      targets: this.victoryBars[0],\n      y: 40,\n      duration: 320,\n      ease: \"Cubic.easeOut\",\n    });\n    this.tweens.add({\n      targets: this.victoryBars[1],\n      y: this.scale.height - 40,\n      duration: 320,\n      ease: \"Cubic.easeOut\",\n    });\n\n    this.victorySpeedLines.forEach((line, idx) => {\n      line.x = -220 - idx * 36;\n      this.tweens.add({\n        targets: line,\n        x: this.scale.width + 220,\n        duration: 360 + idx * 22,\n        ease: \"Linear\",\n        repeat: -1,\n        delay: idx * 20,\n      });\n    });\n\n    this.tweens.add({\n      targets: this.victoryText,\n      alpha: 1,\n      scaleX: { from: 1.65, to: 1 },\n      scaleY: { from: 0.35, to: 1 },\n      angle: { from: -8, to: 0 },\n      duration: 280,\n      ease: \"Back.easeOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victorySubText,\n      alpha: 1,\n      y: this.victorySubText.y + 10,\n      duration: 240,\n      delay: 180,\n      ease: \"Quad.easeOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victoryText,\n      scale: 1.05,\n      yoyo: true,\n      duration: 620,\n      repeat: -1,\n      ease: \"Sine.easeInOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victoryCharacter,\n      alpha: 1,\n      scale: 1,\n      x: this.scale.width - 196,\n      duration: 300,\n      ease: \"Back.easeOut\",\n    });\n\n    this.tweens.add({\n      targets: this.victoryCharacter,\n      y: this.victoryCharacter.y - 8,\n      yoyo: true,\n      repeat: -1,\n      duration: 900,\n      ease: \"Sine.easeInOut\",\n    });\n  }\n\n  showLevelTransition(payload) {\n    const from = payload && payload.from ? payload.from : \"?\";\n    const to = payload && payload.to ? payload.to : \"?\";\n    this.transitionText\n      .setText(`LEVEL ${from} CLEAR\\\\nNEXT: LEVEL ${to}`)\n      .setVisible(true)\n      .setAlpha(0)\n      .setScale(1.1);\n\n    this.tweens.add({\n      targets: this.transitionText,\n      alpha: 1,\n      scale: 1,\n      duration: 220,\n      yoyo: true,\n      hold: 350,\n      onComplete: () => this.transitionText.setVisible(false),\n    });\n  }\n\n  resetOverlayStates() {\n    this.gameOverText.setVisible(false);\n    this.pauseText.setVisible(false);\n    this.hidePauseMenu();\n    this.stopPauseMusic();\n    this.victoryText.setVisible(false).setAlpha(0).setScale(1).setAngle(0);\n    if (this.transitionText) {\n      this.transitionText.setVisible(false).setAlpha(0).setScale(1);\n    }\n    this.victorySubText.setVisible(false).setAlpha(0).setY(this.scale.height / 2 + 52);\n    this.victoryBars[0].setVisible(false).setY(-45);\n    this.victoryBars[1].setVisible(false).setY(this.scale.height + 45);\n    this.victorySpeedLines.forEach((line) => line.setVisible(false));\n\n    if (this.victoryCharacter) {\n      this.victoryCharacter.setVisible(false).setAlpha(0).setScale(0.8);\n      this.victoryCharacter.setPosition(this.scale.width - 210, this.scale.height - 210);\n    }\n\n    this.tweens.killAll();\n  }\n\n  shutdown() {\n    this.stopPauseMusic();\n    this.resumePhaserGameMusic = false;\n    this.resumeHtmlGameMusic = false;\n    if (this.toastTween) {\n      this.toastTween.stop();\n      this.toastTween = null;\n    }\n    if (this.onRegistryChanged) {\n      this.registry.events.off(\"changedata\", this.onRegistryChanged);\n      this.onRegistryChanged = null;\n    }\n    if (this.onGameOver) this.game.events.off(\"game-over\", this.onGameOver);\n    if (this.onLevelComplete) this.game.events.off(\"level-complete\", this.onLevelComplete);\n    if (this.onLevelTransition) this.game.events.off(\"level-transition\", this.onLevelTransition);\n    if (this.onOptionsClosed) this.game.events.off(\"options-closed-to-pause\", this.onOptionsClosed);\n    if (this.onToastMessage) this.game.events.off(\"toast-message\", this.onToastMessage);\n    if (this.onPauseKey && this.pauseKeyEventName) this.input.keyboard.off(this.pauseKeyEventName, this.onPauseKey);\n    if (this.onRestartKey) this.input.keyboard.off(\"keydown-R\", this.onRestartKey);\n    if (this.onEnterKey) this.input.keyboard.off(\"keydown-ENTER\", this.onEnterKey);\n    this.onPauseKey = null;\n    this.onRestartKey = null;\n    this.onEnterKey = null;\n    this.onGameOver = null;\n    this.onLevelComplete = null;\n    this.onLevelTransition = null;\n    this.onOptionsClosed = null;\n    this.onToastMessage = null;\n    this.pauseKeyEventName = null;\n  }\n};\n","window.Platformer = window.Platformer || {};\n\n(async () => {\n  if (!Platformer.BUILD_VERSION || typeof Platformer.BUILD_VERSION !== \"string\") {\n    document.body.innerHTML = \"<div style='font-family:Consolas,monospace;padding:24px;color:#fee2e2;background:#1f2937'>Build metadata missing. Rebuild the game package.</div>\";\n    throw new Error(\"BUILD_VERSION missing.\");\n  }\n  await Platformer.Settings.bootstrap();\n  const { PLAYER } = Platformer.Config;\n  const settings = Platformer.Settings.current;\n  const fpsTarget = settings.video.fpsCap === \"unlimited\" ? 0 : Number(settings.video.fpsCap);\n  const isFileProtocol = window.location.protocol === \"file:\";\n  const isDesktopHost = !!(window.pywebview && window.pywebview.api);\n  const dpr = Math.max(1, Math.min(2, Math.round((window.devicePixelRatio || 1) * 100) / 100));\n  const getViewportSize = () => {\n    const root = document.getElementById(\"game-root\");\n    const rootW = root && root.clientWidth ? root.clientWidth : 0;\n    const rootH = root && root.clientHeight ? root.clientHeight : 0;\n    const docW = document.documentElement && document.documentElement.clientWidth ? document.documentElement.clientWidth : 0;\n    const docH = document.documentElement && document.documentElement.clientHeight ? document.documentElement.clientHeight : 0;\n    const w = Math.max(rootW, docW, 640);\n    const h = Math.max(rootH, docH, 360);\n    return { w, h };\n  };\n  const initial = getViewportSize();\n  Platformer.Debug.init();\n  if (Platformer.BUILD_VERSION) {\n    Platformer.Debug.log(\"Build\", `version=${Platformer.BUILD_VERSION} time=${Platformer.BUILD_TIME_UTC || \"n/a\"}`);\n  }\n  if (isFileProtocol && !isDesktopHost) Platformer.Debug.log(\"Runtime\", \"file:// mode detected.\");\n  if (isDesktopHost) Platformer.Debug.log(\"Runtime\", \"Desktop host mode detected.\");\n\n  const SafeBootScene = Platformer.wrapSceneSafety(Platformer.BootScene, \"BootScene\");\n  const SafeMenuScene = Platformer.wrapSceneSafety(Platformer.MenuScene, \"MenuScene\");\n  const SafeIntroScene = Platformer.wrapSceneSafety(Platformer.IntroScene, \"IntroScene\");\n  const SafeOptionsScene = Platformer.wrapSceneSafety(Platformer.OptionsScene, \"OptionsScene\");\n  const SafeGameScene = Platformer.wrapSceneSafety(Platformer.GameScene, \"GameScene\");\n  const SafeUIScene = Platformer.wrapSceneSafety(Platformer.UIScene, \"UIScene\");\n\n  const config = {\n    type: Phaser.AUTO,\n    width: initial.w,\n    height: initial.h,\n    parent: \"game-root\",\n    pixelArt: settings.video.pixelPerfect,\n    resolution: dpr,\n    scale: {\n      mode: Phaser.Scale.RESIZE,\n      width: initial.w,\n      height: initial.h,\n      zoom: 1,\n    },\n    backgroundColor: \"#7dd3fc\",\n    autoRound: true,\n    render: {\n      antialias: false,\n      antialiasGL: false,\n      pixelArt: true,\n      roundPixels: true,\n      powerPreference: \"high-performance\",\n    },\n    physics: {\n      default: \"arcade\",\n      arcade: {\n        gravity: { y: PLAYER.gravity },\n        debug: false,\n      },\n    },\n    fps: {\n      target: fpsTarget || 60,\n      forceSetTimeOut: !settings.video.vsync,\n    },\n    dom: {\n      createContainer: true,\n    },\n    scene: [\n      SafeBootScene,\n      SafeMenuScene,\n      SafeIntroScene,\n      SafeOptionsScene,\n      SafeGameScene,\n      SafeUIScene,\n    ],\n  };\n\n  const game = new Phaser.Game(config);\n  window.AnimePlatformerGame = {\n    play() { if (game && game.scene) game.scene.resume(\"GameScene\"); },\n    pause() { if (game && game.scene) game.scene.pause(\"GameScene\"); },\n    settings() { return Platformer.Settings.current; },\n  };\n  Platformer.Debug.attachGameMonitors(game);\n  let lastW = initial.w;\n  let lastH = initial.h;\n\n  const applySize = (wRaw, hRaw, source = \"window\") => {\n    const vp = getViewportSize();\n    const w = Math.max(640, Number(wRaw) || vp.w);\n    const h = Math.max(360, Number(hRaw) || vp.h);\n    if (w === lastW && h === lastH) return;\n    lastW = w;\n    lastH = h;\n    Platformer.Debug.log(\"ResizeSync\", `${source} -> ${w}x${h}`);\n\n    if (game && game.scale) {\n      game.scale.resize(w, h);\n      if (typeof game.scale.refresh === \"function\") {\n        game.scale.refresh();\n      }\n      if (game.input && game.input.manager && typeof game.input.manager.resize === \"function\") {\n        game.input.manager.resize(w, h);\n      }\n    }\n  };\n  const syncGameSize = () => {\n    const vp = getViewportSize();\n    applySize(vp.w, vp.h, \"viewport\");\n  };\n\n  window.addEventListener(\"resize\", syncGameSize);\n  window.addEventListener(\"orientationchange\", syncGameSize);\n  window.addEventListener(\"online\", () => {\n    const scene = game && game.scene ? game.scene.getScene(\"MenuScene\") : null;\n    if (scene && typeof scene.autoCheckUpdatesForBottomLeft === \"function\") {\n      scene.autoCheckUpdatesForBottomLeft();\n    }\n  });\n  // Keep a lightweight heartbeat for wrappers that occasionally miss resize events.\n  setInterval(syncGameSize, 500);\n\n  if (settings.video.fullscreen) {\n    game.events.once(\"ready\", () => {\n      if (!game.scale.isFullscreen) {\n        game.scale.startFullscreen();\n      }\n    });\n  }\n})();\n\n\n"],"names":[],"mappings":";;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACvBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC1SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACpYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACjMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AClFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC/BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AChCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AChCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACpDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACzUA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACvtCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC1IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AC7gBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;ACl9CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;AClnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;"}